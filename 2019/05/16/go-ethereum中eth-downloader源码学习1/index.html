<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">

<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CConsolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="article">
<meta property="og:title" content="go-ethereum中eth-downloader源码学习（一）">
<meta property="og:url" content="http://example.com/2019/05/16/go-ethereum%E4%B8%ADeth-downloader%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A01/index.html">
<meta property="og:site_name" content="AmorFati">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/christoph-schmid-437840-unsplash.jpg">
<meta property="article:published_time" content="2019-05-16T09:49:51.000Z">
<meta property="article:modified_time" content="2021-11-17T13:54:30.490Z">
<meta property="article:author" content="AmorFati">
<meta property="article:tag" content="区块链">
<meta property="article:tag" content="以太坊">
<meta property="article:tag" content="go">
<meta property="article:tag" content="go-ethereum">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/christoph-schmid-437840-unsplash.jpg">


<link rel="canonical" href="http://example.com/2019/05/16/go-ethereum%E4%B8%ADeth-downloader%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A01/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2019/05/16/go-ethereum%E4%B8%ADeth-downloader%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A01/","path":"2019/05/16/go-ethereum中eth-downloader源码学习1/","title":"go-ethereum中eth-downloader源码学习（一）"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>go-ethereum中eth-downloader源码学习（一） | AmorFati</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">AmorFati</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">风吹过窗前的书，又翻过一页</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#new"><span class="nav-number">1.</span> <span class="nav-text">new</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Synchronise"><span class="nav-number">2.</span> <span class="nav-text">Synchronise</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fetchHeaders"><span class="nav-number">3.</span> <span class="nav-text">fetchHeaders</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fetchBodies"><span class="nav-number">4.</span> <span class="nav-text">fetchBodies</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fetchReceipts"><span class="nav-number">5.</span> <span class="nav-text">fetchReceipts</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#processHeaders"><span class="nav-number">6.</span> <span class="nav-text">processHeaders</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fetchParts"><span class="nav-number">7.</span> <span class="nav-text">fetchParts</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#processFastSyncContent"><span class="nav-number">8.</span> <span class="nav-text">processFastSyncContent</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#processFullSyncContent"><span class="nav-number">9.</span> <span class="nav-text">processFullSyncContent</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DeliverXxx"><span class="nav-number">10.</span> <span class="nav-text">DeliverXxx</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="AmorFati"
      src="/assets/img/icon.jpg">
  <p class="site-author-name" itemprop="name">AmorFati</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/1chenyy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;1chenyy" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:henyang4346@foxmail.com" title="E-Mail → mailto:henyang4346@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/52c1bec4559c" title="简书 → https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;52c1bec4559c" rel="noopener" target="_blank"><i class="fa fa-globe fa-fw"></i>简书</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/16/go-ethereum%E4%B8%ADeth-downloader%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/icon.jpg">
      <meta itemprop="name" content="AmorFati">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmorFati">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          go-ethereum中eth-downloader源码学习（一）
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-16 17:49:51" itemprop="dateCreated datePublished" datetime="2019-05-16T17:49:51+08:00">2019-05-16</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-11-17 21:54:30" itemprop="dateModified" datetime="2021-11-17T21:54:30+08:00">2021-11-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go-ethereum%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">go-ethereum源码学习</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>28k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>25 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/christoph-schmid-437840-unsplash.jpg"></p>
<span id="more"></span>
<p>本文是downloader的源码分析的第一部分，分析downloader.go也就是主流程</p>
<h2 id="new"><a href="#new" class="headerlink" title="new"></a>new</h2><p>downloader主要是进行网络的同步，有两种同步模式，FullSync和FastSync，后者只能在第一次运行时才有效，这里可见ProtocolManager源码。关于两种同步模式，FullSync会通过下载区块头和区块体构建区块链，包括区块的验证，交易的执行，账户的状态改变等，就类似于一个一个插入区块。而FastSync在开始时会直接下载区块头、区块体和收据，并不执行交易，然后在最后若干个区块才会像FullSync一样进行区块同步。</p>
<p>downloader在ProtocolManager创建时被创建，用的是New方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>mode SyncMode<span class="token punctuation">,</span> stateDb ethdb<span class="token punctuation">.</span>Database<span class="token punctuation">,</span> mux <span class="token operator">*</span>event<span class="token punctuation">.</span>TypeMux<span class="token punctuation">,</span> chain BlockChain<span class="token punctuation">,</span> lightchain LightChain<span class="token punctuation">,</span> dropPeer peerDropFn<span class="token punctuation">)</span> <span class="token operator">*</span>Downloader <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> lightchain <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		lightchain <span class="token operator">=</span> chain
	<span class="token punctuation">&#125;</span>

	dl <span class="token operator">:=</span> <span class="token operator">&amp;</span>Downloader<span class="token punctuation">&#123;</span>
		mode<span class="token punctuation">:</span>           mode<span class="token punctuation">,</span>
		stateDB<span class="token punctuation">:</span>        stateDb<span class="token punctuation">,</span>
		mux<span class="token punctuation">:</span>            mux<span class="token punctuation">,</span>
		queue<span class="token punctuation">:</span>          <span class="token function">newQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		peers<span class="token punctuation">:</span>          <span class="token function">newPeerSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		rttEstimate<span class="token punctuation">:</span>    <span class="token function">uint64</span><span class="token punctuation">(</span>rttMaxEstimate<span class="token punctuation">)</span><span class="token punctuation">,</span>
		rttConfidence<span class="token punctuation">:</span>  <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		blockchain<span class="token punctuation">:</span>     chain<span class="token punctuation">,</span>
		lightchain<span class="token punctuation">:</span>     lightchain<span class="token punctuation">,</span>
		dropPeer<span class="token punctuation">:</span>       dropPeer<span class="token punctuation">,</span>
		headerCh<span class="token punctuation">:</span>       <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> dataPack<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		bodyCh<span class="token punctuation">:</span>         <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> dataPack<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		receiptCh<span class="token punctuation">:</span>      <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> dataPack<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		bodyWakeCh<span class="token punctuation">:</span>     <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		receiptWakeCh<span class="token punctuation">:</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		headerProcCh<span class="token punctuation">:</span>   <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		quitCh<span class="token punctuation">:</span>         <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		stateCh<span class="token punctuation">:</span>        <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> dataPack<span class="token punctuation">)</span><span class="token punctuation">,</span>
		stateSyncStart<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>stateSync<span class="token punctuation">)</span><span class="token punctuation">,</span>
		syncStatsState<span class="token punctuation">:</span> stateSyncStats<span class="token punctuation">&#123;</span>
			processed<span class="token punctuation">:</span> rawdb<span class="token punctuation">.</span><span class="token function">ReadFastTrieProgress</span><span class="token punctuation">(</span>stateDb<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		trackStateReq<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>stateReq<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">go</span> dl<span class="token punctuation">.</span><span class="token function">qosTuner</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> dl<span class="token punctuation">.</span><span class="token function">stateFetcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> dl
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先根据传入的参数创建了一个Downloader对象，然后启动了两个goroutine分别执行qosTuner和stateFetcher方法。</p>
<h2 id="Synchronise"><a href="#Synchronise" class="headerlink" title="Synchronise"></a>Synchronise</h2><p>通过前面的ProtocolManager的学习，我们了解到总共有两个地方调用了Synchronise，一个是收到一个NewBlockMsg消息时，表示对方有新的区块，如果对方的总难度大于我们，则进行同步调用pm的synchronise方法。另外在启动pm时，在syncer方法中无论是forceSync定时器到时间或者newPeerCh得到赋值（在连接到一个peer时触发）都会调用synchronise。在pm的synchronise中会调用Synchronise方法</p>
<p>Synchronise方法实现如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">Synchronise</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> head common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> td <span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> mode SyncMode<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">synchronise</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> head<span class="token punctuation">,</span> td<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
	<span class="token keyword">switch</span> err <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
	<span class="token keyword">case</span> errBusy<span class="token punctuation">:</span>

	<span class="token keyword">case</span> errTimeout<span class="token punctuation">,</span> errBadPeer<span class="token punctuation">,</span> errStallingPeer<span class="token punctuation">,</span>
		errEmptyHeaderSet<span class="token punctuation">,</span> errPeersUnavailable<span class="token punctuation">,</span> errTooOld<span class="token punctuation">,</span>
		errInvalidAncestor<span class="token punctuation">,</span> errInvalidChain<span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Synchronisation failed, dropping peer"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">if</span> d<span class="token punctuation">.</span>dropPeer <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Downloader wants to drop peer, but peerdrop-function is not set"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			d<span class="token punctuation">.</span><span class="token function">dropPeer</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Synchronisation failed, retrying"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>直接调用synchronise方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">synchronise</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> td <span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> mode SyncMode<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> d<span class="token punctuation">.</span>synchroniseMock <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">synchroniseMock</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>synchronising<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errBusy
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">defer</span> atomic<span class="token punctuation">.</span><span class="token function">StoreInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>synchronising<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>notified<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Block synchronisation started"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	d<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ch <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">&#123;</span>d<span class="token punctuation">.</span>bodyWakeCh<span class="token punctuation">,</span> d<span class="token punctuation">.</span>receiptWakeCh<span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ch <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">chan</span> dataPack<span class="token punctuation">&#123;</span>d<span class="token punctuation">.</span>headerCh<span class="token punctuation">,</span> d<span class="token punctuation">.</span>bodyCh<span class="token punctuation">,</span> d<span class="token punctuation">.</span>receiptCh<span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> empty <span class="token operator">:=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token operator">!</span>empty<span class="token punctuation">;</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>
				empty <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> empty <span class="token operator">:=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token operator">!</span>empty<span class="token punctuation">;</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>headerProcCh<span class="token punctuation">:</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			empty <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	d<span class="token punctuation">.</span>cancelLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	d<span class="token punctuation">.</span>cancelCh <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	d<span class="token punctuation">.</span>cancelPeer <span class="token operator">=</span> id
	d<span class="token punctuation">.</span>cancelLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">defer</span> d<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  channel open

	d<span class="token punctuation">.</span>mode <span class="token operator">=</span> mode

	p <span class="token operator">:=</span> d<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">Peer</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
	<span class="token keyword">if</span> p <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errUnknownPeer
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">syncWithPeer</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> td<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一个方法是在做同步前的准备工作，先确定只有一个实例运行，然后重置queue和peers,表示一次同步准备开始，清空几个channel。之后从peers取出对应id的peer。peer保存着已连接的peer的peerConnection对象，由pm在新连接到来时通过downloader的RegisterPeer方法添加。然后执行syncWithPeer:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">syncWithPeer</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> td <span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	d<span class="token punctuation">.</span>mux<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span>StartEvent<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			d<span class="token punctuation">.</span>mux<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span>FailedEvent<span class="token punctuation">&#123;</span>err<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			latest <span class="token operator">:=</span> d<span class="token punctuation">.</span>lightchain<span class="token punctuation">.</span><span class="token function">CurrentHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			d<span class="token punctuation">.</span>mux<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span>DoneEvent<span class="token punctuation">&#123;</span>latest<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> p<span class="token punctuation">.</span>version <span class="token operator">&lt;</span> <span class="token number">62</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errTooOld
	<span class="token punctuation">&#125;</span>

	log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Synchronising with the network"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">"eth"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>version<span class="token punctuation">,</span> <span class="token string">"head"</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">"td"</span><span class="token punctuation">,</span> td<span class="token punctuation">,</span> <span class="token string">"mode"</span><span class="token punctuation">,</span> d<span class="token punctuation">.</span>mode<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span>start time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Synchronisation terminated"</span><span class="token punctuation">,</span> <span class="token string">"elapsed"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


	latest<span class="token punctuation">,</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">fetchHeight</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	height <span class="token operator">:=</span> latest<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	origin<span class="token punctuation">,</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">findAncestor</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> latest<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	d<span class="token punctuation">.</span>syncStatsLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> d<span class="token punctuation">.</span>syncStatsChainHeight <span class="token operator">&lt;=</span> origin <span class="token operator">||</span> d<span class="token punctuation">.</span>syncStatsChainOrigin <span class="token operator">></span> origin <span class="token punctuation">&#123;</span>
		d<span class="token punctuation">.</span>syncStatsChainOrigin <span class="token operator">=</span> origin
	<span class="token punctuation">&#125;</span>
	d<span class="token punctuation">.</span>syncStatsChainHeight <span class="token operator">=</span> height
	d<span class="token punctuation">.</span>syncStatsLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	pivot <span class="token operator">:=</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> d<span class="token punctuation">.</span>mode <span class="token operator">==</span> FastSync <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> height <span class="token operator">&lt;=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>fsMinFullBlocks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			origin <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			pivot <span class="token operator">=</span> height <span class="token operator">-</span> <span class="token function">uint64</span><span class="token punctuation">(</span>fsMinFullBlocks<span class="token punctuation">)</span>
			<span class="token keyword">if</span> pivot <span class="token operator">&lt;=</span> origin <span class="token punctuation">&#123;</span>
				origin <span class="token operator">=</span> pivot <span class="token operator">-</span> <span class="token number">1</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	d<span class="token punctuation">.</span>committed <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token keyword">if</span> d<span class="token punctuation">.</span>mode <span class="token operator">==</span> FastSync <span class="token operator">&amp;&amp;</span> pivot <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		d<span class="token punctuation">.</span>committed <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token punctuation">&#125;</span>

	d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Prepare</span><span class="token punctuation">(</span>origin<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> d<span class="token punctuation">.</span>mode<span class="token punctuation">)</span>
	<span class="token keyword">if</span> d<span class="token punctuation">.</span>syncInitHook <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		d<span class="token punctuation">.</span><span class="token function">syncInitHook</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	fetchers <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">fetchHeaders</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> origin<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> pivot<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// Headers are always retrieved</span>
		<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">fetchBodies</span><span class="token punctuation">(</span>origin <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>          <span class="token comment">// Bodies are retrieved during normal and fast sync</span>
		<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">fetchReceipts</span><span class="token punctuation">(</span>origin <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token comment">// Receipts are retrieved during fast sync</span>
		<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">processHeaders</span><span class="token punctuation">(</span>origin<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> pivot<span class="token punctuation">,</span> td<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> d<span class="token punctuation">.</span>mode <span class="token operator">==</span> FastSync <span class="token punctuation">&#123;</span>
		fetchers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>fetchers<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">processFastSyncContent</span><span class="token punctuation">(</span>latest<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> d<span class="token punctuation">.</span>mode <span class="token operator">==</span> FullSync <span class="token punctuation">&#123;</span>
		fetchers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>fetchers<span class="token punctuation">,</span> d<span class="token punctuation">.</span>processFullSyncContent<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">spawnSync</span><span class="token punctuation">(</span>fetchers<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个表示从某个peer开始同步，先调用fetchHeight获取区块头：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">fetchHeight</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Retrieving remote chain height"</span><span class="token punctuation">)</span>

	head<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> p<span class="token punctuation">.</span>peer<span class="token punctuation">.</span><span class="token function">Head</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> p<span class="token punctuation">.</span>peer<span class="token punctuation">.</span><span class="token function">RequestHeadersByHash</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>

	ttl <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">requestTTL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	timeout <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>ttl<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>cancelCh<span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errCancelBlockFetch

		<span class="token keyword">case</span> packet <span class="token operator">:=</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>headerCh<span class="token punctuation">:</span>
			<span class="token keyword">if</span> packet<span class="token punctuation">.</span><span class="token function">PeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> p<span class="token punctuation">.</span>id <span class="token punctuation">&#123;</span>
				log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Received headers from incorrect peer"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> packet<span class="token punctuation">.</span><span class="token function">PeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>
			headers <span class="token operator">:=</span> packet<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>headerPack<span class="token punctuation">)</span><span class="token punctuation">.</span>headers
			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
				p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Multiple headers for single request"</span><span class="token punctuation">,</span> <span class="token string">"headers"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errBadPeer
			<span class="token punctuation">&#125;</span>
			head <span class="token operator">:=</span> headers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
			p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Remote head header identified"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> head<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> head<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> head<span class="token punctuation">,</span> <span class="token boolean">nil</span>

		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>timeout<span class="token punctuation">:</span>
			p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Waiting for head header timed out"</span><span class="token punctuation">,</span> <span class="token string">"elapsed"</span><span class="token punctuation">,</span> ttl<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errTimeout

		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>bodyCh<span class="token punctuation">:</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>receiptCh<span class="token punctuation">:</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里主要就是启动一个goroutine利用RequestHeadersByHash方法去请求区块头，这里的peer是pm的newPeer方法创建的，RequestHeadersByHash就是发送一个GetBlockHeadersMsg消息。由于是在单独线程执行的RequestHeadersByHash，在外面设置了一个定时器，超时的话报错。</p>
<p>另外在回顾pm，在对方收到GetBlockHeadersMsg消息后，会回复BlockHeadersMsg消息，在fetcher过滤完后调用DeliverHeaders方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">DeliverHeaders</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> headers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">deliver</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> d<span class="token punctuation">.</span>headerCh<span class="token punctuation">,</span> <span class="token operator">&amp;</span>headerPack<span class="token punctuation">&#123;</span>id<span class="token punctuation">,</span> headers<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> headerInMeter<span class="token punctuation">,</span> headerDropMeter<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">deliver</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> destCh <span class="token keyword">chan</span> dataPack<span class="token punctuation">,</span> packet dataPack<span class="token punctuation">,</span> inMeter<span class="token punctuation">,</span> dropMeter metrics<span class="token punctuation">.</span>Meter<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	inMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span><span class="token function">Items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			dropMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span><span class="token function">Items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	d<span class="token punctuation">.</span>cancelLock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	cancel <span class="token operator">:=</span> d<span class="token punctuation">.</span>cancelCh
	d<span class="token punctuation">.</span>cancelLock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> cancel <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errNoSyncActive
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> destCh <span class="token operator">&lt;-</span> packet<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>cancel<span class="token punctuation">:</span>
		<span class="token keyword">return</span> errNoSyncActive
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里向destCh也就是headerCh赋值，也就触发fetchHeight中的对应逻辑，从而返回获得的区块头，这个区块头就是该peer的最新的区块。回到syncWithPeer中，又用findAncestor方法去寻找大家的共同祖先以便开始同步。</p>
<p>再往下设置了pivot，这是针对快速同步而言的，在最后64个块，即使是快速同步模式也要使用fullmode模式，这里如果对方高度小于64，则从0开始同步而pivot也为0，否则如果刚才计算的公共祖先在最后64个以内，则从倒数第64个开始同步而且pivot也设为倒数第64个区块高度。另外还设置committed的值，为1时表示快速模式结束。然后调用了queue的prepare方法准备进行同步，prepare主要是配置了偏移量和同步模式以便于调度时寻找正确区块。</p>
<p>接着设置一组fetcher方法分别用于fetch区块头、区块体和收据以及处理区块头，另外根据模式的不同添加不通的方法，最后调用spawnSync</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">spawnSync</span><span class="token punctuation">(</span>fetchers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	errc <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>fetchers<span class="token punctuation">)</span><span class="token punctuation">)</span>
	d<span class="token punctuation">.</span>cancelWg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>fetchers<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> fn <span class="token operator">:=</span> <span class="token keyword">range</span> fetchers <span class="token punctuation">&#123;</span>
		fn <span class="token operator">:=</span> fn
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">defer</span> d<span class="token punctuation">.</span>cancelWg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> errc <span class="token operator">&lt;-</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>fetchers<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>fetchers<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">&#123;</span>

			d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> err <span class="token operator">=</span> <span class="token operator">&lt;-</span>errc<span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	d<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里为fetchers中每个方法都启动一个goroutine去执行，等待结束或出错。我们看一下fetchers中的方法</p>
<h2 id="fetchHeaders"><a href="#fetchHeaders" class="headerlink" title="fetchHeaders"></a>fetchHeaders</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">fetchHeaders</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> from <span class="token builtin">uint64</span><span class="token punctuation">,</span> pivot <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Directing header downloads"</span><span class="token punctuation">,</span> <span class="token string">"origin"</span><span class="token punctuation">,</span> from<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Header download terminated"</span><span class="token punctuation">)</span>

	skeleton <span class="token operator">:=</span> <span class="token boolean">true</span>            <span class="token comment">// Skeleton assembly phase or finishing up</span>
	request <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token comment">// time of the last skeleton fetch request</span>
	timeout <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTimer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// timer to dump a non-responsive active peer</span>
	<span class="token operator">&lt;-</span>timeout<span class="token punctuation">.</span>C                 <span class="token comment">// timeout channel should be initially empty</span>
	<span class="token keyword">defer</span> timeout<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">var</span> ttl time<span class="token punctuation">.</span>Duration
	getHeaders <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>from <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		request <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		ttl <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">requestTTL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		timeout<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>ttl<span class="token punctuation">)</span>

		<span class="token keyword">if</span> skeleton <span class="token punctuation">&#123;</span>
			p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Fetching skeleton headers"</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> MaxHeaderFetch<span class="token punctuation">,</span> <span class="token string">"from"</span><span class="token punctuation">,</span> from<span class="token punctuation">)</span>
			<span class="token keyword">go</span> p<span class="token punctuation">.</span>peer<span class="token punctuation">.</span><span class="token function">RequestHeadersByNumber</span><span class="token punctuation">(</span>from<span class="token operator">+</span><span class="token function">uint64</span><span class="token punctuation">(</span>MaxHeaderFetch<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> MaxSkeletonSize<span class="token punctuation">,</span> MaxHeaderFetch<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Fetching full headers"</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> MaxHeaderFetch<span class="token punctuation">,</span> <span class="token string">"from"</span><span class="token punctuation">,</span> from<span class="token punctuation">)</span>
			<span class="token keyword">go</span> p<span class="token punctuation">.</span>peer<span class="token punctuation">.</span><span class="token function">RequestHeadersByNumber</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span> MaxHeaderFetch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">getHeaders</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>cancelCh<span class="token punctuation">:</span>
			<span class="token keyword">return</span> errCancelHeaderFetch

		<span class="token keyword">case</span> packet <span class="token operator">:=</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>headerCh<span class="token punctuation">:</span>
			<span class="token keyword">if</span> packet<span class="token punctuation">.</span><span class="token function">PeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> p<span class="token punctuation">.</span>id <span class="token punctuation">&#123;</span>
				log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Received skeleton from incorrect peer"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> packet<span class="token punctuation">.</span><span class="token function">PeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>
			headerReqTimer<span class="token punctuation">.</span><span class="token function">UpdateSince</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
			timeout<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

			<span class="token keyword">if</span> packet<span class="token punctuation">.</span><span class="token function">Items</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> skeleton <span class="token punctuation">&#123;</span>
				skeleton <span class="token operator">=</span> <span class="token boolean">false</span>
				<span class="token function">getHeaders</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">&#125;</span>

			<span class="token keyword">if</span> packet<span class="token punctuation">.</span><span class="token function">Items</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">LoadInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>committed<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pivot <span class="token operator">&lt;=</span> from <span class="token punctuation">&#123;</span>
					p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"No headers, waiting for pivot commit"</span><span class="token punctuation">)</span>
					<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>fsHeaderContCheck<span class="token punctuation">)</span><span class="token punctuation">:</span>
						<span class="token function">getHeaders</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span>
						<span class="token keyword">continue</span>
					<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>cancelCh<span class="token punctuation">:</span>
						<span class="token keyword">return</span> errCancelHeaderFetch
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
				p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"No more headers available"</span><span class="token punctuation">)</span>
				<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">case</span> d<span class="token punctuation">.</span>headerProcCh <span class="token operator">&lt;-</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
					<span class="token keyword">return</span> <span class="token boolean">nil</span>
				<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>cancelCh<span class="token punctuation">:</span>
					<span class="token keyword">return</span> errCancelHeaderFetch
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
			headers <span class="token operator">:=</span> packet<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>headerPack<span class="token punctuation">)</span><span class="token punctuation">.</span>headers

			<span class="token keyword">if</span> skeleton <span class="token punctuation">&#123;</span>
				filled<span class="token punctuation">,</span> proced<span class="token punctuation">,</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">fillHeaderSkeleton</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span> headers<span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Skeleton chain invalid"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
					<span class="token keyword">return</span> errInvalidChain
				<span class="token punctuation">&#125;</span>
				headers <span class="token operator">=</span> filled<span class="token punctuation">[</span>proced<span class="token punctuation">:</span><span class="token punctuation">]</span>
				from <span class="token operator">+=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>proced<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> n <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span> n <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
					head <span class="token operator">:=</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
					<span class="token keyword">if</span> d<span class="token punctuation">.</span>mode <span class="token operator">==</span> LightSync <span class="token punctuation">&#123;</span>
						head <span class="token operator">=</span> d<span class="token punctuation">.</span>lightchain<span class="token punctuation">.</span><span class="token function">CurrentHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
						head <span class="token operator">=</span> d<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">CurrentFastBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
						<span class="token keyword">if</span> full <span class="token operator">:=</span> d<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">CurrentBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> head <span class="token operator">&lt;</span> full <span class="token punctuation">&#123;</span>
							head <span class="token operator">=</span> full
						<span class="token punctuation">&#125;</span>
					<span class="token punctuation">&#125;</span>
					<span class="token keyword">if</span> head<span class="token operator">+</span><span class="token function">uint64</span><span class="token punctuation">(</span>reorgProtThreshold<span class="token punctuation">)</span> <span class="token operator">&lt;</span> headers<span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
						delay <span class="token operator">:=</span> reorgProtHeaderDelay
						<span class="token keyword">if</span> delay <span class="token operator">></span> n <span class="token punctuation">&#123;</span>
							delay <span class="token operator">=</span> n
						<span class="token punctuation">&#125;</span>
						headers <span class="token operator">=</span> headers<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token operator">-</span>delay<span class="token punctuation">]</span>
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Scheduling new headers"</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"from"</span><span class="token punctuation">,</span> from<span class="token punctuation">)</span>
				<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">case</span> d<span class="token punctuation">.</span>headerProcCh <span class="token operator">&lt;-</span> headers<span class="token punctuation">:</span>
				<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>cancelCh<span class="token punctuation">:</span>
					<span class="token keyword">return</span> errCancelHeaderFetch
				<span class="token punctuation">&#125;</span>
				from <span class="token operator">+=</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token function">getHeaders</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
				p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"All headers delayed, waiting"</span><span class="token punctuation">)</span>
				<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>fsHeaderContCheck<span class="token punctuation">)</span><span class="token punctuation">:</span>
					<span class="token function">getHeaders</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span>
					<span class="token keyword">continue</span>
				<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>cancelCh<span class="token punctuation">:</span>
					<span class="token keyword">return</span> errCancelHeaderFetch
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>

		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>timeout<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
			<span class="token keyword">if</span> d<span class="token punctuation">.</span>dropPeer <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Downloader wants to drop peer, but peerdrop-function is not set"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>
			p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Header request timed out"</span><span class="token punctuation">,</span> <span class="token string">"elapsed"</span><span class="token punctuation">,</span> ttl<span class="token punctuation">)</span>
			headerTimeoutMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			d<span class="token punctuation">.</span><span class="token function">dropPeer</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">)</span>

			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ch <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">&#123;</span>d<span class="token punctuation">.</span>bodyWakeCh<span class="token punctuation">,</span> d<span class="token punctuation">.</span>receiptWakeCh<span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">case</span> ch <span class="token operator">&lt;-</span> <span class="token boolean">false</span><span class="token punctuation">:</span>
				<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>cancelCh<span class="token punctuation">:</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> d<span class="token punctuation">.</span>headerProcCh <span class="token operator">&lt;-</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>cancelCh<span class="token punctuation">:</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">return</span> errBadPeer
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法比较长，基本上分了两部分首先定义了一个getHeaders方法，用于从对应的peer获取一定数量的head，指定起始位置之后，根据是否是骨架模式来决定下载哪些head。如果是骨架模式，则从from+191开始获取128个head，每两个head之间间隔191个区块，这样构成一个断续的框架。如果不是骨架模式，则从from开始连续请求192个区块。请求方法都是peer的RequestHeadersByNumber方法，发送了GetBlockHeadersMsg消息，这个我们前面分析过，会触发接下来的for-select结构的headerCh逻辑。</p>
<p>在对应case中，首先验证了是否来自对应的peer，判断返回的head数，如果为0且是骨架模式，则禁用骨架模式，再次调用getHeaders请求head。如果再一次获取的head数量还是0，且仍处于快速模式并且没有进入最后64个区块，则等待3秒后继续刚才的连续请求知道接收到取消信号；如果获取的head数量还是0但不处于快速模式，表示已经同步完毕，给headerProcCh赋值并退出，headerProcCh影响processHeaders里的逻辑。</p>
<p>对于收到的区块头数量不为0的话，根据不同模式进行不同处理。</p>
<p>如果是骨架模式，则调用fillHeaderSkeleton去填充那个框架，这个方法里先调用ScheduleSkeleton进行调用，然后调用了fetchParts方法，这个稍后再讲。</p>
<p>如果不是骨架模式，表示我们从from开始连续请求了192个head，这里根据具体情况延迟最后几个区块头。总之这个if-else结构确定了下一步fetch的head集合。然后将该集合内的head赋值给headerProcCh触发processHeaders中对应逻辑，并更新from的值再次调用getHeaders去请求下一批head，直到没有head可取，等待3秒再次尝试。</p>
<h2 id="fetchBodies"><a href="#fetchBodies" class="headerlink" title="fetchBodies"></a>fetchBodies</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">fetchBodies</span><span class="token punctuation">(</span>from <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Downloading block bodies"</span><span class="token punctuation">,</span> <span class="token string">"origin"</span><span class="token punctuation">,</span> from<span class="token punctuation">)</span>

	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		deliver <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>packet dataPack<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			pack <span class="token operator">:=</span> packet<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>bodyPack<span class="token punctuation">)</span>
			<span class="token keyword">return</span> d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">DeliverBodies</span><span class="token punctuation">(</span>pack<span class="token punctuation">.</span>peerID<span class="token punctuation">,</span> pack<span class="token punctuation">.</span>transactions<span class="token punctuation">,</span> pack<span class="token punctuation">.</span>uncles<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		expire   <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">ExpireBodies</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">requestTTL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
		fetch    <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> req <span class="token operator">*</span>fetchRequest<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">FetchBodies</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
		capacity <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">BlockCapacity</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">requestRTT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
		setIdle  <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> accepted <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> p<span class="token punctuation">.</span><span class="token function">SetBodiesIdle</span><span class="token punctuation">(</span>accepted<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
	<span class="token punctuation">)</span>
	err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">fetchParts</span><span class="token punctuation">(</span>errCancelBodyFetch<span class="token punctuation">,</span> d<span class="token punctuation">.</span>bodyCh<span class="token punctuation">,</span> deliver<span class="token punctuation">,</span> d<span class="token punctuation">.</span>bodyWakeCh<span class="token punctuation">,</span> expire<span class="token punctuation">,</span>
		d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>PendingBlocks<span class="token punctuation">,</span> d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>InFlightBlocks<span class="token punctuation">,</span> d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>ShouldThrottleBlocks<span class="token punctuation">,</span> d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>ReserveBodies<span class="token punctuation">,</span>
		d<span class="token punctuation">.</span>bodyFetchHook<span class="token punctuation">,</span> fetch<span class="token punctuation">,</span> d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>CancelBodies<span class="token punctuation">,</span> capacity<span class="token punctuation">,</span> d<span class="token punctuation">.</span>peers<span class="token punctuation">.</span>BodyIdlePeers<span class="token punctuation">,</span> setIdle<span class="token punctuation">,</span> <span class="token string">"bodies"</span><span class="token punctuation">)</span>

	log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Block body download terminated"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>相比fetchHeaders，fetchBodies就简单很多，就是直接调用fetchParts，关于fetchParts稍后再分析</p>
<h2 id="fetchReceipts"><a href="#fetchReceipts" class="headerlink" title="fetchReceipts"></a>fetchReceipts</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">fetchReceipts</span><span class="token punctuation">(</span>from <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Downloading transaction receipts"</span><span class="token punctuation">,</span> <span class="token string">"origin"</span><span class="token punctuation">,</span> from<span class="token punctuation">)</span>

	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		deliver <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>packet dataPack<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			pack <span class="token operator">:=</span> packet<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>receiptPack<span class="token punctuation">)</span>
			<span class="token keyword">return</span> d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">DeliverReceipts</span><span class="token punctuation">(</span>pack<span class="token punctuation">.</span>peerID<span class="token punctuation">,</span> pack<span class="token punctuation">.</span>receipts<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		expire   <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">ExpireReceipts</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">requestTTL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
		fetch    <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> req <span class="token operator">*</span>fetchRequest<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">FetchReceipts</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
		capacity <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">ReceiptCapacity</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">requestRTT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
		setIdle  <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> accepted <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> p<span class="token punctuation">.</span><span class="token function">SetReceiptsIdle</span><span class="token punctuation">(</span>accepted<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
	<span class="token punctuation">)</span>
	err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">fetchParts</span><span class="token punctuation">(</span>errCancelReceiptFetch<span class="token punctuation">,</span> d<span class="token punctuation">.</span>receiptCh<span class="token punctuation">,</span> deliver<span class="token punctuation">,</span> d<span class="token punctuation">.</span>receiptWakeCh<span class="token punctuation">,</span> expire<span class="token punctuation">,</span>
		d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>PendingReceipts<span class="token punctuation">,</span> d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>InFlightReceipts<span class="token punctuation">,</span> d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>ShouldThrottleReceipts<span class="token punctuation">,</span> d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>ReserveReceipts<span class="token punctuation">,</span>
		d<span class="token punctuation">.</span>receiptFetchHook<span class="token punctuation">,</span> fetch<span class="token punctuation">,</span> d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span>CancelReceipts<span class="token punctuation">,</span> capacity<span class="token punctuation">,</span> d<span class="token punctuation">.</span>peers<span class="token punctuation">.</span>ReceiptIdlePeers<span class="token punctuation">,</span> setIdle<span class="token punctuation">,</span> <span class="token string">"receipts"</span><span class="token punctuation">)</span>

	log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Transaction receipt download terminated"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>和fetchBodies一样，都是直接调用fetchParts</p>
<h2 id="processHeaders"><a href="#processHeaders" class="headerlink" title="processHeaders"></a>processHeaders</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">processHeaders</span><span class="token punctuation">(</span>origin <span class="token builtin">uint64</span><span class="token punctuation">,</span> pivot <span class="token builtin">uint64</span><span class="token punctuation">,</span> td <span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	rollback <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>rollback<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			hashes <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rollback<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">for</span> i<span class="token punctuation">,</span> header <span class="token operator">:=</span> <span class="token keyword">range</span> rollback <span class="token punctuation">&#123;</span>
				hashes<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			lastHeader<span class="token punctuation">,</span> lastFastBlock<span class="token punctuation">,</span> lastBlock <span class="token operator">:=</span> d<span class="token punctuation">.</span>lightchain<span class="token punctuation">.</span><span class="token function">CurrentHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Number<span class="token punctuation">,</span> common<span class="token punctuation">.</span>Big0<span class="token punctuation">,</span> common<span class="token punctuation">.</span>Big0
			<span class="token keyword">if</span> d<span class="token punctuation">.</span>mode <span class="token operator">!=</span> LightSync <span class="token punctuation">&#123;</span>
				lastFastBlock <span class="token operator">=</span> d<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">CurrentFastBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				lastBlock <span class="token operator">=</span> d<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">CurrentBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			d<span class="token punctuation">.</span>lightchain<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span>hashes<span class="token punctuation">)</span>
			curFastBlock<span class="token punctuation">,</span> curBlock <span class="token operator">:=</span> common<span class="token punctuation">.</span>Big0<span class="token punctuation">,</span> common<span class="token punctuation">.</span>Big0
			<span class="token keyword">if</span> d<span class="token punctuation">.</span>mode <span class="token operator">!=</span> LightSync <span class="token punctuation">&#123;</span>
				curFastBlock <span class="token operator">=</span> d<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">CurrentFastBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				curBlock <span class="token operator">=</span> d<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">CurrentBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Rolled back headers"</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>hashes<span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token string">"header"</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%d->%d"</span><span class="token punctuation">,</span> lastHeader<span class="token punctuation">,</span> d<span class="token punctuation">.</span>lightchain<span class="token punctuation">.</span><span class="token function">CurrentHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Number<span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token string">"fast"</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%d->%d"</span><span class="token punctuation">,</span> lastFastBlock<span class="token punctuation">,</span> curFastBlock<span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token string">"block"</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%d->%d"</span><span class="token punctuation">,</span> lastBlock<span class="token punctuation">,</span> curBlock<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	gotHeaders <span class="token operator">:=</span> <span class="token boolean">false</span>

	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>cancelCh<span class="token punctuation">:</span>
			<span class="token keyword">return</span> errCancelHeaderProcessing

		<span class="token keyword">case</span> headers <span class="token operator">:=</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>headerProcCh<span class="token punctuation">:</span>
			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ch <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">&#123;</span>d<span class="token punctuation">.</span>bodyWakeCh<span class="token punctuation">,</span> d<span class="token punctuation">.</span>receiptWakeCh<span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">case</span> ch <span class="token operator">&lt;-</span> <span class="token boolean">false</span><span class="token punctuation">:</span>
					<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>cancelCh<span class="token punctuation">:</span>
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">if</span> d<span class="token punctuation">.</span>mode <span class="token operator">!=</span> LightSync <span class="token punctuation">&#123;</span>
					head <span class="token operator">:=</span> d<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">CurrentBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token keyword">if</span> <span class="token operator">!</span>gotHeaders <span class="token operator">&amp;&amp;</span> td<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">GetTd</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> head<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
						<span class="token keyword">return</span> errStallingPeer
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">if</span> d<span class="token punctuation">.</span>mode <span class="token operator">==</span> FastSync <span class="token operator">||</span> d<span class="token punctuation">.</span>mode <span class="token operator">==</span> LightSync <span class="token punctuation">&#123;</span>
					head <span class="token operator">:=</span> d<span class="token punctuation">.</span>lightchain<span class="token punctuation">.</span><span class="token function">CurrentHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token keyword">if</span> td<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>lightchain<span class="token punctuation">.</span><span class="token function">GetTd</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> head<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
						<span class="token keyword">return</span> errStallingPeer
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
				rollback <span class="token operator">=</span> <span class="token boolean">nil</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span>
			<span class="token punctuation">&#125;</span>
			gotHeaders <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token keyword">for</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>cancelCh<span class="token punctuation">:</span>
					<span class="token keyword">return</span> errCancelHeaderProcessing
				<span class="token keyword">default</span><span class="token punctuation">:</span>
				<span class="token punctuation">&#125;</span>
				limit <span class="token operator">:=</span> maxHeadersProcess
				<span class="token keyword">if</span> limit <span class="token operator">></span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					limit <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
				chunk <span class="token operator">:=</span> headers<span class="token punctuation">[</span><span class="token punctuation">:</span>limit<span class="token punctuation">]</span>

				<span class="token keyword">if</span> d<span class="token punctuation">.</span>mode <span class="token operator">==</span> FastSync <span class="token operator">||</span> d<span class="token punctuation">.</span>mode <span class="token operator">==</span> LightSync <span class="token punctuation">&#123;</span>
					unknown <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> header <span class="token operator">:=</span> <span class="token keyword">range</span> chunk <span class="token punctuation">&#123;</span>
						<span class="token keyword">if</span> <span class="token operator">!</span>d<span class="token punctuation">.</span>lightchain<span class="token punctuation">.</span><span class="token function">HasHeader</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
							unknown <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>unknown<span class="token punctuation">,</span> header<span class="token punctuation">)</span>
						<span class="token punctuation">&#125;</span>
					<span class="token punctuation">&#125;</span>
					frequency <span class="token operator">:=</span> fsHeaderCheckFrequency
					<span class="token keyword">if</span> chunk<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">uint64</span><span class="token punctuation">(</span>fsHeaderForceVerify<span class="token punctuation">)</span> <span class="token operator">></span> pivot <span class="token punctuation">&#123;</span>
						frequency <span class="token operator">=</span> <span class="token number">1</span>
					<span class="token punctuation">&#125;</span>
					<span class="token keyword">if</span> n<span class="token punctuation">,</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span>lightchain<span class="token punctuation">.</span><span class="token function">InsertHeaderChain</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> frequency<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
						<span class="token keyword">if</span> n <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
							rollback <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>rollback<span class="token punctuation">,</span> chunk<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
						<span class="token punctuation">&#125;</span>
						log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Invalid header encountered"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> chunk<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>Number<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> chunk<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
						<span class="token keyword">return</span> errInvalidChain
					<span class="token punctuation">&#125;</span>
					rollback <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>rollback<span class="token punctuation">,</span> unknown<span class="token operator">...</span><span class="token punctuation">)</span>
					<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>rollback<span class="token punctuation">)</span> <span class="token operator">></span> fsHeaderSafetyNet <span class="token punctuation">&#123;</span>
						rollback <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>rollback<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rollback<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>rollback<span class="token punctuation">)</span><span class="token operator">-</span>fsHeaderSafetyNet<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">if</span> d<span class="token punctuation">.</span>mode <span class="token operator">==</span> FullSync <span class="token operator">||</span> d<span class="token punctuation">.</span>mode <span class="token operator">==</span> FastSync <span class="token punctuation">&#123;</span>
					<span class="token keyword">for</span> d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">PendingBlocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> maxQueuedHeaders <span class="token operator">||</span> d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">PendingReceipts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> maxQueuedHeaders <span class="token punctuation">&#123;</span>
						<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
						<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>cancelCh<span class="token punctuation">:</span>
							<span class="token keyword">return</span> errCancelHeaderProcessing
						<span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">:</span>
						<span class="token punctuation">&#125;</span>
					<span class="token punctuation">&#125;</span>
					inserts <span class="token operator">:=</span> d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Schedule</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> origin<span class="token punctuation">)</span>
					<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>inserts<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
						log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Stale headers"</span><span class="token punctuation">)</span>
						<span class="token keyword">return</span> errBadPeer
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
				headers <span class="token operator">=</span> headers<span class="token punctuation">[</span>limit<span class="token punctuation">:</span><span class="token punctuation">]</span>
				origin <span class="token operator">+=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			d<span class="token punctuation">.</span>syncStatsLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> d<span class="token punctuation">.</span>syncStatsChainHeight <span class="token operator">&lt;</span> origin <span class="token punctuation">&#123;</span>
				d<span class="token punctuation">.</span>syncStatsChainHeight <span class="token operator">=</span> origin <span class="token operator">-</span> <span class="token number">1</span>
			<span class="token punctuation">&#125;</span>
			d<span class="token punctuation">.</span>syncStatsLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ch <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">&#123;</span>d<span class="token punctuation">.</span>bodyWakeCh<span class="token punctuation">,</span> d<span class="token punctuation">.</span>receiptWakeCh<span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">case</span> ch <span class="token operator">&lt;-</span> <span class="token boolean">true</span><span class="token punctuation">:</span>
				<span class="token keyword">default</span><span class="token punctuation">:</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是固定的一组fetchers中的最后一个启动的方法，用于处理收到了head。</p>
<p>首先定义了一个defer执行的方法用于在出错时回滚。接着还是一个无限循环加select的结构，还记得前面fetchHeaders方法最后将一组head赋值给headerProcCh了么，就在这里触发了响应逻辑。</p>
<p>首先处理的传来的head数量为0的情况，为0的情况是在fetchHeaders中fetch区块头结束后给headerProcCh传了nil导致的，此时给bodyWakeCh和receiptWakeCh都传了false。接着判断了如果对方此时总难度还比我们大，但是我们却取不到什么东西则返回一个错误</p>
<p>对于传来的head数量不为0时，先判断数量是否大于2048，否则进行截断，先处理前2048个。接着对于同步模式是FastSync或者LightSync的情况，先遍历了传来的head在本地是否已有，没有的存入unknown中。接着定义了frequency，原始值为100，但是如果是最后64个则为1，这个值表示在插入时每隔多少个区块验证一次，最后64个区块需要全部验证，其余的每100个验证一次。然后调用InsertHeaderChain进行插入，这是core/blockchain.go中的方法，返回的n表示实在第几个区块出错的，最后如果有错则将chunk[:n]添加到rollback便于回滚，目的是一旦出错则回滚所有内容。如果没错也将刚才unknown的内容添加到rollback，如果回滚的总量大于2048，只取最后2048个区块。</p>
<p>再往下如果是FullSync或FastSync模式，先判断queue的PendingBlocks或PendingReceipts数量是否大于规定，是的话先等待1秒，反复循环直到其数量满足要求。然后调用了Schedule申请调度，接下来修改headers和origin循环处理剩余的head。</p>
<p>最后给通道d.bodyWakeCh, d.receiptWakeCh发送消息，触发对应逻辑。</p>
<h2 id="fetchParts"><a href="#fetchParts" class="headerlink" title="fetchParts"></a>fetchParts</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// The instrumentation parameters:</span>
<span class="token comment">//  - errCancel:   fetch操作被取消时返回的错误类型</span>
<span class="token comment">//  - deliveryCh:  检索下载数据包的通道</span>
<span class="token comment">//  - deliver:     将数据包传递到特定队列的回调函数</span>
<span class="token comment">//  - wakeCh:      当心的任务到来时唤醒fetch</span>
<span class="token comment">//  - expire:      因为超时而终止的回调</span>
<span class="token comment">//  - pending:     还需要下载的任务数量</span>
<span class="token comment">//  - inFlight:    正在处理的请求数量</span>
<span class="token comment">//  - throttle:    用于检测某个队列是否已满</span>
<span class="token comment">//  - reserve:     用来将新的下载任务保留给特定的peer</span>
<span class="token comment">//  - fetchHook:   用于通知正在启动新的任务</span>
<span class="token comment">//  - fetch:       发送网络请求</span>
<span class="token comment">//  - cancel:      取消正在请求的下载</span>
<span class="token comment">//  - capacity:    获取网络带宽</span>
<span class="token comment">//  - idle:        检测peer是否空闲</span>
<span class="token comment">//  - setIdle:     设置peer为空闲</span>
<span class="token comment">//  - kind:        正在下载的类型</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">fetchParts</span><span class="token punctuation">(</span>errCancel <span class="token builtin">error</span><span class="token punctuation">,</span> deliveryCh <span class="token keyword">chan</span> dataPack<span class="token punctuation">,</span> deliver <span class="token keyword">func</span><span class="token punctuation">(</span>dataPack<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wakeCh <span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span>
	expire <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> pending <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span><span class="token punctuation">,</span> inFlight <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> throttle <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> reserve <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>fetchRequest<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	fetchHook <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span><span class="token punctuation">,</span> fetch <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> <span class="token operator">*</span>fetchRequest<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">,</span> cancel <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>fetchRequest<span class="token punctuation">)</span><span class="token punctuation">,</span> capacity <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>peerConnection<span class="token punctuation">)</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
	idle <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> setIdle <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kind <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>

	ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	update <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

	finished <span class="token operator">:=</span> <span class="token boolean">false</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>cancelCh<span class="token punctuation">:</span>
			<span class="token keyword">return</span> errCancel

		<span class="token keyword">case</span> packet <span class="token operator">:=</span> <span class="token operator">&lt;-</span>deliveryCh<span class="token punctuation">:</span>
			<span class="token keyword">if</span> peer <span class="token operator">:=</span> d<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">Peer</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span><span class="token function">PeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> peer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				accepted<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">deliver</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">==</span> errInvalidChain <span class="token punctuation">&#123;</span>
					<span class="token keyword">return</span> err
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">if</span> err <span class="token operator">!=</span> errStaleDelivery <span class="token punctuation">&#123;</span>
					<span class="token function">setIdle</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> accepted<span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">switch</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">case</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> packet<span class="token punctuation">.</span><span class="token function">Items</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
					peer<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Requested data not delivered"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">,</span> kind<span class="token punctuation">)</span>
				<span class="token keyword">case</span> err <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
					peer<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Delivered new batch of data"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">,</span> kind<span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> packet<span class="token punctuation">.</span><span class="token function">Stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">default</span><span class="token punctuation">:</span>
					peer<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Failed to deliver retrieved data"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">,</span> kind<span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>

			<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> update <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">:</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token punctuation">&#125;</span>

		<span class="token keyword">case</span> cont <span class="token operator">:=</span> <span class="token operator">&lt;-</span>wakeCh<span class="token punctuation">:</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>cont <span class="token punctuation">&#123;</span>
				finished <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> update <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">:</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token punctuation">&#125;</span>

		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
			<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> update <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">:</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token punctuation">&#125;</span>

		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>update<span class="token punctuation">:</span>

			<span class="token keyword">if</span> d<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> errNoPeers
			<span class="token punctuation">&#125;</span>

			<span class="token keyword">for</span> pid<span class="token punctuation">,</span> fails <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">expire</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> peer <span class="token operator">:=</span> d<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">Peer</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span> peer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">if</span> fails <span class="token operator">></span> <span class="token number">2</span> <span class="token punctuation">&#123;</span>
						peer<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Data delivery timed out"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">,</span> kind<span class="token punctuation">)</span>
						<span class="token function">setIdle</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
					<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
						peer<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Stalling delivery, dropping"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">,</span> kind<span class="token punctuation">)</span>
						<span class="token keyword">if</span> d<span class="token punctuation">.</span>dropPeer <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
							peer<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Downloader wants to drop peer, but peerdrop-function is not set"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span>
						<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
							d<span class="token punctuation">.</span><span class="token function">dropPeer</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span>
						<span class="token punctuation">&#125;</span>
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>

			<span class="token keyword">if</span> <span class="token function">pending</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">inFlight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> finished <span class="token punctuation">&#123;</span>
					log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Data fetching completed"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">,</span> kind<span class="token punctuation">)</span>
					<span class="token keyword">return</span> <span class="token boolean">nil</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>

			progressed<span class="token punctuation">,</span> throttled<span class="token punctuation">,</span> running <span class="token operator">:=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token function">inFlight</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			idles<span class="token punctuation">,</span> total <span class="token operator">:=</span> <span class="token function">idle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> peer <span class="token operator">:=</span> <span class="token keyword">range</span> idles <span class="token punctuation">&#123;</span>

				<span class="token keyword">if</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					throttled <span class="token operator">=</span> <span class="token boolean">true</span>
					<span class="token keyword">break</span>
				<span class="token punctuation">&#125;</span>

				<span class="token keyword">if</span> <span class="token function">pending</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">break</span>
				<span class="token punctuation">&#125;</span>

				request<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">reserve</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> <span class="token function">capacity</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">return</span> err
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">if</span> progress <span class="token punctuation">&#123;</span>
					progressed <span class="token operator">=</span> <span class="token boolean">true</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">if</span> request <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">continue</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">if</span> request<span class="token punctuation">.</span>From <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
					peer<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Requesting new batch of data"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">,</span> kind<span class="token punctuation">,</span> <span class="token string">"from"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>From<span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
					peer<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Requesting new batch of data"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">,</span> kind<span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>Headers<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"from"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>Headers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Number<span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">if</span> fetchHook <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					<span class="token function">fetchHook</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>Headers<span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">fetch</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%v: %s fetch assignment failed"</span><span class="token punctuation">,</span> peer<span class="token punctuation">,</span> kind<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
				running <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token punctuation">&#125;</span>

			<span class="token keyword">if</span> <span class="token operator">!</span>progressed <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>throttled <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>running <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>idles<span class="token punctuation">)</span> <span class="token operator">==</span> total <span class="token operator">&amp;&amp;</span> <span class="token function">pending</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> errPeersUnavailable
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法在前面多次出现，这里详细分析一下。首先这个方法的参数非常多，大致功能在方法前的注释部分已经写了，可以简单参考一下。</p>
<p>首先设置了一个ticker，每100毫秒触发一次，触发时向update写入内容，触发相应逻辑：首先判断peer数量是否为0，然后调用expire方法获取那些因为超时而终止的请求，expire根据传入的参数有不同的方法，但都属于queue的ExpireXxx其中之一，最后返回的是一个map，保存着每个peer超时的请求的head数量。回到fetchParts中，遍历这个map，如果对应peer失效的head数大于2，者将其设为idle状态。否则调用pm的removePeer方法将该peer移除。</p>
<p>处理完超时的请求后，调用了pending方法，这个方法主要就是返回queue中headerTaskQueue、blockTaskQueue和receiptTaskQueue这几个队列其中某个的大小，这些队列存储着调度任务。如果对应队列为空的话，调用了inFlight方法，对应的是queue中headerPendPool、blockPendPool和receiptPendPool这几个请求等待池中对应的那个池是否为空，如果不为空但是finished为true表示完成则退出，否则表示暂时没有任务，进行下次循环等待逻辑触发。</p>
<p>接下来设置了几个标志位，然后通过idle方法获取了对应状态空闲的peer。之后遍历这些空闲的peer。下面调用了throttle方法，分别对应queue中的ShouldThrottleBlocks和ShouldThrottleReceipts，在fillHeaderSkeleton中调用fetchParts该方法时直接返回false。ShouldThrottleBlocks和ShouldThrottleReceipts分别返回对应下载任务是否需要限流。如果需要则停止本次操作，等待下一次。否则如果没有等待的任务则也停止本次操作。</p>
<p>再往下调用了reserve，对应的是queue的ReserveHeaders、ReserveBodies和ReserveReceipts方法。传入的参数是相应的peer的HeaderCapacity、BlockCapacity或ReceiptCapacity返回的结果。关于ReserveXxx后面会详细介绍，这里简单说一下作用。对于ReserveHeaders，是构造一个请求，请求中包含了起始位置，让后将请求放入headerPendPool并返回这个请求，headerPendPool存储了等待下载的请求。对于ReserveBodies和ReserveReceipts则是将对应的taskQueue的head进行分类，并构造请求结果放入resultCache中，之后将要跳过的head重新放入taskQueue，最后构建一个请求包含剩余的head，并将该请求放入对应的pendPool，最后返回该请求以及处理状态progress。其中的taskQueue是在调用Schedule时放入的，这里取出准备进行请求。</p>
<p>回到fetchParts中，经过reserve方法后，返回了构造的请求。进行了简单的判断后，调用了fetch方法去处理请求。分别对应peer的FetchHeaders、FetchBodies和FetchReceipts。这几个方法就是根据请求的内容实际调用peer的Request去发送请求。</p>
<p>这样一个idle状态的peer处理完毕，后面会遍历所有idle状态的peer执行相同逻辑。</p>
<p>除了update对应的逻辑，还有deliveryCh对应的逻辑。回顾pm的handleMsg逻辑，在收到BlockHeadersMsg、BlockBodiesMsg和ReceiptsMsg消息后，这几个消息对应前面FetchHeaders、FetchBodies和FetchReceipts发送的请求消息的回应，也就是在收到响应后，会调用downloader的相应DeliverXxx方法，之后调用deliver方法，这个方法的主要作用是向headerCh、bodyCh和receiptCh某一个发送收到的包，headerCh、bodyCh和receiptCh这三个channel分别在调用fetchParts时被传入deliveryCh参数，所以收到响应后触发了deliveryCh对应的逻辑。</p>
<p>在这里面，首先调用了deliver方法，这个分别对应queue的DeliverHeaders、DeliverBodies和DeliverReceipts方法。这几个方法后面会详细介绍，这里简单说一下作用。对于DeliverHeaders方法主要是检查收到的heads是否正确，不正确的话将其重新放回headerTaskQueue等待后续处理。正确的话将准备好的head传入headerProcCh触发processHeaders中逻辑并返回收到的head数量。对于DeliverBodies和DeliverReceipts，主要是对收到的数据进行检查，成功的补全fetchResult，不成功放入taskQueue重新请求。最后返回成功接收的数量，然后将对应peer设为空闲，最后打印log。</p>
<h2 id="processFastSyncContent"><a href="#processFastSyncContent" class="headerlink" title="processFastSyncContent"></a>processFastSyncContent</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">processFastSyncContent</span><span class="token punctuation">(</span>latest <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	stateSync <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">syncState</span><span class="token punctuation">(</span>latest<span class="token punctuation">.</span>Root<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> stateSync<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> stateSync<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> errCancelStateFetch <span class="token punctuation">&#123;</span>
			d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// wake up Results</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	pivot <span class="token operator">:=</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> height <span class="token operator">:=</span> latest<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> height <span class="token operator">></span> <span class="token function">uint64</span><span class="token punctuation">(</span>fsMinFullBlocks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		pivot <span class="token operator">=</span> height <span class="token operator">-</span> <span class="token function">uint64</span><span class="token punctuation">(</span>fsMinFullBlocks<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		oldPivot <span class="token operator">*</span>fetchResult   <span class="token comment">// Locked in pivot block, might change eventually</span>
		oldTail  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>fetchResult <span class="token comment">// Downloaded content after the pivot</span>
	<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		results <span class="token operator">:=</span> d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Results</span><span class="token punctuation">(</span>oldPivot <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token comment">// Block if we're not monitoring pivot staleness</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> oldPivot <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> stateSync<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>cancelCh<span class="token punctuation">:</span>
				<span class="token keyword">return</span> stateSync<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> d<span class="token punctuation">.</span>chainInsertHook <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			d<span class="token punctuation">.</span><span class="token function">chainInsertHook</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> oldPivot <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			results <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>fetchResult<span class="token punctuation">&#123;</span>oldPivot<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> oldTail<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> results<span class="token operator">...</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">LoadInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>committed<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			latest <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Header
			<span class="token keyword">if</span> height <span class="token operator">:=</span> latest<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> height <span class="token operator">></span> pivot<span class="token operator">+</span><span class="token number">2</span><span class="token operator">*</span><span class="token function">uint64</span><span class="token punctuation">(</span>fsMinFullBlocks<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Pivot became stale, moving"</span><span class="token punctuation">,</span> <span class="token string">"old"</span><span class="token punctuation">,</span> pivot<span class="token punctuation">,</span> <span class="token string">"new"</span><span class="token punctuation">,</span> height<span class="token operator">-</span><span class="token function">uint64</span><span class="token punctuation">(</span>fsMinFullBlocks<span class="token punctuation">)</span><span class="token punctuation">)</span>
				pivot <span class="token operator">=</span> height <span class="token operator">-</span> <span class="token function">uint64</span><span class="token punctuation">(</span>fsMinFullBlocks<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		P<span class="token punctuation">,</span> beforeP<span class="token punctuation">,</span> afterP <span class="token operator">:=</span> <span class="token function">splitAroundPivot</span><span class="token punctuation">(</span>pivot<span class="token punctuation">,</span> results<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">commitFastSyncData</span><span class="token punctuation">(</span>beforeP<span class="token punctuation">,</span> stateSync<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> P <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> oldPivot <span class="token operator">!=</span> P <span class="token punctuation">&#123;</span>
				stateSync<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

				stateSync <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">syncState</span><span class="token punctuation">(</span>P<span class="token punctuation">.</span>Header<span class="token punctuation">.</span>Root<span class="token punctuation">)</span>
				<span class="token keyword">defer</span> stateSync<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">if</span> err <span class="token operator">:=</span> stateSync<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> errCancelStateFetch <span class="token punctuation">&#123;</span>
						d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// wake up Results</span>
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				oldPivot <span class="token operator">=</span> P
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>stateSync<span class="token punctuation">.</span>done<span class="token punctuation">:</span>
				<span class="token keyword">if</span> stateSync<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">return</span> stateSync<span class="token punctuation">.</span>err
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">if</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">commitPivotBlock</span><span class="token punctuation">(</span>P<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">return</span> err
				<span class="token punctuation">&#125;</span>
				oldPivot <span class="token operator">=</span> <span class="token boolean">nil</span>

			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">:</span>
				oldTail <span class="token operator">=</span> afterP
				<span class="token keyword">continue</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">importBlockResults</span><span class="token punctuation">(</span>afterP<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是fast模式特有的方法，也是整个快速同步过程中的最后一步。首先调用syncState，这个方法后面会分析，syncState启动后开始同步状态树。与此同时processFastSyncContent中计算了pivot，这个值和前面syncWithPeer中的pivot类似。随后启动了一个死循环，循环中先调用Results方法，Results主要取出已经处理完成的块。然后将这些块根据pivot的值分为3部分（使用splitAroundPivot）：pivot之前的、pivot之后的和pivot位置上的。然后将之前的直接插入区块链（使用commitFastSyncData方法），对于之后的虽然也要插入区块链，但是不直接插入收据数据。</p>
<h2 id="processFullSyncContent"><a href="#processFullSyncContent" class="headerlink" title="processFullSyncContent"></a>processFullSyncContent</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">processFullSyncContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		results <span class="token operator">:=</span> d<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Results</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> d<span class="token punctuation">.</span>chainInsertHook <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			d<span class="token punctuation">.</span><span class="token function">chainInsertHook</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">importBlockResults</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个是full模式下的最后一步，首先还是调用Results获取已经处理完毕的块，然后调用importBlockResults方法插入区块链，和processFastSyncContent中处理pivot点之后的区块一样，不直接插入下载的收据，详细插入过程在BlockChain源码部分分析。</p>
<p>processFullSyncContent与processFastSyncContent也就集中体现了两种同步方式的区别</p>
<h2 id="DeliverXxx"><a href="#DeliverXxx" class="headerlink" title="DeliverXxx"></a>DeliverXxx</h2><p>是一组方法，一共有四个DeliverHeaders、DeliverBodies、DeliverReceipts和DeliverNodeData，前三个在queue中有同名方法，但作用不同。这几个方法主要用在pm中，用于在收到对应响应时执行对应逻辑</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">DeliverHeaders</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> headers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">deliver</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> d<span class="token punctuation">.</span>headerCh<span class="token punctuation">,</span> <span class="token operator">&amp;</span>headerPack<span class="token punctuation">&#123;</span>id<span class="token punctuation">,</span> headers<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> headerInMeter<span class="token punctuation">,</span> headerDropMeter<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">DeliverBodies</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> transactions <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> uncles <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">deliver</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> d<span class="token punctuation">.</span>bodyCh<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bodyPack<span class="token punctuation">&#123;</span>id<span class="token punctuation">,</span> transactions<span class="token punctuation">,</span> uncles<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> bodyInMeter<span class="token punctuation">,</span> bodyDropMeter<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">DeliverReceipts</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> receipts <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Receipt<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">deliver</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> d<span class="token punctuation">.</span>receiptCh<span class="token punctuation">,</span> <span class="token operator">&amp;</span>receiptPack<span class="token punctuation">&#123;</span>id<span class="token punctuation">,</span> receipts<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> receiptInMeter<span class="token punctuation">,</span> receiptDropMeter<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">DeliverNodeData</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">deliver</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> d<span class="token punctuation">.</span>stateCh<span class="token punctuation">,</span> <span class="token operator">&amp;</span>statePack<span class="token punctuation">&#123;</span>id<span class="token punctuation">,</span> data<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> stateInMeter<span class="token punctuation">,</span> stateDropMeter<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>都只是调用了deliver方法，区别在于传入的数据和触发异步逻辑的channel</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">deliver</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> destCh <span class="token keyword">chan</span> dataPack<span class="token punctuation">,</span> packet dataPack<span class="token punctuation">,</span> inMeter<span class="token punctuation">,</span> dropMeter metrics<span class="token punctuation">.</span>Meter<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	inMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span><span class="token function">Items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			dropMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span><span class="token function">Items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	d<span class="token punctuation">.</span>cancelLock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	cancel <span class="token operator">:=</span> d<span class="token punctuation">.</span>cancelCh
	d<span class="token punctuation">.</span>cancelLock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> cancel <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errNoSyncActive
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> destCh <span class="token operator">&lt;-</span> packet<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>cancel<span class="token punctuation">:</span>
		<span class="token keyword">return</span> errNoSyncActive
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>没有什么实际动作，关键是将收到的数据传给destCh触发后续逻辑，对于前三个方法都是触发fetchParts中deliveryCh的逻辑，第四个方法触发了statesync中runStateSyn方法的逻辑。</p>
<blockquote>
<p>题图来自unsplash：<a target="_blank" rel="noopener" href="https://unsplash.com/photos/PHdLDymaV90">https://unsplash.com/photos/PHdLDymaV90</a></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag"><i class="fa fa-tag"></i> 区块链</a>
              <a href="/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" rel="tag"><i class="fa fa-tag"></i> 以太坊</a>
              <a href="/tags/go/" rel="tag"><i class="fa fa-tag"></i> go</a>
              <a href="/tags/go-ethereum/" rel="tag"><i class="fa fa-tag"></i> go-ethereum</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/05/13/%E9%80%9A%E8%BF%87RPC%E4%B8%8E%E5%A4%AA%E5%9D%8A%E8%8A%82%E7%82%B9%E4%BA%A4%E4%BA%92/" rel="prev" title="通过RPC与太坊节点交互">
                  <i class="fa fa-chevron-left"></i> 通过RPC与太坊节点交互
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/05/16/go-ethereum%E4%B8%ADeth-downloader%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A02/" rel="next" title="go-ethereum中eth-downloader源码学习（二）">
                  go-ethereum中eth-downloader源码学习（二） <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">AmorFati</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">631k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:34</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
