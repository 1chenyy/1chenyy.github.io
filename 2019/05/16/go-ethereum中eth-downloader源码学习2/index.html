<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">

<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CConsolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="article">
<meta property="og:title" content="go-ethereum中eth-downloader源码学习（二）">
<meta property="og:url" content="http://example.com/2019/05/16/go-ethereum%E4%B8%ADeth-downloader%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A02/index.html">
<meta property="og:site_name" content="AmorFati">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/yermek-zhakipzhanov-1582770-unsplash.jpg">
<meta property="article:published_time" content="2019-05-16T09:49:56.000Z">
<meta property="article:modified_time" content="2021-11-17T13:54:30.491Z">
<meta property="article:author" content="AmorFati">
<meta property="article:tag" content="区块链">
<meta property="article:tag" content="以太坊">
<meta property="article:tag" content="go">
<meta property="article:tag" content="go-ethereum">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/yermek-zhakipzhanov-1582770-unsplash.jpg">


<link rel="canonical" href="http://example.com/2019/05/16/go-ethereum%E4%B8%ADeth-downloader%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A02/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2019/05/16/go-ethereum%E4%B8%ADeth-downloader%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A02/","path":"2019/05/16/go-ethereum中eth-downloader源码学习2/","title":"go-ethereum中eth-downloader源码学习（二）"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>go-ethereum中eth-downloader源码学习（二） | AmorFati</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">AmorFati</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">风吹过窗前的书，又翻过一页</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#peer-go"><span class="nav-number">1.</span> <span class="nav-text">peer.go</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#register-amp-Unregister"><span class="nav-number">1.1.</span> <span class="nav-text">register &amp; Unregister</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FetchXxx"><span class="nav-number">1.2.</span> <span class="nav-text">FetchXxx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SetXxxIdle"><span class="nav-number">1.3.</span> <span class="nav-text">SetXxxIdle</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XxxCapacity"><span class="nav-number">1.4.</span> <span class="nav-text">XxxCapacity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XxxIdlePeers"><span class="nav-number">1.5.</span> <span class="nav-text">XxxIdlePeers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reset"><span class="nav-number">1.6.</span> <span class="nav-text">Reset</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#queue-go"><span class="nav-number">2.</span> <span class="nav-text">queue.go</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Schedule"><span class="nav-number">2.1.</span> <span class="nav-text">Schedule</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ScheduleSkeleton"><span class="nav-number">2.2.</span> <span class="nav-text">ScheduleSkeleton</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ReserveXxx"><span class="nav-number">2.3.</span> <span class="nav-text">ReserveXxx</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#reserveHeaders"><span class="nav-number">2.3.1.</span> <span class="nav-text">reserveHeaders</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ReserveHeaders"><span class="nav-number">2.3.2.</span> <span class="nav-text">ReserveHeaders</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DeliverXxx"><span class="nav-number">2.4.</span> <span class="nav-text">DeliverXxx</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#deliver"><span class="nav-number">2.4.1.</span> <span class="nav-text">deliver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DeliverHeaders"><span class="nav-number">2.4.2.</span> <span class="nav-text">DeliverHeaders</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ExpireXxx"><span class="nav-number">2.5.</span> <span class="nav-text">ExpireXxx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CancelXxx"><span class="nav-number">2.6.</span> <span class="nav-text">CancelXxx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RetrieveHeaders"><span class="nav-number">2.7.</span> <span class="nav-text">RetrieveHeaders</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#statesync-go"><span class="nav-number">3.</span> <span class="nav-text">statesync.go</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#stateFetcher"><span class="nav-number">3.1.</span> <span class="nav-text">stateFetcher</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#runStateSync"><span class="nav-number">3.2.</span> <span class="nav-text">runStateSync</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="AmorFati"
      src="/assets/img/icon.jpg">
  <p class="site-author-name" itemprop="name">AmorFati</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/1chenyy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;1chenyy" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:henyang4346@foxmail.com" title="E-Mail → mailto:henyang4346@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/52c1bec4559c" title="简书 → https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;52c1bec4559c" rel="noopener" target="_blank"><i class="fa fa-globe fa-fw"></i>简书</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/16/go-ethereum%E4%B8%ADeth-downloader%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/icon.jpg">
      <meta itemprop="name" content="AmorFati">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmorFati">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          go-ethereum中eth-downloader源码学习（二）
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-16 17:49:56" itemprop="dateCreated datePublished" datetime="2019-05-16T17:49:56+08:00">2019-05-16</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-11-17 21:54:30" itemprop="dateModified" datetime="2021-11-17T21:54:30+08:00">2021-11-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go-ethereum%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">go-ethereum源码学习</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>33k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>30 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/yermek-zhakipzhanov-1582770-unsplash.jpg"></p>
<span id="more"></span>
<p>本文是downloader的源码分析的第二部分，分析peer、queue和statesync这三个辅助部分</p>
<h1 id="peer-go"><a href="#peer-go" class="headerlink" title="peer.go"></a>peer.go</h1><p>peer表示了一个节点，封装了一系列有用的方法</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Peer <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>
	LightPeer
	<span class="token function">RequestBodies</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">RequestReceipts</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">RequestNodeData</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> LightPeer <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>
	<span class="token function">Head</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> <span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span>
	<span class="token function">RequestHeadersByHash</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">RequestHeadersByNumber</span><span class="token punctuation">(</span><span class="token builtin">uint64</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="register-amp-Unregister"><a href="#register-amp-Unregister" class="headerlink" title="register &amp; Unregister"></a>register &amp; Unregister</h2><p>实际使用中，当一个连接建立后，使用pm的handle去处理一个peer时会用RegisterPeer的RegisterPeer方法去注册一个peer，RegisterPeer方法如下</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">RegisterPeer</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> version <span class="token builtin">int</span><span class="token punctuation">,</span> peer Peer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	logger <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"peer"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span>
	logger<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Registering sync peer"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> d<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token function">newPeerConnection</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> version<span class="token punctuation">,</span> peer<span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Failed to register sync peer"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	d<span class="token punctuation">.</span><span class="token function">qosReduceConfidence</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可见实际上是向peers中注册，peers是一个peerSet对象，它的注册的是peerConnection对象</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> peerSet <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	peers        <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>peerConnection
	newPeerFeed  event<span class="token punctuation">.</span>Feed
	peerDropFeed event<span class="token punctuation">.</span>Feed
	lock         sync<span class="token punctuation">.</span>RWMutex
<span class="token punctuation">&#125;</span>
<span class="token keyword">type</span> peerConnection <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	id <span class="token builtin">string</span> <span class="token comment">// Unique identifier of the peer</span>

	headerIdle  <span class="token builtin">int32</span> <span class="token comment">// Current header activity state of the peer (idle = 0, active = 1)</span>
	blockIdle   <span class="token builtin">int32</span> <span class="token comment">// Current block activity state of the peer (idle = 0, active = 1)</span>
	receiptIdle <span class="token builtin">int32</span> <span class="token comment">// Current receipt activity state of the peer (idle = 0, active = 1)</span>
	stateIdle   <span class="token builtin">int32</span> <span class="token comment">// Current node data activity state of the peer (idle = 0, active = 1)</span>

	headerThroughput  <span class="token builtin">float64</span> <span class="token comment">// Number of headers measured to be retrievable per second</span>
	blockThroughput   <span class="token builtin">float64</span> <span class="token comment">// Number of blocks (bodies) measured to be retrievable per second</span>
	receiptThroughput <span class="token builtin">float64</span> <span class="token comment">// Number of receipts measured to be retrievable per second</span>
	stateThroughput   <span class="token builtin">float64</span> <span class="token comment">// Number of node data pieces measured to be retrievable per second</span>

	rtt time<span class="token punctuation">.</span>Duration <span class="token comment">// Request round trip time to track responsiveness (QoS)</span>

	headerStarted  time<span class="token punctuation">.</span>Time <span class="token comment">// Time instance when the last header fetch was started</span>
	blockStarted   time<span class="token punctuation">.</span>Time <span class="token comment">// Time instance when the last block (body) fetch was started</span>
	receiptStarted time<span class="token punctuation">.</span>Time <span class="token comment">// Time instance when the last receipt fetch was started</span>
	stateStarted   time<span class="token punctuation">.</span>Time <span class="token comment">// Time instance when the last node data fetch was started</span>

	lacking <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// Set of hashes not to request (didn't have previously)</span>

	peer Peer

	version <span class="token builtin">int</span>        <span class="token comment">// Eth protocol version number to switch strategies</span>
	log     log<span class="token punctuation">.</span>Logger <span class="token comment">// Contextual logger to add extra infos to peer logs</span>
	lock    sync<span class="token punctuation">.</span>RWMutex
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>peerSet的Register方法如下</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ps <span class="token operator">*</span>peerSet<span class="token punctuation">)</span> <span class="token function">Register</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	p<span class="token punctuation">.</span>rtt <span class="token operator">=</span> ps<span class="token punctuation">.</span><span class="token function">medianRTT</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	ps<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> ps<span class="token punctuation">.</span>peers<span class="token punctuation">[</span>p<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
		ps<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> errAlreadyRegistered
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>peers<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		p<span class="token punctuation">.</span>headerThroughput<span class="token punctuation">,</span> p<span class="token punctuation">.</span>blockThroughput<span class="token punctuation">,</span> p<span class="token punctuation">.</span>receiptThroughput<span class="token punctuation">,</span> p<span class="token punctuation">.</span>stateThroughput <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>

		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> peer <span class="token operator">:=</span> <span class="token keyword">range</span> ps<span class="token punctuation">.</span>peers <span class="token punctuation">&#123;</span>
			peer<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			p<span class="token punctuation">.</span>headerThroughput <span class="token operator">+=</span> peer<span class="token punctuation">.</span>headerThroughput
			p<span class="token punctuation">.</span>blockThroughput <span class="token operator">+=</span> peer<span class="token punctuation">.</span>blockThroughput
			p<span class="token punctuation">.</span>receiptThroughput <span class="token operator">+=</span> peer<span class="token punctuation">.</span>receiptThroughput
			p<span class="token punctuation">.</span>stateThroughput <span class="token operator">+=</span> peer<span class="token punctuation">.</span>stateThroughput
			peer<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		p<span class="token punctuation">.</span>headerThroughput <span class="token operator">/=</span> <span class="token function">float64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token punctuation">)</span>
		p<span class="token punctuation">.</span>blockThroughput <span class="token operator">/=</span> <span class="token function">float64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token punctuation">)</span>
		p<span class="token punctuation">.</span>receiptThroughput <span class="token operator">/=</span> <span class="token function">float64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token punctuation">)</span>
		p<span class="token punctuation">.</span>stateThroughput <span class="token operator">/=</span> <span class="token function">float64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	ps<span class="token punctuation">.</span>peers<span class="token punctuation">[</span>p<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> p
	ps<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	ps<span class="token punctuation">.</span>newPeerFeed<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>medianRTT是取ps存储的所有peer的rtt的中位数，RTT即round-trip time，往返时间，可以评估和一个peer的通信质量。medianRTT实现如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ps <span class="token operator">*</span>peerSet<span class="token punctuation">)</span> <span class="token function">medianRTT</span><span class="token punctuation">(</span><span class="token punctuation">)</span> time<span class="token punctuation">.</span>Duration <span class="token punctuation">&#123;</span>
	ps<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> ps<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	rtts <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> ps<span class="token punctuation">.</span>peers <span class="token punctuation">&#123;</span>
		p<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		rtts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>rtts<span class="token punctuation">,</span> <span class="token function">float64</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>rtt<span class="token punctuation">)</span><span class="token punctuation">)</span>
		p<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	sort<span class="token punctuation">.</span><span class="token function">Float64s</span><span class="token punctuation">(</span>rtts<span class="token punctuation">)</span>

	median <span class="token operator">:=</span> rttMaxEstimate
	<span class="token keyword">if</span> qosTuningPeers <span class="token operator">&lt;=</span> <span class="token function">len</span><span class="token punctuation">(</span>rtts<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		median <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>rtts<span class="token punctuation">[</span>qosTuningPeers<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>rtts<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		median <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>rtts<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>rtts<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// Median of our connected peers (maintain even like this some baseline qos)</span>
	<span class="token punctuation">&#125;</span>
	
	<span class="token keyword">if</span> median <span class="token operator">&lt;</span> rttMinEstimate <span class="token punctuation">&#123;</span>
		median <span class="token operator">=</span> rttMinEstimate
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> median <span class="token operator">></span> rttMaxEstimate <span class="token punctuation">&#123;</span>
		median <span class="token operator">=</span> rttMaxEstimate
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> median
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>逻辑很简单，首先取出所有peer的rtt，然后排序，如果序列长度大于5，就只取前5个的中位数，否则就是序列的中位数，获得的时间最后控制在2秒到20秒之间。</p>
<p>回到Register中，先看是否注册过，若没有再判断是否注册过其他peer，则计算headerThroughput、blockThroughput、receiptThroughput和stateThroughput四个值，分别代表：每秒可检索的区块头数量，每秒可检索的区块体数量，每秒可检索的收据数量和每秒可检测的节点数据数量。然后将peer按照其id放入peers中。</p>
<p>有注册就有反注册，Unregister实现如下</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ps <span class="token operator">*</span>peerSet<span class="token punctuation">)</span> <span class="token function">Unregister</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	ps<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	p<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ps<span class="token punctuation">.</span>peers<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">defer</span> ps<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> errNotRegistered
	<span class="token punctuation">&#125;</span>
	<span class="token function">delete</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>peers<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
	ps<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	ps<span class="token punctuation">.</span>peerDropFeed<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单就是先判断在删除。</p>
<h2 id="FetchXxx"><a href="#FetchXxx" class="headerlink" title="FetchXxx"></a>FetchXxx</h2><p>peerConnection除了封装一个peer，还有一系列的peer相关的信息，除了前面提到过的headerThroughput、blockThroughput、receiptThroughput和stateThroughput，还有headerIdle、blockIdle、receiptIdle和stateIdle分别用来记录peer对应的工作状态，这几个变量为0时表示对应状态空闲，为1时表示对应状态繁忙。除此之外还有headerStarted、blockStarted、receiptStarted和stateStarted几个时间变量记录对应工作开始的时间。</p>
<p>以head为例介绍一下相关变量的改变，在peerConnection有一个FetchHeaders表示请求区块头，实现如下</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">)</span> <span class="token function">FetchHeaders</span><span class="token punctuation">(</span>from <span class="token builtin">uint64</span><span class="token punctuation">,</span> count <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> p<span class="token punctuation">.</span>version <span class="token operator">&lt;</span> <span class="token number">62</span> <span class="token punctuation">&#123;</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"header fetch [eth/62+] requested on eth/%d"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>version<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>headerIdle<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errAlreadyFetching
	<span class="token punctuation">&#125;</span>
	p<span class="token punctuation">.</span>headerStarted <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> p<span class="token punctuation">.</span>peer<span class="token punctuation">.</span><span class="token function">RequestHeadersByNumber</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span> count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里先判断了eth协议的版本号，然后将headerIdle置为1，并记录开始时间到headerStarted，真正的请求逻辑在peer的RequestHeadersByNumber方法。这里的peer是ProtocolManager的newPeer方法创建的peer(go-ethereum\eth\peer.go)。</p>
<p>同样还有FetchBodies、FetchReceipts和FetchNodeData等方法。</p>
<h2 id="SetXxxIdle"><a href="#SetXxxIdle" class="headerlink" title="SetXxxIdle"></a>SetXxxIdle</h2><p>前面的FetchXxx是将对应状态置为忙碌，这里SetXxxIdle则是相反，他们都调用的是setIdle方法。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">)</span> <span class="token function">setIdle</span><span class="token punctuation">(</span>started time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> delivered <span class="token builtin">int</span><span class="token punctuation">,</span> throughput <span class="token operator">*</span><span class="token builtin">float64</span><span class="token punctuation">,</span> idle <span class="token operator">*</span><span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">defer</span> atomic<span class="token punctuation">.</span><span class="token function">StoreInt32</span><span class="token punctuation">(</span>idle<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

	p<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> p<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> delivered <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token operator">*</span>throughput <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	elapsed <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>started<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> 
	measured <span class="token operator">:=</span> <span class="token function">float64</span><span class="token punctuation">(</span>delivered<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>elapsed<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">float64</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token operator">*</span>throughput <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>measurementImpact<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>throughput<span class="token punctuation">)</span> <span class="token operator">+</span> measurementImpact<span class="token operator">*</span>measured
	p<span class="token punctuation">.</span>rtt <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span>measurementImpact<span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">float64</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>rtt<span class="token punctuation">)</span> <span class="token operator">+</span> measurementImpact<span class="token operator">*</span><span class="token function">float64</span><span class="token punctuation">(</span>elapsed<span class="token punctuation">)</span><span class="token punctuation">)</span>

	p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Peer throughput measurements updated"</span><span class="token punctuation">,</span>
		<span class="token string">"hps"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>headerThroughput<span class="token punctuation">,</span> <span class="token string">"bps"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>blockThroughput<span class="token punctuation">,</span>
		<span class="token string">"rps"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>receiptThroughput<span class="token punctuation">,</span> <span class="token string">"sps"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>stateThroughput<span class="token punctuation">,</span>
		<span class="token string">"miss"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>lacking<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"rtt"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>rtt<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先置0，表示空闲，然后如果delivered为0，表示没有传送到，则该peer的对应throughput置0.否则更新throughput和rtt。</p>
<h2 id="XxxCapacity"><a href="#XxxCapacity" class="headerlink" title="XxxCapacity"></a>XxxCapacity</h2><p>返回的对应状态的吞吐量，以heads为例</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">)</span> <span class="token function">HeaderCapacity</span><span class="token punctuation">(</span>targetRTT time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>
	p<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> p<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token function">int</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span><span class="token function">Min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>math<span class="token punctuation">.</span><span class="token function">Max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>headerThroughput<span class="token operator">*</span><span class="token function">float64</span><span class="token punctuation">(</span>targetRTT<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">float64</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">float64</span><span class="token punctuation">(</span>MaxHeaderFetch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="XxxIdlePeers"><a href="#XxxIdlePeers" class="headerlink" title="XxxIdlePeers"></a>XxxIdlePeers</h2><p>用来获取对应状态空闲的peer</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ps <span class="token operator">*</span>peerSet<span class="token punctuation">)</span> <span class="token function">HeaderIdlePeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	idle <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> atomic<span class="token punctuation">.</span><span class="token function">LoadInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>headerIdle<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
	<span class="token punctuation">&#125;</span>
	throughput <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">&#123;</span>
		p<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">defer</span> p<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> p<span class="token punctuation">.</span>headerThroughput
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> ps<span class="token punctuation">.</span><span class="token function">idlePeers</span><span class="token punctuation">(</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> idle<span class="token punctuation">,</span> throughput<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>调用的是idlePeers</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ps <span class="token operator">*</span>peerSet<span class="token punctuation">)</span> <span class="token function">idlePeers</span><span class="token punctuation">(</span>minProtocol<span class="token punctuation">,</span> maxProtocol <span class="token builtin">int</span><span class="token punctuation">,</span> idleCheck <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>peerConnection<span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> throughput <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>peerConnection<span class="token punctuation">)</span> <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	ps<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> ps<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	idle<span class="token punctuation">,</span> total <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> ps<span class="token punctuation">.</span>peers <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> p<span class="token punctuation">.</span>version <span class="token operator">>=</span> minProtocol <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>version <span class="token operator">&lt;=</span> maxProtocol <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> <span class="token function">idleCheck</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				idle <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>idle<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			total<span class="token operator">++</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>idle<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> j <span class="token operator">:=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>idle<span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> <span class="token function">throughput</span><span class="token punctuation">(</span>idle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">throughput</span><span class="token punctuation">(</span>idle<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				idle<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> idle<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> idle<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> idle<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> idle<span class="token punctuation">,</span> total
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>就是简单的遍历，然后将结果按throughput排序。</p>
<h2 id="Reset"><a href="#Reset" class="headerlink" title="Reset"></a>Reset</h2><p>重置所有变量</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">)</span> <span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	p<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> p<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	atomic<span class="token punctuation">.</span><span class="token function">StoreInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>headerIdle<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	atomic<span class="token punctuation">.</span><span class="token function">StoreInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>blockIdle<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	atomic<span class="token punctuation">.</span><span class="token function">StoreInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>receiptIdle<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	atomic<span class="token punctuation">.</span><span class="token function">StoreInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>stateIdle<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

	p<span class="token punctuation">.</span>headerThroughput <span class="token operator">=</span> <span class="token number">0</span>
	p<span class="token punctuation">.</span>blockThroughput <span class="token operator">=</span> <span class="token number">0</span>
	p<span class="token punctuation">.</span>receiptThroughput <span class="token operator">=</span> <span class="token number">0</span>
	p<span class="token punctuation">.</span>stateThroughput <span class="token operator">=</span> <span class="token number">0</span>

	p<span class="token punctuation">.</span>lacking <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="queue-go"><a href="#queue-go" class="headerlink" title="queue.go"></a>queue.go</h1><p>这实际上起到一个调度的作用，配合downloader的fetchParts方法，它用来告诉downloader哪些可以去处理。先看构造方法，在downloader创建时调用了newQueue方法创建了一个queue</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">newQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>queue <span class="token punctuation">&#123;</span>
	lock <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>queue<span class="token punctuation">&#123;</span>
		headerPendPool<span class="token punctuation">:</span>   <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>fetchRequest<span class="token punctuation">)</span><span class="token punctuation">,</span>
		headerContCh<span class="token punctuation">:</span>     <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		blockTaskPool<span class="token punctuation">:</span>    <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span><span class="token punctuation">,</span>
		blockTaskQueue<span class="token punctuation">:</span>   prque<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		blockPendPool<span class="token punctuation">:</span>    <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>fetchRequest<span class="token punctuation">)</span><span class="token punctuation">,</span>
		blockDonePool<span class="token punctuation">:</span>    <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		receiptTaskPool<span class="token punctuation">:</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span><span class="token punctuation">,</span>
		receiptTaskQueue<span class="token punctuation">:</span> prque<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		receiptPendPool<span class="token punctuation">:</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>fetchRequest<span class="token punctuation">)</span><span class="token punctuation">,</span>
		receiptDonePool<span class="token punctuation">:</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		resultCache<span class="token punctuation">:</span>      <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>fetchResult<span class="token punctuation">,</span> blockCacheItems<span class="token punctuation">)</span><span class="token punctuation">,</span>
		active<span class="token punctuation">:</span>           sync<span class="token punctuation">.</span><span class="token function">NewCond</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">,</span>
		lock<span class="token punctuation">:</span>             lock<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中的active变量是一个Cond类型的锁，它有一个锁L可以正常加锁解锁，除此之外还有wait进入阻塞，Signal和Broadcast可以进行唤醒。receiptTaskQueue与blockTaskQueue是两个优先级队列。</p>
<h2 id="Schedule"><a href="#Schedule" class="headerlink" title="Schedule"></a>Schedule</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">Schedule</span><span class="token punctuation">(</span>headers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> from <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header <span class="token punctuation">&#123;</span>
	q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	inserts <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> header <span class="token operator">:=</span> <span class="token keyword">range</span> headers <span class="token punctuation">&#123;</span>
		hash <span class="token operator">:=</span> header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> header<span class="token punctuation">.</span>Number <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> from <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Header broke chain ordering"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">"expected"</span><span class="token punctuation">,</span> from<span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> q<span class="token punctuation">.</span>headerHead <span class="token operator">!=</span> <span class="token punctuation">(</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> q<span class="token punctuation">.</span>headerHead <span class="token operator">!=</span> header<span class="token punctuation">.</span>ParentHash <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Header broke chain ancestry"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> q<span class="token punctuation">.</span>blockTaskPool<span class="token punctuation">[</span>hash<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Header already scheduled for block fetch"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> q<span class="token punctuation">.</span>receiptTaskPool<span class="token punctuation">[</span>hash<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Header already scheduled for receipt fetch"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">&#125;</span>
		q<span class="token punctuation">.</span>blockTaskPool<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> header
		q<span class="token punctuation">.</span>blockTaskQueue<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">int64</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token keyword">if</span> q<span class="token punctuation">.</span>mode <span class="token operator">==</span> FastSync <span class="token punctuation">&#123;</span>
			q<span class="token punctuation">.</span>receiptTaskPool<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> header
			q<span class="token punctuation">.</span>receiptTaskQueue<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">int64</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		inserts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>inserts<span class="token punctuation">,</span> header<span class="token punctuation">)</span>
		q<span class="token punctuation">.</span>headerHead <span class="token operator">=</span> hash
		from<span class="token operator">++</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> inserts
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法在downloader的processHeaders方法中出现。传入的参数headers是一组head，from是开始的位置。这个方法的主要作用是申请对一些区块头进行下载的调度。首先创建了一个Header数组，之后遍历了所有传入的head，对每个head进行一系列检查。</p>
<p>首先检测head格式是否正确，即编号是否为空，且是否为正确的编号。在检测区块间是否为父子关系，即检测父区块哈希是否正确且对应。然后在检测是否已经位于blockTaskPool和receiptTaskPool中，是的话直接跳过。</p>
<p>检测完毕后，将head放入blockTaskPool，这个map存储着等待检索区块体的任务。之后再放入blockTaskQueue这个队列，并以区块编号的负数作为优先级，编号越小的区块优先级越高。再接着对于fast模式下，再向receiptTaskPool和receiptTaskQueue添加内容，这也就显示出fast模式的特性。之后将head放入insert中，然后更新headerHead与from，用于下一个区块验证。整个方法的返回值就是要等待请求的区块头集合。</p>
<p>其中的两个TaskPool主要作用是避免重复申请调度，会在请求结束后在DeliverXxx方法中被删除。而这两个TaskQueue则是调度的关键，存储着等待调度的东西，在后面的ReserveXxx方法中会被拿出来构造请求进行处理。</p>
<h2 id="ScheduleSkeleton"><a href="#ScheduleSkeleton" class="headerlink" title="ScheduleSkeleton"></a>ScheduleSkeleton</h2><p>这个方法出现在downloader的fillHeaderSkeleton方法中，就是在fetchHeaders中对于骨架模式进行填充</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">ScheduleSkeleton</span><span class="token punctuation">(</span>from <span class="token builtin">uint64</span><span class="token punctuation">,</span> skeleton <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> q<span class="token punctuation">.</span>headerResults <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"skeleton assembly already in progress"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	q<span class="token punctuation">.</span>headerTaskPool <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint64</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span>
	q<span class="token punctuation">.</span>headerTaskQueue <span class="token operator">=</span> prque<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
	q<span class="token punctuation">.</span>headerPeerMiss <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint64</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token comment">// Reset availability to correct invalid chains</span>
	q<span class="token punctuation">.</span>headerResults <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>skeleton<span class="token punctuation">)</span><span class="token operator">*</span>MaxHeaderFetch<span class="token punctuation">)</span>
	q<span class="token punctuation">.</span>headerProced <span class="token operator">=</span> <span class="token number">0</span>
	q<span class="token punctuation">.</span>headerOffset <span class="token operator">=</span> from
	q<span class="token punctuation">.</span>headerContCh <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> i<span class="token punctuation">,</span> header <span class="token operator">:=</span> <span class="token keyword">range</span> skeleton <span class="token punctuation">&#123;</span>
		index <span class="token operator">:=</span> from <span class="token operator">+</span> <span class="token function">uint64</span><span class="token punctuation">(</span>i<span class="token operator">*</span>MaxHeaderFetch<span class="token punctuation">)</span>

		q<span class="token punctuation">.</span>headerTaskPool<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> header
		q<span class="token punctuation">.</span>headerTaskQueue<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">int64</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先避免重复框架组装，通过检测headerResults是否为空来判断。之后遍历skeleton，skeleton是一组断续的header，他从from+191位置开始，每隔192个区块请求一个，总共请求128个。遍历的时候用headerTaskPool记录框架对于位置的head，并将index按照其负数作为优先级存入headerTaskQueue队列。headerTaskPool和headerTaskQueue的作用和前面Schedule方法中那两对变量作用类似。</p>
<h2 id="ReserveXxx"><a href="#ReserveXxx" class="headerlink" title="ReserveXxx"></a>ReserveXxx</h2><p>这是一组方法，在downloader的Synchronise流程最后定义了一组fetch方法，最后都调用了fetchParts方法，其中reserve参数就是这里对应的ReserveXxx方法，这组方法的主要用途是从TaskQueue队列中领取任务构造请求便于后续执行。</p>
<p>一共有三个方法：ReserveReceipts、ReserveBodies和ReserveHeaders，但是ReserveReceipts和ReserveBodies都调用了reserveHeaders方法</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">ReserveBodies</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> count <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>fetchRequest<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	isNoop <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> header<span class="token punctuation">.</span>TxHash <span class="token operator">==</span> types<span class="token punctuation">.</span>EmptyRootHash <span class="token operator">&amp;&amp;</span> header<span class="token punctuation">.</span>UncleHash <span class="token operator">==</span> types<span class="token punctuation">.</span>EmptyUncleHash
	<span class="token punctuation">&#125;</span>
	q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> q<span class="token punctuation">.</span><span class="token function">reserveHeaders</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> count<span class="token punctuation">,</span> q<span class="token punctuation">.</span>blockTaskPool<span class="token punctuation">,</span> q<span class="token punctuation">.</span>blockTaskQueue<span class="token punctuation">,</span> q<span class="token punctuation">.</span>blockPendPool<span class="token punctuation">,</span> q<span class="token punctuation">.</span>blockDonePool<span class="token punctuation">,</span> isNoop<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">ReserveReceipts</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> count <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>fetchRequest<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	isNoop <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> header<span class="token punctuation">.</span>ReceiptHash <span class="token operator">==</span> types<span class="token punctuation">.</span>EmptyRootHash
	<span class="token punctuation">&#125;</span>
	q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> q<span class="token punctuation">.</span><span class="token function">reserveHeaders</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> count<span class="token punctuation">,</span> q<span class="token punctuation">.</span>receiptTaskPool<span class="token punctuation">,</span> q<span class="token punctuation">.</span>receiptTaskQueue<span class="token punctuation">,</span> q<span class="token punctuation">.</span>receiptPendPool<span class="token punctuation">,</span> q<span class="token punctuation">.</span>receiptDonePool<span class="token punctuation">,</span> isNoop<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="reserveHeaders"><a href="#reserveHeaders" class="headerlink" title="reserveHeaders"></a>reserveHeaders</h3><p>这里看一下这个方法</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">reserveHeaders</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> count <span class="token builtin">int</span><span class="token punctuation">,</span> taskPool <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> taskQueue <span class="token operator">*</span>prque<span class="token punctuation">.</span>Prque<span class="token punctuation">,</span>
	pendPool <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>fetchRequest<span class="token punctuation">,</span> donePool <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> isNoop <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>fetchRequest<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> taskQueue<span class="token punctuation">.</span><span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> pendPool<span class="token punctuation">[</span>p<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	space <span class="token operator">:=</span> q<span class="token punctuation">.</span><span class="token function">resultSlots</span><span class="token punctuation">(</span>pendPool<span class="token punctuation">,</span> donePool<span class="token punctuation">)</span>

	send <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>
	skip <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

	progress <span class="token operator">:=</span> <span class="token boolean">false</span>
	<span class="token keyword">for</span> proc <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> proc <span class="token operator">&lt;</span> space <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>send<span class="token punctuation">)</span> <span class="token operator">&lt;</span> count <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>taskQueue<span class="token punctuation">.</span><span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> proc<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		header <span class="token operator">:=</span> taskQueue<span class="token punctuation">.</span><span class="token function">PopItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span>
		hash <span class="token operator">:=</span> header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		index <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">int64</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>resultOffset<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> index <span class="token operator">>=</span> <span class="token function">len</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>resultCache<span class="token punctuation">)</span> <span class="token operator">||</span> index <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			common<span class="token punctuation">.</span><span class="token function">Report</span><span class="token punctuation">(</span><span class="token string">"index allocation went beyond available resultCache space"</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> errInvalidChain
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> q<span class="token punctuation">.</span>resultCache<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			components <span class="token operator">:=</span> <span class="token number">1</span>
			<span class="token keyword">if</span> q<span class="token punctuation">.</span>mode <span class="token operator">==</span> FastSync <span class="token punctuation">&#123;</span>
				components <span class="token operator">=</span> <span class="token number">2</span>
			<span class="token punctuation">&#125;</span>
			q<span class="token punctuation">.</span>resultCache<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>fetchResult<span class="token punctuation">&#123;</span>
				Pending<span class="token punctuation">:</span> components<span class="token punctuation">,</span>
				Hash<span class="token punctuation">:</span>    hash<span class="token punctuation">,</span>
				Header<span class="token punctuation">:</span>  header<span class="token punctuation">,</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> <span class="token function">isNoop</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			donePool<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>taskPool<span class="token punctuation">,</span> hash<span class="token punctuation">)</span>

			space<span class="token punctuation">,</span> proc <span class="token operator">=</span> space<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> proc<span class="token operator">-</span><span class="token number">1</span>
			q<span class="token punctuation">.</span>resultCache<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Pending<span class="token operator">--</span>
			progress <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> p<span class="token punctuation">.</span><span class="token function">Lacks</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			skip <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>skip<span class="token punctuation">,</span> header<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			send <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>send<span class="token punctuation">,</span> header<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> header <span class="token operator">:=</span> <span class="token keyword">range</span> skip <span class="token punctuation">&#123;</span>
		taskQueue<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">int64</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> progress <span class="token punctuation">&#123;</span>
		q<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">Signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>send<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> progress<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	request <span class="token operator">:=</span> <span class="token operator">&amp;</span>fetchRequest<span class="token punctuation">&#123;</span>
		Peer<span class="token punctuation">:</span>    p<span class="token punctuation">,</span>
		Headers<span class="token punctuation">:</span> send<span class="token punctuation">,</span>
		Time<span class="token punctuation">:</span>    time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	pendPool<span class="token punctuation">[</span>p<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> request

	<span class="token keyword">return</span> request<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先检查taskQueue是否为空，taskQueue是作为参数传入的，对应ReserveBodies和ReserveReceipts分别是blockTaskQueue和receiptTaskQueue，这两个队列分别在前面Schedule方法中被填充。接着计算了fetch的上限，创建了两个数组send和skip。</p>
<p>然后开始循环，每次从taskQueue获取优先级最高的item，然后根据区块头的高度计算index，index表示在resultCache的位置，resultCache是一个fetchResult数组，存储已经下载完毕的结果。如果resultCache对应位置为空，则构造一个fetchResult对象存入。然后调用了isNoop方法，这是方法的一个参数，用于检测是否为包含交易。如果是的话表示不需要继续操作，将其donePool对应元素置空，然后从taskPool中删除，由于taskPool被改变，则space和proc两个计数器响应的都减一。如果不为空，检测hash是否在lacking中，如在表示没有这个hash相关数据，则放入skip中，否则放入send中。</p>
<p>循环结束后，也就是从taskPool中分类一定数量的head后，遍历skip，将其中改的head按期高度的负数再次添加到对应taskQueue队列中。然后如果progress为true，表示刚才循环中出现没有交易的区块头，则调用active的Signal方法，唤醒wait，他在Result方法中阻塞，稍后介绍。之后检测send数组，如果空则返回，否则构建一个fetchRequest，然后按照peer的id放入pendPool。</p>
<h3 id="ReserveHeaders"><a href="#ReserveHeaders" class="headerlink" title="ReserveHeaders"></a>ReserveHeaders</h3><p>这个方法和前面的ScheduleSkeleton一样只有在骨架模式下才回调用，该方法实现如下</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">ReserveHeaders</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> count <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>fetchRequest <span class="token punctuation">&#123;</span>
	q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> q<span class="token punctuation">.</span>headerPendPool<span class="token punctuation">[</span>p<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	send<span class="token punctuation">,</span> skip <span class="token operator">:=</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint64</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> send <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>q<span class="token punctuation">.</span>headerTaskQueue<span class="token punctuation">.</span><span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		from<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> q<span class="token punctuation">.</span>headerTaskQueue<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> q<span class="token punctuation">.</span>headerPeerMiss<span class="token punctuation">[</span>p<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> q<span class="token punctuation">.</span>headerPeerMiss<span class="token punctuation">[</span>p<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">[</span>from<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">uint64</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
				skip <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>skip<span class="token punctuation">,</span> from<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">uint64</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		send <span class="token operator">=</span> from<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">uint64</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> from <span class="token operator">:=</span> <span class="token keyword">range</span> skip <span class="token punctuation">&#123;</span>
		q<span class="token punctuation">.</span>headerTaskQueue<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">int64</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> send <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	request <span class="token operator">:=</span> <span class="token operator">&amp;</span>fetchRequest<span class="token punctuation">&#123;</span>
		Peer<span class="token punctuation">:</span> p<span class="token punctuation">,</span>
		From<span class="token punctuation">:</span> send<span class="token punctuation">,</span>
		Time<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	q<span class="token punctuation">.</span>headerPendPool<span class="token punctuation">[</span>p<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> request
	<span class="token keyword">return</span> request
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>逻辑和reserveHeaders类似，首先检测peer是否已在headerPendPool中。然后遍历headerTaskQueue，每次取优先级最高的，在检测对应hash是否在headerPeerMiss中，headerPeerMiss记录了每个peer明确不可用的区块，是的话放入skip以跳过，这个循环直到取到一个有效的head位置，然后记录from值到send。后续的逻辑就和reserveHeaders差不多，对于skip的再次放入headerTaskQueue，然后构造一个fetchRequest放入headerPendPool中。注意这个fetchRequest和前面的reserveHeaders最后构造的不太一样，这里没有传入Heads字段，而是写入了From字段，表示骨架中第一个有效的head，由于骨架是有规律的记录起始位置即可。</p>
<h2 id="DeliverXxx"><a href="#DeliverXxx" class="headerlink" title="DeliverXxx"></a>DeliverXxx</h2><p>这也是一组方法，和ReserveXxx类似，都是在调用fetchParts时作为参数传入的，这组方法的作用是在数据下载完毕后被调用。有DeliverBodies、DeliverReceipts和DeliverReceipts三个，前两个都是直接调用了deliver方法</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">DeliverBodies</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> txLists <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> uncleLists <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	reconstruct <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> index <span class="token builtin">int</span><span class="token punctuation">,</span> result <span class="token operator">*</span>fetchResult<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> types<span class="token punctuation">.</span><span class="token function">DeriveSha</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">Transactions</span><span class="token punctuation">(</span>txLists<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> header<span class="token punctuation">.</span>TxHash <span class="token operator">||</span> types<span class="token punctuation">.</span><span class="token function">CalcUncleHash</span><span class="token punctuation">(</span>uncleLists<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> header<span class="token punctuation">.</span>UncleHash <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> errInvalidBody
		<span class="token punctuation">&#125;</span>
		result<span class="token punctuation">.</span>Transactions <span class="token operator">=</span> txLists<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
		result<span class="token punctuation">.</span>Uncles <span class="token operator">=</span> uncleLists<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> q<span class="token punctuation">.</span><span class="token function">deliver</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> q<span class="token punctuation">.</span>blockTaskPool<span class="token punctuation">,</span> q<span class="token punctuation">.</span>blockTaskQueue<span class="token punctuation">,</span> q<span class="token punctuation">.</span>blockPendPool<span class="token punctuation">,</span> q<span class="token punctuation">.</span>blockDonePool<span class="token punctuation">,</span> bodyReqTimer<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>txLists<span class="token punctuation">)</span><span class="token punctuation">,</span> reconstruct<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">DeliverReceipts</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> receiptList <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Receipt<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	reconstruct <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> index <span class="token builtin">int</span><span class="token punctuation">,</span> result <span class="token operator">*</span>fetchResult<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> types<span class="token punctuation">.</span><span class="token function">DeriveSha</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">Receipts</span><span class="token punctuation">(</span>receiptList<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> header<span class="token punctuation">.</span>ReceiptHash <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> errInvalidReceipt
		<span class="token punctuation">&#125;</span>
		result<span class="token punctuation">.</span>Receipts <span class="token operator">=</span> receiptList<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> q<span class="token punctuation">.</span><span class="token function">deliver</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> q<span class="token punctuation">.</span>receiptTaskPool<span class="token punctuation">,</span> q<span class="token punctuation">.</span>receiptTaskQueue<span class="token punctuation">,</span> q<span class="token punctuation">.</span>receiptPendPool<span class="token punctuation">,</span> q<span class="token punctuation">.</span>receiptDonePool<span class="token punctuation">,</span> receiptReqTimer<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>receiptList<span class="token punctuation">)</span><span class="token punctuation">,</span> reconstruct<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="deliver"><a href="#deliver" class="headerlink" title="deliver"></a>deliver</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">deliver</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> taskPool <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> taskQueue <span class="token operator">*</span>prque<span class="token punctuation">.</span>Prque<span class="token punctuation">,</span>
	pendPool <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>fetchRequest<span class="token punctuation">,</span> donePool <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> reqTimer metrics<span class="token punctuation">.</span>Timer<span class="token punctuation">,</span>
	results <span class="token builtin">int</span><span class="token punctuation">,</span> reconstruct <span class="token keyword">func</span><span class="token punctuation">(</span>header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> index <span class="token builtin">int</span><span class="token punctuation">,</span> result <span class="token operator">*</span>fetchResult<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

	request <span class="token operator">:=</span> pendPool<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
	<span class="token keyword">if</span> request <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> errNoFetchesPending
	<span class="token punctuation">&#125;</span>
	reqTimer<span class="token punctuation">.</span><span class="token function">UpdateSince</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>Time<span class="token punctuation">)</span>
	<span class="token function">delete</span><span class="token punctuation">(</span>pendPool<span class="token punctuation">,</span> id<span class="token punctuation">)</span>

	<span class="token keyword">if</span> results <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> header <span class="token operator">:=</span> <span class="token keyword">range</span> request<span class="token punctuation">.</span>Headers <span class="token punctuation">&#123;</span>
			request<span class="token punctuation">.</span>Peer<span class="token punctuation">.</span><span class="token function">MarkLacking</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		accepted <span class="token builtin">int</span>
		failure  <span class="token builtin">error</span>
		useful   <span class="token builtin">bool</span>
	<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> header <span class="token operator">:=</span> <span class="token keyword">range</span> request<span class="token punctuation">.</span>Headers <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> i <span class="token operator">>=</span> results <span class="token punctuation">&#123;</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
		index <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">int64</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>resultOffset<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> index <span class="token operator">>=</span> <span class="token function">len</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>resultCache<span class="token punctuation">)</span> <span class="token operator">||</span> index <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> q<span class="token punctuation">.</span>resultCache<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			failure <span class="token operator">=</span> errInvalidChain
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">reconstruct</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> i<span class="token punctuation">,</span> q<span class="token punctuation">.</span>resultCache<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			failure <span class="token operator">=</span> err
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
		hash <span class="token operator">:=</span> header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		donePool<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
		q<span class="token punctuation">.</span>resultCache<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Pending<span class="token operator">--</span>
		useful <span class="token operator">=</span> <span class="token boolean">true</span>
		accepted<span class="token operator">++</span>

		request<span class="token punctuation">.</span>Headers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">nil</span>
		<span class="token function">delete</span><span class="token punctuation">(</span>taskPool<span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> header <span class="token operator">:=</span> <span class="token keyword">range</span> request<span class="token punctuation">.</span>Headers <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> header <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			taskQueue<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">int64</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> accepted <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		q<span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">Signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">switch</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> failure <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> failure <span class="token operator">==</span> errInvalidChain<span class="token punctuation">:</span>
		<span class="token keyword">return</span> accepted<span class="token punctuation">,</span> failure
	<span class="token keyword">case</span> useful<span class="token punctuation">:</span>
		<span class="token keyword">return</span> accepted<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"partial failure: %v"</span><span class="token punctuation">,</span> failure<span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> accepted<span class="token punctuation">,</span> errStaleDelivery
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先检测相应id是否在pendPool，pendPool是参数，对应DeliverBodies和DeliverReceipts分别是blockPendPool和receiptPendPool，他们分别在对应的ReserveXxx中被填充。如果没有则返回错误，有的话先从pendPool将其删除，表示已经结束。之后检查result的值，他表示DeliverXxx传入的List的长度，这个list表示检索到的数据集合，如果为0表示相应的head在该peer取不到，则调用MarkLacking将其添加到lacking中。</p>
<p>接下来进入一个循环，变量最开始从pendPool取出的request的Headers，然后计算在resultCache的index，之后利用reconstruct构建，reconstruct是传入的参数，主要作用是补全fetchResult，如在DeliverReceipts中是补全Receipts字段，在DeliverBodies补全Transactions和Uncles字段。之后在donePool标记对应hash的任务已经完成，并且useful写为true，accepted自增一，清空request对应位置的数据，并且删除taskPool对应hash内容。</p>
<p>循环结束后，由于刚才循环最后遍历results个，可能有剩余，将剩余的head放入对应taskQueue中。之后如果accept大于一，表示有任务真正完成了，同样调用active的Signal唤醒阻塞，和前面reserveHeaders类似。最后返回错误报告和accepted数量。</p>
<h3 id="DeliverHeaders"><a href="#DeliverHeaders" class="headerlink" title="DeliverHeaders"></a>DeliverHeaders</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">DeliverHeaders</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> headers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> headerProcCh <span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	request <span class="token operator">:=</span> q<span class="token punctuation">.</span>headerPendPool<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
	<span class="token keyword">if</span> request <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> errNoFetchesPending
	<span class="token punctuation">&#125;</span>
	headerReqTimer<span class="token punctuation">.</span><span class="token function">UpdateSince</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>Time<span class="token punctuation">)</span>
	<span class="token function">delete</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>headerPendPool<span class="token punctuation">,</span> id<span class="token punctuation">)</span>

	target <span class="token operator">:=</span> q<span class="token punctuation">.</span>headerTaskPool<span class="token punctuation">[</span>request<span class="token punctuation">.</span>From<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	accepted <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token operator">==</span> MaxHeaderFetch
	<span class="token keyword">if</span> accepted <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> headers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> request<span class="token punctuation">.</span>From <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"First header broke chain ordering"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> headers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Number<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> headers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>From<span class="token punctuation">)</span>
			accepted <span class="token operator">=</span> <span class="token boolean">false</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> headers<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> target <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Last header broke skeleton structure "</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> headers<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Number<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> headers<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"expected"</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span>
			accepted <span class="token operator">=</span> <span class="token boolean">false</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> accepted <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> i<span class="token punctuation">,</span> header <span class="token operator">:=</span> <span class="token keyword">range</span> headers<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
			hash <span class="token operator">:=</span> header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> want <span class="token operator">:=</span> request<span class="token punctuation">.</span>From <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token function">uint64</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> want <span class="token punctuation">&#123;</span>
				log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Header broke chain ordering"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">"expected"</span><span class="token punctuation">,</span> want<span class="token punctuation">)</span>
				accepted <span class="token operator">=</span> <span class="token boolean">false</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">if</span> headers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> header<span class="token punctuation">.</span>ParentHash <span class="token punctuation">&#123;</span>
				log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Header broke chain ancestry"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
				accepted <span class="token operator">=</span> <span class="token boolean">false</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>accepted <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Skeleton filling not accepted"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token string">"from"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>From<span class="token punctuation">)</span>

		miss <span class="token operator">:=</span> q<span class="token punctuation">.</span>headerPeerMiss<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
		<span class="token keyword">if</span> miss <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			q<span class="token punctuation">.</span>headerPeerMiss<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint64</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
			miss <span class="token operator">=</span> q<span class="token punctuation">.</span>headerPeerMiss<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
		<span class="token punctuation">&#125;</span>
		miss<span class="token punctuation">[</span>request<span class="token punctuation">.</span>From<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

		q<span class="token punctuation">.</span>headerTaskQueue<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>From<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">int64</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>From<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"delivery not accepted"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>headerResults<span class="token punctuation">[</span>request<span class="token punctuation">.</span>From<span class="token operator">-</span>q<span class="token punctuation">.</span>headerOffset<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> headers<span class="token punctuation">)</span>
	<span class="token function">delete</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>headerTaskPool<span class="token punctuation">,</span> request<span class="token punctuation">.</span>From<span class="token punctuation">)</span>

	ready <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> q<span class="token punctuation">.</span>headerProced<span class="token operator">+</span>ready <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>headerResults<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> q<span class="token punctuation">.</span>headerResults<span class="token punctuation">[</span>q<span class="token punctuation">.</span>headerProced<span class="token operator">+</span>ready<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		ready <span class="token operator">+=</span> MaxHeaderFetch
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> ready <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		process <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> ready<span class="token punctuation">)</span>
		<span class="token function">copy</span><span class="token punctuation">(</span>process<span class="token punctuation">,</span> q<span class="token punctuation">.</span>headerResults<span class="token punctuation">[</span>q<span class="token punctuation">.</span>headerProced<span class="token punctuation">:</span>q<span class="token punctuation">.</span>headerProced<span class="token operator">+</span>ready<span class="token punctuation">]</span><span class="token punctuation">)</span>

		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> headerProcCh <span class="token operator">&lt;-</span> process<span class="token punctuation">:</span>
			log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Pre-scheduled new headers"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>process<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"from"</span><span class="token punctuation">,</span> process<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Number<span class="token punctuation">)</span>
			q<span class="token punctuation">.</span>headerProced <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>process<span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>headerTaskPool<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		q<span class="token punctuation">.</span>headerContCh <span class="token operator">&lt;-</span> <span class="token boolean">false</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>大致逻辑和deliver类似，参数headers是收到的数据。先判断收到的消息是否符合我们要请求的。先从headerPendPool取出对应request，然后判断headers的长度是否为192，是的话验证headers中第一个是否是请求的起始位置，再验证最后一个是否符合要求，二者任何一个不合要求就将accepted置为false。接下来就是验证这一组head是否有关联，一个是序号上的一个是父hash是否对应。对于accepted为false时，在headerPeerMiss标记对应peer的相应head无效，并将相应再次放入headerTaskQueue中并返回错误。对于结果正确的情况，现将headers复制到headerResults，然后从headerTaskPool删除。接着计算已经准备好的head数ready，然后将其发送到headerProcCh触发downloader中processHeaders的相关逻辑。接着调整headerProced的值，它表示已经处理的head数量。</p>
<h2 id="ExpireXxx"><a href="#ExpireXxx" class="headerlink" title="ExpireXxx"></a>ExpireXxx</h2><p>也是一组方法，用于在downloader的fetchParts使用，</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">ExpireHeaders</span><span class="token punctuation">(</span>timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token punctuation">&#123;</span>
	q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> q<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> q<span class="token punctuation">.</span>headerPendPool<span class="token punctuation">,</span> q<span class="token punctuation">.</span>headerTaskQueue<span class="token punctuation">,</span> headerTimeoutMeter<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">ExpireBodies</span><span class="token punctuation">(</span>timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token punctuation">&#123;</span>
	q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> q<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> q<span class="token punctuation">.</span>blockPendPool<span class="token punctuation">,</span> q<span class="token punctuation">.</span>blockTaskQueue<span class="token punctuation">,</span> bodyTimeoutMeter<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">ExpireReceipts</span><span class="token punctuation">(</span>timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token punctuation">&#123;</span>
	q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> q<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> q<span class="token punctuation">.</span>receiptPendPool<span class="token punctuation">,</span> q<span class="token punctuation">.</span>receiptTaskQueue<span class="token punctuation">,</span> receiptTimeoutMeter<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>都是调用了expire方法</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">expire</span><span class="token punctuation">(</span>timeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> pendPool <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>fetchRequest<span class="token punctuation">,</span> taskQueue <span class="token operator">*</span>prque<span class="token punctuation">.</span>Prque<span class="token punctuation">,</span> timeoutMeter metrics<span class="token punctuation">.</span>Meter<span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token punctuation">&#123;</span>
	expiries <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> id<span class="token punctuation">,</span> request <span class="token operator">:=</span> <span class="token keyword">range</span> pendPool <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token operator">></span> timeout <span class="token punctuation">&#123;</span>
			timeoutMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
l
			<span class="token keyword">if</span> request<span class="token punctuation">.</span>From <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				taskQueue<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>From<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">int64</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>From<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> header <span class="token operator">:=</span> <span class="token keyword">range</span> request<span class="token punctuation">.</span>Headers <span class="token punctuation">&#123;</span>
				taskQueue<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">int64</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			expiries<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>Headers<span class="token punctuation">)</span>

			<span class="token function">delete</span><span class="token punctuation">(</span>pendPool<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> expiries
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主要是遍历pendPool，分别对应headerPendPool、blockPendPool和receiptPendPool，这些pool都保存着等待处理的request。遍历每个request看是否超时，对于超时的请求将其请求的head再次放入taskQueue等待后续处理，并按id将其请求的heads数存入expiries，然后将其从pendPool移除，最后返回expiries。</p>
<h2 id="CancelXxx"><a href="#CancelXxx" class="headerlink" title="CancelXxx"></a>CancelXxx</h2><p>也是一组方法，用于在downloader的fetchParts使用，</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">CancelHeaders</span><span class="token punctuation">(</span>request <span class="token operator">*</span>fetchRequest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	q<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> q<span class="token punctuation">.</span>headerTaskQueue<span class="token punctuation">,</span> q<span class="token punctuation">.</span>headerPendPool<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">CancelBodies</span><span class="token punctuation">(</span>request <span class="token operator">*</span>fetchRequest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	q<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> q<span class="token punctuation">.</span>blockTaskQueue<span class="token punctuation">,</span> q<span class="token punctuation">.</span>blockPendPool<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">CancelReceipts</span><span class="token punctuation">(</span>request <span class="token operator">*</span>fetchRequest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	q<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> q<span class="token punctuation">.</span>receiptTaskQueue<span class="token punctuation">,</span> q<span class="token punctuation">.</span>receiptPendPool<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>都调用了cancel方法</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">cancel</span><span class="token punctuation">(</span>request <span class="token operator">*</span>fetchRequest<span class="token punctuation">,</span> taskQueue <span class="token operator">*</span>prque<span class="token punctuation">.</span>Prque<span class="token punctuation">,</span> pendPool <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>fetchRequest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> request<span class="token punctuation">.</span>From <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		taskQueue<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>From<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">int64</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>From<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> header <span class="token operator">:=</span> <span class="token keyword">range</span> request<span class="token punctuation">.</span>Headers <span class="token punctuation">&#123;</span>
		taskQueue<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">int64</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">delete</span><span class="token punctuation">(</span>pendPool<span class="token punctuation">,</span> request<span class="token punctuation">.</span>Peer<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主要主要是取消某个request，但是请求的head还要重新放入taskQueue等待下次处理，最后将其从pendPool移除。</p>
<h2 id="RetrieveHeaders"><a href="#RetrieveHeaders" class="headerlink" title="RetrieveHeaders"></a>RetrieveHeaders</h2><p>这个方法出现在fillHeaderSkeleton最后，他返回结果重置状态为下一次ScheduleSkeleton做准备</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>q <span class="token operator">*</span>queue<span class="token punctuation">)</span> <span class="token function">RetrieveHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> q<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	headers<span class="token punctuation">,</span> proced <span class="token operator">:=</span> q<span class="token punctuation">.</span>headerResults<span class="token punctuation">,</span> q<span class="token punctuation">.</span>headerProced
	q<span class="token punctuation">.</span>headerResults<span class="token punctuation">,</span> q<span class="token punctuation">.</span>headerProced <span class="token operator">=</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token number">0</span>

	<span class="token keyword">return</span> headers<span class="token punctuation">,</span> proced
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="statesync-go"><a href="#statesync-go" class="headerlink" title="statesync.go"></a>statesync.go</h1><p>主要是用来同步状态信息。第一次被创建是在downloader的processFastSyncContent方法中，调用了syncState方法</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">syncState</span><span class="token punctuation">(</span>root common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span> <span class="token operator">*</span>stateSync <span class="token punctuation">&#123;</span>
	s <span class="token operator">:=</span> <span class="token function">newStateSync</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> root<span class="token punctuation">)</span>
	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> d<span class="token punctuation">.</span>stateSyncStart <span class="token operator">&lt;-</span> s<span class="token punctuation">:</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>quitCh<span class="token punctuation">:</span>
		s<span class="token punctuation">.</span>err <span class="token operator">=</span> errCancelStateFetch
		<span class="token function">close</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>done<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> s
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">newStateSync</span><span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">,</span> root common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span> <span class="token operator">*</span>stateSync <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>stateSync<span class="token punctuation">&#123;</span>
		d<span class="token punctuation">:</span>       d<span class="token punctuation">,</span>
		sched<span class="token punctuation">:</span>   state<span class="token punctuation">.</span><span class="token function">NewStateSync</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> d<span class="token punctuation">.</span>stateDB<span class="token punctuation">)</span><span class="token punctuation">,</span>
		keccak<span class="token punctuation">:</span>  sha3<span class="token punctuation">.</span><span class="token function">NewLegacyKeccak256</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		tasks<span class="token punctuation">:</span>   <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>stateTask<span class="token punctuation">)</span><span class="token punctuation">,</span>
		deliver<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>stateReq<span class="token punctuation">)</span><span class="token punctuation">,</span>
		cancel<span class="token punctuation">:</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		done<span class="token punctuation">:</span>    <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建过程中有一个sched成员，是一个trie.Sync对象，构造过程如下</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// go-ethereum\core\state\sync.go</span>
<span class="token keyword">func</span> <span class="token function">NewStateSync</span><span class="token punctuation">(</span>root common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> database trie<span class="token punctuation">.</span>DatabaseReader<span class="token punctuation">)</span> <span class="token operator">*</span>trie<span class="token punctuation">.</span>Sync <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> syncer <span class="token operator">*</span>trie<span class="token punctuation">.</span>Sync
	callback <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>leaf <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> parent common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">var</span> obj Account
		<span class="token keyword">if</span> err <span class="token operator">:=</span> rlp<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>leaf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
		syncer<span class="token punctuation">.</span><span class="token function">AddSubTrie</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>Root<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> parent<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		syncer<span class="token punctuation">.</span><span class="token function">AddRawEntry</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>CodeHash<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	syncer <span class="token operator">=</span> trie<span class="token punctuation">.</span><span class="token function">NewSync</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> database<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
	<span class="token keyword">return</span> syncer
<span class="token punctuation">&#125;</span>

<span class="token comment">// go-ethereum\trie\sync.go</span>
<span class="token keyword">func</span> <span class="token function">NewSync</span><span class="token punctuation">(</span>root common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> database DatabaseReader<span class="token punctuation">,</span> callback LeafCallback<span class="token punctuation">)</span> <span class="token operator">*</span>Sync <span class="token punctuation">&#123;</span>
	ts <span class="token operator">:=</span> <span class="token operator">&amp;</span>Sync<span class="token punctuation">&#123;</span>
		database<span class="token punctuation">:</span> database<span class="token punctuation">,</span>
		membatch<span class="token punctuation">:</span> <span class="token function">newSyncMemBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		requests<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>request<span class="token punctuation">)</span><span class="token punctuation">,</span>
		queue<span class="token punctuation">:</span>    prque<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	ts<span class="token punctuation">.</span><span class="token function">AddSubTrie</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
	<span class="token keyword">return</span> ts
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后调用trie的NewSync方法构造了一个Sync，Sync是用于同步状态树的。最后的AddSubTrie如下</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Sync<span class="token punctuation">)</span> <span class="token function">AddSubTrie</span><span class="token punctuation">(</span>root common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> depth <span class="token builtin">int</span><span class="token punctuation">,</span> parent common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> callback LeafCallback<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> root <span class="token operator">==</span> emptyRoot <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> s<span class="token punctuation">.</span>membatch<span class="token punctuation">.</span>batch<span class="token punctuation">[</span>root<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	key <span class="token operator">:=</span> root<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	blob<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> s<span class="token punctuation">.</span>database<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	<span class="token keyword">if</span> local<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">decodeNode</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> blob<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> local <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	req <span class="token operator">:=</span> <span class="token operator">&amp;</span>request<span class="token punctuation">&#123;</span>
		hash<span class="token punctuation">:</span>     root<span class="token punctuation">,</span>
		depth<span class="token punctuation">:</span>    depth<span class="token punctuation">,</span>
		callback<span class="token punctuation">:</span> callback<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> parent <span class="token operator">!=</span> <span class="token punctuation">(</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		ancestor <span class="token operator">:=</span> s<span class="token punctuation">.</span>requests<span class="token punctuation">[</span>parent<span class="token punctuation">]</span>
		<span class="token keyword">if</span> ancestor <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"sub-trie ancestor not found: %x"</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		ancestor<span class="token punctuation">.</span>deps<span class="token operator">++</span>
		req<span class="token punctuation">.</span>parents <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>parents<span class="token punctuation">,</span> ancestor<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	s<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在开始状态下构建了request，然后调用schedule</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Sync<span class="token punctuation">)</span> <span class="token function">schedule</span><span class="token punctuation">(</span>req <span class="token operator">*</span>request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> old<span class="token punctuation">,</span> ok <span class="token operator">:=</span> s<span class="token punctuation">.</span>requests<span class="token punctuation">[</span>req<span class="token punctuation">.</span>hash<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
		old<span class="token punctuation">.</span>parents <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>old<span class="token punctuation">.</span>parents<span class="token punctuation">,</span> req<span class="token punctuation">.</span>parents<span class="token operator">...</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	s<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>hash<span class="token punctuation">,</span> <span class="token function">int64</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>depth<span class="token punctuation">)</span><span class="token punctuation">)</span>
	s<span class="token punctuation">.</span>requests<span class="token punctuation">[</span>req<span class="token punctuation">.</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> req
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>也是通过将请求放入队列中进行调度工作。</p>
<p>回到syncState，sched创建后就向stateSyncStart发送了消息，内容就是StateSync对象。</p>
<h2 id="stateFetcher"><a href="#stateFetcher" class="headerlink" title="stateFetcher"></a>stateFetcher</h2><p>在downloader的New方法最后启动了两个goroutine方法，第二个就是stateFetcher方法。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">stateFetcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> s <span class="token operator">:=</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>stateSyncStart<span class="token punctuation">:</span>
			<span class="token keyword">for</span> next <span class="token operator">:=</span> s<span class="token punctuation">;</span> next <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> <span class="token punctuation">&#123;</span>
				next <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">runStateSync</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>stateCh<span class="token punctuation">:</span>
			<span class="token comment">// Ignore state responses while no sync is running.</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>quitCh<span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一个go-select结构，前面syncState中触发了这里的逻辑，调用了runStateSync方法</p>
<h2 id="runStateSync"><a href="#runStateSync" class="headerlink" title="runStateSync"></a>runStateSync</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Downloader<span class="token punctuation">)</span> <span class="token function">runStateSync</span><span class="token punctuation">(</span>s <span class="token operator">*</span>stateSync<span class="token punctuation">)</span> <span class="token operator">*</span>stateSync <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		active   <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>stateReq<span class="token punctuation">)</span> <span class="token comment">// Currently in-flight requests</span>
		finished <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>stateReq                  <span class="token comment">// Completed or failed requests</span>
		timeout  <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>stateReq<span class="token punctuation">)</span>       <span class="token comment">// Timed out active requests</span>
	<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> req <span class="token operator">:=</span> <span class="token keyword">range</span> active <span class="token punctuation">&#123;</span>
			req<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			req<span class="token punctuation">.</span>peer<span class="token punctuation">.</span><span class="token function">SetNodeDataIdle</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> s<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> s<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	peerDrop <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
	peerSub <span class="token operator">:=</span> s<span class="token punctuation">.</span>d<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">SubscribePeerDrops</span><span class="token punctuation">(</span>peerDrop<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> peerSub<span class="token punctuation">.</span><span class="token function">Unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">var</span> <span class="token punctuation">(</span>
			deliverReq   <span class="token operator">*</span>stateReq
			deliverReqCh <span class="token keyword">chan</span> <span class="token operator">*</span>stateReq
		<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>finished<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			deliverReq <span class="token operator">=</span> finished<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
			deliverReqCh <span class="token operator">=</span> s<span class="token punctuation">.</span>deliver
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> next <span class="token operator">:=</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>stateSyncStart<span class="token punctuation">:</span>
			<span class="token keyword">return</span> next

		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>s<span class="token punctuation">.</span>done<span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>

		<span class="token keyword">case</span> deliverReqCh <span class="token operator">&lt;-</span> deliverReq<span class="token punctuation">:</span>
			<span class="token function">copy</span><span class="token punctuation">(</span>finished<span class="token punctuation">,</span> finished<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
			finished<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>finished<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">nil</span>
			finished <span class="token operator">=</span> finished<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>finished<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

		<span class="token keyword">case</span> pack <span class="token operator">:=</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>stateCh<span class="token punctuation">:</span>
			req <span class="token operator">:=</span> active<span class="token punctuation">[</span>pack<span class="token punctuation">.</span><span class="token function">PeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
			<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Unrequested node data"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> pack<span class="token punctuation">.</span><span class="token function">PeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"len"</span><span class="token punctuation">,</span> pack<span class="token punctuation">.</span><span class="token function">Items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">&#125;</span>
			req<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			req<span class="token punctuation">.</span>response <span class="token operator">=</span> pack<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>statePack<span class="token punctuation">)</span><span class="token punctuation">.</span>states

			finished <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>finished<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>active<span class="token punctuation">,</span> pack<span class="token punctuation">.</span><span class="token function">PeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token keyword">case</span> p <span class="token operator">:=</span> <span class="token operator">&lt;-</span>peerDrop<span class="token punctuation">:</span>
			req <span class="token operator">:=</span> active<span class="token punctuation">[</span>p<span class="token punctuation">.</span>id<span class="token punctuation">]</span>
			<span class="token keyword">if</span> req <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">&#125;</span>
			req<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			req<span class="token punctuation">.</span>dropped <span class="token operator">=</span> <span class="token boolean">true</span>

			finished <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>finished<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>active<span class="token punctuation">,</span> p<span class="token punctuation">.</span>id<span class="token punctuation">)</span>

		<span class="token keyword">case</span> req <span class="token operator">:=</span> <span class="token operator">&lt;-</span>timeout<span class="token punctuation">:</span>
			<span class="token keyword">if</span> active<span class="token punctuation">[</span>req<span class="token punctuation">.</span>peer<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">!=</span> req <span class="token punctuation">&#123;</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">&#125;</span>
			finished <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>finished<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>active<span class="token punctuation">,</span> req<span class="token punctuation">.</span>peer<span class="token punctuation">.</span>id<span class="token punctuation">)</span>

		<span class="token keyword">case</span> req <span class="token operator">:=</span> <span class="token operator">&lt;-</span>d<span class="token punctuation">.</span>trackStateReq<span class="token punctuation">:</span>
			<span class="token keyword">if</span> old <span class="token operator">:=</span> active<span class="token punctuation">[</span>req<span class="token punctuation">.</span>peer<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span> old <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Busy peer assigned new state fetch"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> old<span class="token punctuation">.</span>peer<span class="token punctuation">.</span>id<span class="token punctuation">)</span>

				<span class="token comment">// Make sure the previous one doesn't get siletly lost</span>
				old<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				old<span class="token punctuation">.</span>dropped <span class="token operator">=</span> <span class="token boolean">true</span>

				finished <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>finished<span class="token punctuation">,</span> old<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			req<span class="token punctuation">.</span>timer <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">AfterFunc</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>timeout<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">case</span> timeout <span class="token operator">&lt;-</span> req<span class="token punctuation">:</span>
				<span class="token keyword">case</span> <span class="token operator">&lt;-</span>s<span class="token punctuation">.</span>done<span class="token punctuation">:</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
			active<span class="token punctuation">[</span>req<span class="token punctuation">.</span>peer<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> req
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里直接调用了run方法，是在一个单独的goroutine中，随后有一个for-select结构等待逻辑触发。run内容如下</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>stateSync<span class="token punctuation">)</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	s<span class="token punctuation">.</span>err <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">close</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>done<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>stateSync<span class="token punctuation">)</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	newPeer <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>peerConnection<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
	peerSub <span class="token operator">:=</span> s<span class="token punctuation">.</span>d<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">SubscribeNewPeers</span><span class="token punctuation">(</span>newPeer<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> peerSub<span class="token punctuation">.</span><span class="token function">Unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		cerr <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			err <span class="token operator">=</span> cerr
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> s<span class="token punctuation">.</span>sched<span class="token punctuation">.</span><span class="token function">Pending</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
		s<span class="token punctuation">.</span><span class="token function">assignTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>newPeer<span class="token punctuation">:</span>

		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>s<span class="token punctuation">.</span>cancel<span class="token punctuation">:</span>
			<span class="token keyword">return</span> errCancelStateFetch

		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>s<span class="token punctuation">.</span>d<span class="token punctuation">.</span>cancelCh<span class="token punctuation">:</span>
			<span class="token keyword">return</span> errCancelStateFetch

		<span class="token keyword">case</span> req <span class="token operator">:=</span> <span class="token operator">&lt;-</span>s<span class="token punctuation">.</span>deliver<span class="token punctuation">:</span>
			log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Received node data response"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>peer<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"dropped"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>dropped<span class="token punctuation">,</span> <span class="token string">"timeout"</span><span class="token punctuation">,</span> <span class="token operator">!</span>req<span class="token punctuation">.</span>dropped <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span><span class="token function">timedOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>req<span class="token punctuation">.</span>dropped <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span><span class="token function">timedOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Stalling state sync, dropping peer"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>peer<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
				s<span class="token punctuation">.</span>d<span class="token punctuation">.</span><span class="token function">dropPeer</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>peer<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			delivered<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Node data write error"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">&#125;</span>
			req<span class="token punctuation">.</span>peer<span class="token punctuation">.</span><span class="token function">SetNodeDataIdle</span><span class="token punctuation">(</span>delivered<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先调用了sched的Pending方法，这个方法返回requests的长度，requests在schedule时被填充方法，如果大于0表示有等待调度的任务。之后进入循环，调用commit，最开始没有可以提交的，直接返回nil。接着调用assignTasks</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>stateSync<span class="token punctuation">)</span> <span class="token function">assignTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	peers<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> s<span class="token punctuation">.</span>d<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">NodeDataIdlePeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> peers <span class="token punctuation">&#123;</span>
		<span class="token builtin">cap</span> <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">NodeDataCapacity</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>d<span class="token punctuation">.</span><span class="token function">requestRTT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		req <span class="token operator">:=</span> <span class="token operator">&amp;</span>stateReq<span class="token punctuation">&#123;</span>peer<span class="token punctuation">:</span> p<span class="token punctuation">,</span> timeout<span class="token punctuation">:</span> s<span class="token punctuation">.</span>d<span class="token punctuation">.</span><span class="token function">requestTTL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
		s<span class="token punctuation">.</span><span class="token function">fillTasks</span><span class="token punctuation">(</span><span class="token builtin">cap</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span>

		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			req<span class="token punctuation">.</span>peer<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Requesting new batch of data"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"state"</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> s<span class="token punctuation">.</span>d<span class="token punctuation">.</span>trackStateReq <span class="token operator">&lt;-</span> req<span class="token punctuation">:</span>
				req<span class="token punctuation">.</span>peer<span class="token punctuation">.</span><span class="token function">FetchNodeData</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>items<span class="token punctuation">)</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>s<span class="token punctuation">.</span>cancel<span class="token punctuation">:</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>s<span class="token punctuation">.</span>d<span class="token punctuation">.</span>cancelCh<span class="token punctuation">:</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>stateSync<span class="token punctuation">)</span> <span class="token function">fillTasks</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> req <span class="token operator">*</span>stateReq<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>tasks<span class="token punctuation">)</span> <span class="token operator">&lt;</span> n <span class="token punctuation">&#123;</span>
		<span class="token builtin">new</span> <span class="token operator">:=</span> s<span class="token punctuation">.</span>sched<span class="token punctuation">.</span><span class="token function">Missing</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> hash <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token builtin">new</span> <span class="token punctuation">&#123;</span>
			s<span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>stateTask<span class="token punctuation">&#123;</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	req<span class="token punctuation">.</span>items <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
	req<span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>stateTask<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
	<span class="token keyword">for</span> hash<span class="token punctuation">,</span> t <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>tasks <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token operator">==</span> n <span class="token punctuation">&#123;</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> t<span class="token punctuation">.</span>attempts<span class="token punctuation">[</span>req<span class="token punctuation">.</span>peer<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">&#125;</span>
		t<span class="token punctuation">.</span>attempts<span class="token punctuation">[</span>req<span class="token punctuation">.</span>peer<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
		req<span class="token punctuation">.</span>items <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>items<span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
		req<span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> t
		<span class="token function">delete</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>tasks<span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>NodeDataIdlePeers获取对应状态下空闲的peer，之后遍历所有idle的peer，然后构造请求，fillTasks中先调用了sched的Missing方法，这个方法将sched中schedule方法存入队列的请求取出。取出后将hash存入tasks，随后填充请求的items与tasks。一个请求构造完之后，在assignTasks的select结构中赋值给trackStateReq触发runStateSync里的逻辑。同时又调用了peer的FetchNodeData方法，FetchNodeData就是调用peer的RequestNodeData方法，发送GetNodeDataMsg方法。</p>
<p>发送GetNodeDataMsg消息后，对方会回复NodeDataMsg消息，这是调用downloader的DeliverNodeData方法。这个方法只是将接收到的数据发送到destCh，也就是d.stateCh，同样触发runStateSyn里逻辑。</p>
<p>由于刚才的run和loop都是再独立goroutine中运行的，所以runStateSync正常进入select结构阻塞。</p>
<p>首先触发trackStateReq逻辑，这个是追踪请求的，首先看该peer是否请求过，没有的话设置一个定时器，并将该请求按id存入active中，同时也制定了超时的逻辑。</p>
<p>其次触发的是d.stateCh，也是先检测是否是之前请求的，是的话停止定时器，然后填充请求的响应字段，然后向finished追加内容，一次循环结束，下一次循环开始时，取finished第一个内容，在select中触发deliverReqCh逻辑，由于deliverReqCh等于s.deliver，所以也触发loop中的逻辑，这里先调用process方法处理响应的内容。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>stateSync<span class="token punctuation">)</span> <span class="token function">process</span><span class="token punctuation">(</span>req <span class="token operator">*</span>stateReq<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	duplicate<span class="token punctuation">,</span> unexpected<span class="token punctuation">,</span> successful <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>

	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span>start time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> duplicate <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> unexpected <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			s<span class="token punctuation">.</span><span class="token function">updateStats</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> duplicate<span class="token punctuation">,</span> unexpected<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> blob <span class="token operator">:=</span> <span class="token keyword">range</span> req<span class="token punctuation">.</span>response <span class="token punctuation">&#123;</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">processNodeData</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
		<span class="token keyword">switch</span> err <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
			s<span class="token punctuation">.</span>numUncommitted<span class="token operator">++</span>
			s<span class="token punctuation">.</span>bytesUncommitted <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
			successful<span class="token operator">++</span>
		<span class="token keyword">case</span> trie<span class="token punctuation">.</span>ErrNotRequested<span class="token punctuation">:</span>
			unexpected<span class="token operator">++</span>
		<span class="token keyword">case</span> trie<span class="token punctuation">.</span>ErrAlreadyProcessed<span class="token punctuation">:</span>
			duplicate<span class="token operator">++</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> successful<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid state node %s: %v"</span><span class="token punctuation">,</span> hash<span class="token punctuation">.</span><span class="token function">TerminalString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> req<span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>hash<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>tasks<span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	npeers <span class="token operator">:=</span> s<span class="token punctuation">.</span>d<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> hash<span class="token punctuation">,</span> task <span class="token operator">:=</span> <span class="token keyword">range</span> req<span class="token punctuation">.</span>tasks <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>response<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> req<span class="token punctuation">.</span><span class="token function">timedOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>attempts<span class="token punctuation">,</span> req<span class="token punctuation">.</span>peer<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>attempts<span class="token punctuation">)</span> <span class="token operator">>=</span> npeers <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> successful<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"state node %s failed with all peers (%d tries, %d peers)"</span><span class="token punctuation">,</span> hash<span class="token punctuation">.</span><span class="token function">TerminalString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>attempts<span class="token punctuation">)</span><span class="token punctuation">,</span> npeers<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		s<span class="token punctuation">.</span>tasks<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> task
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> successful<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>stateSync<span class="token punctuation">)</span> <span class="token function">processNodeData</span><span class="token punctuation">(</span>blob <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	res <span class="token operator">:=</span> trie<span class="token punctuation">.</span>SyncResult<span class="token punctuation">&#123;</span>Data<span class="token punctuation">:</span> blob<span class="token punctuation">&#125;</span>
	s<span class="token punctuation">.</span>keccak<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	s<span class="token punctuation">.</span>keccak<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
	s<span class="token punctuation">.</span>keccak<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>Hash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	committed<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>sched<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>trie<span class="token punctuation">.</span>SyncResult<span class="token punctuation">&#123;</span>res<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> committed<span class="token punctuation">,</span> res<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> err
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于响应可能是多组数据，所以遍历每一组数据，调用processNodeData进行处理，processNodeData主要是构建SyncResult以便sched处理，sched的process方法主要就是将数据解析为树中节点，然后在递归的去请求节点的孩子，直到一棵树建立，请求的方法还是构建请求放入requests等待调度，这里不再详细说明。总之经过processNodeData一次响应的数据被处理，如果没有错误，numUncommitted和bytesUncommitted对应增加，然后将成功的请求从tasks中移除，未成功的放回队列等待下次请求。回到loop中对于逻辑，处理完之后，没有错的话修改对应peer状态信息。</p>
<blockquote>
<p>题图来自unsplash：<a target="_blank" rel="noopener" href="https://unsplash.com/photos/3Xj6BntfsIU">https://unsplash.com/photos/3Xj6BntfsIU</a></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag"><i class="fa fa-tag"></i> 区块链</a>
              <a href="/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" rel="tag"><i class="fa fa-tag"></i> 以太坊</a>
              <a href="/tags/go/" rel="tag"><i class="fa fa-tag"></i> go</a>
              <a href="/tags/go-ethereum/" rel="tag"><i class="fa fa-tag"></i> go-ethereum</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/05/16/go-ethereum%E4%B8%ADeth-downloader%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A01/" rel="prev" title="go-ethereum中eth-downloader源码学习（一）">
                  <i class="fa fa-chevron-left"></i> go-ethereum中eth-downloader源码学习（一）
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/05/17/go-ethereum%E4%B8%ADcore-state%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" rel="next" title="go-ethereum中core-state源码学习">
                  go-ethereum中core-state源码学习 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">AmorFati</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">633k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:36</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
