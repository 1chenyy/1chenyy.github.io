<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">

<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CConsolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="article">
<meta property="og:title" content="go-ethereum中eth-Fetcher源码学习">
<meta property="og:url" content="http://example.com/2019/05/10/go-ethereum%E4%B8%ADeth-Fetcher%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="AmorFati">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/andrew-coelho-60428-unsplash.jpg">
<meta property="article:published_time" content="2019-05-10T05:35:03.000Z">
<meta property="article:modified_time" content="2021-11-17T13:54:30.489Z">
<meta property="article:author" content="AmorFati">
<meta property="article:tag" content="区块链">
<meta property="article:tag" content="以太坊">
<meta property="article:tag" content="go">
<meta property="article:tag" content="go-ethereum">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/andrew-coelho-60428-unsplash.jpg">


<link rel="canonical" href="http://example.com/2019/05/10/go-ethereum%E4%B8%ADeth-Fetcher%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2019/05/10/go-ethereum%E4%B8%ADeth-Fetcher%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/","path":"2019/05/10/go-ethereum中eth-Fetcher源码学习/","title":"go-ethereum中eth-Fetcher源码学习"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>go-ethereum中eth-Fetcher源码学习 | AmorFati</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">AmorFati</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">风吹过窗前的书，又翻过一页</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.</span> <span class="nav-text">数据结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#New"><span class="nav-number">2.</span> <span class="nav-text">New</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Start-amp-loop"><span class="nav-number">3.</span> <span class="nav-text">Start &amp; loop</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FilterHeaders"><span class="nav-number">4.</span> <span class="nav-text">FilterHeaders</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FilterBodies"><span class="nav-number">5.</span> <span class="nav-text">FilterBodies</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Notify"><span class="nav-number">6.</span> <span class="nav-text">Notify</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Enqueue"><span class="nav-number">7.</span> <span class="nav-text">Enqueue</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#fetchTimer"><span class="nav-number">8.</span> <span class="nav-text">fetchTimer</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#completeTimer"><span class="nav-number">9.</span> <span class="nav-text">completeTimer</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#insert"><span class="nav-number">10.</span> <span class="nav-text">insert</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#rescheduleFetch"><span class="nav-number">11.</span> <span class="nav-text">rescheduleFetch</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#forgetHash"><span class="nav-number">12.</span> <span class="nav-text">forgetHash</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#stop"><span class="nav-number">13.</span> <span class="nav-text">stop</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="AmorFati"
      src="/assets/img/icon.jpg">
  <p class="site-author-name" itemprop="name">AmorFati</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/1chenyy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;1chenyy" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:henyang4346@foxmail.com" title="E-Mail → mailto:henyang4346@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/52c1bec4559c" title="简书 → https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;52c1bec4559c" rel="noopener" target="_blank"><i class="fa fa-globe fa-fw"></i>简书</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/10/go-ethereum%E4%B8%ADeth-Fetcher%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/icon.jpg">
      <meta itemprop="name" content="AmorFati">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmorFati">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          go-ethereum中eth-Fetcher源码学习
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-10 13:35:03" itemprop="dateCreated datePublished" datetime="2019-05-10T13:35:03+08:00">2019-05-10</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-11-17 21:54:30" itemprop="dateModified" datetime="2021-11-17T21:54:30+08:00">2021-11-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go-ethereum%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">go-ethereum源码学习</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>19k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>17 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/andrew-coelho-60428-unsplash.jpg"></p>
<span id="more"></span>
<h1 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h1><p>fetcher负责收集来自各个对等点的块通知并进行处理。前面在介绍ProtocolManager时就出现过，我们先看数据结构</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> announce <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	hash   common<span class="token punctuation">.</span>Hash   <span class="token comment">// Hash of the block being announced</span>
	number <span class="token builtin">uint64</span>        <span class="token comment">// Number of the block being announced (0 = unknown | old protocol)</span>
	header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header <span class="token comment">// Header of the block partially reassembled (new protocol)</span>
	time   time<span class="token punctuation">.</span>Time     <span class="token comment">// Timestamp of the announcement</span>

	origin <span class="token builtin">string</span> <span class="token comment">// Identifier of the peer originating the notification</span>

	fetchHeader headerRequesterFn <span class="token comment">// Fetcher function to retrieve the header of an announced block</span>
	fetchBodies bodyRequesterFn   <span class="token comment">// Fetcher function to retrieve the body of an announced block</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>announce是一个通知，表示网络中有新块出现。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> inject <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	origin <span class="token builtin">string</span>
	block  <span class="token operator">*</span>types<span class="token punctuation">.</span>Block
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>inject表示要插入一个区块。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Fetcher <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// Various event channels</span>
	notify <span class="token keyword">chan</span> <span class="token operator">*</span>announce
	inject <span class="token keyword">chan</span> <span class="token operator">*</span>inject

	headerFilter <span class="token keyword">chan</span> <span class="token keyword">chan</span> <span class="token operator">*</span>headerFilterTask
	bodyFilter   <span class="token keyword">chan</span> <span class="token keyword">chan</span> <span class="token operator">*</span>bodyFilterTask

	done <span class="token keyword">chan</span> common<span class="token punctuation">.</span>Hash
	quit <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

	<span class="token comment">// Announce states</span>
	announces  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span>              <span class="token comment">// Per peer announce counts to prevent memory exhaustion</span>
	announced  <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>announce <span class="token comment">// Announced blocks, scheduled for fetching</span>
	fetching   <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>announce   <span class="token comment">// Announced blocks, currently fetching</span>
	fetched    <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>announce <span class="token comment">// Blocks with headers fetched, scheduled for body retrieval</span>
	completing <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>announce   <span class="token comment">// Blocks with headers, currently body-completing</span>

	<span class="token comment">// Block cache</span>
	queue  <span class="token operator">*</span>prque<span class="token punctuation">.</span>Prque            <span class="token comment">// Queue containing the import operations (block number sorted)</span>
	queues <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span>          <span class="token comment">// Per peer block counts to prevent memory exhaustion</span>
	queued <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>inject <span class="token comment">// Set of already queued blocks (to dedupe imports)</span>

	<span class="token comment">// Callbacks</span>
	getBlock       blockRetrievalFn   <span class="token comment">// Retrieves a block from the local chain</span>
	verifyHeader   headerVerifierFn   <span class="token comment">// Checks if a block's headers have a valid proof of work</span>
	broadcastBlock blockBroadcasterFn <span class="token comment">// Broadcasts a block to connected peers</span>
	chainHeight    chainHeightFn      <span class="token comment">// Retrieves the current chain's height</span>
	insertChain    chainInsertFn      <span class="token comment">// Injects a batch of blocks into the chain</span>
	dropPeer       peerDropFn         <span class="token comment">// Drops a peer for misbehaving</span>

	<span class="token comment">// Testing hooks</span>
	announceChangeHook <span class="token keyword">func</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token comment">// Method to call upon adding or deleting a hash from the announce list</span>
	queueChangeHook    <span class="token keyword">func</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token comment">// Method to call upon adding or deleting a block from the import queue</span>
	fetchingHook       <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span>     <span class="token comment">// Method to call upon starting a block (eth/61) or header (eth/62) fetch</span>
	completingHook     <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span>     <span class="token comment">// Method to call upon starting a block body fetch (eth/62)</span>
	importedHook       <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">)</span>      <span class="token comment">// Method to call upon successful block import (both eth/61 and eth/62)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="New"><a href="#New" class="headerlink" title="New"></a>New</h1><p>在创建ProtocolManager时使用了NewProtocolManager方法，在最后使用fetcher的new方法创建了一个fetcher：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">manager<span class="token punctuation">.</span>fetcher <span class="token operator">=</span> fetcher<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>blockchain<span class="token punctuation">.</span>GetBlockByHash<span class="token punctuation">,</span> validator<span class="token punctuation">,</span> manager<span class="token punctuation">.</span>BroadcastBlock<span class="token punctuation">,</span> heighter<span class="token punctuation">,</span> inserter<span class="token punctuation">,</span> manager<span class="token punctuation">.</span>removePeer<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>getBlock blockRetrievalFn<span class="token punctuation">,</span> verifyHeader headerVerifierFn<span class="token punctuation">,</span> broadcastBlock blockBroadcasterFn<span class="token punctuation">,</span> chainHeight chainHeightFn<span class="token punctuation">,</span> insertChain chainInsertFn<span class="token punctuation">,</span> dropPeer peerDropFn<span class="token punctuation">)</span> <span class="token operator">*</span>Fetcher <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Fetcher<span class="token punctuation">&#123;</span>
		notify<span class="token punctuation">:</span>         <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>announce<span class="token punctuation">)</span><span class="token punctuation">,</span>
		inject<span class="token punctuation">:</span>         <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>inject<span class="token punctuation">)</span><span class="token punctuation">,</span>
		headerFilter<span class="token punctuation">:</span>   <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">chan</span> <span class="token operator">*</span>headerFilterTask<span class="token punctuation">)</span><span class="token punctuation">,</span>
		bodyFilter<span class="token punctuation">:</span>     <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">chan</span> <span class="token operator">*</span>bodyFilterTask<span class="token punctuation">)</span><span class="token punctuation">,</span>
		done<span class="token punctuation">:</span>           <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span><span class="token punctuation">,</span>
		quit<span class="token punctuation">:</span>           <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		announces<span class="token punctuation">:</span>      <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		announced<span class="token punctuation">:</span>      <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>announce<span class="token punctuation">)</span><span class="token punctuation">,</span>
		fetching<span class="token punctuation">:</span>       <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>announce<span class="token punctuation">)</span><span class="token punctuation">,</span>
		fetched<span class="token punctuation">:</span>        <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>announce<span class="token punctuation">)</span><span class="token punctuation">,</span>
		completing<span class="token punctuation">:</span>     <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>announce<span class="token punctuation">)</span><span class="token punctuation">,</span>
		queue<span class="token punctuation">:</span>          prque<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		queues<span class="token punctuation">:</span>         <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		queued<span class="token punctuation">:</span>         <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>inject<span class="token punctuation">)</span><span class="token punctuation">,</span>
		getBlock<span class="token punctuation">:</span>       getBlock<span class="token punctuation">,</span>
		verifyHeader<span class="token punctuation">:</span>   verifyHeader<span class="token punctuation">,</span>
		broadcastBlock<span class="token punctuation">:</span> broadcastBlock<span class="token punctuation">,</span>
		chainHeight<span class="token punctuation">:</span>    chainHeight<span class="token punctuation">,</span>
		insertChain<span class="token punctuation">:</span>    insertChain<span class="token punctuation">,</span>
		dropPeer<span class="token punctuation">:</span>       dropPeer<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>new方法并没有什么实际逻辑，只是创建了一个对象，只不过传入了几个方法：getBlock表示根据hash值获取对应区块，verifyHeader用来验证区块头，broadcastBlock表示给peer广播区块，chainHeight用来获取区块链高度，insertChain用来插入区块，dropPeer用来删除一个peer。</p>
<p>上面几个方法中getBlock、chainHeight和insertChain都是BlockChain的方法，verifyHeader是共识引擎的方法，broadcastBlock和dropPeer都是ProtocolManager的方法。</p>
<h1 id="Start-amp-loop"><a href="#Start-amp-loop" class="headerlink" title="Start &amp; loop"></a>Start &amp; loop</h1><p>在ProtocolManager调用Start方法启动后，会调用syncer方法，此时启动fetcher，使用的是Start方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>Fetcher<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">go</span> f<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>可见只是启动了一个goroutine去执行loop</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>Fetcher<span class="token punctuation">)</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	fetchTimer <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTimer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	completeTimer <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTimer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> hash<span class="token punctuation">,</span> announce <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>fetching <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>announce<span class="token punctuation">.</span>time<span class="token punctuation">)</span> <span class="token operator">></span> fetchTimeout <span class="token punctuation">&#123;</span>
				f<span class="token punctuation">.</span><span class="token function">forgetHash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>

		height <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">chainHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token operator">!</span>f<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			op <span class="token operator">:=</span> f<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">PopItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>inject<span class="token punctuation">)</span>
			hash <span class="token operator">:=</span> op<span class="token punctuation">.</span>block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> f<span class="token punctuation">.</span>queueChangeHook <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				f<span class="token punctuation">.</span><span class="token function">queueChangeHook</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>

			number <span class="token operator">:=</span> op<span class="token punctuation">.</span>block<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> number <span class="token operator">></span> height<span class="token operator">+</span><span class="token number">1</span> <span class="token punctuation">&#123;</span>
				f<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">int64</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> f<span class="token punctuation">.</span>queueChangeHook <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					f<span class="token punctuation">.</span><span class="token function">queueChangeHook</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>

			<span class="token keyword">if</span> number<span class="token operator">+</span>maxUncleDist <span class="token operator">&lt;</span> height <span class="token operator">||</span> f<span class="token punctuation">.</span><span class="token function">getBlock</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				f<span class="token punctuation">.</span><span class="token function">forgetBlock</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">&#125;</span>
			f<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> op<span class="token punctuation">.</span>block<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		    <span class="token operator">...</span><span class="token punctuation">.</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>既然是loop就还是一样的套路，里面有一个死循环，再嵌套一个select结构用来触发相应事件。在loop首先定义了两个定时器，不过此时定时时间都是0，也就是立即会触发。</p>
<p>然后进入for循环，先遍历所有正在fetcher的announce，对于那些fetcher超过5秒的进行抛弃。然后获取了区块链高度，接着遍历了queue队列，这是一个优先级队列，优先级是其区块编号的负数，这样编号越小的区块优先级越高。每次从队列顶端取一个，这个是inject对象，如果他的编号大于当前区块高度加一，就先放回队列然后退出循环，否则如果区块过于旧，即比当前区块高度减7还小就抛弃，最后如果合适就插入。</p>
<p>遍历完queue后进入select结构。其中一些case我们后面会陆续介绍。在loop中会通过四个map记录announce状态：announced表示等待fetch，fetching表示正在fetch；fetched表示fetch完头部等待fetch区块体；completing表示完全结束。</p>
<h1 id="FilterHeaders"><a href="#FilterHeaders" class="headerlink" title="FilterHeaders"></a>FilterHeaders</h1><p>在pm中如果收到code为BlockHeadersMsg的消息时，这个消息是在请求方发送GetBlockHeadersMsg消息后收到响应的消息，表示接收到了区块头，这时会调用fetcher的FilterHeaders方法去处理</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>Fetcher<span class="token punctuation">)</span> <span class="token function">FilterHeaders</span><span class="token punctuation">(</span>peer <span class="token builtin">string</span><span class="token punctuation">,</span> headers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> time time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Filtering headers"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> peer<span class="token punctuation">,</span> <span class="token string">"headers"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>

	filter <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>headerFilterTask<span class="token punctuation">)</span>

	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> f<span class="token punctuation">.</span>headerFilter <span class="token operator">&lt;-</span> filter<span class="token punctuation">:</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>f<span class="token punctuation">.</span>quit<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> filter <span class="token operator">&lt;-</span> <span class="token operator">&amp;</span>headerFilterTask<span class="token punctuation">&#123;</span>peer<span class="token punctuation">:</span> peer<span class="token punctuation">,</span> headers<span class="token punctuation">:</span> headers<span class="token punctuation">,</span> time<span class="token punctuation">:</span> time<span class="token punctuation">&#125;</span><span class="token punctuation">:</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>f<span class="token punctuation">.</span>quit<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> task <span class="token operator">:=</span> <span class="token operator">&lt;-</span>filter<span class="token punctuation">:</span>
		<span class="token keyword">return</span> task<span class="token punctuation">.</span>headers
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>f<span class="token punctuation">.</span>quit<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先给headerFilter赋值，触发loop中对应逻辑</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> filter <span class="token operator">:=</span> <span class="token operator">&lt;-</span>f<span class="token punctuation">.</span>headerFilter<span class="token punctuation">:</span>
	<span class="token keyword">var</span> task <span class="token operator">*</span>headerFilterTask
	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> task <span class="token operator">=</span> <span class="token operator">&lt;-</span>filter<span class="token punctuation">:</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>f<span class="token punctuation">.</span>quit<span class="token punctuation">:</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	headerFilterInMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	unknown<span class="token punctuation">,</span> incomplete<span class="token punctuation">,</span> complete <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>announce<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> header <span class="token operator">:=</span> <span class="token keyword">range</span> task<span class="token punctuation">.</span>headers <span class="token punctuation">&#123;</span>
		hash <span class="token operator">:=</span> header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token keyword">if</span> announce <span class="token operator">:=</span> f<span class="token punctuation">.</span>fetching<span class="token punctuation">[</span>hash<span class="token punctuation">]</span><span class="token punctuation">;</span> announce <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> announce<span class="token punctuation">.</span>origin <span class="token operator">==</span> task<span class="token punctuation">.</span>peer <span class="token operator">&amp;&amp;</span> f<span class="token punctuation">.</span>fetched<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> f<span class="token punctuation">.</span>completing<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> f<span class="token punctuation">.</span>queued<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> announce<span class="token punctuation">.</span>number <span class="token punctuation">&#123;</span>
				log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Invalid block number fetched"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> announce<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"announced"</span><span class="token punctuation">,</span> announce<span class="token punctuation">.</span>number<span class="token punctuation">,</span> <span class="token string">"provided"</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">)</span>
				f<span class="token punctuation">.</span><span class="token function">dropPeer</span><span class="token punctuation">(</span>announce<span class="token punctuation">.</span>origin<span class="token punctuation">)</span>
				f<span class="token punctuation">.</span><span class="token function">forgetHash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">&#125;</span>

			<span class="token keyword">if</span> f<span class="token punctuation">.</span><span class="token function">getBlock</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				announce<span class="token punctuation">.</span>header <span class="token operator">=</span> header
				announce<span class="token punctuation">.</span>time <span class="token operator">=</span> task<span class="token punctuation">.</span>time

				<span class="token keyword">if</span> header<span class="token punctuation">.</span>TxHash <span class="token operator">==</span> types<span class="token punctuation">.</span><span class="token function">DeriveSha</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>Transactions<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> header<span class="token punctuation">.</span>UncleHash <span class="token operator">==</span> types<span class="token punctuation">.</span><span class="token function">CalcUncleHash</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Block empty, skipping body retrieval"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> announce<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

					block <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">NewBlockWithHeader</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span>
					block<span class="token punctuation">.</span>ReceivedAt <span class="token operator">=</span> task<span class="token punctuation">.</span>time

					complete <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>complete<span class="token punctuation">,</span> block<span class="token punctuation">)</span>
					f<span class="token punctuation">.</span>completing<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> announce
					<span class="token keyword">continue</span>
				<span class="token punctuation">&#125;</span>
				incomplete <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>incomplete<span class="token punctuation">,</span> announce<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
				log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Block already imported, discarding header"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> announce<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				f<span class="token punctuation">.</span><span class="token function">forgetHash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			unknown <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>unknown<span class="token punctuation">,</span> header<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	headerFilterOutMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>unknown<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> filter <span class="token operator">&lt;-</span> <span class="token operator">&amp;</span>headerFilterTask<span class="token punctuation">&#123;</span>headers<span class="token punctuation">:</span> unknown<span class="token punctuation">,</span> time<span class="token punctuation">:</span> task<span class="token punctuation">.</span>time<span class="token punctuation">&#125;</span><span class="token punctuation">:</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>f<span class="token punctuation">.</span>quit<span class="token punctuation">:</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> announce <span class="token operator">:=</span> <span class="token keyword">range</span> incomplete <span class="token punctuation">&#123;</span>
		hash <span class="token operator">:=</span> announce<span class="token punctuation">.</span>header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> f<span class="token punctuation">.</span>completing<span class="token punctuation">[</span>hash<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">&#125;</span>
		f<span class="token punctuation">.</span>fetched<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>fetched<span class="token punctuation">[</span>hash<span class="token punctuation">]</span><span class="token punctuation">,</span> announce<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>fetched<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
			f<span class="token punctuation">.</span><span class="token function">rescheduleComplete</span><span class="token punctuation">(</span>completeTimer<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> block <span class="token operator">:=</span> <span class="token keyword">range</span> complete <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> announce <span class="token operator">:=</span> f<span class="token punctuation">.</span>completing<span class="token punctuation">[</span>block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> announce <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			f<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>announce<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> block<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在对应case中，首先就是一个select结构，这里代码优点特殊，首先headerFilter这个channel里面存储的也是一个channel，回到FilterHeaders的第二个select中，给filter赋值headerFilterTask对象，其中包装了peerID，区块头和当前时间，再回到loop的case中，这里select阻塞得到释放，task得到赋值，是一个headerFilterTask对象。</p>
<p>接着定义了三个数组：unknown, incomplete, complete，然后遍历刚才传过来的一些区块头。先进行了许多判断，主要是确定这个头正在在fetch，接着如果返回的高度和我们请求的区块高度不一样，则删除这个peer并删除这个hash，然后判断下一个head。接着如果一样的话，尝试从本地取区块，如果取不到，在接下来的一个判断中判断这个块是否为空，也就是没有交易且没有叔块，这时创建一个空的区块放入complete中，并将对应的announce放入completing表示fetch完成，若能从本地取到对应区块，则表示已经fetch过了，则抛弃这个hash。再往下，如果不满足最开始的判断，则将对于头放入unknown中。</p>
<p>在遍历完所有head后，再构造一个headerFilterTask将unknown放入其中，然后将这个headerFilterTask赋值给filter，这时触发FilterHeaders的第三个select，在那里面将task的heads返回，也就是刚才放入unknown中的，随后交给Downloader处理。</p>
<p>在loop的对应case中还有操作，首先遍历所有incomplete，这个里面的表示那些在fetch的，而且没有fetch完的，而且对应区块也不是空的announce，首先看其是否在completing中，也就是fetch完的，这时进行忽略，否则将announce放入fetched中对于hash的数组中。接着如果fetched只有一个等待fetch区块体的任务，则调用rescheduleComplete重置completeTimer定时器。</p>
<p>接着遍历complete数组，如果对应区块的announce在completing中也就是以及fetch完成的，则调用enqueue方法插入区块，这个方法稍后介绍。</p>
<h1 id="FilterBodies"><a href="#FilterBodies" class="headerlink" title="FilterBodies"></a>FilterBodies</h1><p>和上一个类似，这个方法是在请求一个区块体收到响应后进行了调用：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>Fetcher<span class="token punctuation">)</span> <span class="token function">FilterBodies</span><span class="token punctuation">(</span>peer <span class="token builtin">string</span><span class="token punctuation">,</span> transactions <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> uncles <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> time time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Filtering bodies"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> peer<span class="token punctuation">,</span> <span class="token string">"txs"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>transactions<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"uncles"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>uncles<span class="token punctuation">)</span><span class="token punctuation">)</span>

	filter <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>bodyFilterTask<span class="token punctuation">)</span>

	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> f<span class="token punctuation">.</span>bodyFilter <span class="token operator">&lt;-</span> filter<span class="token punctuation">:</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>f<span class="token punctuation">.</span>quit<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> filter <span class="token operator">&lt;-</span> <span class="token operator">&amp;</span>bodyFilterTask<span class="token punctuation">&#123;</span>peer<span class="token punctuation">:</span> peer<span class="token punctuation">,</span> transactions<span class="token punctuation">:</span> transactions<span class="token punctuation">,</span> uncles<span class="token punctuation">:</span> uncles<span class="token punctuation">,</span> time<span class="token punctuation">:</span> time<span class="token punctuation">&#125;</span><span class="token punctuation">:</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>f<span class="token punctuation">.</span>quit<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> task <span class="token operator">:=</span> <span class="token operator">&lt;-</span>filter<span class="token punctuation">:</span>
		<span class="token keyword">return</span> task<span class="token punctuation">.</span>transactions<span class="token punctuation">,</span> task<span class="token punctuation">.</span>uncles
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>f<span class="token punctuation">.</span>quit<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

		<span class="token keyword">case</span> filter <span class="token operator">:=</span> <span class="token operator">&lt;-</span>f<span class="token punctuation">.</span>bodyFilter<span class="token punctuation">:</span>
			<span class="token keyword">var</span> task <span class="token operator">*</span>bodyFilterTask
			<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> task <span class="token operator">=</span> <span class="token operator">&lt;-</span>filter<span class="token punctuation">:</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>f<span class="token punctuation">.</span>quit<span class="token punctuation">:</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">&#125;</span>
			bodyFilterInMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>transactions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

			blocks <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
			<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>transactions<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>uncles<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
				matched <span class="token operator">:=</span> <span class="token boolean">false</span>

				<span class="token keyword">for</span> hash<span class="token punctuation">,</span> announce <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>completing <span class="token punctuation">&#123;</span>
					<span class="token keyword">if</span> f<span class="token punctuation">.</span>queued<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
						txnHash <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">DeriveSha</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">Transactions</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>transactions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
						uncleHash <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">CalcUncleHash</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>uncles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>

						<span class="token keyword">if</span> txnHash <span class="token operator">==</span> announce<span class="token punctuation">.</span>header<span class="token punctuation">.</span>TxHash <span class="token operator">&amp;&amp;</span> uncleHash <span class="token operator">==</span> announce<span class="token punctuation">.</span>header<span class="token punctuation">.</span>UncleHash <span class="token operator">&amp;&amp;</span> announce<span class="token punctuation">.</span>origin <span class="token operator">==</span> task<span class="token punctuation">.</span>peer <span class="token punctuation">&#123;</span>
							matched <span class="token operator">=</span> <span class="token boolean">true</span>

							<span class="token keyword">if</span> f<span class="token punctuation">.</span><span class="token function">getBlock</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
								block <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">NewBlockWithHeader</span><span class="token punctuation">(</span>announce<span class="token punctuation">.</span>header<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithBody</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>transactions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span>uncles<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
								block<span class="token punctuation">.</span>ReceivedAt <span class="token operator">=</span> task<span class="token punctuation">.</span>time

								blocks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>blocks<span class="token punctuation">,</span> block<span class="token punctuation">)</span>
							<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
								f<span class="token punctuation">.</span><span class="token function">forgetHash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
							<span class="token punctuation">&#125;</span>
						<span class="token punctuation">&#125;</span>
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">if</span> matched <span class="token punctuation">&#123;</span>
					task<span class="token punctuation">.</span>transactions <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>transactions<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span>transactions<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
					task<span class="token punctuation">.</span>uncles <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>uncles<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span>uncles<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
					i<span class="token operator">--</span>
					<span class="token keyword">continue</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>

			bodyFilterOutMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>transactions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> filter <span class="token operator">&lt;-</span> task<span class="token punctuation">:</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>f<span class="token punctuation">.</span>quit<span class="token punctuation">:</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> block <span class="token operator">:=</span> <span class="token keyword">range</span> blocks <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> announce <span class="token operator">:=</span> f<span class="token punctuation">.</span>completing<span class="token punctuation">[</span>block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> announce <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					f<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>announce<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> block<span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>逻辑和上面的类似，这次是过滤body，主要是滤掉那些已经fetch完成的，剩余的返回交给Downloader处理，这里不再详述。</p>
<h1 id="Notify"><a href="#Notify" class="headerlink" title="Notify"></a>Notify</h1><p>Notify方法是在pm收到NewBlockHashesMsg消息时得到调用，NewBlockHashesMsg是自己向其他peer发送新区快消息时用的code。接收方收到这个code表示有新的区块，在检测自己是否有相应区块后，将每个未知区块fetcher处理</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>Fetcher<span class="token punctuation">)</span> <span class="token function">Notify</span><span class="token punctuation">(</span>peer <span class="token builtin">string</span><span class="token punctuation">,</span> hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> number <span class="token builtin">uint64</span><span class="token punctuation">,</span> time time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span>
	headerFetcher headerRequesterFn<span class="token punctuation">,</span> bodyFetcher bodyRequesterFn<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	block <span class="token operator">:=</span> <span class="token operator">&amp;</span>announce<span class="token punctuation">&#123;</span>
		hash<span class="token punctuation">:</span>        hash<span class="token punctuation">,</span>
		number<span class="token punctuation">:</span>      number<span class="token punctuation">,</span>
		time<span class="token punctuation">:</span>        time<span class="token punctuation">,</span>
		origin<span class="token punctuation">:</span>      peer<span class="token punctuation">,</span>
		fetchHeader<span class="token punctuation">:</span> headerFetcher<span class="token punctuation">,</span>
		fetchBodies<span class="token punctuation">:</span> bodyFetcher<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> f<span class="token punctuation">.</span>notify <span class="token operator">&lt;-</span> block<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>f<span class="token punctuation">.</span>quit<span class="token punctuation">:</span>
		<span class="token keyword">return</span> errTerminated
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里主要是构建了一个announce对象，表示有新区块的通知，然后传递给notify触发loop的逻辑：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> notification <span class="token operator">:=</span> <span class="token operator">&lt;-</span>f<span class="token punctuation">.</span>notify<span class="token punctuation">:</span>
	propAnnounceInMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

	count <span class="token operator">:=</span> f<span class="token punctuation">.</span>announces<span class="token punctuation">[</span>notification<span class="token punctuation">.</span>origin<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>
	<span class="token keyword">if</span> count <span class="token operator">></span> hashLimit <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Peer exceeded outstanding announces"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> notification<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> <span class="token string">"limit"</span><span class="token punctuation">,</span> hashLimit<span class="token punctuation">)</span>
		propAnnounceDOSMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">break</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> notification<span class="token punctuation">.</span>number <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> dist <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>number<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">int64</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">chainHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> dist <span class="token operator">&lt;</span> <span class="token operator">-</span>maxUncleDist <span class="token operator">||</span> dist <span class="token operator">></span> maxQueueDist <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Peer discarded announcement"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> notification<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> notification<span class="token punctuation">.</span>number<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> notification<span class="token punctuation">.</span>hash<span class="token punctuation">,</span> <span class="token string">"distance"</span><span class="token punctuation">,</span> dist<span class="token punctuation">)</span>
			propAnnounceDropMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> f<span class="token punctuation">.</span>fetching<span class="token punctuation">[</span>notification<span class="token punctuation">.</span>hash<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">break</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> f<span class="token punctuation">.</span>completing<span class="token punctuation">[</span>notification<span class="token punctuation">.</span>hash<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">break</span>
	<span class="token punctuation">&#125;</span>
	f<span class="token punctuation">.</span>announces<span class="token punctuation">[</span>notification<span class="token punctuation">.</span>origin<span class="token punctuation">]</span> <span class="token operator">=</span> count
	f<span class="token punctuation">.</span>announced<span class="token punctuation">[</span>notification<span class="token punctuation">.</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>announced<span class="token punctuation">[</span>notification<span class="token punctuation">.</span>hash<span class="token punctuation">]</span><span class="token punctuation">,</span> notification<span class="token punctuation">)</span>
	<span class="token keyword">if</span> f<span class="token punctuation">.</span>announceChangeHook <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>announced<span class="token punctuation">[</span>notification<span class="token punctuation">.</span>hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
		f<span class="token punctuation">.</span><span class="token function">announceChangeHook</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>hash<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>announced<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
		f<span class="token punctuation">.</span><span class="token function">rescheduleFetch</span><span class="token punctuation">(</span>fetchTimer<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先将来源的announce数量加1，然后判断是否超出最大数量，在检查区块高度是否太低或太高，也就是区块太旧或太新。然后检查该announce是否正在fetch或者已经完成。若都不是，则将其添加到announced中等待fetch，另外若添加完announced长度为1则立即重置fetchTimer进行fetch。</p>
<h1 id="Enqueue"><a href="#Enqueue" class="headerlink" title="Enqueue"></a>Enqueue</h1><p>Enqueue方法是在pm收到NewBlockMsg消息后执行，NewBlockMsg也是自己向其他佩尔发送新的区块信息时的code，Enqueue实现如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>Fetcher<span class="token punctuation">)</span> <span class="token function">Enqueue</span><span class="token punctuation">(</span>peer <span class="token builtin">string</span><span class="token punctuation">,</span> block <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	op <span class="token operator">:=</span> <span class="token operator">&amp;</span>inject<span class="token punctuation">&#123;</span>
		origin<span class="token punctuation">:</span> peer<span class="token punctuation">,</span>
		block<span class="token punctuation">:</span>  block<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> f<span class="token punctuation">.</span>inject <span class="token operator">&lt;-</span> op<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>f<span class="token punctuation">.</span>quit<span class="token punctuation">:</span>
		<span class="token keyword">return</span> errTerminated
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>构建了一个inject对象，然后赋值给inject触发loop的逻辑：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> op <span class="token operator">:=</span> <span class="token operator">&lt;-</span>f<span class="token punctuation">.</span>inject<span class="token punctuation">:</span>
	propBroadcastInMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	f<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> op<span class="token punctuation">.</span>block<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>enqueue逻辑如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>Fetcher<span class="token punctuation">)</span> <span class="token function">enqueue</span><span class="token punctuation">(</span>peer <span class="token builtin">string</span><span class="token punctuation">,</span> block <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	hash <span class="token operator">:=</span> block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	count <span class="token operator">:=</span> f<span class="token punctuation">.</span>queues<span class="token punctuation">[</span>peer<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>
	<span class="token keyword">if</span> count <span class="token operator">></span> blockLimit <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Discarded propagated block, exceeded allowance"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> peer<span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">"limit"</span><span class="token punctuation">,</span> blockLimit<span class="token punctuation">)</span>
		propBroadcastDOSMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		f<span class="token punctuation">.</span><span class="token function">forgetHash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> dist <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">int64</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">chainHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> dist <span class="token operator">&lt;</span> <span class="token operator">-</span>maxUncleDist <span class="token operator">||</span> dist <span class="token operator">></span> maxQueueDist <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Discarded propagated block, too far away"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> peer<span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">"distance"</span><span class="token punctuation">,</span> dist<span class="token punctuation">)</span>
		propBroadcastDropMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		f<span class="token punctuation">.</span><span class="token function">forgetHash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> f<span class="token punctuation">.</span>queued<span class="token punctuation">[</span>hash<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		op <span class="token operator">:=</span> <span class="token operator">&amp;</span>inject<span class="token punctuation">&#123;</span>
			origin<span class="token punctuation">:</span> peer<span class="token punctuation">,</span>
			block<span class="token punctuation">:</span>  block<span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span>
		f<span class="token punctuation">.</span>queues<span class="token punctuation">[</span>peer<span class="token punctuation">]</span> <span class="token operator">=</span> count
		f<span class="token punctuation">.</span>queued<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> op
		f<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">int64</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> f<span class="token punctuation">.</span>queueChangeHook <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			f<span class="token punctuation">.</span><span class="token function">queueChangeHook</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span>block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Queued propagated block"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> peer<span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">"queued"</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>和Notify逻辑类似，也是给来源加一，再判断是否超出最大值，然后判断区块是否太旧或太新。对于符合条件的，判断是否添加到queued中，若没有，则重新创建一个inject对象添加到queued和queue中。</p>
<h1 id="fetchTimer"><a href="#fetchTimer" class="headerlink" title="fetchTimer"></a>fetchTimer</h1><p>前面的种种方法基本上都是对到来的announce进行分类，而在开头的两个定时器则真正担负了驱动作用，先看fetchTimer，由于开始设置的时间为0，所以立即触发：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> <span class="token operator">&lt;-</span>fetchTimer<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
	request <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span>

	<span class="token keyword">for</span> hash<span class="token punctuation">,</span> announces <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>announced <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>announces<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>time<span class="token punctuation">)</span> <span class="token operator">></span> arriveTimeout<span class="token operator">-</span>gatherSlack <span class="token punctuation">&#123;</span>
			announce <span class="token operator">:=</span> announces<span class="token punctuation">[</span>rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>announces<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
			f<span class="token punctuation">.</span><span class="token function">forgetHash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>

			<span class="token keyword">if</span> f<span class="token punctuation">.</span><span class="token function">getBlock</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				request<span class="token punctuation">[</span>announce<span class="token punctuation">.</span>origin<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>request<span class="token punctuation">[</span>announce<span class="token punctuation">.</span>origin<span class="token punctuation">]</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
				f<span class="token punctuation">.</span>fetching<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> announce
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> peer<span class="token punctuation">,</span> hashes <span class="token operator">:=</span> <span class="token keyword">range</span> request <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Fetching scheduled headers"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> peer<span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> hashes<span class="token punctuation">)</span>

		fetchHeader<span class="token punctuation">,</span> hashes <span class="token operator">:=</span> f<span class="token punctuation">.</span>fetching<span class="token punctuation">[</span>hashes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fetchHeader<span class="token punctuation">,</span> hashes
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> f<span class="token punctuation">.</span>fetchingHook <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				f<span class="token punctuation">.</span><span class="token function">fetchingHook</span><span class="token punctuation">(</span>hashes<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> hash <span class="token operator">:=</span> <span class="token keyword">range</span> hashes <span class="token punctuation">&#123;</span>
				headerFetchMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
				<span class="token function">fetchHeader</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token comment">// Suboptimal, but protocol doesn't allow batch header retrievals</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	f<span class="token punctuation">.</span><span class="token function">rescheduleFetch</span><span class="token punctuation">(</span>fetchTimer<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先遍历announced，announced存储了对于同一个区块来自不同peer的announce，它的第一个announce则是最早的哪一个，如果400毫秒，则随机取一个announce，然后删除该hash，如果这个hash还未fetch到，则将其添加到fetching中，并在request中记录，request记录了同一个来源的多个hash。随后遍历所有request，获得每个来源的fetchHeader方法，这个方法在调用Notify方法构建一个announce时被传入，是peer的一个方法，只要是发送一个GetBlockHeadersMsg消息去获取区块头，之后在每次循环后启动一个goroutine去变量该来源的所有hash然后请求。最后重置fetchTimer。</p>
<p>发送GetBlockHeadersMsg后，如果顺利会收到BlockHeadersMsg消息，这时也就触发FilterHeaders，这是回到前面分析的逻辑，将所有head分三类，unknown的交给download处理，incomplete的存放到fetched中等待fetch区块体，complete的且fetch完成的交给enqueue处理。</p>
<h1 id="completeTimer"><a href="#completeTimer" class="headerlink" title="completeTimer"></a>completeTimer</h1><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> <span class="token operator">&lt;-</span>completeTimer<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
	request <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span>

	<span class="token keyword">for</span> hash<span class="token punctuation">,</span> announces <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>fetched <span class="token punctuation">&#123;</span>
		announce <span class="token operator">:=</span> announces<span class="token punctuation">[</span>rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>announces<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
		f<span class="token punctuation">.</span><span class="token function">forgetHash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>

		<span class="token keyword">if</span> f<span class="token punctuation">.</span><span class="token function">getBlock</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			request<span class="token punctuation">[</span>announce<span class="token punctuation">.</span>origin<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>request<span class="token punctuation">[</span>announce<span class="token punctuation">.</span>origin<span class="token punctuation">]</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
			f<span class="token punctuation">.</span>completing<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> announce
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> peer<span class="token punctuation">,</span> hashes <span class="token operator">:=</span> <span class="token keyword">range</span> request <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Fetching scheduled bodies"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> peer<span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> hashes<span class="token punctuation">)</span>

		<span class="token keyword">if</span> f<span class="token punctuation">.</span>completingHook <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			f<span class="token punctuation">.</span><span class="token function">completingHook</span><span class="token punctuation">(</span>hashes<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		bodyFetchMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>hashes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> f<span class="token punctuation">.</span>completing<span class="token punctuation">[</span>hashes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">fetchBodies</span><span class="token punctuation">(</span>hashes<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	f<span class="token punctuation">.</span><span class="token function">rescheduleComplete</span><span class="token punctuation">(</span>completeTimer<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>completeTimer的逻辑和fetchTimer类似，只不过前一个是fetch区块头，这个是fetch区块体。首先是从fetched中取一组announce，他们都对应一个区块。然后从中随机取一个announce，若果本地没有该区块则添加到reuqest，这个同意也是存储一个来源的多个announce，然后变量request，调用announce的fetchBodies方法去请求一个来源的多个区块，fetchBodies也是在创建announce时传入的，他会发送GetBlockBodiesMsg消息，同样如果顺利的话会收到BlockBodiesMsg消息，触发FilterBodies方法，又回到前面的逻辑。</p>
<h1 id="insert"><a href="#insert" class="headerlink" title="insert"></a>insert</h1><p>之前许多方法中我们都调用了enqueue方法，这里将一个个inject对象放入queue队列里，然后在loop的每个循环开始，处理queue队列里的东西，对于符合规定的，调用insert方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>Fetcher<span class="token punctuation">)</span> <span class="token function">insert</span><span class="token punctuation">(</span>peer <span class="token builtin">string</span><span class="token punctuation">,</span> block <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	hash <span class="token operator">:=</span> block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Importing propagated block"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> peer<span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> f<span class="token punctuation">.</span>done <span class="token operator">&lt;-</span> hash <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		parent <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">getBlock</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">ParentHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> parent <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Unknown parent of propagated block"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> peer<span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">"parent"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">ParentHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">switch</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">verifyHeader</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
			propBroadcastOutTimer<span class="token punctuation">.</span><span class="token function">UpdateSince</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>ReceivedAt<span class="token punctuation">)</span>
			<span class="token keyword">go</span> f<span class="token punctuation">.</span><span class="token function">broadcastBlock</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

		<span class="token keyword">case</span> consensus<span class="token punctuation">.</span>ErrFutureBlock<span class="token punctuation">:</span>

		<span class="token keyword">default</span><span class="token punctuation">:</span>
			log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Propagated block verification failed"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> peer<span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			f<span class="token punctuation">.</span><span class="token function">dropPeer</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">insertChain</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>Blocks<span class="token punctuation">&#123;</span>block<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Propagated block import failed"</span><span class="token punctuation">,</span> <span class="token string">"peer"</span><span class="token punctuation">,</span> peer<span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
		propAnnounceOutTimer<span class="token punctuation">.</span><span class="token function">UpdateSince</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>ReceivedAt<span class="token punctuation">)</span>
		<span class="token keyword">go</span> f<span class="token punctuation">.</span><span class="token function">broadcastBlock</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>

		<span class="token keyword">if</span> f<span class="token punctuation">.</span>importedHook <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			f<span class="token punctuation">.</span><span class="token function">importedHook</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>直接启动了一个goroutine，先获取要插入区块的父块，如果不存在停止插入，然后验证区块头，出错的话而且不是consensus.ErrFutureBlock错误的话，抛弃来源的peer，没有错的话启动一个goroutine调用broadcastBlock方法。之后调用insertchain方法插入一个区块，如果插入成功再次调用broadcastBlock方法，这里第二个参数为true，关于broadcastBlock在ProtocolManager分析中有介绍。另外insertChain方法是blockchain的方法，后面会涉及到。</p>
<h1 id="rescheduleFetch"><a href="#rescheduleFetch" class="headerlink" title="rescheduleFetch"></a>rescheduleFetch</h1><p>前面也多次涉及到了这个方法，在定时器触发时最后会用到，在notify添加完一个announce后如果announced长度为一，表示之前announced都已处理过，这是要重新启动定时器。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>Fetcher<span class="token punctuation">)</span> <span class="token function">rescheduleFetch</span><span class="token punctuation">(</span>fetch <span class="token operator">*</span>time<span class="token punctuation">.</span>Timer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>announced<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// Otherwise find the earliest expiring announcement</span>
	earliest <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> announces <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>announced <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> earliest<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>announces<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>time<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			earliest <span class="token operator">=</span> announces<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>time
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	fetch<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>arriveTimeout <span class="token operator">-</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>earliest<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先announced长度为0，表示没有要fetch的任务，则返回，前面说过，在notify中向announced新添加时会触发此方法重设定时器。之后遍历所有announced，每个hash对应的那组取第一个也就时间最早的那个announce尝试更新earliest，最后earliest为所有announce最早的那一个，然后重设fetchTimer定时器。</p>
<p>类似的还有一个rescheduleComplete，大致逻辑一样，不在赘述</p>
<h1 id="forgetHash"><a href="#forgetHash" class="headerlink" title="forgetHash"></a>forgetHash</h1><p>这个也多次出现，出钥匙删除一个hash对应的announce</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>Fetcher<span class="token punctuation">)</span> <span class="token function">forgetHash</span><span class="token punctuation">(</span>hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> announce <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>announced<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
		f<span class="token punctuation">.</span>announces<span class="token punctuation">[</span>announce<span class="token punctuation">.</span>origin<span class="token punctuation">]</span><span class="token operator">--</span>
		<span class="token keyword">if</span> f<span class="token punctuation">.</span>announces<span class="token punctuation">[</span>announce<span class="token punctuation">.</span>origin<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>announces<span class="token punctuation">,</span> announce<span class="token punctuation">.</span>origin<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">delete</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>announced<span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
	<span class="token keyword">if</span> f<span class="token punctuation">.</span>announceChangeHook <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		f<span class="token punctuation">.</span><span class="token function">announceChangeHook</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> announce <span class="token operator">:=</span> f<span class="token punctuation">.</span>fetching<span class="token punctuation">[</span>hash<span class="token punctuation">]</span><span class="token punctuation">;</span> announce <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		f<span class="token punctuation">.</span>announces<span class="token punctuation">[</span>announce<span class="token punctuation">.</span>origin<span class="token punctuation">]</span><span class="token operator">--</span>
		<span class="token keyword">if</span> f<span class="token punctuation">.</span>announces<span class="token punctuation">[</span>announce<span class="token punctuation">.</span>origin<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>announces<span class="token punctuation">,</span> announce<span class="token punctuation">.</span>origin<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token function">delete</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>fetching<span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>


	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> announce <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>fetched<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
		f<span class="token punctuation">.</span>announces<span class="token punctuation">[</span>announce<span class="token punctuation">.</span>origin<span class="token punctuation">]</span><span class="token operator">--</span>
		<span class="token keyword">if</span> f<span class="token punctuation">.</span>announces<span class="token punctuation">[</span>announce<span class="token punctuation">.</span>origin<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>announces<span class="token punctuation">,</span> announce<span class="token punctuation">.</span>origin<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">delete</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>fetched<span class="token punctuation">,</span> hash<span class="token punctuation">)</span>


	<span class="token keyword">if</span> announce <span class="token operator">:=</span> f<span class="token punctuation">.</span>completing<span class="token punctuation">[</span>hash<span class="token punctuation">]</span><span class="token punctuation">;</span> announce <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		f<span class="token punctuation">.</span>announces<span class="token punctuation">[</span>announce<span class="token punctuation">.</span>origin<span class="token punctuation">]</span><span class="token operator">--</span>
		<span class="token keyword">if</span> f<span class="token punctuation">.</span>announces<span class="token punctuation">[</span>announce<span class="token punctuation">.</span>origin<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>announces<span class="token punctuation">,</span> announce<span class="token punctuation">.</span>origin<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token function">delete</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>completing<span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先遍历announced对应hash的所有announce，然后将对应来源的计数器减1，如果减到0则删除该来源的计数器。然后从announced删除hash对应的值。结合如果fetching、fetched及completing有对应的键值对，也相应的删除。</p>
<h1 id="stop"><a href="#stop" class="headerlink" title="stop"></a>stop</h1><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>Fetcher<span class="token punctuation">)</span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>quit<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这个就是关闭方法，关闭quit这个通道，触发多个地方的逻辑，第一个就是loop中，这里面退出了无限循环，其次还有其他涉及select阻塞的地方，如notify、FilterHeaders等，都是直接退出。</p>
<blockquote>
<p>题图来自unsplash：<a target="_blank" rel="noopener" href="https://unsplash.com/photos/m6tAqZvy4RM">https://unsplash.com/photos/m6tAqZvy4RM</a></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag"><i class="fa fa-tag"></i> 区块链</a>
              <a href="/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" rel="tag"><i class="fa fa-tag"></i> 以太坊</a>
              <a href="/tags/go/" rel="tag"><i class="fa fa-tag"></i> go</a>
              <a href="/tags/go-ethereum/" rel="tag"><i class="fa fa-tag"></i> go-ethereum</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/04/29/go-ethereum%E4%B8%ADeth-ProtocolManager%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" rel="prev" title="go-ethereum中eth-ProtocolManager源码学习">
                  <i class="fa fa-chevron-left"></i> go-ethereum中eth-ProtocolManager源码学习
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/05/13/%E9%80%9A%E8%BF%87RPC%E4%B8%8E%E5%A4%AA%E5%9D%8A%E8%8A%82%E7%82%B9%E4%BA%A4%E4%BA%92/" rel="next" title="通过RPC与太坊节点交互">
                  通过RPC与太坊节点交互 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">AmorFati</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">631k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:34</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
