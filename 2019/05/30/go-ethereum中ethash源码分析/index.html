<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">

<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CConsolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="article">
<meta property="og:title" content="go-ethereum中ethash源码分析">
<meta property="og:url" content="http://example.com/2019/05/30/go-ethereum%E4%B8%ADethash%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="AmorFati">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/ben-klea-1633206-unsplash.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/verify-gaslimit.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/pow1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/reward.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/difficulty.png">
<meta property="article:published_time" content="2019-05-30T07:31:05.000Z">
<meta property="article:modified_time" content="2021-11-17T13:54:30.492Z">
<meta property="article:author" content="AmorFati">
<meta property="article:tag" content="区块链">
<meta property="article:tag" content="以太坊">
<meta property="article:tag" content="go">
<meta property="article:tag" content="go-ethereum">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/ben-klea-1633206-unsplash.jpg">


<link rel="canonical" href="http://example.com/2019/05/30/go-ethereum%E4%B8%ADethash%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2019/05/30/go-ethereum%E4%B8%ADethash%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/","path":"2019/05/30/go-ethereum中ethash源码分析/","title":"go-ethereum中ethash源码分析"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>go-ethereum中ethash源码分析 | AmorFati</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">AmorFati</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">风吹过窗前的书，又翻过一页</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Engine"><span class="nav-number">1.</span> <span class="nav-text">Engine</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#New"><span class="nav-number">1.1.</span> <span class="nav-text">New</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Author"><span class="nav-number">1.2.</span> <span class="nav-text">Author</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VerifyHeader"><span class="nav-number">1.3.</span> <span class="nav-text">VerifyHeader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#verifyHeader"><span class="nav-number">1.4.</span> <span class="nav-text">verifyHeader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VerifyHeaders"><span class="nav-number">1.5.</span> <span class="nav-text">VerifyHeaders</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VerifyUncles"><span class="nav-number">1.6.</span> <span class="nav-text">VerifyUncles</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VerifySeal"><span class="nav-number">1.7.</span> <span class="nav-text">VerifySeal</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Prepare"><span class="nav-number">1.8.</span> <span class="nav-text">Prepare</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Finalize"><span class="nav-number">1.9.</span> <span class="nav-text">Finalize</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CalcDifficulty"><span class="nav-number">1.10.</span> <span class="nav-text">CalcDifficulty</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Seal"><span class="nav-number">1.11.</span> <span class="nav-text">Seal</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mine"><span class="nav-number">1.12.</span> <span class="nav-text">mine</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ethash%E7%AE%97%E6%B3%95"><span class="nav-number">2.</span> <span class="nav-text">Ethash算法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">2.1.</span> <span class="nav-text">数据结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cache%E7%94%9F%E6%88%90"><span class="nav-number">2.2.</span> <span class="nav-text">cache生成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dataset%E7%94%9F%E6%88%90"><span class="nav-number">2.3.</span> <span class="nav-text">dataset生成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hashimotoFull"><span class="nav-number">2.4.</span> <span class="nav-text">hashimotoFull</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hashimotoLight"><span class="nav-number">2.5.</span> <span class="nav-text">hashimotoLight</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hashimoto"><span class="nav-number">2.6.</span> <span class="nav-text">hashimoto</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#geth%E7%94%9F%E6%88%90%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="nav-number">2.7.</span> <span class="nav-text">geth生成数据集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E5%A4%A7%E5%B0%8F%E7%AB%AF"><span class="nav-number">2.8.</span> <span class="nav-text">关于大小端</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="AmorFati"
      src="/assets/img/icon.jpg">
  <p class="site-author-name" itemprop="name">AmorFati</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/1chenyy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;1chenyy" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:henyang4346@foxmail.com" title="E-Mail → mailto:henyang4346@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/52c1bec4559c" title="简书 → https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;52c1bec4559c" rel="noopener" target="_blank"><i class="fa fa-globe fa-fw"></i>简书</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/30/go-ethereum%E4%B8%ADethash%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/icon.jpg">
      <meta itemprop="name" content="AmorFati">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmorFati">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          go-ethereum中ethash源码分析
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-30 15:31:05" itemprop="dateCreated datePublished" datetime="2019-05-30T15:31:05+08:00">2019-05-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-11-17 21:54:30" itemprop="dateModified" datetime="2021-11-17T21:54:30+08:00">2021-11-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go-ethereum%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">go-ethereum源码学习</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>38k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>35 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/ben-klea-1633206-unsplash.jpg"></p>
<span id="more"></span>
<p>本文代码大部分集中在consensus目录下</p>
<h1 id="Engine"><a href="#Engine" class="headerlink" title="Engine"></a>Engine</h1><p>Engine就是以太坊中共识引擎，在构建Ethereum时被创建使用CreateConsensusEngine方法</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token function">CreateConsensusEngine</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> chainConfig<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">.</span>Ethash<span class="token punctuation">,</span> config<span class="token punctuation">.</span>MinerNotify<span class="token punctuation">,</span> config<span class="token punctuation">.</span>MinerNoverify<span class="token punctuation">,</span> chainDb<span class="token punctuation">)</span><span class="token punctuation">,</span>

<span class="token keyword">func</span> <span class="token function">CreateConsensusEngine</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>node<span class="token punctuation">.</span>ServiceContext<span class="token punctuation">,</span> chainConfig <span class="token operator">*</span>params<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">,</span> config <span class="token operator">*</span>ethash<span class="token punctuation">.</span>Config<span class="token punctuation">,</span> notify <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> noverify <span class="token builtin">bool</span><span class="token punctuation">,</span> db ethdb<span class="token punctuation">.</span>Database<span class="token punctuation">)</span> consensus<span class="token punctuation">.</span>Engine <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> chainConfig<span class="token punctuation">.</span>Clique <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> clique<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>chainConfig<span class="token punctuation">.</span>Clique<span class="token punctuation">,</span> db<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">switch</span> config<span class="token punctuation">.</span>PowMode <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> ethash<span class="token punctuation">.</span>ModeFake<span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Ethash used in fake mode"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ethash<span class="token punctuation">.</span><span class="token function">NewFaker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> ethash<span class="token punctuation">.</span>ModeTest<span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Ethash used in test mode"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ethash<span class="token punctuation">.</span><span class="token function">NewTester</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> noverify<span class="token punctuation">)</span>
	<span class="token keyword">case</span> ethash<span class="token punctuation">.</span>ModeShared<span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Ethash used in shared mode"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ethash<span class="token punctuation">.</span><span class="token function">NewShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		engine <span class="token operator">:=</span> ethash<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>ethash<span class="token punctuation">.</span>Config<span class="token punctuation">&#123;</span>
			CacheDir<span class="token punctuation">:</span>       ctx<span class="token punctuation">.</span><span class="token function">ResolvePath</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>CacheDir<span class="token punctuation">)</span><span class="token punctuation">,</span>
			CachesInMem<span class="token punctuation">:</span>    config<span class="token punctuation">.</span>CachesInMem<span class="token punctuation">,</span>
			CachesOnDisk<span class="token punctuation">:</span>   config<span class="token punctuation">.</span>CachesOnDisk<span class="token punctuation">,</span>
			DatasetDir<span class="token punctuation">:</span>     config<span class="token punctuation">.</span>DatasetDir<span class="token punctuation">,</span>
			DatasetsInMem<span class="token punctuation">:</span>  config<span class="token punctuation">.</span>DatasetsInMem<span class="token punctuation">,</span>
			DatasetsOnDisk<span class="token punctuation">:</span> config<span class="token punctuation">.</span>DatasetsOnDisk<span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> notify<span class="token punctuation">,</span> noverify<span class="token punctuation">)</span>
		engine<span class="token punctuation">.</span><span class="token function">SetThreads</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// Disable CPU mining</span>
		<span class="token keyword">return</span> engine
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先如果需要PoA共识的话，创建clique对象。对于PoW共识的话根据不同模式创建不同的ethash对象。</p>
<p>对于CreateConsensusEngine是返回的一个Engine类型对象，它是一个接口，定义如下</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// go-ethereum\consensus\consensus.go</span>
<span class="token keyword">type</span> Engine <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>
	<span class="token function">Author</span><span class="token punctuation">(</span>header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token punctuation">(</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

	<span class="token function">VerifyHeader</span><span class="token punctuation">(</span>chain ChainReader<span class="token punctuation">,</span> header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> seal <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span>

	<span class="token function">VerifyHeaders</span><span class="token punctuation">(</span>chain ChainReader<span class="token punctuation">,</span> headers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> seals <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

	<span class="token function">VerifyUncles</span><span class="token punctuation">(</span>chain ChainReader<span class="token punctuation">,</span> block <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">)</span> <span class="token builtin">error</span>

	<span class="token function">VerifySeal</span><span class="token punctuation">(</span>chain ChainReader<span class="token punctuation">,</span> header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token builtin">error</span>

	<span class="token function">Prepare</span><span class="token punctuation">(</span>chain ChainReader<span class="token punctuation">,</span> header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token builtin">error</span>

	<span class="token function">Finalize</span><span class="token punctuation">(</span>chain ChainReader<span class="token punctuation">,</span> header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> state <span class="token operator">*</span>state<span class="token punctuation">.</span>StateDB<span class="token punctuation">,</span> txs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span>
		uncles <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> receipts <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Receipt<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

	<span class="token function">Seal</span><span class="token punctuation">(</span>chain ChainReader<span class="token punctuation">,</span> block <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">,</span> results <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">,</span> stop <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token builtin">error</span>

	<span class="token function">SealHash</span><span class="token punctuation">(</span>header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> common<span class="token punctuation">.</span>Hash

	<span class="token function">CalcDifficulty</span><span class="token punctuation">(</span>chain ChainReader<span class="token punctuation">,</span> time <span class="token builtin">uint64</span><span class="token punctuation">,</span> parent <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token operator">*</span>big<span class="token punctuation">.</span>Int

	<span class="token function">APIs</span><span class="token punctuation">(</span>chain ChainReader<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>rpc<span class="token punctuation">.</span>API

	<span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Author是返回挖出该区块的地址，接下来几个Verify开头的方法是用来验证对错的。Prepare用于填充区块头的难度字段。Finalize是发放奖励和组装区块。Seal用来打包区块。SealHash返回打包区块的hash。CalcDifficulty计算新区快的应有难度。</p>
<p>与Engine一起定义的还有一个PoW接口，它除了继承了Engine接口内容，还多一个Hashrate方法用于返回当前挖矿的hash率。</p>
<h2 id="New"><a href="#New" class="headerlink" title="New"></a>New</h2><p>本文主要介绍Ethash源码，先看其New方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>config Config<span class="token punctuation">,</span> notify <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> noverify <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>Ethash <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> config<span class="token punctuation">.</span>CachesInMem <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"One ethash cache must always be in memory"</span><span class="token punctuation">,</span> <span class="token string">"requested"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>CachesInMem<span class="token punctuation">)</span>
		config<span class="token punctuation">.</span>CachesInMem <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> config<span class="token punctuation">.</span>CacheDir <span class="token operator">!=</span> <span class="token string">""</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>CachesOnDisk <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Disk storage enabled for ethash caches"</span><span class="token punctuation">,</span> <span class="token string">"dir"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>CacheDir<span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>CachesOnDisk<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> config<span class="token punctuation">.</span>DatasetDir <span class="token operator">!=</span> <span class="token string">""</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>DatasetsOnDisk <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Disk storage enabled for ethash DAGs"</span><span class="token punctuation">,</span> <span class="token string">"dir"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>DatasetDir<span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>DatasetsOnDisk<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	ethash <span class="token operator">:=</span> <span class="token operator">&amp;</span>Ethash<span class="token punctuation">&#123;</span>
		config<span class="token punctuation">:</span>       config<span class="token punctuation">,</span>
		caches<span class="token punctuation">:</span>       <span class="token function">newlru</span><span class="token punctuation">(</span><span class="token string">"cache"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>CachesInMem<span class="token punctuation">,</span> newCache<span class="token punctuation">)</span><span class="token punctuation">,</span>
		datasets<span class="token punctuation">:</span>     <span class="token function">newlru</span><span class="token punctuation">(</span><span class="token string">"dataset"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>DatasetsInMem<span class="token punctuation">,</span> newDataset<span class="token punctuation">)</span><span class="token punctuation">,</span>
		update<span class="token punctuation">:</span>       <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		hashrate<span class="token punctuation">:</span>     metrics<span class="token punctuation">.</span><span class="token function">NewMeterForced</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		workCh<span class="token punctuation">:</span>       <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>sealTask<span class="token punctuation">)</span><span class="token punctuation">,</span>
		fetchWorkCh<span class="token punctuation">:</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>sealWork<span class="token punctuation">)</span><span class="token punctuation">,</span>
		submitWorkCh<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>mineResult<span class="token punctuation">)</span><span class="token punctuation">,</span>
		fetchRateCh<span class="token punctuation">:</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">chan</span> <span class="token builtin">uint64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		submitRateCh<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>hashrate<span class="token punctuation">)</span><span class="token punctuation">,</span>
		exitCh<span class="token punctuation">:</span>       <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">go</span> ethash<span class="token punctuation">.</span><span class="token function">remote</span><span class="token punctuation">(</span>notify<span class="token punctuation">,</span> noverify<span class="token punctuation">)</span>
	<span class="token keyword">return</span> ethash
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主要就是根据config信息构建一个ethash对象，我们简单回顾一下ethash的配置，首先在eth.DefaultConfig中加载了一部分默认配置信息</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// go-ethereum\eth\config.go</span>
<span class="token keyword">var</span> DefaultConfig <span class="token operator">=</span> Config<span class="token punctuation">&#123;</span>
	SyncMode<span class="token punctuation">:</span> downloader<span class="token punctuation">.</span>FastSync<span class="token punctuation">,</span>
	Ethash<span class="token punctuation">:</span> ethash<span class="token punctuation">.</span>Config<span class="token punctuation">&#123;</span>
		CacheDir<span class="token punctuation">:</span>       <span class="token string">"ethash"</span><span class="token punctuation">,</span>
		CachesInMem<span class="token punctuation">:</span>    <span class="token number">2</span><span class="token punctuation">,</span>
		CachesOnDisk<span class="token punctuation">:</span>   <span class="token number">3</span><span class="token punctuation">,</span>
		DatasetsInMem<span class="token punctuation">:</span>  <span class="token number">1</span><span class="token punctuation">,</span>
		DatasetsOnDisk<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	NetworkId<span class="token punctuation">:</span>      <span class="token number">1</span><span class="token punctuation">,</span>
	LightPeers<span class="token punctuation">:</span>     <span class="token number">100</span><span class="token punctuation">,</span>
	DatabaseCache<span class="token punctuation">:</span>  <span class="token number">512</span><span class="token punctuation">,</span>
	TrieCleanCache<span class="token punctuation">:</span> <span class="token number">256</span><span class="token punctuation">,</span>
	TrieDirtyCache<span class="token punctuation">:</span> <span class="token number">256</span><span class="token punctuation">,</span>
	TrieTimeout<span class="token punctuation">:</span>    <span class="token number">60</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">,</span>
	MinerGasFloor<span class="token punctuation">:</span>  <span class="token number">8000000</span><span class="token punctuation">,</span>
	MinerGasCeil<span class="token punctuation">:</span>   <span class="token number">8000000</span><span class="token punctuation">,</span>
	MinerGasPrice<span class="token punctuation">:</span>  big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>GWei<span class="token punctuation">)</span><span class="token punctuation">,</span>
	MinerRecommit<span class="token punctuation">:</span>  <span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>

	TxPool<span class="token punctuation">:</span> core<span class="token punctuation">.</span>DefaultTxPoolConfig<span class="token punctuation">,</span>
	GPO<span class="token punctuation">:</span> gasprice<span class="token punctuation">.</span>Config<span class="token punctuation">&#123;</span>
		Blocks<span class="token punctuation">:</span>     <span class="token number">20</span><span class="token punctuation">,</span>
		Percentile<span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里给出了构建ethash的几个关键参数，还有一个config.DatasetDir是在go-ethereum\eth\config.go的init中初始化，默认是在/home/.ethash。除此之外还有一些列用户可以设定的参数，需要在启动以太坊节点后根据固定参数设置，在go-ethereum\cmd\utils\flags.go的SetEthConfig中加载参数，一般我们都没有指定特殊参数。new方法最后启动了一个goroutine运行remote方法，我们稍后再讲</p>
<h2 id="Author"><a href="#Author" class="headerlink" title="Author"></a>Author</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ethash <span class="token operator">*</span>Ethash<span class="token punctuation">)</span> <span class="token function">Author</span><span class="token punctuation">(</span>header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token punctuation">(</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> header<span class="token punctuation">.</span>Coinbase<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这个很简单就是返回区块头的Coinbase字段</p>
<h2 id="VerifyHeader"><a href="#VerifyHeader" class="headerlink" title="VerifyHeader"></a>VerifyHeader</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ethash <span class="token operator">*</span>Ethash<span class="token punctuation">)</span> <span class="token function">VerifyHeader</span><span class="token punctuation">(</span>chain consensus<span class="token punctuation">.</span>ChainReader<span class="token punctuation">,</span> header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> seal <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PowMode <span class="token operator">==</span> ModeFullFake <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	number <span class="token operator">:=</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> chain<span class="token punctuation">.</span><span class="token function">GetHeader</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> number<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	parent <span class="token operator">:=</span> chain<span class="token punctuation">.</span><span class="token function">GetHeader</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>ParentHash<span class="token punctuation">,</span> number<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> parent <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> consensus<span class="token punctuation">.</span>ErrUnknownAncestor
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> ethash<span class="token punctuation">.</span><span class="token function">verifyHeader</span><span class="token punctuation">(</span>chain<span class="token punctuation">,</span> header<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> seal<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先对于ModeFullFake模式下的共识对任何区块头都予以放行，不进行检测。对于需要检测的区块头，首先获取可区块的高度，接着从本地尝试获取对应高度和hash的区块头，如果能获取到，说明该区块正确。之后在本地检查了父块，如果找不到返回ErrUnknownAncestor错误。</p>
<p>接下来如果能找到父块，则调用verifyHeader方法进行检测</p>
<h2 id="verifyHeader"><a href="#verifyHeader" class="headerlink" title="verifyHeader"></a>verifyHeader</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ethash <span class="token operator">*</span>Ethash<span class="token punctuation">)</span> <span class="token function">verifyHeader</span><span class="token punctuation">(</span>chain consensus<span class="token punctuation">.</span>ChainReader<span class="token punctuation">,</span> header<span class="token punctuation">,</span> parent <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> uncle <span class="token builtin">bool</span><span class="token punctuation">,</span> seal <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>Extra<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> params<span class="token punctuation">.</span>MaximumExtraDataSize <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"extra-data too long: %d > %d"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>Extra<span class="token punctuation">)</span><span class="token punctuation">,</span> params<span class="token punctuation">.</span>MaximumExtraDataSize<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> uncle <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> header<span class="token punctuation">.</span>Time<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>MaxBig256<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> errLargeBlockTime
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> header<span class="token punctuation">.</span>Time<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>allowedFutureBlockTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> consensus<span class="token punctuation">.</span>ErrFutureBlock
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> header<span class="token punctuation">.</span>Time<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errZeroBlockTime
	<span class="token punctuation">&#125;</span>

	expected <span class="token operator">:=</span> ethash<span class="token punctuation">.</span><span class="token function">CalcDifficulty</span><span class="token punctuation">(</span>chain<span class="token punctuation">,</span> header<span class="token punctuation">.</span>Time<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span>

	<span class="token keyword">if</span> expected<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>Difficulty<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid difficulty: have %v, want %v"</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>Difficulty<span class="token punctuation">,</span> expected<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token builtin">cap</span> <span class="token operator">:=</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token number">0x7fffffffffffffff</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> header<span class="token punctuation">.</span>GasLimit <span class="token operator">></span> <span class="token builtin">cap</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid gasLimit: have %v, max %v"</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>GasLimit<span class="token punctuation">,</span> <span class="token builtin">cap</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> header<span class="token punctuation">.</span>GasUsed <span class="token operator">></span> header<span class="token punctuation">.</span>GasLimit <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid gasUsed: have %d, gasLimit %d"</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>GasUsed<span class="token punctuation">,</span> header<span class="token punctuation">.</span>GasLimit<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	diff <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>GasLimit<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">int64</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>GasLimit<span class="token punctuation">)</span>
	<span class="token keyword">if</span> diff <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		diff <span class="token operator">*=</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token punctuation">&#125;</span>
	limit <span class="token operator">:=</span> parent<span class="token punctuation">.</span>GasLimit <span class="token operator">/</span> params<span class="token punctuation">.</span>GasLimitBoundDivisor

	<span class="token keyword">if</span> <span class="token function">uint64</span><span class="token punctuation">(</span>diff<span class="token punctuation">)</span> <span class="token operator">>=</span> limit <span class="token operator">||</span> header<span class="token punctuation">.</span>GasLimit <span class="token operator">&lt;</span> params<span class="token punctuation">.</span>MinGasLimit <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid gas limit: have %d, want %d += %d"</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>GasLimit<span class="token punctuation">,</span> parent<span class="token punctuation">.</span>GasLimit<span class="token punctuation">,</span> limit<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> diff <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> parent<span class="token punctuation">.</span>Number<span class="token punctuation">)</span><span class="token punctuation">;</span> diff<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> consensus<span class="token punctuation">.</span>ErrInvalidNumber
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> seal <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> ethash<span class="token punctuation">.</span><span class="token function">VerifySeal</span><span class="token punctuation">(</span>chain<span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> misc<span class="token punctuation">.</span><span class="token function">VerifyDAOHeaderExtraData</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> misc<span class="token punctuation">.</span><span class="token function">VerifyForkHashes</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">,</span> uncle<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个是区块头验证的主要地方，基本遵循黄皮书4.3.4的所述。分以下几步：</p>
<ol>
<li>验证额外数据长度度：在区块头有一个额外数据的字段Extra，它的长度要小于32字节</li>
<li>验证时间戳：时间戳最基本的要求是要大于父块的时间戳。其次对于如果是一个叔块，时间戳不能太大，代码中要求不大于2的256次方。对于普通区块，不能为未来15秒之外的区块。</li>
<li>验证总难度：首先调用CalcDifficulty计算应该难度，然后判断是否相等，关于难度的计算稍后介绍。</li>
<li>验证gas限制：首先要求不大于2^63-1，但不能小于5000。其次gaslimit还和父块中的gaslimit相关，先关公式如下：<img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/verify-gaslimit.png"></li>
<li>验证gas用量：要求小于gasLimit即可</li>
<li>验证区块高度：要求等于父块高度加一</li>
<li>其他验证：如果方法参数seal为true，执行VerifySeal方法，稍后介绍</li>
<li>验证分叉</li>
</ol>
<h2 id="VerifyHeaders"><a href="#VerifyHeaders" class="headerlink" title="VerifyHeaders"></a>VerifyHeaders</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ethash <span class="token operator">*</span>Ethash<span class="token punctuation">)</span> <span class="token function">VerifyHeaders</span><span class="token punctuation">(</span>chain consensus<span class="token punctuation">.</span>ChainReader<span class="token punctuation">,</span> headers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> seals <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PowMode <span class="token operator">==</span> ModeFullFake <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		abort<span class="token punctuation">,</span> results <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
			results <span class="token operator">&lt;-</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> abort<span class="token punctuation">,</span> results
	<span class="token punctuation">&#125;</span>

	workers <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">GOMAXPROCS</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token operator">&lt;</span> workers <span class="token punctuation">&#123;</span>
		workers <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		inputs <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
		done   <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> workers<span class="token punctuation">)</span>
		errors <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>
		abort  <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> workers<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">for</span> index <span class="token operator">:=</span> <span class="token keyword">range</span> inputs <span class="token punctuation">&#123;</span>
				errors<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> ethash<span class="token punctuation">.</span><span class="token function">verifyHeaderWorker</span><span class="token punctuation">(</span>chain<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> seals<span class="token punctuation">,</span> index<span class="token punctuation">)</span>
				done <span class="token operator">&lt;-</span> index
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	errorsOut <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
		<span class="token keyword">var</span> <span class="token punctuation">(</span>
			in<span class="token punctuation">,</span> out <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
			checked <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">)</span>
			inputs  <span class="token operator">=</span> inputs
		<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> inputs <span class="token operator">&lt;-</span> in<span class="token punctuation">:</span>
				<span class="token keyword">if</span> in<span class="token operator">++</span><span class="token punctuation">;</span> in <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					inputs <span class="token operator">=</span> <span class="token boolean">nil</span>
				<span class="token punctuation">&#125;</span>
			<span class="token keyword">case</span> index <span class="token operator">:=</span> <span class="token operator">&lt;-</span>done<span class="token punctuation">:</span>
				<span class="token keyword">for</span> checked<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> checked<span class="token punctuation">[</span>out<span class="token punctuation">]</span><span class="token punctuation">;</span> out<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
					errorsOut <span class="token operator">&lt;-</span> errors<span class="token punctuation">[</span>out<span class="token punctuation">]</span>
					<span class="token keyword">if</span> out <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">&#123;</span>
						<span class="token keyword">return</span>
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>abort<span class="token punctuation">:</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> abort<span class="token punctuation">,</span> errorsOut
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个是批量验证。首先还是对ModeFullFake模式不进行实质的验证，直接放行。接着利用一个循环，并发的执行verifyHeaderWorker方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ethash <span class="token operator">*</span>Ethash<span class="token punctuation">)</span> <span class="token function">verifyHeaderWorker</span><span class="token punctuation">(</span>chain consensus<span class="token punctuation">.</span>ChainReader<span class="token punctuation">,</span> headers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> seals <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">bool</span><span class="token punctuation">,</span> index <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> parent <span class="token operator">*</span>types<span class="token punctuation">.</span>Header
	<span class="token keyword">if</span> index <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		parent <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">GetHeader</span><span class="token punctuation">(</span>headers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ParentHash<span class="token punctuation">,</span> headers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> headers<span class="token punctuation">[</span>index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> headers<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>ParentHash <span class="token punctuation">&#123;</span>
		parent <span class="token operator">=</span> headers<span class="token punctuation">[</span>index<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> parent <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> consensus<span class="token punctuation">.</span>ErrUnknownAncestor
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> chain<span class="token punctuation">.</span><span class="token function">GetHeader</span><span class="token punctuation">(</span>headers<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> headers<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span> <span class="token comment">// known block</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> ethash<span class="token punctuation">.</span><span class="token function">verifyHeader</span><span class="token punctuation">(</span>chain<span class="token punctuation">,</span> headers<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> parent<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> seals<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里逻辑很简单，根据index验证相应的区块头，首先获取父区块，然后要验证的区块在本地是否存在，之后调用verifyHeader方法。</p>
<p>回到VerifyHeaders，前面的那个并发程序后河面这个匿名方法是组合使用。手下前面的for循环启动了workers个goroutine，workers表示目前可用的cpu核心数，这样做是为了尽量满负荷运行，加速验证过程。但是每个线程都在从inputs这个channel读数据的时候阻塞，这时第二个匿名函数开始执行，首先他向inputs中写入数据，写入的是要验证的区块头的index，这样前面的验证线程可以结束阻塞执行verifyHeaderWorker方法。在验证完成后，将结果写入errors中，并向done赋值，这样又触发匿名方法中select中的逻辑，这里讲错误放入errorsOut，并由errorsOut最终返回。</p>
<h2 id="VerifyUncles"><a href="#VerifyUncles" class="headerlink" title="VerifyUncles"></a>VerifyUncles</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ethash <span class="token operator">*</span>Ethash<span class="token punctuation">)</span> <span class="token function">VerifyUncles</span><span class="token punctuation">(</span>chain consensus<span class="token punctuation">.</span>ChainReader<span class="token punctuation">,</span> block <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PowMode <span class="token operator">==</span> ModeFullFake <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">Uncles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> maxUncles <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errTooManyUncles
	<span class="token punctuation">&#125;</span>

	uncles<span class="token punctuation">,</span> ancestors <span class="token operator">:=</span> mapset<span class="token punctuation">.</span><span class="token function">NewSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span>

	number<span class="token punctuation">,</span> parent <span class="token operator">:=</span> block<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">ParentHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		ancestor <span class="token operator">:=</span> chain<span class="token punctuation">.</span><span class="token function">GetBlock</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> number<span class="token punctuation">)</span>
		<span class="token keyword">if</span> ancestor <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
		ancestors<span class="token punctuation">[</span>ancestor<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> ancestor<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> uncle <span class="token operator">:=</span> <span class="token keyword">range</span> ancestor<span class="token punctuation">.</span><span class="token function">Uncles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			uncles<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>uncle<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		parent<span class="token punctuation">,</span> number <span class="token operator">=</span> ancestor<span class="token punctuation">.</span><span class="token function">ParentHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> number<span class="token operator">-</span><span class="token number">1</span>
	<span class="token punctuation">&#125;</span>
	ancestors<span class="token punctuation">[</span>block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> block<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	uncles<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> uncle <span class="token operator">:=</span> <span class="token keyword">range</span> block<span class="token punctuation">.</span><span class="token function">Uncles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		hash <span class="token operator">:=</span> uncle<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> uncles<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> errDuplicateUncle
		<span class="token punctuation">&#125;</span>
		uncles<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>

		<span class="token keyword">if</span> ancestors<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> errUncleIsAncestor
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> ancestors<span class="token punctuation">[</span>uncle<span class="token punctuation">.</span>ParentHash<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> uncle<span class="token punctuation">.</span>ParentHash <span class="token operator">==</span> block<span class="token punctuation">.</span><span class="token function">ParentHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> errDanglingUncle
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> ethash<span class="token punctuation">.</span><span class="token function">verifyHeader</span><span class="token punctuation">(</span>chain<span class="token punctuation">,</span> uncle<span class="token punctuation">,</span> ancestors<span class="token punctuation">[</span>uncle<span class="token punctuation">.</span>ParentHash<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是验证叔块的。首先也是对于ModeFullFake模式直接放行。然后检查该块的叔块数量，如果大于2报错。接着寻找了该块的父块高度和hash。之后收集了该块的祖先，最高7代。ancestors是一个map，key是hash类型，value是header类型，它存储着从该块的父块开始连续寻找7个祖先块的区块头，最后将自己也放入在内。uncles存储着每一代祖先的所有叔块hash以及该块自己的hash。</p>
<p>之后遍历该块的所有叔块，对于每个叔块，首先验证是否已经在uncles内，uncles存的是该块祖先的叔块，所以他的叔块不应包含在内。在之后验证是否在ancestors，因为ancestors是其直接祖先块，所以也不能成为其叔块。在之后叔块的父块时候包含在ancestors内，或者叔块的父块等于该块的父块，这都是不和逻辑的。最后校验每个叔块是否正确，调用verifyHeader方法</p>
<h2 id="VerifySeal"><a href="#VerifySeal" class="headerlink" title="VerifySeal"></a>VerifySeal</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ethash <span class="token operator">*</span>Ethash<span class="token punctuation">)</span> <span class="token function">VerifySeal</span><span class="token punctuation">(</span>chain consensus<span class="token punctuation">.</span>ChainReader<span class="token punctuation">,</span> header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> ethash<span class="token punctuation">.</span><span class="token function">verifySeal</span><span class="token punctuation">(</span>chain<span class="token punctuation">,</span> header<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ethash <span class="token operator">*</span>Ethash<span class="token punctuation">)</span> <span class="token function">verifySeal</span><span class="token punctuation">(</span>chain consensus<span class="token punctuation">.</span>ChainReader<span class="token punctuation">,</span> header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> fulldag <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PowMode <span class="token operator">==</span> ModeFake <span class="token operator">||</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PowMode <span class="token operator">==</span> ModeFullFake <span class="token punctuation">&#123;</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>ethash<span class="token punctuation">.</span>fakeDelay<span class="token punctuation">)</span>
		<span class="token keyword">if</span> ethash<span class="token punctuation">.</span>fakeFail <span class="token operator">==</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> errInvalidPoW
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> ethash<span class="token punctuation">.</span>shared <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> ethash<span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">verifySeal</span><span class="token punctuation">(</span>chain<span class="token punctuation">,</span> header<span class="token punctuation">,</span> fulldag<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> header<span class="token punctuation">.</span>Difficulty<span class="token punctuation">.</span><span class="token function">Sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errInvalidDifficulty
	<span class="token punctuation">&#125;</span>

	number <span class="token operator">:=</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		digest <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
		result <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
	<span class="token punctuation">)</span>

	<span class="token keyword">if</span> fulldag <span class="token punctuation">&#123;</span>
		dataset <span class="token operator">:=</span> ethash<span class="token punctuation">.</span><span class="token function">dataset</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> dataset<span class="token punctuation">.</span><span class="token function">generated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			digest<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token function">hashimotoFull</span><span class="token punctuation">(</span>dataset<span class="token punctuation">.</span>dataset<span class="token punctuation">,</span> ethash<span class="token punctuation">.</span><span class="token function">SealHash</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>Nonce<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

			runtime<span class="token punctuation">.</span><span class="token function">KeepAlive</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// Dataset not yet generated, don't hang, use a cache instead</span>
			fulldag <span class="token operator">=</span> <span class="token boolean">false</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>fulldag <span class="token punctuation">&#123;</span>
		cache <span class="token operator">:=</span> ethash<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span>

		size <span class="token operator">:=</span> <span class="token function">datasetSize</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span>
		<span class="token keyword">if</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PowMode <span class="token operator">==</span> ModeTest <span class="token punctuation">&#123;</span>
			size <span class="token operator">=</span> <span class="token number">32</span> <span class="token operator">*</span> <span class="token number">1024</span>
		<span class="token punctuation">&#125;</span>
		digest<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token function">hashimotoLight</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> cache<span class="token punctuation">.</span>cache<span class="token punctuation">,</span> ethash<span class="token punctuation">.</span><span class="token function">SealHash</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>Nonce<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

		runtime<span class="token punctuation">.</span><span class="token function">KeepAlive</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>bytes<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>MixDigest<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> digest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errInvalidMixDigest
	<span class="token punctuation">&#125;</span>
	target <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Div</span><span class="token punctuation">(</span>two256<span class="token punctuation">,</span> header<span class="token punctuation">.</span>Difficulty<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetBytes</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errInvalidPoW
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法用来检测区块是否满足PoW的难度要求，主要是验证nonce。首先对于ModeFake和ModeFullFake不进行检测。另外如果是shared模式，则采用对应的verifySeal方法。接下来检测区块头的难度值必须大于0.接下来根据fulldag的具体情况执行不同逻辑。</p>
<p>如果fullgdag为true，则先加载对应数据集，如果数据集已经产生则使用hashimotoFull进行验证，否则fulldag置为false。如果fullgad为false，则加载对应的随机数集cache，然后计算数据集大小，之后用hashimotoLight进行验证。这两处都用了KeepAlive方法，这是告诉编译器不要回收给定代码的内存。</p>
<p>验证之后返回两个结果digest和result，按照下面公式进行验证：</p>
<p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/pow1.png">。</p>
<p>其中的n就是result，m就是digest。Hd表示该区块的难度；Hm表示该区块头的mixHash字段，是一个256位的哈希值，用来与nonce一起证明当前区块已经承载了足够的计算量。上图中的PoW函数的第一个参数表示不包含nonce和mixHash的区块头，也就是SealHash方法所产生的。</p>
<h2 id="Prepare"><a href="#Prepare" class="headerlink" title="Prepare"></a>Prepare</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ethash <span class="token operator">*</span>Ethash<span class="token punctuation">)</span> <span class="token function">Prepare</span><span class="token punctuation">(</span>chain consensus<span class="token punctuation">.</span>ChainReader<span class="token punctuation">,</span> header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	parent <span class="token operator">:=</span> chain<span class="token punctuation">.</span><span class="token function">GetHeader</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>ParentHash<span class="token punctuation">,</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> parent <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> consensus<span class="token punctuation">.</span>ErrUnknownAncestor
	<span class="token punctuation">&#125;</span>
	header<span class="token punctuation">.</span>Difficulty <span class="token operator">=</span> ethash<span class="token punctuation">.</span><span class="token function">CalcDifficulty</span><span class="token punctuation">(</span>chain<span class="token punctuation">,</span> header<span class="token punctuation">.</span>Time<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法首先查找了给定区块头的父区块，然后计算了难度。</p>
<h2 id="Finalize"><a href="#Finalize" class="headerlink" title="Finalize"></a>Finalize</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ethash <span class="token operator">*</span>Ethash<span class="token punctuation">)</span> <span class="token function">Finalize</span><span class="token punctuation">(</span>chain consensus<span class="token punctuation">.</span>ChainReader<span class="token punctuation">,</span> header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> state <span class="token operator">*</span>state<span class="token punctuation">.</span>StateDB<span class="token punctuation">,</span> txs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> uncles <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> receipts <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Receipt<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">accumulateRewards</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> header<span class="token punctuation">,</span> uncles<span class="token punctuation">)</span>
	header<span class="token punctuation">.</span>Root <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">IntermediateRoot</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsEIP158</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>Number<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> types<span class="token punctuation">.</span><span class="token function">NewBlock</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> txs<span class="token punctuation">,</span> uncles<span class="token punctuation">,</span> receipts<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先调用accumulateRewards发放奖励：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">accumulateRewards</span><span class="token punctuation">(</span>config <span class="token operator">*</span>params<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">,</span> state <span class="token operator">*</span>state<span class="token punctuation">.</span>StateDB<span class="token punctuation">,</span> header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">,</span> uncles <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	blockReward <span class="token operator">:=</span> FrontierBlockReward
	<span class="token keyword">if</span> config<span class="token punctuation">.</span><span class="token function">IsByzantium</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>Number<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		blockReward <span class="token operator">=</span> ByzantiumBlockReward
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> config<span class="token punctuation">.</span><span class="token function">IsConstantinople</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>Number<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		blockReward <span class="token operator">=</span> ConstantinopleBlockReward
	<span class="token punctuation">&#125;</span>

	reward <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>blockReward<span class="token punctuation">)</span>
	r <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> uncle <span class="token operator">:=</span> <span class="token keyword">range</span> uncles <span class="token punctuation">&#123;</span>
		r<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>uncle<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> big8<span class="token punctuation">)</span>
		r<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">)</span>
		r<span class="token punctuation">.</span><span class="token function">Mul</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> blockReward<span class="token punctuation">)</span>
		r<span class="token punctuation">.</span><span class="token function">Div</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> big8<span class="token punctuation">)</span>
		state<span class="token punctuation">.</span><span class="token function">AddBalance</span><span class="token punctuation">(</span>uncle<span class="token punctuation">.</span>Coinbase<span class="token punctuation">,</span> r<span class="token punctuation">)</span>

		r<span class="token punctuation">.</span><span class="token function">Div</span><span class="token punctuation">(</span>blockReward<span class="token punctuation">,</span> big32<span class="token punctuation">)</span>
		reward<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>reward<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	state<span class="token punctuation">.</span><span class="token function">AddBalance</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>Coinbase<span class="token punctuation">,</span> reward<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先根据区块高度决定基本的区块奖励，详细奖励发放的细节见黄皮书11.3节描述。如果是拜占庭版本也就是区块高度大于4370000，每个区块基本奖励为3以太币。如果是君士坦丁堡版本，也就是区块高度大于7280000，每个区块基本奖励为2以太币。如果区块高度低于4370000，则是5以太币。之后遍历所有叔块，每多一个叔块，奖励提高三十二分之一的基本区块奖励。对于每个叔块也有其相应奖励，公式如下：</p>
<p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/reward.png"></p>
<p>上面公式用Ui表示叔块高度，BHi表示当前区块高度，Rblock表示表示基本区块奖励。每计算一个叔块用state的AddBalance修改对应地址的余额。最后修改该区块头的coinbase余额，奖励发放完毕。</p>
<p>回到Finalize，计算新状态的状态树根hash，然后染回一个新的区块。</p>
<h2 id="CalcDifficulty"><a href="#CalcDifficulty" class="headerlink" title="CalcDifficulty"></a>CalcDifficulty</h2><p>这是一个计算难度的方法，用于计算一个区块应有的难度。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ethash <span class="token operator">*</span>Ethash<span class="token punctuation">)</span> <span class="token function">CalcDifficulty</span><span class="token punctuation">(</span>chain consensus<span class="token punctuation">.</span>ChainReader<span class="token punctuation">,</span> time <span class="token builtin">uint64</span><span class="token punctuation">,</span> parent <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token operator">*</span>big<span class="token punctuation">.</span>Int <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token function">CalcDifficulty</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">CalcDifficulty</span><span class="token punctuation">(</span>config <span class="token operator">*</span>params<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">,</span> time <span class="token builtin">uint64</span><span class="token punctuation">,</span> parent <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token operator">*</span>big<span class="token punctuation">.</span>Int <span class="token punctuation">&#123;</span>
	next <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> big1<span class="token punctuation">)</span>
	<span class="token keyword">switch</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> config<span class="token punctuation">.</span><span class="token function">IsConstantinople</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">calcDifficultyConstantinople</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
	<span class="token keyword">case</span> config<span class="token punctuation">.</span><span class="token function">IsByzantium</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">calcDifficultyByzantium</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
	<span class="token keyword">case</span> config<span class="token punctuation">.</span><span class="token function">IsHomestead</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">calcDifficultyHomestead</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">calcDifficultyFrontier</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里首先计算该区块多对应的版本号，简单说一下不同版本的划分，高度在7280000以上的为君士坦丁堡版本；高度在4370000以上的为拜占庭版本；高度在1150000以上的为家园(Homestead)版本；最后高度在1150000一下的为前沿(Frontier)版本。其中君士坦丁堡版本和拜占庭版本都调用了makeDifficultyCalculator方法，区别是其中的参数不同，这个参数为了推迟难度炸弹的来临，关于难度计算是根据黄皮书中的公式计算的，这里讲一下公式，公式如下：</p>
<p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/head/difficulty.png"></p>
<p>公式(41)描述了难度的计算，首先创世区块为131072，转为16进制表示就是0x‭20000，这就是官网给的创世区块json示例中的难度值。对于非创世区块则在两个值中取一个最大值。第一个值就是创世区块的难度。第二个值由三部分组成：</p>
<ol>
<li>P(H)Hd表示父区块难度</li>
<li>x表示父区块的难度除以2048并向下取整。与x相乘的有一个系数，由公式(44)计算。这个公式中y有父区块的叔块数量决定，如果叔块数量为0则取1，否则取2.公式(44)中的Hs表示当前区块的时间戳，P(H)Hs表示父区块的时间戳。</li>
<li>第三部分由公式(45)(46)联合计算，这里在以太坊初始版本中没有公式(46)，直接是用区块高度除以100000，由于是做指数运算，会使第三部分的值每十万个区块指数增长一次，难度值会越来越夸张，所以从拜占庭版本开始对区块高度减去一个值，拜占庭版本是3000000，君士坦丁堡版本是5000000。公式中的Hi就是区块高度。</li>
</ol>
<p>区块的难度就由上面的公式计算的，代码也都是一些数学运算，这里不再叙述了。</p>
<p>关于难度计算通过公式可以看到也是动态调整的，首先它是基于父块的难度，然后难度的第二部分，当两个区块时间间隔过近时，x的系数为正，加大难度；当两个区块时间间隔过远时，x的系数为负数，减小难度值。最后一部分则会根据区块高度稳定增加一定的难度。</p>
<h2 id="Seal"><a href="#Seal" class="headerlink" title="Seal"></a>Seal</h2><p>这个方法就是尝试找到一个nonce去满足PoW要求，然后封装一个区块</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ethash <span class="token operator">*</span>Ethash<span class="token punctuation">)</span> <span class="token function">Seal</span><span class="token punctuation">(</span>chain consensus<span class="token punctuation">.</span>ChainReader<span class="token punctuation">,</span> block <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">,</span> results <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">,</span> stop <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PowMode <span class="token operator">==</span> ModeFake <span class="token operator">||</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PowMode <span class="token operator">==</span> ModeFullFake <span class="token punctuation">&#123;</span>
		header <span class="token operator">:=</span> block<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		header<span class="token punctuation">.</span>Nonce<span class="token punctuation">,</span> header<span class="token punctuation">.</span>MixDigest <span class="token operator">=</span> types<span class="token punctuation">.</span>BlockNonce<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> results <span class="token operator">&lt;-</span> block<span class="token punctuation">.</span><span class="token function">WithSeal</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Sealing result is not read by miner"</span><span class="token punctuation">,</span> <span class="token string">"mode"</span><span class="token punctuation">,</span> <span class="token string">"fake"</span><span class="token punctuation">,</span> <span class="token string">"sealhash"</span><span class="token punctuation">,</span> ethash<span class="token punctuation">.</span><span class="token function">SealHash</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> ethash<span class="token punctuation">.</span>shared <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> ethash<span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">Seal</span><span class="token punctuation">(</span>chain<span class="token punctuation">,</span> block<span class="token punctuation">,</span> results<span class="token punctuation">,</span> stop<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	abort <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	ethash<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	threads <span class="token operator">:=</span> ethash<span class="token punctuation">.</span>threads
	<span class="token keyword">if</span> ethash<span class="token punctuation">.</span>rand <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		seed<span class="token punctuation">,</span> err <span class="token operator">:=</span> crand<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span>crand<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>MaxInt64<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			ethash<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
		ethash<span class="token punctuation">.</span>rand <span class="token operator">=</span> rand<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">NewSource</span><span class="token punctuation">(</span>seed<span class="token punctuation">.</span><span class="token function">Int64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	ethash<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> threads <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		threads <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">NumCPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> threads <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		threads <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// Allows disabling local mining without extra logic around local/remote</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> ethash<span class="token punctuation">.</span>workCh <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		ethash<span class="token punctuation">.</span>workCh <span class="token operator">&lt;-</span> <span class="token operator">&amp;</span>sealTask<span class="token punctuation">&#123;</span>block<span class="token punctuation">:</span> block<span class="token punctuation">,</span> results<span class="token punctuation">:</span> results<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		pend   sync<span class="token punctuation">.</span>WaitGroup
		locals <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">)</span>
	<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threads<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		pend<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>id <span class="token builtin">int</span><span class="token punctuation">,</span> nonce <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">defer</span> pend<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			ethash<span class="token punctuation">.</span><span class="token function">mine</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> id<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> abort<span class="token punctuation">,</span> locals<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token function">uint64</span><span class="token punctuation">(</span>ethash<span class="token punctuation">.</span>rand<span class="token punctuation">.</span><span class="token function">Int63</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">var</span> result <span class="token operator">*</span>types<span class="token punctuation">.</span>Block
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>stop<span class="token punctuation">:</span>
			<span class="token function">close</span><span class="token punctuation">(</span>abort<span class="token punctuation">)</span>
		<span class="token keyword">case</span> result <span class="token operator">=</span> <span class="token operator">&lt;-</span>locals<span class="token punctuation">:</span>
			<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> results <span class="token operator">&lt;-</span> result<span class="token punctuation">:</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>
				log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Sealing result is not read by miner"</span><span class="token punctuation">,</span> <span class="token string">"mode"</span><span class="token punctuation">,</span> <span class="token string">"local"</span><span class="token punctuation">,</span> <span class="token string">"sealhash"</span><span class="token punctuation">,</span> ethash<span class="token punctuation">.</span><span class="token function">SealHash</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			<span class="token function">close</span><span class="token punctuation">(</span>abort<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ethash<span class="token punctuation">.</span>update<span class="token punctuation">:</span>
			<span class="token function">close</span><span class="token punctuation">(</span>abort<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> ethash<span class="token punctuation">.</span><span class="token function">Seal</span><span class="token punctuation">(</span>chain<span class="token punctuation">,</span> block<span class="token punctuation">,</span> results<span class="token punctuation">,</span> stop<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Failed to restart sealing after update"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		pend<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先对于ModeFake或ModeFullFake模式，直接打包一个区块，nonce为0。另外如果为shared模式则调用对应的Seal方法。</p>
<p>接下来ethash.threads获取挖矿线程数，如果为0的话表示线程数等于cpu核数，如果小于0则禁用。接着如果随机数种子为空，则生成一个。接着启动threads个goroutine去执行mine方法。另外在外面还有一个独立的goroutine执行一个匿名方法，用于接受信号执行响应逻辑。stop读到信号表示终止操作；locals读到信号表示有线程找到了合法值；update收到信号表示进行重启。最后这个方法会等待前面执行mine的goroutine都结束才会退出。</p>
<h2 id="mine"><a href="#mine" class="headerlink" title="mine"></a>mine</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ethash <span class="token operator">*</span>Ethash<span class="token punctuation">)</span> <span class="token function">mine</span><span class="token punctuation">(</span>block <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">,</span> id <span class="token builtin">int</span><span class="token punctuation">,</span> seed <span class="token builtin">uint64</span><span class="token punctuation">,</span> abort <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> found <span class="token keyword">chan</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		header  <span class="token operator">=</span> block<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		hash    <span class="token operator">=</span> ethash<span class="token punctuation">.</span><span class="token function">SealHash</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		target  <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Div</span><span class="token punctuation">(</span>two256<span class="token punctuation">,</span> header<span class="token punctuation">.</span>Difficulty<span class="token punctuation">)</span>
		number  <span class="token operator">=</span> header<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		dataset <span class="token operator">=</span> ethash<span class="token punctuation">.</span><span class="token function">dataset</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
	<span class="token punctuation">)</span>

	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		attempts <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
		nonce    <span class="token operator">=</span> seed
	<span class="token punctuation">)</span>
	logger <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"miner"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span>
	logger<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Started ethash search for new nonces"</span><span class="token punctuation">,</span> <span class="token string">"seed"</span><span class="token punctuation">,</span> seed<span class="token punctuation">)</span>
search<span class="token punctuation">:</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>abort<span class="token punctuation">:</span>
			logger<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Ethash nonce search aborted"</span><span class="token punctuation">,</span> <span class="token string">"attempts"</span><span class="token punctuation">,</span> nonce<span class="token operator">-</span>seed<span class="token punctuation">)</span>
			ethash<span class="token punctuation">.</span>hashrate<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span>attempts<span class="token punctuation">)</span>
			<span class="token keyword">break</span> search

		<span class="token keyword">default</span><span class="token punctuation">:</span>
			attempts<span class="token operator">++</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>attempts <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				ethash<span class="token punctuation">.</span>hashrate<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span>attempts<span class="token punctuation">)</span>
				attempts <span class="token operator">=</span> <span class="token number">0</span>
			<span class="token punctuation">&#125;</span>
			digest<span class="token punctuation">,</span> result <span class="token operator">:=</span> <span class="token function">hashimotoFull</span><span class="token punctuation">(</span>dataset<span class="token punctuation">.</span>dataset<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> nonce<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetBytes</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				header <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">CopyHeader</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span>
				header<span class="token punctuation">.</span>Nonce <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">EncodeNonce</span><span class="token punctuation">(</span>nonce<span class="token punctuation">)</span>
				header<span class="token punctuation">.</span>MixDigest <span class="token operator">=</span> common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>digest<span class="token punctuation">)</span>

				<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">case</span> found <span class="token operator">&lt;-</span> block<span class="token punctuation">.</span><span class="token function">WithSeal</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">:</span>
					logger<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Ethash nonce found and reported"</span><span class="token punctuation">,</span> <span class="token string">"attempts"</span><span class="token punctuation">,</span> nonce<span class="token operator">-</span>seed<span class="token punctuation">,</span> <span class="token string">"nonce"</span><span class="token punctuation">,</span> nonce<span class="token punctuation">)</span>
				<span class="token keyword">case</span> <span class="token operator">&lt;-</span>abort<span class="token punctuation">:</span>
					logger<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Ethash nonce found but discarded"</span><span class="token punctuation">,</span> <span class="token string">"attempts"</span><span class="token punctuation">,</span> nonce<span class="token operator">-</span>seed<span class="token punctuation">,</span> <span class="token string">"nonce"</span><span class="token punctuation">,</span> nonce<span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">break</span> search
			<span class="token punctuation">&#125;</span>
			nonce<span class="token operator">++</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	runtime<span class="token punctuation">.</span><span class="token function">KeepAlive</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法才是实际上寻找nonce的方法，基本逻辑从后面的for循环开始，从给定的seed开始，每次加一，利用hashimotoFull计算digest和result，就和前面的VerifySeal方法一样，只要result小于target即可。target等于2^256除以区块的难度。</p>
<p>如果找到的话给区块头补充nonce和misdigest字段，并通过WithSeal产生一个区块赋值给found，found就是前面Seal中的locals。</p>
<h1 id="Ethash算法"><a href="#Ethash算法" class="headerlink" title="Ethash算法"></a>Ethash算法</h1><p><a target="_blank" rel="noopener" href="https://github.com/ethereum/wiki/wiki/Ethash">官方文档</a>有详细的叙述，这里简单描述一下。</p>
<p>Ethash是以太坊中PoW的主要算法，基本流程如下：</p>
<ol>
<li>根据区块高度计算出一个seed</li>
<li>根据seed产生一个16MB伪随机数据集cache</li>
<li>根据cache产生一个1GB大小的数据集DAG，一般完全节点需要DAG，轻客户端只需要cache</li>
<li>从DAG中随机选出元素，对其进行hash运算，看是否满足要求</li>
<li>数据集30000个区块更新一次，约100小时，并且会线性增长，DAG每次增长8MB，cache每次128KB。（之所以是100小时，目的是为了在18月左右增长一倍，符合摩尔定律）</li>
</ol>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> cache <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	epoch <span class="token builtin">uint64</span>    <span class="token comment">// Epoch for which this cache is relevant</span>
	dump  <span class="token operator">*</span>os<span class="token punctuation">.</span>File  <span class="token comment">// File descriptor of the memory mapped cache</span>
	mmap  mmap<span class="token punctuation">.</span>MMap <span class="token comment">// Memory map itself to unmap before releasing</span>
	cache <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span>  <span class="token comment">// The actual cache data content (may be memory mapped)</span>
	once  sync<span class="token punctuation">.</span>Once <span class="token comment">// Ensures the cache is generated only once</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> dataset <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	epoch   <span class="token builtin">uint64</span>    <span class="token comment">// Epoch for which this cache is relevant</span>
	dump    <span class="token operator">*</span>os<span class="token punctuation">.</span>File  <span class="token comment">// File descriptor of the memory mapped cache</span>
	mmap    mmap<span class="token punctuation">.</span>MMap <span class="token comment">// Memory map itself to unmap before releasing</span>
	dataset <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span>  <span class="token comment">// The actual cache data content</span>
	once    sync<span class="token punctuation">.</span>Once <span class="token comment">// Ensures the cache is generated only once</span>
	done    <span class="token builtin">uint32</span>    <span class="token comment">// Atomic flag to determine generation status</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="cache生成"><a href="#cache生成" class="headerlink" title="cache生成"></a>cache生成</h2><p>前面在verifySeal方法中就通过cache获取了对应的cache</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ethash <span class="token operator">*</span>Ethash<span class="token punctuation">)</span> <span class="token function">cache</span><span class="token punctuation">(</span>block <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token operator">*</span>cache <span class="token punctuation">&#123;</span>
	epoch <span class="token operator">:=</span> block <span class="token operator">/</span> epochLength
	currentI<span class="token punctuation">,</span> futureI <span class="token operator">:=</span> ethash<span class="token punctuation">.</span>caches<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span>
	current <span class="token operator">:=</span> currentI<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>cache<span class="token punctuation">)</span>

	current<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>CacheDir<span class="token punctuation">,</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>CachesOnDisk<span class="token punctuation">,</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PowMode <span class="token operator">==</span> ModeTest<span class="token punctuation">)</span>


	<span class="token keyword">if</span> futureI <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		future <span class="token operator">:=</span> futureI<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>cache<span class="token punctuation">)</span>
		<span class="token keyword">go</span> future<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>CacheDir<span class="token punctuation">,</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>CachesOnDisk<span class="token punctuation">,</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PowMode <span class="token operator">==</span> ModeTest<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> current
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一步计算了代数，就是区块高度除以30000，然后从caches从尝试获取cache，caches的get获取所需代数及下一代的cache。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>lru <span class="token operator">*</span>lru<span class="token punctuation">)</span> <span class="token function">get</span><span class="token punctuation">(</span>epoch <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span> future <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	lru<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> lru<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	item<span class="token punctuation">,</span> ok <span class="token operator">:=</span> lru<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> lru<span class="token punctuation">.</span>future <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> lru<span class="token punctuation">.</span>future <span class="token operator">==</span> epoch <span class="token punctuation">&#123;</span>
			item <span class="token operator">=</span> lru<span class="token punctuation">.</span>futureItem
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Requiring new ethash "</span><span class="token operator">+</span>lru<span class="token punctuation">.</span>what<span class="token punctuation">,</span> <span class="token string">"epoch"</span><span class="token punctuation">,</span> epoch<span class="token punctuation">)</span>
			item <span class="token operator">=</span> lru<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		lru<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> item<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> epoch <span class="token operator">&lt;</span> maxEpoch<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> lru<span class="token punctuation">.</span>future <span class="token operator">&lt;</span> epoch<span class="token operator">+</span><span class="token number">1</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Requiring new future ethash "</span><span class="token operator">+</span>lru<span class="token punctuation">.</span>what<span class="token punctuation">,</span> <span class="token string">"epoch"</span><span class="token punctuation">,</span> epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
		future <span class="token operator">=</span> lru<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
		lru<span class="token punctuation">.</span>future <span class="token operator">=</span> epoch <span class="token operator">+</span> <span class="token number">1</span>
		lru<span class="token punctuation">.</span>futureItem <span class="token operator">=</span> future
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> item<span class="token punctuation">,</span> future
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>lru.cache是一个lru类型的缓存，先从中获取指定代数的，如果没有尝试从futureItem中获取，futureItem永远存储着下一代的cache，当然最开始为空。如果都没有新建一个。不管从哪里取到的话，如果代数低于最大代数，而且future需要更新的话，就更新future与futureItem。</p>
<p>我们再看新建方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">newCache</span><span class="token punctuation">(</span>epoch <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>cache<span class="token punctuation">&#123;</span>epoch<span class="token punctuation">:</span> epoch<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>就是新建一个cache对象。回到cache方法，调用了generate方法</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cache<span class="token punctuation">)</span> <span class="token function">generate</span><span class="token punctuation">(</span>dir <span class="token builtin">string</span><span class="token punctuation">,</span> limit <span class="token builtin">int</span><span class="token punctuation">,</span> test <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	c<span class="token punctuation">.</span>once<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		size <span class="token operator">:=</span> <span class="token function">cacheSize</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>epoch<span class="token operator">*</span>epochLength <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
		seed <span class="token operator">:=</span> <span class="token function">seedHash</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>epoch<span class="token operator">*</span>epochLength <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> test <span class="token punctuation">&#123;</span>
			size <span class="token operator">=</span> <span class="token number">1024</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> dir <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
			c<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> size<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span>
			<span class="token function">generateCache</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>cache<span class="token punctuation">,</span> c<span class="token punctuation">.</span>epoch<span class="token punctuation">,</span> seed<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">var</span> endian <span class="token builtin">string</span>
		<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isLittleEndian</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			endian <span class="token operator">=</span> <span class="token string">".be"</span>
		<span class="token punctuation">&#125;</span>
		path <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"cache-R%d-%x%s"</span><span class="token punctuation">,</span> algorithmRevision<span class="token punctuation">,</span> seed<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> endian<span class="token punctuation">)</span><span class="token punctuation">)</span>
		logger <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"epoch"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>epoch<span class="token punctuation">)</span>


		runtime<span class="token punctuation">.</span><span class="token function">SetFinalizer</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>cache<span class="token punctuation">)</span><span class="token punctuation">.</span>finalizer<span class="token punctuation">)</span>


		<span class="token keyword">var</span> err <span class="token builtin">error</span>
		c<span class="token punctuation">.</span>dump<span class="token punctuation">,</span> c<span class="token punctuation">.</span>mmap<span class="token punctuation">,</span> c<span class="token punctuation">.</span>cache<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">memoryMap</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Loaded old ethash cache from disk"</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
		logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Failed to load old ethash cache"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>


		c<span class="token punctuation">.</span>dump<span class="token punctuation">,</span> c<span class="token punctuation">.</span>mmap<span class="token punctuation">,</span> c<span class="token punctuation">.</span>cache<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">memoryMapAndGenerate</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>buffer <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">generateCache</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>epoch<span class="token punctuation">,</span> seed<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Failed to generate mapped ethash cache"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>

			c<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> size<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span>
			<span class="token function">generateCache</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>cache<span class="token punctuation">,</span> c<span class="token punctuation">.</span>epoch<span class="token punctuation">,</span> seed<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">for</span> ep <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>epoch<span class="token punctuation">)</span> <span class="token operator">-</span> limit<span class="token punctuation">;</span> ep <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> ep<span class="token operator">--</span> <span class="token punctuation">&#123;</span>
			seed <span class="token operator">:=</span> <span class="token function">seedHash</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span>ep<span class="token punctuation">)</span><span class="token operator">*</span>epochLength <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
			path <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"cache-R%d-%x%s"</span><span class="token punctuation">,</span> algorithmRevision<span class="token punctuation">,</span> seed<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> endian<span class="token punctuation">)</span><span class="token punctuation">)</span>
			os<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先计算了cache大小，使用cacheSize方法，如果代数小于2048（按30000块一代，2048代有61440000个区块，需要二十几年才能生成）则根据预先计算好的表查找，否则先计算size = 初始值(128MB) + 128KB * 代数 - 64B，然后验证size/64取整后是否为质数，否则size减去128在验证，循环递减直到size/64取整后为质数。对于测试模式直接设为1024.</p>
<p>第二步计算了seed，如果是第零代区块，直接返回一个空的长度为32的字节数组。否则对那个空字节数组循环做n次keccak256哈希运算，n就是区块所在代数。总之seed是一个256位的数据</p>
<p>接着组装了本地的存储文件，接下来的runtime.SetFinalizer方法是设置cache被回收时执行的方法。接着调用memoryMap将加载文件并在内存中映射，这个方法如果不报错说明之前在磁盘有旧文件，可以直接用。否则需要生成cache文件。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">memoryMapAndGenerate</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">,</span> size <span class="token builtin">uint64</span><span class="token punctuation">,</span> generator <span class="token keyword">func</span><span class="token punctuation">(</span>buffer <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>os<span class="token punctuation">.</span>File<span class="token punctuation">,</span> mmap<span class="token punctuation">.</span>MMap<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Dir</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	temp <span class="token operator">:=</span> path <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	dump<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> err <span class="token operator">=</span> dump<span class="token punctuation">.</span><span class="token function">Truncate</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>dumpMagic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span> <span class="token operator">+</span> <span class="token function">int64</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	mem<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">memoryMapFile</span><span class="token punctuation">(</span>dump<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		dump<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> dumpMagic<span class="token punctuation">)</span>

	data <span class="token operator">:=</span> buffer<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>dumpMagic<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token function">generator</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> mem<span class="token punctuation">.</span><span class="token function">Unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> dump<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Rename</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token function">memoryMap</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先创建目录，然后创建一个临时文件，接着调用Truncate方法修改临时文件大小，大小为8+size。接着映射该临时文件到内存，用的是memoryMapFile方法，我们具体看一下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">memoryMapFile</span><span class="token punctuation">(</span>file <span class="token operator">*</span>os<span class="token punctuation">.</span>File<span class="token punctuation">,</span> write <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>mmap<span class="token punctuation">.</span>MMap<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

	flag <span class="token operator">:=</span> mmap<span class="token punctuation">.</span>RDONLY
	<span class="token keyword">if</span> write <span class="token punctuation">&#123;</span>
		flag <span class="token operator">=</span> mmap<span class="token punctuation">.</span>RDWR
	<span class="token punctuation">&#125;</span>
	mem<span class="token punctuation">,</span> err <span class="token operator">:=</span> mmap<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>

	header <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>reflect<span class="token punctuation">.</span>SliceHeader<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mem<span class="token punctuation">)</span><span class="token punctuation">)</span>
	header<span class="token punctuation">.</span>Len <span class="token operator">/=</span> <span class="token number">4</span>
	header<span class="token punctuation">.</span>Cap <span class="token operator">/=</span> <span class="token number">4</span>

	<span class="token keyword">return</span> mem<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>header<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先设置模式，只读或是可读写。接着调用mmap.Map方法，这是”github.com/edsrzf/mmap-go”的库。mmap将一个文件或者其它对象映射进内存，让用户程序直接访问设备内存，这种机制，相比较在用户空间和内核空间互相拷贝数据，效率更高。Map方法返回一个MMap对象，翻阅源码实际就是字节数组。接下来将MMap转为一个切片（切片实际就是SliceHeader类型），这里将切片的长度和容器都缩减到原来四分之一，这是因为原来是字节数组，后面要改为uin32数组，之后有将修改过的切片转为32位无符号整形数组连同MMap一起返回。</p>
<p>回到memoryMapAndGenerate中，这里将dumpMagic拷贝到刚才返回的那个uint32数组中，dumpMagic是预置的一个含有两个魔法数的数组。接着调用generator生成数据，实际上是generateCache方法</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">generateCache</span><span class="token punctuation">(</span>dest <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> epoch <span class="token builtin">uint64</span><span class="token punctuation">,</span> seed <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	logger <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"epoch"</span><span class="token punctuation">,</span> epoch<span class="token punctuation">)</span>

	start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		elapsed <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span>

		logFn <span class="token operator">:=</span> logger<span class="token punctuation">.</span>Debug
		<span class="token keyword">if</span> elapsed <span class="token operator">></span> <span class="token number">3</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second <span class="token punctuation">&#123;</span>
			logFn <span class="token operator">=</span> logger<span class="token punctuation">.</span>Info
		<span class="token punctuation">&#125;</span>
		<span class="token function">logFn</span><span class="token punctuation">(</span><span class="token string">"Generated ethash verification cache"</span><span class="token punctuation">,</span> <span class="token string">"elapsed"</span><span class="token punctuation">,</span> common<span class="token punctuation">.</span><span class="token function">PrettyDuration</span><span class="token punctuation">(</span>elapsed<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	header <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>reflect<span class="token punctuation">.</span>SliceHeader<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dest<span class="token punctuation">)</span><span class="token punctuation">)</span>
	header<span class="token punctuation">.</span>Len <span class="token operator">*=</span> <span class="token number">4</span>
	header<span class="token punctuation">.</span>Cap <span class="token operator">*=</span> <span class="token number">4</span>
	cache <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>header<span class="token punctuation">)</span><span class="token punctuation">)</span>


	size <span class="token operator">:=</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">)</span>
	rows <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">/</span> hashBytes


	<span class="token keyword">var</span> progress <span class="token builtin">uint32</span>

	done <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>done<span class="token punctuation">:</span>
				<span class="token keyword">return</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">:</span>
				logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Generating ethash verification cache"</span><span class="token punctuation">,</span> <span class="token string">"percentage"</span><span class="token punctuation">,</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>progress<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span><span class="token function">uint32</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">"elapsed"</span><span class="token punctuation">,</span> common<span class="token punctuation">.</span><span class="token function">PrettyDuration</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	keccak512 <span class="token operator">:=</span> <span class="token function">makeHasher</span><span class="token punctuation">(</span>sha3<span class="token punctuation">.</span><span class="token function">NewLegacyKeccak512</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token function">keccak512</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> seed<span class="token punctuation">)</span>
	<span class="token keyword">for</span> offset <span class="token operator">:=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>hashBytes<span class="token punctuation">)</span><span class="token punctuation">;</span> offset <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> offset <span class="token operator">+=</span> hashBytes <span class="token punctuation">&#123;</span>
		<span class="token function">keccak512</span><span class="token punctuation">(</span>cache<span class="token punctuation">[</span>offset<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cache<span class="token punctuation">[</span>offset<span class="token operator">-</span>hashBytes<span class="token punctuation">:</span>offset<span class="token punctuation">]</span><span class="token punctuation">)</span>
		atomic<span class="token punctuation">.</span><span class="token function">AddUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>progress<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	temp <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> hashBytes<span class="token punctuation">)</span>

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cacheRounds<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> rows<span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">var</span> <span class="token punctuation">(</span>
				srcOff <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>j <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">+</span> rows<span class="token punctuation">)</span> <span class="token operator">%</span> rows<span class="token punctuation">)</span> <span class="token operator">*</span> hashBytes
				dstOff <span class="token operator">=</span> j <span class="token operator">*</span> hashBytes
				xorOff <span class="token operator">=</span> <span class="token punctuation">(</span>binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">Uint32</span><span class="token punctuation">(</span>cache<span class="token punctuation">[</span>dstOff<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">uint32</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> hashBytes
			<span class="token punctuation">)</span>
			bitutil<span class="token punctuation">.</span><span class="token function">XORBytes</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> cache<span class="token punctuation">[</span>srcOff<span class="token punctuation">:</span>srcOff<span class="token operator">+</span>hashBytes<span class="token punctuation">]</span><span class="token punctuation">,</span> cache<span class="token punctuation">[</span>xorOff<span class="token punctuation">:</span>xorOff<span class="token operator">+</span>hashBytes<span class="token punctuation">]</span><span class="token punctuation">)</span>
			<span class="token function">keccak512</span><span class="token punctuation">(</span>cache<span class="token punctuation">[</span>dstOff<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> temp<span class="token punctuation">)</span>

			atomic<span class="token punctuation">.</span><span class="token function">AddUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>progress<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isLittleEndian</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token function">swap</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>传入的参数有三个。第一个就是生成的数据要填充的数组，也就是前面映射文件时返回的一个数组，第二个是区块所在代数，第三个是开始计算的种子。cache生成流程如下：</p>
<ol>
<li><p>第一步将传进来的数组转为切片，然后长度和容量都乘以4。这里有几个大小需要注意，首先创建临时文件时大小是8+size，映射完返回的buffer容量是2+cap/4，之后前两个字节被写入固定值，之后剩余cap/4容量被传过来，这里又乘以4，进行了恢复，目的是为了将uint32数组转为字节数组，一个uint32等于4个字节长度。之后再将切片转为字节数组。然后计算大小size和轮数rows。接着启动一个goroutine，里面有一个for-select结构，每3秒打印一个log，显示cache生成进度。</p>
</li>
<li><p>第二步，准备一个hash函数–keccak512，keccak512(cache, seed)方法表示对seed计算hash值并写入cache中。此时cache的前512位也就是前64个字节</p>
</li>
<li><p>第三步开始一个循环，对cache进行预填充，每512位一组即64字节，第一组是对seed进行hash后的结果，之后每一组都是对前一组的hash。</p>
</li>
<li><p>第四步开始主循环，外循环有3轮，内循环轮数为第一步计算的rows。这一步连同上一步合起来是一种叫RandMemoHash的函数，是一种内存困难型的计算，详细内容参见<a target="_blank" rel="noopener" href="http://www.hashcash.org/papers/memohash.pdf">原文</a>或者<a target="_blank" rel="noopener" href="https://blog.grapefruit.tk/2019/05/22/%E4%B8%A5%E6%A0%BC%E7%9A%84%E5%86%85%E5%AD%98%E5%9B%B0%E9%9A%BE%E5%9E%8B%E5%93%88%E5%B8%8C%E5%87%BD%E6%95%B0/">译文</a>。这里不再叙述，只是说一下几个方法的作用，XORBytes接受三个参数，作用是将第二个和第三个参数异或后的结果放入第一个参数中。keccak512是对第二个参数做hash运算，结果放入第一个参数。</p>
</li>
</ol>
<p>经过上面第四步的循环后，cache被填满，最后还要保证cache中的数据时小端模式。注意cache是由header转换类型而来的，header则是的dest转换类型而来的，所以最后dest中也填满了数据。</p>
<p>最后cache中是若干组数据，每组有64个字节，也就是512位数据。</p>
<p>再回到memoryMapAndGenerate中，经过generator方法后，data填充了数据，data是buffer从2开始的切片，buffer前两个索引被放入的魔法数字，此时buffer也是有数据的。接着解除映射，这一步会将刚才内存中的数据写入文件，但注意此时还是那个temp临时文件，这里对其重命名，然后调用memoryMap</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">memoryMap</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>os<span class="token punctuation">.</span>File<span class="token punctuation">,</span> mmap<span class="token punctuation">.</span>MMap<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_RDONLY<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	mem<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">memoryMapFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> magic <span class="token operator">:=</span> <span class="token keyword">range</span> dumpMagic <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> magic <span class="token punctuation">&#123;</span>
			mem<span class="token punctuation">.</span><span class="token function">Unmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrInvalidDumpMagic
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> file<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> buffer<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>dumpMagic<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> err
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里再次对文件进行映射，只不过这次时只读模式，然后检查开头两个魔法数字来判断格式是否正确，然后返回文件句柄，映射对象，实际数据。</p>
<p>再往前回到cache的generate方法，memoryMapAndGenerate结束后，返回的几个值分别赋给了cache的几个成员，其中cache就是实际数据。接着判断前一步是否有错，有错的话则不映射文件直接生成数据。最后删除之前一些旧的文件。</p>
<p>最后回到Ethash的cache方法，此时我们只是生成的当前代的cache，接下来，为了方便，我们在生成下一代的cache，不过是在一个独立的goroutine中生成，方法一样，最后返回当前代的cache。</p>
<h2 id="dataset生成"><a href="#dataset生成" class="headerlink" title="dataset生成"></a>dataset生成</h2><p>同样在verifySeal方法中也有获取dateset的方法，用的是ethash的dataset方法</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ethash <span class="token operator">*</span>Ethash<span class="token punctuation">)</span> <span class="token function">dataset</span><span class="token punctuation">(</span>block <span class="token builtin">uint64</span><span class="token punctuation">,</span> async <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>dataset <span class="token punctuation">&#123;</span>
	epoch <span class="token operator">:=</span> block <span class="token operator">/</span> epochLength
	currentI<span class="token punctuation">,</span> futureI <span class="token operator">:=</span> ethash<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span>
	current <span class="token operator">:=</span> currentI<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>dataset<span class="token punctuation">)</span>

	<span class="token keyword">if</span> async <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>current<span class="token punctuation">.</span><span class="token function">generated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			current<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>DatasetDir<span class="token punctuation">,</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>DatasetsOnDisk<span class="token punctuation">,</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PowMode <span class="token operator">==</span> ModeTest<span class="token punctuation">)</span>

			<span class="token keyword">if</span> futureI <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				future <span class="token operator">:=</span> futureI<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>dataset<span class="token punctuation">)</span>
				future<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>DatasetDir<span class="token punctuation">,</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>DatasetsOnDisk<span class="token punctuation">,</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PowMode <span class="token operator">==</span> ModeTest<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		current<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>DatasetDir<span class="token punctuation">,</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>DatasetsOnDisk<span class="token punctuation">,</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PowMode <span class="token operator">==</span> ModeTest<span class="token punctuation">)</span>

		<span class="token keyword">if</span> futureI <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			future <span class="token operator">:=</span> futureI<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>dataset<span class="token punctuation">)</span>
			<span class="token keyword">go</span> future<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>DatasetDir<span class="token punctuation">,</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>DatasetsOnDisk<span class="token punctuation">,</span> ethash<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PowMode <span class="token operator">==</span> ModeTest<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> current
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>前三行和cache一样，都尝试获取当前和下一代的数据集，接着判断当前代的dataset是否已经生成，没有的话调用generate</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>dataset<span class="token punctuation">)</span> <span class="token function">generate</span><span class="token punctuation">(</span>dir <span class="token builtin">string</span><span class="token punctuation">,</span> limit <span class="token builtin">int</span><span class="token punctuation">,</span> test <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	d<span class="token punctuation">.</span>once<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">defer</span> atomic<span class="token punctuation">.</span><span class="token function">StoreUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>done<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

		csize <span class="token operator">:=</span> <span class="token function">cacheSize</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>epoch<span class="token operator">*</span>epochLength <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
		dsize <span class="token operator">:=</span> <span class="token function">datasetSize</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>epoch<span class="token operator">*</span>epochLength <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
		seed <span class="token operator">:=</span> <span class="token function">seedHash</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>epoch<span class="token operator">*</span>epochLength <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> test <span class="token punctuation">&#123;</span>
			csize <span class="token operator">=</span> <span class="token number">1024</span>
			dsize <span class="token operator">=</span> <span class="token number">32</span> <span class="token operator">*</span> <span class="token number">1024</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> dir <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
			cache <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> csize<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span>
			<span class="token function">generateCache</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> d<span class="token punctuation">.</span>epoch<span class="token punctuation">,</span> seed<span class="token punctuation">)</span>

			d<span class="token punctuation">.</span>dataset <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> dsize<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span>
			<span class="token function">generateDataset</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>dataset<span class="token punctuation">,</span> d<span class="token punctuation">.</span>epoch<span class="token punctuation">,</span> cache<span class="token punctuation">)</span>

			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">var</span> endian <span class="token builtin">string</span>
		<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isLittleEndian</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			endian <span class="token operator">=</span> <span class="token string">".be"</span>
		<span class="token punctuation">&#125;</span>
		path <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"full-R%d-%x%s"</span><span class="token punctuation">,</span> algorithmRevision<span class="token punctuation">,</span> seed<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> endian<span class="token punctuation">)</span><span class="token punctuation">)</span>
		logger <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"epoch"</span><span class="token punctuation">,</span> d<span class="token punctuation">.</span>epoch<span class="token punctuation">)</span>

		runtime<span class="token punctuation">.</span><span class="token function">SetFinalizer</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>dataset<span class="token punctuation">)</span><span class="token punctuation">.</span>finalizer<span class="token punctuation">)</span>

		d<span class="token punctuation">.</span>dump<span class="token punctuation">,</span> d<span class="token punctuation">.</span>mmap<span class="token punctuation">,</span> d<span class="token punctuation">.</span>dataset<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">memoryMap</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Loaded old ethash dataset from disk"</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
		logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Failed to load old ethash dataset"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>


		cache <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> csize<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span>
		<span class="token function">generateCache</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> d<span class="token punctuation">.</span>epoch<span class="token punctuation">,</span> seed<span class="token punctuation">)</span>

		d<span class="token punctuation">.</span>dump<span class="token punctuation">,</span> d<span class="token punctuation">.</span>mmap<span class="token punctuation">,</span> d<span class="token punctuation">.</span>dataset<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">memoryMapAndGenerate</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> dsize<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>buffer <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">generateDataset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> d<span class="token punctuation">.</span>epoch<span class="token punctuation">,</span> cache<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Failed to generate mapped ethash dataset"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>

			d<span class="token punctuation">.</span>dataset <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> dsize<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token function">generateDataset</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>dataset<span class="token punctuation">,</span> d<span class="token punctuation">.</span>epoch<span class="token punctuation">,</span> cache<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">for</span> ep <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>epoch<span class="token punctuation">)</span> <span class="token operator">-</span> limit<span class="token punctuation">;</span> ep <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> ep<span class="token operator">--</span> <span class="token punctuation">&#123;</span>
			seed <span class="token operator">:=</span> <span class="token function">seedHash</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span>ep<span class="token punctuation">)</span><span class="token operator">*</span>epochLength <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
			path <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"full-R%d-%x%s"</span><span class="token punctuation">,</span> algorithmRevision<span class="token punctuation">,</span> seed<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> endian<span class="token punctuation">)</span><span class="token punctuation">)</span>
			os<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里首先计算了对应代的cache大小和种子seed，和前面cache中一样，不在叙述。除此之外还计算了dateset大小：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">datasetSize</span><span class="token punctuation">(</span>block <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">&#123;</span>
	epoch <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>block <span class="token operator">/</span> epochLength<span class="token punctuation">)</span>
	<span class="token keyword">if</span> epoch <span class="token operator">&lt;</span> maxEpoch <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> datasetSizes<span class="token punctuation">[</span>epoch<span class="token punctuation">]</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token function">calcDatasetSize</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">calcDatasetSize</span><span class="token punctuation">(</span>epoch <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">&#123;</span>
	size <span class="token operator">:=</span> datasetInitBytes <span class="token operator">+</span> datasetGrowthBytes<span class="token operator">*</span><span class="token function">uint64</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span> <span class="token operator">-</span> mixBytes
	<span class="token keyword">for</span> <span class="token operator">!</span><span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetUint64</span><span class="token punctuation">(</span>size <span class="token operator">/</span> mixBytes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ProbablyPrime</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// Always accurate for n &lt; 2^64</span>
		size <span class="token operator">-=</span> <span class="token number">2</span> <span class="token operator">*</span> mixBytes
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> size
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>和计算cachesize一样，对于2048代以内是查表，超过2048代是size=1GB+8MB*代数-128B，同样还是要求size除以128为质数，否则减去256在判断，如此循环直到为质数为止。</p>
<p>回到generate中，如果是测试模式，则设置cache的大小为1024，dateset大小为32*1024。接着如果没有指定目录的话，则不用文件映射，直接先生成一个cache，之后再生成dateset</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">generateDataset</span><span class="token punctuation">(</span>dest <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> epoch <span class="token builtin">uint64</span><span class="token punctuation">,</span> cache <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	logger <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"epoch"</span><span class="token punctuation">,</span> epoch<span class="token punctuation">)</span>

	start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		elapsed <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span>

		logFn <span class="token operator">:=</span> logger<span class="token punctuation">.</span>Debug
		<span class="token keyword">if</span> elapsed <span class="token operator">></span> <span class="token number">3</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second <span class="token punctuation">&#123;</span>
			logFn <span class="token operator">=</span> logger<span class="token punctuation">.</span>Info
		<span class="token punctuation">&#125;</span>
		<span class="token function">logFn</span><span class="token punctuation">(</span><span class="token string">"Generated ethash verification cache"</span><span class="token punctuation">,</span> <span class="token string">"elapsed"</span><span class="token punctuation">,</span> common<span class="token punctuation">.</span><span class="token function">PrettyDuration</span><span class="token punctuation">(</span>elapsed<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	swapped <span class="token operator">:=</span> <span class="token operator">!</span><span class="token function">isLittleEndian</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	header <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>reflect<span class="token punctuation">.</span>SliceHeader<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dest<span class="token punctuation">)</span><span class="token punctuation">)</span>
	header<span class="token punctuation">.</span>Len <span class="token operator">*=</span> <span class="token number">4</span>
	header<span class="token punctuation">.</span>Cap <span class="token operator">*=</span> <span class="token number">4</span>
	dataset <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>header<span class="token punctuation">)</span><span class="token punctuation">)</span>

	threads <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">NumCPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	size <span class="token operator">:=</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">var</span> pend sync<span class="token punctuation">.</span>WaitGroup
	pend<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>threads<span class="token punctuation">)</span>

	<span class="token keyword">var</span> progress <span class="token builtin">uint32</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threads<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>id <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">defer</span> pend<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

			keccak512 <span class="token operator">:=</span> <span class="token function">makeHasher</span><span class="token punctuation">(</span>sha3<span class="token punctuation">.</span><span class="token function">NewLegacyKeccak512</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

			batch <span class="token operator">:=</span> <span class="token function">uint32</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size <span class="token operator">+</span> hashBytes<span class="token operator">*</span><span class="token function">uint64</span><span class="token punctuation">(</span>threads<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>hashBytes <span class="token operator">*</span> <span class="token function">uint64</span><span class="token punctuation">(</span>threads<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			first <span class="token operator">:=</span> <span class="token function">uint32</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">*</span> batch
			limit <span class="token operator">:=</span> first <span class="token operator">+</span> batch
			<span class="token keyword">if</span> limit <span class="token operator">></span> <span class="token function">uint32</span><span class="token punctuation">(</span>size<span class="token operator">/</span>hashBytes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				limit <span class="token operator">=</span> <span class="token function">uint32</span><span class="token punctuation">(</span>size <span class="token operator">/</span> hashBytes<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>

			percent <span class="token operator">:=</span> <span class="token function">uint32</span><span class="token punctuation">(</span>size <span class="token operator">/</span> hashBytes <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span>
			<span class="token keyword">for</span> index <span class="token operator">:=</span> first<span class="token punctuation">;</span> index <span class="token operator">&lt;</span> limit<span class="token punctuation">;</span> index<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
				item <span class="token operator">:=</span> <span class="token function">generateDatasetItem</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> index<span class="token punctuation">,</span> keccak512<span class="token punctuation">)</span>
				<span class="token keyword">if</span> swapped <span class="token punctuation">&#123;</span>
					<span class="token function">swap</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
				<span class="token function">copy</span><span class="token punctuation">(</span>dataset<span class="token punctuation">[</span>index<span class="token operator">*</span>hashBytes<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span>

				<span class="token keyword">if</span> status <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">AddUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>progress<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> status<span class="token operator">%</span>percent <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
					logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Generating DAG in progress"</span><span class="token punctuation">,</span> <span class="token string">"percentage"</span><span class="token punctuation">,</span> <span class="token function">uint64</span><span class="token punctuation">(</span>status<span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>size<span class="token operator">/</span>hashBytes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"elapsed"</span><span class="token punctuation">,</span> common<span class="token punctuation">.</span><span class="token function">PrettyDuration</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	pend<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里首先对传入的dest也就是要存放数据的数组进行处理，先转为切片，修改其长度和容量，都是扩大4倍，之后再转为字节数组类型。接着获取cpu核数记为threads，获取数据集大小，然后启动threads个独立的goroutine。</p>
<p>首先dataset的整体数据结构和cache类似，都是按64字节也就是512位为一组，这里为了实现多线程并行计算，在每个goroutine中计算了需要计算的组数，然后循环调用generateDatasetItem生成每一组数据：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">generateDatasetItem</span><span class="token punctuation">(</span>cache <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> index <span class="token builtin">uint32</span><span class="token punctuation">,</span> keccak512 hasher<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">&#123;</span>
	rows <span class="token operator">:=</span> <span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span> <span class="token operator">/</span> hashWords<span class="token punctuation">)</span>

	mix <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> hashBytes<span class="token punctuation">)</span>

	binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">PutUint32</span><span class="token punctuation">(</span>mix<span class="token punctuation">,</span> cache<span class="token punctuation">[</span><span class="token punctuation">(</span>index<span class="token operator">%</span>rows<span class="token punctuation">)</span><span class="token operator">*</span>hashWords<span class="token punctuation">]</span><span class="token operator">^</span>index<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> hashWords<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">PutUint32</span><span class="token punctuation">(</span>mix<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cache<span class="token punctuation">[</span><span class="token punctuation">(</span>index<span class="token operator">%</span>rows<span class="token punctuation">)</span><span class="token operator">*</span>hashWords<span class="token operator">+</span><span class="token function">uint32</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">keccak512</span><span class="token punctuation">(</span>mix<span class="token punctuation">,</span> mix<span class="token punctuation">)</span>

	intMix <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> hashWords<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>intMix<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		intMix<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">Uint32</span><span class="token punctuation">(</span>mix<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">uint32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> datasetParents<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		parent <span class="token operator">:=</span> <span class="token function">fnv</span><span class="token punctuation">(</span>index<span class="token operator">^</span>i<span class="token punctuation">,</span> intMix<span class="token punctuation">[</span>i<span class="token operator">%</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> rows
		<span class="token function">fnvHash</span><span class="token punctuation">(</span>intMix<span class="token punctuation">,</span> cache<span class="token punctuation">[</span>parent<span class="token operator">*</span>hashWords<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> i<span class="token punctuation">,</span> val <span class="token operator">:=</span> <span class="token keyword">range</span> intMix <span class="token punctuation">&#123;</span>
		binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">PutUint32</span><span class="token punctuation">(</span>mix<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">keccak512</span><span class="token punctuation">(</span>mix<span class="token punctuation">,</span> mix<span class="token punctuation">)</span>
	<span class="token keyword">return</span> mix
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先把cache中的数据每16个视作一行，计算cache的总行数，由于cache每个元素时32位，16个也即是512位，也就是cache中的一组。这里初始化了一个含有64字节的数组mix，总长度也就是512位。接着按照一定规则计算mix，基本原则是充分利用cache中足够多的数据。</p>
<p>接着把mix中的数据放入一个长度为16的32位整型数组intmix，总长度也是512位。然后有一个循环，每次循环都利用了所谓的fnv和fnvhash函数，总循环为256次，目的还是尽可能多的使用cache中数据。每次循环的结果还是放在intmix中。（<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Fowler%E2%80%93Noll%E2%80%93Vo_hash_function">fnv</a>全称Fowler–Noll–Vo，也是一种hash函数，他计算速度非常快，冲突率较低，也就是对于相似的数据也能产生大量的差别，其分散性较好，之所以用它是为了能较为随机的从数据集中取数据，避免数据间的使用率差别较大）</p>
<p>最后将intmix的数据写入mix中，再对mix做一次哈希运算，最后得到一个512位的数据，就是dataset中一组数据。</p>
<p>数据集的生成算法借鉴了Hashimoto算法，要想了解更多请参考<a target="_blank" rel="noopener" href="http://diyhpl.us/~bryan/papers2/bitcoin/meh/hashimoto.pdf">Hashimoto算法</a>，译文<a target="_blank" rel="noopener" href="https://blog.grapefruit.tk/2019/05/23/Hashimoto%EF%BC%9AIO%E9%99%90%E5%88%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E8%AF%81%E6%98%8E/">见这里</a></p>
<p>回到generateDataset中，调用generateDatasetItem之后，获取了一组数据，将其放到dateset对应位置，经过若干次上面过程后一个完整的dataset得以生成。</p>
<p>回到dataset的generate方法中，刚才我们分析的是没有指定数据存储路径的流程，接下来我们在看一下有数据路径的流程。</p>
<p>首先构建文件的最终路径，然后调用memoryMap进行映射，这一步和cache相同，如果没有错误说明原本就有，直接返回，读取的数据放入dataset相应字段中。如果读不到数据或有错，则先用generateCache生成cache数据，在使用memoryMapAndGenerate生成空文件，并进行映射然后生成dataset数据进行填充，流程和cache一样，不在叙述。只不过和前面直接生成数据不同的是，这里在数据开头写入了64位的魔法数字，和cache一样。最后尝试旧的数据文件，和cache一样的流程。</p>
<p>最后回到ethash的dataset方法，在这里主要是分了同步还是异步，逻辑都还是一样，只不过异步的是在一个单独的goroutine中执行的。最后生成完当代的dateset后，又根据具体需要生成了下一代数据。</p>
<h2 id="hashimotoFull"><a href="#hashimotoFull" class="headerlink" title="hashimotoFull"></a>hashimotoFull</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">hashimotoFull</span><span class="token punctuation">(</span>dataset <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> hash <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> nonce <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	lookup <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>index <span class="token builtin">uint32</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span> <span class="token punctuation">&#123;</span>
		offset <span class="token operator">:=</span> index <span class="token operator">*</span> hashWords
		<span class="token keyword">return</span> dataset<span class="token punctuation">[</span>offset <span class="token punctuation">:</span> offset<span class="token operator">+</span>hashWords<span class="token punctuation">]</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token function">hashimoto</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">,</span> lookup<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是在全节点中节点有完整dateset数据集时的验证方法，直接调用了hashimoto方法</p>
<h2 id="hashimotoLight"><a href="#hashimotoLight" class="headerlink" title="hashimotoLight"></a>hashimotoLight</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">hashimotoLight</span><span class="token punctuation">(</span>size <span class="token builtin">uint64</span><span class="token punctuation">,</span> cache <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> hash <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> nonce <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	keccak512 <span class="token operator">:=</span> <span class="token function">makeHasher</span><span class="token punctuation">(</span>sha3<span class="token punctuation">.</span><span class="token function">NewLegacyKeccak512</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	lookup <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>index <span class="token builtin">uint32</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span> <span class="token punctuation">&#123;</span>
		rawData <span class="token operator">:=</span> <span class="token function">generateDatasetItem</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> index<span class="token punctuation">,</span> keccak512<span class="token punctuation">)</span>

		data <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rawData<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
			data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">Uint32</span><span class="token punctuation">(</span>rawData<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> data
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token function">hashimoto</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> size<span class="token punctuation">,</span> lookup<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是没有完整dataset之后cache的轻节点的验证方法，也是直接调用了hashimoto方法，和hashimotoFull的区别是lookup的差别</p>
<h2 id="hashimoto"><a href="#hashimoto" class="headerlink" title="hashimoto"></a>hashimoto</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">hashimoto</span><span class="token punctuation">(</span>hash <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> nonce <span class="token builtin">uint64</span><span class="token punctuation">,</span> size <span class="token builtin">uint64</span><span class="token punctuation">,</span> lookup <span class="token keyword">func</span><span class="token punctuation">(</span>index <span class="token builtin">uint32</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	rows <span class="token operator">:=</span> <span class="token function">uint32</span><span class="token punctuation">(</span>size <span class="token operator">/</span> mixBytes<span class="token punctuation">)</span>


	seed <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>seed<span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
	binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">PutUint64</span><span class="token punctuation">(</span>seed<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nonce<span class="token punctuation">)</span>

	seed <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">Keccak512</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
	seedHead <span class="token operator">:=</span> binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">Uint32</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span>


	mix <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> mixBytes<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>mix<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		mix<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">Uint32</span><span class="token punctuation">(</span>seed<span class="token punctuation">[</span>i<span class="token operator">%</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	temp <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>mix<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> loopAccesses<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		parent <span class="token operator">:=</span> <span class="token function">fnv</span><span class="token punctuation">(</span><span class="token function">uint32</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">^</span>seedHead<span class="token punctuation">,</span> mix<span class="token punctuation">[</span>i<span class="token operator">%</span><span class="token function">len</span><span class="token punctuation">(</span>mix<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> rows
		<span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token function">uint32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> mixBytes<span class="token operator">/</span>hashBytes<span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
			<span class="token function">copy</span><span class="token punctuation">(</span>temp<span class="token punctuation">[</span>j<span class="token operator">*</span>hashWords<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">lookup</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>parent<span class="token operator">+</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token function">fnvHash</span><span class="token punctuation">(</span>mix<span class="token punctuation">,</span> temp<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>mix<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">4</span> <span class="token punctuation">&#123;</span>
		mix<span class="token punctuation">[</span>i<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">fnv</span><span class="token punctuation">(</span><span class="token function">fnv</span><span class="token punctuation">(</span><span class="token function">fnv</span><span class="token punctuation">(</span>mix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> mix<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mix<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mix<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	mix <span class="token operator">=</span> mix<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>mix<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">]</span>

	digest <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> common<span class="token punctuation">.</span>HashLength<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> val <span class="token operator">:=</span> <span class="token keyword">range</span> mix <span class="token punctuation">&#123;</span>
		binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">PutUint32</span><span class="token punctuation">(</span>digest<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> digest<span class="token punctuation">,</span> crypto<span class="token punctuation">.</span><span class="token function">Keccak256</span><span class="token punctuation">(</span><span class="token function">append</span><span class="token punctuation">(</span>seed<span class="token punctuation">,</span> digest<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先根据给定的头部hash和nonce计算seed，头部hash是32字节，nonce是8字节，将其拼接后做一次keccak512哈希运算，得到一个长度为64的字节数组。接着创建了一个无符号32位整型数组，长度是32。然后将seed中的数据数据放入mix中，由于mix总位数是seed的两倍，所以mix先后放置了两个seed的数据内容。</p>
<p>继续向下，设置一个和mix大小一样的临时数组。开始了64次循环，每次循环还是fnv和fnvhash进行运算，其中循环中fnv即其后的那个循环是为了对temp进行填充，fnvhash是为了利用temp对mix进行运算，最后结果放入mix中。关键一点是在lookup中。对于节点有完整dataset时，lookup实现如下</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">lookup <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>index <span class="token builtin">uint32</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span> <span class="token punctuation">&#123;</span>
		offset <span class="token operator">:=</span> index <span class="token operator">*</span> hashWords
		<span class="token keyword">return</span> dataset<span class="token punctuation">[</span>offset <span class="token punctuation">:</span> offset<span class="token operator">+</span>hashWords<span class="token punctuation">]</span>
	<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单就是输入一个索引，然后从dateset中取一组数据（16个uint32数据，共512位）。对于没有完整dateset时，实现如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">lookup <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>index <span class="token builtin">uint32</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span> <span class="token punctuation">&#123;</span>
		rawData <span class="token operator">:=</span> <span class="token function">generateDatasetItem</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> index<span class="token punctuation">,</span> keccak512<span class="token punctuation">)</span>

		data <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>rawData<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
			data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">Uint32</span><span class="token punctuation">(</span>rawData<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> data
	<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于没有完整的数据，我们要根据索引去临时计算一个数据，调用的是generateDatasetItem方法，这个计算量以及内存占用都是比较少的。</p>
<p>回到hshimoto中，之所以用fnv以及lookup只是为了能随机的从dateset中取一个数据，这样对于挖矿节点，最优的方法是在内存中完整保留dataset数据副本，这就是内存困难型工作证明函数。经过64轮的fnv、lookup及fnvhash运算，最后得到的还是mix数组，接着对mix进行压缩，压缩为之前的四分之一，也就是128位，这就是区块头的MixDigest字段。最后将seed（512位）和digest拼接进行一次keccak256运算得到一个256位的值，挖矿也就是将这个值和难度值比较。</p>
<p>这里我们简要分析一下，从dataset中取数据的索引由parent和j构成，parent由seedhead（seed的前四个字节按小端序组成）和mix（mix由seed经过简单的操作生成），j则是0或1。而seed是由头结点hash和nonce组成。所以对于验证节点，只需一个完整的cache数据，然后在那64轮循环中，每次循环根据索引从cache中计算0dateset的某组数据。而对于挖矿节点，虽然也可以和验证节点一样每次都计算一组，但是由于每次是从整个dataset中随机选一组数据，虽然是伪随机的，但是也难以预测，所以最好的方法是能是保存整个数据集副本，这样就实现了内存困难型计算。</p>
<p>最后在验证过程中既要小于难度值，又要等于digest，所以也就强迫挖矿节点按照刚才流程来进行计算。因为最后和难度值比较的数只是seed和某个128位的值拼接后hash的结果，所以如果不比较digest，挖矿节点只用不断尝试nonce，然后计算出seed即可，digest就是使用dateset的一个证明。</p>
<h2 id="geth生成数据集"><a href="#geth生成数据集" class="headerlink" title="geth生成数据集"></a>geth生成数据集</h2><p>为了方便我们测试，geth提供了生成数据集的命令，只用指定区块号即可</p>
<pre class="line-numbers language-none"><code class="language-none">geth makecache 36000 ethash&#x2F;
geth makedag 36000 ethash&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="关于大小端"><a href="#关于大小端" class="headerlink" title="关于大小端"></a>关于大小端</h2><p>无论是cache还是dateset中的数据都是按照小端模式存储的。所谓小端模式就是在低地址中存放低位，相反低地址存放高位就是大端模式。对于0x01020304这个数，04就是低位，01就是高位。源码中也给出了测试我们的机器是大端还是小端的代码：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">isLittleEndian</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	n <span class="token operator">:=</span> <span class="token function">uint32</span><span class="token punctuation">(</span><span class="token number">0x01020304</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x04</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，就是存一个数，然后取低地址看是否是低位即可，这里的取低地址就是通过指针转为字节类型，由于32位整型转为8位字节，只保留的低位数据。</p>
<p>关于为什么要使用小端模式，实际上无论大小端都可以，但是在计算数据集的时候存在多次uin32与[]byte的转换，如果不统一一下格式，在不同机器上就会有不同结果。同样源码也给出了转为小端模式的代码</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">swap</span><span class="token punctuation">(</span>buffer <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">4</span> <span class="token punctuation">&#123;</span>
		binary<span class="token punctuation">.</span>BigEndian<span class="token punctuation">.</span><span class="token function">PutUint32</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span><span class="token function">Uint32</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>littleEndian<span class="token punctuation">)</span> <span class="token function">Uint32</span><span class="token punctuation">(</span>b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">uint32</span> <span class="token punctuation">&#123;</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> b<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token comment">// bounds check hint to compiler; see golang.org/issue/14808</span>
	<span class="token keyword">return</span> <span class="token function">uint32</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">uint32</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span> <span class="token operator">|</span> <span class="token function">uint32</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span> <span class="token operator">|</span> <span class="token function">uint32</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">24</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际就是利用了littleEndian中的方法翻一下顺序即可。</p>
<blockquote>
<p>题图来自unsplash：<a target="_blank" rel="noopener" href="https://unsplash.com/photos/kDJ4i77UPe0">https://unsplash.com/photos/kDJ4i77UPe0</a></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag"><i class="fa fa-tag"></i> 区块链</a>
              <a href="/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" rel="tag"><i class="fa fa-tag"></i> 以太坊</a>
              <a href="/tags/go/" rel="tag"><i class="fa fa-tag"></i> go</a>
              <a href="/tags/go-ethereum/" rel="tag"><i class="fa fa-tag"></i> go-ethereum</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/05/30/golang%E6%96%87%E4%BB%B6%E9%94%81/" rel="prev" title="golang文件锁">
                  <i class="fa fa-chevron-left"></i> golang文件锁
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/06/08/go-ethereum%E4%B8%ADevm%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" rel="next" title="go-ethereum中evm源码学习">
                  go-ethereum中evm源码学习 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">AmorFati</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">632k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:35</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
