<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">

<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CConsolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="article">
<meta property="og:title" content="go-ethereum中trie源码学习">
<meta property="og:url" content="http://example.com/2019/03/26/go-ethereum%E4%B8%ADtrie%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="AmorFati">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/t1.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/t2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/t3.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/t4.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/t5.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/t6.png">
<meta property="article:published_time" content="2019-03-26T07:26:20.000Z">
<meta property="article:modified_time" content="2021-11-17T13:54:30.496Z">
<meta property="article:author" content="AmorFati">
<meta property="article:tag" content="区块链">
<meta property="article:tag" content="以太坊">
<meta property="article:tag" content="go">
<meta property="article:tag" content="go-ethereum">
<meta property="article:tag" content="数据结构">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/t1.jpg">


<link rel="canonical" href="http://example.com/2019/03/26/go-ethereum%E4%B8%ADtrie%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2019/03/26/go-ethereum%E4%B8%ADtrie%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/","path":"2019/03/26/go-ethereum中trie源码学习/","title":"go-ethereum中trie源码学习"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>go-ethereum中trie源码学习 | AmorFati</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">AmorFati</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">风吹过窗前的书，又翻过一页</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Trie%E6%A0%91"><span class="nav-number">1.1.</span> <span class="nav-text">Trie树</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Patricia-Trie"><span class="nav-number">1.2.</span> <span class="nav-text">Patricia Trie</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Merkle%E6%A0%91"><span class="nav-number">1.3.</span> <span class="nav-text">Merkle树</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%9A%84MPT"><span class="nav-number">2.</span> <span class="nav-text">以太坊的MPT</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E7%82%B9%E5%AE%9A%E4%B9%89"><span class="nav-number">3.1.</span> <span class="nav-text">结点定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%91%E7%9A%84%E6%9E%84%E9%80%A0"><span class="nav-number">3.2.</span> <span class="nav-text">树的构造</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E6%A3%B5%E6%A0%91"><span class="nav-number">3.2.1.</span> <span class="nav-text">创建一棵树</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%92%E5%85%A5"><span class="nav-number">3.2.2.</span> <span class="nav-text">插入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4"><span class="nav-number">3.2.3.</span> <span class="nav-text">删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2"><span class="nav-number">3.2.4.</span> <span class="nav-text">查询</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E7%A0%81"><span class="nav-number">3.3.</span> <span class="nav-text">编码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#hexToCompact"><span class="nav-number">3.3.1.</span> <span class="nav-text">hexToCompact</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#compactToHex"><span class="nav-number">3.3.2.</span> <span class="nav-text">compactToHex</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#keybytesToHex"><span class="nav-number">3.3.3.</span> <span class="nav-text">keybytesToHex</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hexToKeybytes"><span class="nav-number">3.3.4.</span> <span class="nav-text">hexToKeybytes</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">3.4.</span> <span class="nav-text">序列化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">3.5.</span> <span class="nav-text">反序列化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#trie%E7%9A%84cache"><span class="nav-number">3.6.</span> <span class="nav-text">trie的cache</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SecureTrie"><span class="nav-number">3.7.</span> <span class="nav-text">SecureTrie</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#database-go"><span class="nav-number">3.8.</span> <span class="nav-text">database.go</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#InsertBlob"><span class="nav-number">3.8.1.</span> <span class="nav-text">InsertBlob</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Commit"><span class="nav-number">3.8.2.</span> <span class="nav-text">Commit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reference"><span class="nav-number">3.8.3.</span> <span class="nav-text">Reference</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cap"><span class="nav-number">3.8.4.</span> <span class="nav-text">Cap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Preimage"><span class="nav-number">3.8.5.</span> <span class="nav-text">Preimage</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="AmorFati"
      src="/assets/img/icon.jpg">
  <p class="site-author-name" itemprop="name">AmorFati</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/1chenyy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;1chenyy" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:henyang4346@foxmail.com" title="E-Mail → mailto:henyang4346@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/52c1bec4559c" title="简书 → https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;52c1bec4559c" rel="noopener" target="_blank"><i class="fa fa-globe fa-fw"></i>简书</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/03/26/go-ethereum%E4%B8%ADtrie%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/icon.jpg">
      <meta itemprop="name" content="AmorFati">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmorFati">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          go-ethereum中trie源码学习
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-03-26 15:26:20" itemprop="dateCreated datePublished" datetime="2019-03-26T15:26:20+08:00">2019-03-26</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-11-17 21:54:30" itemprop="dateModified" datetime="2021-11-17T21:54:30+08:00">2021-11-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go-ethereum%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">go-ethereum源码学习</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>28k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>25 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/t1.jpg"></p>
<span id="more"></span>
<p>MPT（Merkle Patricia Tree），是以太坊实现中广泛使用的一种数据结构，如在区块头中就保存了状态树，交易树和收据树这三棵树的根的hash，而这三棵树就是MPT。MPT是Trie树、Patricia Trie树和Merkle树的变形，下面我们就来详细了解一下</p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><h2 id="Trie树"><a href="#Trie树" class="headerlink" title="Trie树"></a>Trie树</h2><p>Trie树又称前缀树或字典树。顾名思义一个节点的所有孩子都具有同样的前缀，就像字典一样把单词按前缀分类排序。</p>
<ol>
<li>在Trie树中，根节点不保存信息，每个节点的最大孩子数量相同（若是保存英文字母，不区分大小写，则最多有26个孩子）。</li>
<li>从根节点开始，到某一节点，路径上的字符组合起来就是该节点对应的字符串</li>
<li>没有重复的节点</li>
</ol>
<p>语言说起来比较抽象，看一张图就很清楚了</p>
<p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/t2.png"></p>
<p>如上图所示，这棵树可能保存了:A,to,tea,ted,ten,i,in,inn这8个字符串（具体某个节点表示的仅仅是前缀还是字符串还要根据节点参数判断）。java实现见<a target="_blank" rel="noopener" href="https://github.com/chenyaoyang/example/tree/master/code/MPT/Trie">这里</a></p>
<p>Trie树具有查找效率高的特点，但是稀疏现象比较严重，空间利用率低。Trie树常用于搜索提示，如输入前几个字母，就可以很快的提示一些可能匹配的字符串。</p>
<h2 id="Patricia-Trie"><a href="#Patricia-Trie" class="headerlink" title="Patricia Trie"></a>Patricia Trie</h2><p>实际上是基数树，或压缩前缀树。根据名字可知，是对前缀进行一定的压缩，为了是缓解Trie树空间利用率不高的问题。如下图</p>
<p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/t3.png"></p>
<p>从图中我们可以知道，如果以Trie树存储romane和romanus，对于他们的公共前缀roman我们要创建5个先后依赖的节点，在第5层处分叉，对于us又需要两层节点。而对于基数树，可以把roman合并为一个节点，us也合并为一个节点，这样原本至少7层才能表示的现在2层即可。</p>
<p>关于这种树的实现我们会在后面源码分析提到</p>
<h2 id="Merkle树"><a href="#Merkle树" class="headerlink" title="Merkle树"></a>Merkle树</h2><p>Merkle Tree，通常也被称作Hash Tree。这种树的的主要作用是验证。它结构上大多情况是一颗二叉树，叶子结点都以数据库的hash值作为标签，其他结点都是其子节点的标签拼接后再做hash。他可以高效的安全的验证大型数据结构的内容。</p>
<p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/t4.png"></p>
<p>如上图，数据的每一块都对应一个叶子，叶子内存储该块的hash，之后层层做hash运算，最后得到根节点的一个hash值。我们只需要验证根节点的hash是否相同，就能判断整个文件是否完整或者是否被人恶意篡改。另外，通过重建整个树，可以很快的知道具体哪一部分出错。具体在区块链中，无论比特币还是以太坊，都是只在区块头中存储根节点，从而来判断是否一致。</p>
<h1 id="以太坊的MPT"><a href="#以太坊的MPT" class="headerlink" title="以太坊的MPT"></a>以太坊的MPT</h1><p>一般而言MPT的存储借鉴的是Patricia Trie。与一般的存储英文字符串不同，MPT存储的是hash值，每一位有0-f共16种可能，不过MPT又对其进行了扩展。</p>
<p>首先，定义了三种节点：</p>
<ol>
<li>branch：分支节点，一个长度为17的list，分别是0-f共16位，再加一个value。最后的value代表该节点可能对某个key是终点，用于存取值</li>
<li>leaf：叶子节点，和Trie树的叶子结点类型</li>
<li>extension：扩展节点，纯粹的路径节点，其中的值时其它节点hash，可以理解为一个指向其他节点的指针</li>
</ol>
<p>看一张经典的图会比较容易理解：</p>
<p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/t5.png"></p>
<p>在图中，右上角四对键值就是图中树所存储的内容。首先他们都有前缀a7，所以根节点就是一个扩展节点，它的指针指向一个分支节点，分支节点用到了1、7、f三个值，1、f分别指向两个叶子节点，因为没有其他key和他们有除a7外的公共前缀，分支节点7指向一个扩展节点，因为右上角第二和第四个还有公共前缀d3，随后在指向一个分支节点，再找值分为两个叶子节点。叶子结点的value就存着每个键值对中的value.</p>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><p>ethereum关于这部分的源码集中在trie目录下</p>
<h2 id="结点定义"><a href="#结点定义" class="headerlink" title="结点定义"></a>结点定义</h2><p>见代码：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// go-ethereum\trie\node.go</span>
<span class="token keyword">type</span> node <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>
	<span class="token function">fstring</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
	<span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>hashNode<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>
	<span class="token function">canUnload</span><span class="token punctuation">(</span>cachegen<span class="token punctuation">,</span> cachelimit <span class="token builtin">uint16</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> <span class="token punctuation">(</span>
	fullNode <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
		Children <span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span>node <span class="token comment">// Actual trie node data to encode/decode (needs custom encoder)</span>
		flags    nodeFlag
	<span class="token punctuation">&#125;</span>
	shortNode <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
		Key   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
		Val   node
		flags nodeFlag
	<span class="token punctuation">&#125;</span>
	hashNode  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
	valueNode <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>虽说黄皮书中定义了3种结点，但这里只有两种节点，分别是fullnode和shortnode。fullnode就是分支节点，可见其有一个长度为17的数组。shortnode可以代表扩展节点或叶子节点，因为二者结构是一样的，区分两种节点主要看val的值。另外还有两种节点，虽然是字节数组类型的，但是他们都实现了node接口的全部方法，所以也是节点类型。</p>
<h2 id="树的构造"><a href="#树的构造" class="headerlink" title="树的构造"></a>树的构造</h2><p>先看一下树的结构：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Trie <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	db   <span class="token operator">*</span>Database
	root node
	cachegen<span class="token punctuation">,</span> cachelimit <span class="token builtin">uint16</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>root就是根节点，db就是数据库，树的结构最后要存到数据库中，启动时再加载出来。对于cachegen，每次提交其值都会增加，新节点会标记cachegen，如果当前的cachegen - cachelimit大于node的cache时代，那么node会从cache里面卸载，以便节约内存。 </p>
<h3 id="创建一棵树"><a href="#创建一棵树" class="headerlink" title="创建一棵树"></a>创建一棵树</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>root common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> db <span class="token operator">*</span>Database<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Trie<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> db <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"trie.New called without a database"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	trie <span class="token operator">:=</span> <span class="token operator">&amp;</span>Trie<span class="token punctuation">&#123;</span>
		db<span class="token punctuation">:</span> db<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> root <span class="token operator">!=</span> <span class="token punctuation">(</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> root <span class="token operator">!=</span> emptyRoot <span class="token punctuation">&#123;</span>
		rootnode<span class="token punctuation">,</span> err <span class="token operator">:=</span> trie<span class="token punctuation">.</span><span class="token function">resolveHash</span><span class="token punctuation">(</span>root<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">&#125;</span>
		trie<span class="token punctuation">.</span>root <span class="token operator">=</span> rootnode
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> trie<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>new方法接受一个hash和一个数据库指针，首席确保指针不为空，然后初始化树，之后再判断传入的hash是否为空值，若不是则从数据库加载，否则返回一个空树。</p>
<h3 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Trie<span class="token punctuation">)</span> <span class="token function">insert</span><span class="token punctuation">(</span>n node<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> key <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> value node<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> node<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> n<span class="token punctuation">.</span><span class="token punctuation">(</span>valueNode<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token operator">!</span>bytes<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token punctuation">(</span>valueNode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">switch</span> n <span class="token operator">:=</span> n<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>shortNode<span class="token punctuation">:</span>
		matchlen <span class="token operator">:=</span> <span class="token function">prefixLen</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> n<span class="token punctuation">.</span>Key<span class="token punctuation">)</span>
		<span class="token keyword">if</span> matchlen <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			dirty<span class="token punctuation">,</span> nn<span class="token punctuation">,</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Val<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> key<span class="token punctuation">[</span><span class="token punctuation">:</span>matchlen<span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">[</span>matchlen<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>dirty <span class="token operator">||</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> err
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>shortNode<span class="token punctuation">&#123;</span>n<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> nn<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">newFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
		branch <span class="token operator">:=</span> <span class="token operator">&amp;</span>fullNode<span class="token punctuation">&#123;</span>flags<span class="token punctuation">:</span> t<span class="token punctuation">.</span><span class="token function">newFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
		<span class="token keyword">var</span> err <span class="token builtin">error</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> branch<span class="token punctuation">.</span>Children<span class="token punctuation">[</span>n<span class="token punctuation">.</span>Key<span class="token punctuation">[</span>matchlen<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> err <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> n<span class="token punctuation">.</span>Key<span class="token punctuation">[</span><span class="token punctuation">:</span>matchlen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n<span class="token punctuation">.</span>Key<span class="token punctuation">[</span>matchlen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> n<span class="token punctuation">.</span>Val<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">&#125;</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> branch<span class="token punctuation">.</span>Children<span class="token punctuation">[</span>key<span class="token punctuation">[</span>matchlen<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> err <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> key<span class="token punctuation">[</span><span class="token punctuation">:</span>matchlen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">[</span>matchlen<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> matchlen <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> branch<span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>shortNode<span class="token punctuation">&#123;</span>key<span class="token punctuation">[</span><span class="token punctuation">:</span>matchlen<span class="token punctuation">]</span><span class="token punctuation">,</span> branch<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">newFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>

	<span class="token keyword">case</span> <span class="token operator">*</span>fullNode<span class="token punctuation">:</span>
		dirty<span class="token punctuation">,</span> nn<span class="token punctuation">,</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Children<span class="token punctuation">[</span>key<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> key<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>dirty <span class="token operator">||</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> err
		<span class="token punctuation">&#125;</span>
		n <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		n<span class="token punctuation">.</span>flags <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">newFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		n<span class="token punctuation">.</span>Children<span class="token punctuation">[</span>key<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> nn
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token boolean">nil</span>

	<span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>shortNode<span class="token punctuation">&#123;</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">newFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>

	<span class="token keyword">case</span> hashNode<span class="token punctuation">:</span>
		rn<span class="token punctuation">,</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">resolveHash</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> prefix<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">&#125;</span>
		dirty<span class="token punctuation">,</span> nn<span class="token punctuation">,</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>rn<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>dirty <span class="token operator">||</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> rn<span class="token punctuation">,</span> err
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> nn<span class="token punctuation">,</span> <span class="token boolean">nil</span>

	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%T: invalid node: %v"</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>几个参数分别是：n代表当前的结点。prefix代表已经搜索过的前缀，key表示尚未处理的部分，二者拼接到一起就是完整的key。value表示要插入的值。返回值中bool表示是否改变了树，node表示插入后子树的根节点。通过参数可以猜到这是通过递归进行操作的。</p>
<p>代码的第一个if判断中，若key的长度为0，表示key已经遍历完了，同时也找到了一个节点。判断这个节点是否是valueNode类型节点，若是的话，判断要插入的值和结点的值是否相等，来判断是否改变了树。若不是valueNode类型节点，就直接更新value，同时指明树已经改变了。</p>
<p>若还在变量key的途中，则根据当前节点的类型进行判断：</p>
<ol>
<li>若是shortNode节点，表示是一个叶子节点或扩展节点，则调用prefixLen方法计算公共前缀长度。若公共前缀长度就等于key的长度，说明二者的可以是一样的，则按照需要更新value。若只有部分公共前缀，则需要构造一个分支节点，将原来的节点和要插入的作为新分支节点的孩子插入。最后对刚才的公共前缀进行判断，若为0，表示没有公共前缀，则用新的分支节点替换掉原来的节点，若不为零，则将新的分支节点作为原节点的孩子，并改变原节点的可以。注意给分支节点添加孩子时，也是调用的insert，只不过n为nil，这对应后面的一种情况，稍后分析。</li>
<li>若是fullNode，也就是分支节点，则直接寻找对应的位置尝试插入，注意分支节点对于位置的孩子可能为空，为shortNode或者fullnode，不管为什么，最终继续递归，并按需更新孩子即可</li>
<li>若是nil，这种情况可能会一棵空树时候出现，这是新建一个shortNode节点作为根节点，返回即可。同时，在上文向分支节点插入孩子时也会出现，同样也是新建shortNode结点作为分支节点孩子即可。</li>
<li>若是hashNode，可以理解为一个指针，但是数据都在数据库，需要取数据库取值插入</li>
<li>最后不满足定义的四种节点，报错</li>
</ol>
<p>最后总结一点，对于shortNode节点，要么进行更新，要么新建扩展节点进行插入，对于fullNode，要么成为其某个孩子，要么更新其值，要么为其添加扩展节点，进行扩展。总之新的叶子节点插入操作都是在扩展节点上完成的。</p>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Trie<span class="token punctuation">)</span> <span class="token function">delete</span><span class="token punctuation">(</span>n node<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> key <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> node<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">switch</span> n <span class="token operator">:=</span> n<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>shortNode<span class="token punctuation">:</span>
		matchlen <span class="token operator">:=</span> <span class="token function">prefixLen</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> n<span class="token punctuation">.</span>Key<span class="token punctuation">)</span>
		<span class="token keyword">if</span> matchlen <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token boolean">nil</span> <span class="token comment">// don't replace n on mismatch</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> matchlen <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span> <span class="token comment">// remove n entirely for whole matches</span>
		<span class="token punctuation">&#125;</span>
		dirty<span class="token punctuation">,</span> child<span class="token punctuation">,</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Val<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> key<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>dirty <span class="token operator">||</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> err
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">switch</span> child <span class="token operator">:=</span> child<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">*</span>shortNode<span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>shortNode<span class="token punctuation">&#123;</span><span class="token function">concat</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> child<span class="token punctuation">.</span>Key<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> child<span class="token punctuation">.</span>Val<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">newFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>shortNode<span class="token punctuation">&#123;</span>n<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> child<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">newFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>

	<span class="token keyword">case</span> <span class="token operator">*</span>fullNode<span class="token punctuation">:</span>
		dirty<span class="token punctuation">,</span> nn<span class="token punctuation">,</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Children<span class="token punctuation">[</span>key<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> key<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>dirty <span class="token operator">||</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> err
		<span class="token punctuation">&#125;</span>
		n <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		n<span class="token punctuation">.</span>flags <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">newFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		n<span class="token punctuation">.</span>Children<span class="token punctuation">[</span>key<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> nn
		pos <span class="token operator">:=</span> <span class="token operator">-</span><span class="token number">1</span>
		<span class="token comment">//遍历后，若pos大于等于0，表示只有一个孩子</span>
		<span class="token comment">//若pos等于-2则孩子数量大于一个</span>
		<span class="token keyword">for</span> i<span class="token punctuation">,</span> cld <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token operator">&amp;</span>n<span class="token punctuation">.</span>Children <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> cld <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> pos <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">&#123;</span>
					pos <span class="token operator">=</span> i
				<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
					pos <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span>
					<span class="token keyword">break</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> pos <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> pos <span class="token operator">!=</span> <span class="token number">16</span> <span class="token punctuation">&#123;</span>
				cnode<span class="token punctuation">,</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Children<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">,</span> prefix<span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">if</span> cnode<span class="token punctuation">,</span> ok <span class="token operator">:=</span> cnode<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>shortNode<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
					k <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">&#123;</span><span class="token function">byte</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> cnode<span class="token punctuation">.</span>Key<span class="token operator">...</span><span class="token punctuation">)</span>
					<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>shortNode<span class="token punctuation">&#123;</span>k<span class="token punctuation">,</span> cnode<span class="token punctuation">.</span>Val<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">newFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>shortNode<span class="token punctuation">&#123;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">&#123;</span><span class="token function">byte</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> n<span class="token punctuation">.</span>Children<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">newFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token boolean">nil</span>

	<span class="token keyword">case</span> valueNode<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>

	<span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>

	<span class="token keyword">case</span> hashNode<span class="token punctuation">:</span>
		rn<span class="token punctuation">,</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">resolveHash</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> prefix<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">&#125;</span>
		dirty<span class="token punctuation">,</span> nn<span class="token punctuation">,</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>rn<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>dirty <span class="token operator">||</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> rn<span class="token punctuation">,</span> err
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> nn<span class="token punctuation">,</span> <span class="token boolean">nil</span>

	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%T: invalid node: %v (%v)"</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> n<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>参数和返回值和插入操作类似，不在赘述。依旧是判断当前节点类型：</p>
<ol>
<li>若为shortNode结点，首先也是计算公共前缀。若公共前缀的长度小于当前节点key的长度，表示没有匹配到。若公共前缀的长度等于要删除的key的长度，表示匹配到子树，直接删除该节点为根的子树。若公共前缀的长度等于当前节点key的长度，也就是当前节点的key是要删除key的一部分，说明还要向下查找。但是删除完后要对节点做处理，若子节点fullnode节点删除孩子后孩子数量大于1个，则只改变当前节点的flag。若删除后孩子数量小于等于一个，则要对节点进行合并，也就是对前缀进行合并</li>
<li>若为fullnode结点，则直接根据key的第一个字符取尝试删除某个孩子。然后遍历孩子，判断非空的数量，若大于两个则不做处理，若只有一个，进行节点的合并。</li>
<li>若为valueNode节点，直接删除，返回</li>
<li>若为nil，一般在阐述fullnode的孩子时遇到，表示没有匹配，不做处理</li>
<li>若为hashNode，表示还在数据库中，则先加载，在尝试删除</li>
</ol>
<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><p>也就是Get方法，见代码：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Trie<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">&#123;</span>
	res<span class="token punctuation">,</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">TryGet</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Unhandled trie error: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> res
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Trie<span class="token punctuation">)</span> <span class="token function">TryGet</span><span class="token punctuation">(</span>key <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	key <span class="token operator">=</span> <span class="token function">keybytesToHex</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token comment">//转为16进制半字节</span>
	value<span class="token punctuation">,</span> newroot<span class="token punctuation">,</span> didResolve<span class="token punctuation">,</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">tryGet</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>root<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> didResolve <span class="token punctuation">&#123;</span>
		t<span class="token punctuation">.</span>root <span class="token operator">=</span> newroot
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> value<span class="token punctuation">,</span> err
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Trie<span class="token punctuation">)</span> <span class="token function">tryGet</span><span class="token punctuation">(</span>origNode node<span class="token punctuation">,</span> key <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> pos <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>value <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> newnode node<span class="token punctuation">,</span> didResolve <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">switch</span> n <span class="token operator">:=</span> <span class="token punctuation">(</span>origNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token keyword">case</span> valueNode<span class="token punctuation">:</span>
		<span class="token keyword">return</span> n<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>shortNode<span class="token punctuation">:</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">-</span>pos <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Key<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>bytes<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> key<span class="token punctuation">[</span>pos<span class="token punctuation">:</span>pos<span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token comment">// key not found in trie</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
		value<span class="token punctuation">,</span> newnode<span class="token punctuation">,</span> didResolve<span class="token punctuation">,</span> err <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">tryGet</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Val<span class="token punctuation">,</span> key<span class="token punctuation">,</span> pos<span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> didResolve <span class="token punctuation">&#123;</span>
			n <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			n<span class="token punctuation">.</span>Val <span class="token operator">=</span> newnode
			n<span class="token punctuation">.</span>flags<span class="token punctuation">.</span>gen <span class="token operator">=</span> t<span class="token punctuation">.</span>cachegen
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> value<span class="token punctuation">,</span> n<span class="token punctuation">,</span> didResolve<span class="token punctuation">,</span> err
	<span class="token keyword">case</span> <span class="token operator">*</span>fullNode<span class="token punctuation">:</span>
		value<span class="token punctuation">,</span> newnode<span class="token punctuation">,</span> didResolve<span class="token punctuation">,</span> err <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">tryGet</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Children<span class="token punctuation">[</span>key<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> pos<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> didResolve <span class="token punctuation">&#123;</span>
			n <span class="token operator">=</span> n<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			n<span class="token punctuation">.</span>flags<span class="token punctuation">.</span>gen <span class="token operator">=</span> t<span class="token punctuation">.</span>cachegen
			n<span class="token punctuation">.</span>Children<span class="token punctuation">[</span>key<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> newnode
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> value<span class="token punctuation">,</span> n<span class="token punctuation">,</span> didResolve<span class="token punctuation">,</span> err
	<span class="token keyword">case</span> hashNode<span class="token punctuation">:</span>
		child<span class="token punctuation">,</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">resolveHash</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> key<span class="token punctuation">[</span><span class="token punctuation">:</span>pos<span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> err
		<span class="token punctuation">&#125;</span>
		value<span class="token punctuation">,</span> newnode<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">tryGet</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> key<span class="token punctuation">,</span> pos<span class="token punctuation">)</span>
		<span class="token keyword">return</span> value<span class="token punctuation">,</span> newnode<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> err
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%T: invalid node: %v"</span><span class="token punctuation">,</span> origNode<span class="token punctuation">,</span> origNode<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查找的逻辑也很简单，首先要把byte数组转为16进制半字节的数组形式，使用keybytesToHex方法（后面会讲）。之后从根节点开始，调用tryGet递归查询，也分一下几种情况：</p>
<ol>
<li>若为空，表示没有找到</li>
<li>若为valueNode节点，直接返回即可</li>
<li>若为shortNode，如果当前节点的key长度大于本次递归要查找的或即使长度相等但内容不一样的，则表示没有匹配的，否则继续递归查找</li>
<li>若为fullNode结点，则递归到孩子中寻找</li>
<li>若为hashNode结点，则先从数据库中加载，在尝试递归查询</li>
</ol>
<h2 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h2><p>主要是encoding.go，处理树的三种编码格式的互相转换。</p>
<ol>
<li>keybytes：原始字节数组，大部分trie的函数都用这种格式</li>
<li>hex：hex编码，将一个字节用两个字节表示，编码时，将8位二进制码重新分组成两个4位的字节，其中一个字节的低4位是原字节的高四位，另一个字节的低4位是原数据的低4位，高4位都补0。编码后再在尾部跟上一个标志位0x10，标识是叶子节点或者扩展节点</li>
<li>compact：compact编码，就是Hex-Prefix Encoding，在黄皮书中的附录C有说明。是hex编码的变体。第一个字节的高位存储标志位，低位存储0（长度为偶数）或hex编码的第一个半字节（长度为奇数）。总之最后长度是偶数。数学描述如下（f(t)表示hex编码的标志位是否存在）：</li>
</ol>
<p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/t6.png"></p>
<p>下面具体看源码：</p>
<h3 id="hexToCompact"><a href="#hexToCompact" class="headerlink" title="hexToCompact"></a>hexToCompact</h3><p>hex编码转compact编码</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">hexToCompact</span><span class="token punctuation">(</span>hex <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">&#123;</span>
	terminator <span class="token operator">:=</span> <span class="token function">byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">hasTerm</span><span class="token punctuation">(</span>hex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		terminator <span class="token operator">=</span> <span class="token number">1</span>
		hex <span class="token operator">=</span> hex<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>hex<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token punctuation">&#125;</span>
	buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>hex<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
	buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> terminator <span class="token operator">&lt;&lt;</span> <span class="token number">5</span> <span class="token comment">// the flag byte</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>hex<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
		buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span> <span class="token comment">// odd flag</span>
		buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">|=</span> hex<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// first nibble is contained in the first byte</span>
		hex <span class="token operator">=</span> hex<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">decodeNibbles</span><span class="token punctuation">(</span>hex<span class="token punctuation">,</span> buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> buf
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>hasTerm判断最后一字节是否是16，也就是有没有标志位，若是则terminator标记为1，并去除hex编码的标志位。接下来写入compat编码的标志位，首先terminator右移5位，再判断hex编码长度的奇偶性，并根据情况改下标志位。然后解码hex编码改为compat编码，流程和黄皮书一致。</p>
<h3 id="compactToHex"><a href="#compactToHex" class="headerlink" title="compactToHex"></a>compactToHex</h3><p>compact编码转hex编码</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">compactToHex</span><span class="token punctuation">(</span>compact <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>compact<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> compact
	<span class="token punctuation">&#125;</span>
	base <span class="token operator">:=</span> <span class="token function">keybytesToHex</span><span class="token punctuation">(</span>compact<span class="token punctuation">)</span>
	<span class="token comment">// delete terminator flag</span>
	<span class="token keyword">if</span> base<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token punctuation">&#123;</span>
		base <span class="token operator">=</span> base<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// apply odd flag</span>
	chop <span class="token operator">:=</span> <span class="token number">2</span> <span class="token operator">-</span> base<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">1</span>
	<span class="token keyword">return</span> base<span class="token punctuation">[</span>chop<span class="token punctuation">:</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可见先看做一般字节数组，然后转为hex编码。然后判断是否有标志位。首先根据黄皮书规定，compact编码的第一字节的高四位有这几种情况：</p>
<pre class="line-numbers language-none"><code class="language-none">0000 hex编码没有标志位，且长度为偶数
0001 hex编码没有标志位，且长度为奇数
0010 hex编码有标志位，且长度为偶数
0011 hex编码有标志位，且长度为奇数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据上面四种情况，删除最后的标志位。然后在根据第一位的值，决定是删除前两位还是第一位</p>
<h3 id="keybytesToHex"><a href="#keybytesToHex" class="headerlink" title="keybytesToHex"></a>keybytesToHex</h3><p>原始数组转hex编码</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">keybytesToHex</span><span class="token punctuation">(</span>str <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">&#123;</span>
	l <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span>
	<span class="token keyword">var</span> nibbles <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> l<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token keyword">range</span> str <span class="token punctuation">&#123;</span>
		nibbles<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> b <span class="token operator">/</span> <span class="token number">16</span>
		nibbles<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> b <span class="token operator">%</span> <span class="token number">16</span>
	<span class="token punctuation">&#125;</span>
	nibbles<span class="token punctuation">[</span>l<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">16</span>
	<span class="token keyword">return</span> nibbles
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，就是一个字节拆为两个字节，利用整除和取余，最后加一个标志位。</p>
<h3 id="hexToKeybytes"><a href="#hexToKeybytes" class="headerlink" title="hexToKeybytes"></a>hexToKeybytes</h3><p>hex编码还原</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">hexToKeybytes</span><span class="token punctuation">(</span>hex <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token function">hasTerm</span><span class="token punctuation">(</span>hex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		hex <span class="token operator">=</span> hex<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>hex<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>hex<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">1</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"can't convert hex key of odd length"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	key <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>hex<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token function">decodeNibbles</span><span class="token punctuation">(</span>hex<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	<span class="token keyword">return</span> key
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">decodeNibbles</span><span class="token punctuation">(</span>nibbles <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> bytes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> bi<span class="token punctuation">,</span> ni <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">;</span> ni <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>nibbles<span class="token punctuation">)</span><span class="token punctuation">;</span> bi<span class="token punctuation">,</span> ni <span class="token operator">=</span> bi<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> ni<span class="token operator">+</span><span class="token number">2</span> <span class="token punctuation">&#123;</span>
		bytes<span class="token punctuation">[</span>bi<span class="token punctuation">]</span> <span class="token operator">=</span> nibbles<span class="token punctuation">[</span>ni<span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span> <span class="token operator">|</span> nibbles<span class="token punctuation">[</span>ni<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先根据需求去除标志位，再具体转换。可见将两字节还原为一字节时就是利用移位和或逻辑。</p>
<h2 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h2><p>序列化就是将一课树存储到数据库中</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// go-ethereum\trie\trie.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Trie<span class="token punctuation">)</span> <span class="token function">Commit</span><span class="token punctuation">(</span>onleaf LeafCallback<span class="token punctuation">)</span> <span class="token punctuation">(</span>root common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> t<span class="token punctuation">.</span>db <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"commit called on trie with nil database"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	hash<span class="token punctuation">,</span> cached<span class="token punctuation">,</span> err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">hashRoot</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>db<span class="token punctuation">,</span> onleaf<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	t<span class="token punctuation">.</span>root <span class="token operator">=</span> cached
	t<span class="token punctuation">.</span>cachegen<span class="token operator">++</span>
	<span class="token keyword">return</span> common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>hash<span class="token punctuation">.</span><span class="token punctuation">(</span>hashNode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Trie<span class="token punctuation">)</span> <span class="token function">hashRoot</span><span class="token punctuation">(</span>db <span class="token operator">*</span>Database<span class="token punctuation">,</span> onleaf LeafCallback<span class="token punctuation">)</span> <span class="token punctuation">(</span>node<span class="token punctuation">,</span> node<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> t<span class="token punctuation">.</span>root <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">hashNode</span><span class="token punctuation">(</span>emptyRoot<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	h <span class="token operator">:=</span> <span class="token function">newHasher</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>cachegen<span class="token punctuation">,</span> t<span class="token punctuation">.</span>cachelimit<span class="token punctuation">,</span> onleaf<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">returnHasherToPool</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span>
	<span class="token keyword">return</span> h<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>root<span class="token punctuation">,</span> db<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一部分主要是创建了hasher，然后利用hash方法去实现。进入hasher的代码</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//  go-ethereum\trie\hasher.go</span>
<span class="token keyword">func</span> <span class="token function">newHasher</span><span class="token punctuation">(</span>cachegen<span class="token punctuation">,</span> cachelimit <span class="token builtin">uint16</span><span class="token punctuation">,</span> onleaf LeafCallback<span class="token punctuation">)</span> <span class="token operator">*</span>hasher <span class="token punctuation">&#123;</span>
	h <span class="token operator">:=</span> hasherPool<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>hasher<span class="token punctuation">)</span>
	h<span class="token punctuation">.</span>cachegen<span class="token punctuation">,</span> h<span class="token punctuation">.</span>cachelimit<span class="token punctuation">,</span> h<span class="token punctuation">.</span>onleaf <span class="token operator">=</span> cachegen<span class="token punctuation">,</span> cachelimit<span class="token punctuation">,</span> onleaf
	<span class="token keyword">return</span> h
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>hasherPool是一个对象池，newHasher方法主要是从中尝试取或者创建一个hasher对象。下面看hash方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>hasher<span class="token punctuation">)</span> <span class="token function">hash</span><span class="token punctuation">(</span>n node<span class="token punctuation">,</span> db <span class="token operator">*</span>Database<span class="token punctuation">,</span> force <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>node<span class="token punctuation">,</span> node<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> hash<span class="token punctuation">,</span> dirty <span class="token operator">:=</span> n<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> hash <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> db <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> hash<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> n<span class="token punctuation">.</span><span class="token function">canUnload</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>cachegen<span class="token punctuation">,</span> h<span class="token punctuation">.</span>cachelimit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			cacheUnloadCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> hash<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>dirty <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> hash<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	collapsed<span class="token punctuation">,</span> cached<span class="token punctuation">,</span> err <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">hashChildren</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> db<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> hashNode<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	hashed<span class="token punctuation">,</span> err <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>collapsed<span class="token punctuation">,</span> db<span class="token punctuation">,</span> force<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> hashNode<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	cachedHash<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> hashed<span class="token punctuation">.</span><span class="token punctuation">(</span>hashNode<span class="token punctuation">)</span>
	<span class="token keyword">switch</span> cn <span class="token operator">:=</span> cached<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>shortNode<span class="token punctuation">:</span>
		cn<span class="token punctuation">.</span>flags<span class="token punctuation">.</span>hash <span class="token operator">=</span> cachedHash
		<span class="token keyword">if</span> db <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			cn<span class="token punctuation">.</span>flags<span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">false</span>
		<span class="token punctuation">&#125;</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>fullNode<span class="token punctuation">:</span>
		cn<span class="token punctuation">.</span>flags<span class="token punctuation">.</span>hash <span class="token operator">=</span> cachedHash
		<span class="token keyword">if</span> db <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			cn<span class="token punctuation">.</span>flags<span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">false</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> hashed<span class="token punctuation">,</span> cached<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一个if我们后面再解释，接下来的hashChildren是一个关键点，它将所有的子节点换为他们的hash</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>hasher<span class="token punctuation">)</span> <span class="token function">hashChildren</span><span class="token punctuation">(</span>original node<span class="token punctuation">,</span> db <span class="token operator">*</span>Database<span class="token punctuation">)</span> <span class="token punctuation">(</span>node<span class="token punctuation">,</span> node<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> err <span class="token builtin">error</span>

	<span class="token keyword">switch</span> n <span class="token operator">:=</span> original<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>shortNode<span class="token punctuation">:</span> 
		collapsed<span class="token punctuation">,</span> cached <span class="token operator">:=</span> n<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		collapsed<span class="token punctuation">.</span>Key <span class="token operator">=</span> <span class="token function">hexToCompact</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Key<span class="token punctuation">)</span>
		cached<span class="token punctuation">.</span>Key <span class="token operator">=</span> common<span class="token punctuation">.</span><span class="token function">CopyBytes</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Key<span class="token punctuation">)</span>

		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> n<span class="token punctuation">.</span>Val<span class="token punctuation">.</span><span class="token punctuation">(</span>valueNode<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
			collapsed<span class="token punctuation">.</span>Val<span class="token punctuation">,</span> cached<span class="token punctuation">.</span>Val<span class="token punctuation">,</span> err <span class="token operator">=</span> h<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Val<span class="token punctuation">,</span> db<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> original<span class="token punctuation">,</span> original<span class="token punctuation">,</span> err
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> collapsed<span class="token punctuation">,</span> cached<span class="token punctuation">,</span> <span class="token boolean">nil</span>

	<span class="token keyword">case</span> <span class="token operator">*</span>fullNode<span class="token punctuation">:</span> subtrees
		collapsed<span class="token punctuation">,</span> cached <span class="token operator">:=</span> n<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> n<span class="token punctuation">.</span>Children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				collapsed<span class="token punctuation">.</span>Children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> cached<span class="token punctuation">.</span>Children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> err <span class="token operator">=</span> h<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>Children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> db<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">return</span> original<span class="token punctuation">,</span> original<span class="token punctuation">,</span> err
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		cached<span class="token punctuation">.</span>Children<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> n<span class="token punctuation">.</span>Children<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span>
		<span class="token keyword">return</span> collapsed<span class="token punctuation">,</span> cached<span class="token punctuation">,</span> <span class="token boolean">nil</span>

	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> n<span class="token punctuation">,</span> original<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主要也是根据结点类型进行操作。</p>
<ol>
<li>对于shortNode节点，先对key从hex编码转为compact编码，然后递归调用hash把子节点也改为hash</li>
<li>对于fullNode结点，遍历所有孩子，递归调用hash方法</li>
<li>对于其他类型节点原样返回</li>
</ol>
<p>再回到hash方法，接下来调用store方法。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>hasher<span class="token punctuation">)</span> <span class="token function">store</span><span class="token punctuation">(</span>n node<span class="token punctuation">,</span> db <span class="token operator">*</span>Database<span class="token punctuation">,</span> force <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> isHash <span class="token operator">:=</span> n<span class="token punctuation">.</span><span class="token punctuation">(</span>hashNode<span class="token punctuation">)</span><span class="token punctuation">;</span> n <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> isHash <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> n<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	h<span class="token punctuation">.</span>tmp<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> rlp<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>h<span class="token punctuation">.</span>tmp<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"encode error: "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>tmp<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">32</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>force <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> n<span class="token punctuation">,</span> <span class="token boolean">nil</span> <span class="token comment">// Nodes smaller than 32 bytes are stored inside their parent</span>
	<span class="token punctuation">&#125;</span> database<span class="token punctuation">.</span>
	hash<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> n<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> hash <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		hash <span class="token operator">=</span> h<span class="token punctuation">.</span><span class="token function">makeHashNode</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>tmp<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> db <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span> cache
		hash <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>

		db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		db<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> h<span class="token punctuation">.</span>tmp<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
		db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token keyword">if</span> h<span class="token punctuation">.</span>onleaf <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">switch</span> n <span class="token operator">:=</span> n<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> <span class="token operator">*</span>shortNode<span class="token punctuation">:</span>
				<span class="token keyword">if</span> child<span class="token punctuation">,</span> ok <span class="token operator">:=</span> n<span class="token punctuation">.</span>Val<span class="token punctuation">.</span><span class="token punctuation">(</span>valueNode<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
					h<span class="token punctuation">.</span><span class="token function">onleaf</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
			<span class="token keyword">case</span> <span class="token operator">*</span>fullNode<span class="token punctuation">:</span>
				<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">if</span> child<span class="token punctuation">,</span> ok <span class="token operator">:=</span> n<span class="token punctuation">.</span>Children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span>valueNode<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
						h<span class="token punctuation">.</span><span class="token function">onleaf</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> hash<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先判断节点类型，若本身就是hashNode或为空不存储。然后对节点编码。详细流程不在赘述，参考<a target="_blank" rel="noopener" href="https://blog.grapefruit.tk/2019/03/19/rlp%E7%BC%96%E7%A0%81%E5%AD%A6%E4%B9%A0/">RLP编码学习</a>。编码之后的结果存在tmp这个字节数组中。接下来判断是否强制存储，然后计算根节点编码后结果hash，最后存储到数据库，键就是刚才计算的hash。</p>
<p>再次回到hash方法，存储成功后。将存储的键转为hashNode类，然后判断cached（实际是跟节点的copy）的类型，对于是shortNode和fullNode类型，将其flags成员的hash值进行修改，然后返回hash值和cached。</p>
<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><p>不同于序列化，反序列化在trie的源码中就多次出现，主要是下面方法</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Trie<span class="token punctuation">)</span> <span class="token function">resolveHash</span><span class="token punctuation">(</span>n hashNode<span class="token punctuation">,</span> prefix <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	cacheMissCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

	hash <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
	<span class="token keyword">if</span> node <span class="token operator">:=</span> t<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">node</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> t<span class="token punctuation">.</span>cachegen<span class="token punctuation">)</span><span class="token punctuation">;</span> node <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> node<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>MissingNodeError<span class="token punctuation">&#123;</span>NodeHash<span class="token punctuation">:</span> hash<span class="token punctuation">,</span> Path<span class="token punctuation">:</span> prefix<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主要逻辑在node方法中</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// go-ethereum\trie\database.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>Database<span class="token punctuation">)</span> <span class="token function">node</span><span class="token punctuation">(</span>hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> cachegen <span class="token builtin">uint16</span><span class="token punctuation">)</span> node <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> db<span class="token punctuation">.</span>cleans <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> enc<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span>cleans<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>hash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> enc <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			memcacheCleanHitMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			memcacheCleanReadMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>enc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token function">mustDecodeNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> enc<span class="token punctuation">,</span> cachegen<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	dirty <span class="token operator">:=</span> db<span class="token punctuation">.</span>dirties<span class="token punctuation">[</span>hash<span class="token punctuation">]</span>
	db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> dirty <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> dirty<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> cachegen<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	enc<span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span>diskdb<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>hash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> enc <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> db<span class="token punctuation">.</span>cleans <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		db<span class="token punctuation">.</span>cleans<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>hash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> enc<span class="token punctuation">)</span>
		memcacheCleanMissMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		memcacheCleanWriteMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>enc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token function">mustDecodeNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> enc<span class="token punctuation">,</span> cachegen<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这也是一个典型的二级缓存的例子，首先尝试从内存缓存中获取，若没有，则从磁盘的数据库中获取，最后实际反序列化操作都在mustDecodeNode方法中</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// go-ethereum\trie\node.go</span>
<span class="token keyword">func</span> <span class="token function">mustDecodeNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> buf <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> cachegen <span class="token builtin">uint16</span><span class="token punctuation">)</span> node <span class="token punctuation">&#123;</span>
	n<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">decodeNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> cachegen<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"node %x: %v"</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> n
<span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token function">decodeNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> buf <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> cachegen <span class="token builtin">uint16</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> io<span class="token punctuation">.</span>ErrUnexpectedEOF
	<span class="token punctuation">&#125;</span>
	elems<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> rlp<span class="token punctuation">.</span><span class="token function">SplitList</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"decode error: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">switch</span> c<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> rlp<span class="token punctuation">.</span><span class="token function">CountValues</span><span class="token punctuation">(</span>elems<span class="token punctuation">)</span><span class="token punctuation">;</span> c <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>
		n<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">decodeShort</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> elems<span class="token punctuation">,</span> cachegen<span class="token punctuation">)</span>
		<span class="token keyword">return</span> n<span class="token punctuation">,</span> <span class="token function">wrapError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"short"</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token number">17</span><span class="token punctuation">:</span>
		n<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">decodeFull</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> elems<span class="token punctuation">,</span> cachegen<span class="token punctuation">)</span>
		<span class="token keyword">return</span> n<span class="token punctuation">,</span> <span class="token function">wrapError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"full"</span><span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid number of list elements: %v"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先解释一下涉及到的几个rlp方法，通过学习rlp编码我们知道，rlp编码一般由一个标志位+前缀+内容组成，SplitList方法返回的就是内容以及剩余内容（未被解析的）。对于复合类型，也就是编码中的第二种数据来源–多维数组类型，它的rlp编码内容部分是由多个单独的子类型rlp编码组合而成的，CountValues就是统计有多少个子部分。</p>
<p>接下来一个switch就是根据有多少子内容区分节点的类型，如代码中所述，2个子内容的就是shortNode，17个的就是fullNode，注意这点可能会有些人有疑问，我们定义节点的时候，这两类节点可不止这几个成员变量，这是因为在存储时节点都被转化为rawShortNode和rawFullNode两种简单类型（ go-ethereum\trie\database.go），只保留关键信息。我们接下来再看具体的反序列化方法</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">decodeShort</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> elems <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> cachegen <span class="token builtin">uint16</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	kbuf<span class="token punctuation">,</span> rest<span class="token punctuation">,</span> err <span class="token operator">:=</span> rlp<span class="token punctuation">.</span><span class="token function">SplitString</span><span class="token punctuation">(</span>elems<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	flag <span class="token operator">:=</span> nodeFlag<span class="token punctuation">&#123;</span>hash<span class="token punctuation">:</span> hash<span class="token punctuation">,</span> gen<span class="token punctuation">:</span> cachegen<span class="token punctuation">&#125;</span>
	key <span class="token operator">:=</span> <span class="token function">compactToHex</span><span class="token punctuation">(</span>kbuf<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">hasTerm</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		val<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> rlp<span class="token punctuation">.</span><span class="token function">SplitString</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid value node: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>shortNode<span class="token punctuation">&#123;</span>key<span class="token punctuation">,</span> <span class="token function">append</span><span class="token punctuation">(</span>valueNode<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> val<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> flag<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	r<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">decodeRef</span><span class="token punctuation">(</span>rest<span class="token punctuation">,</span> cachegen<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token function">wrapError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"val"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>shortNode<span class="token punctuation">&#123;</span>key<span class="token punctuation">,</span> r<span class="token punctuation">,</span> flag<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">decodeRef</span><span class="token punctuation">(</span>buf <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> cachegen <span class="token builtin">uint16</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	kind<span class="token punctuation">,</span> val<span class="token punctuation">,</span> rest<span class="token punctuation">,</span> err <span class="token operator">:=</span> rlp<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">switch</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> kind <span class="token operator">==</span> rlp<span class="token punctuation">.</span>List<span class="token punctuation">:</span>
		<span class="token keyword">if</span> size <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">len</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span><span class="token punctuation">;</span> size <span class="token operator">></span> hashLen <span class="token punctuation">&#123;</span>
			err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"oversized embedded node (size is %d bytes, want size &lt; %d)"</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> hashLen<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> err
		<span class="token punctuation">&#125;</span>
		n<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">decodeNode</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> cachegen<span class="token punctuation">)</span>
		<span class="token keyword">return</span> n<span class="token punctuation">,</span> rest<span class="token punctuation">,</span> err
	<span class="token keyword">case</span> kind <span class="token operator">==</span> rlp<span class="token punctuation">.</span>String <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> rest<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token keyword">case</span> kind <span class="token operator">==</span> rlp<span class="token punctuation">.</span>String <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">32</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">append</span><span class="token punctuation">(</span>hashNode<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> val<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rest<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid RLP string size %d (want 0 or 32)"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>逻辑还是很清晰的，首先使用SplitString，分理处内容和剩余数据，然后将内容转为hex编码，再判断value是否有标志位来决定是否是叶子节点，若是叶子节点，则解析剩余的内容。若不是，则使用decodeRef来解析剩余内容。decodeRef首先也是分离出rlp编码各部分，先判断类型，再根据类型生成具体的节点。最后回到decodeShort构造出一个完整的节点。另外decodeFull流程也类似，不在赘述。主要思想就是一层一层剥开rlp编码，根据具体类型生成具体节点。</p>
<h2 id="trie的cache"><a href="#trie的cache" class="headerlink" title="trie的cache"></a>trie的cache</h2><p>trie除了有数据库和根节点这两个成员变量，还有cachegen, cachelimit用于缓存管理的变量。trie树在每次commit时都会将cachegen加1（见上面序列化部分源码），然后在每次插入节点时都会把cachegen写入新节点，利用的是newFlag方法</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Trie<span class="token punctuation">)</span> <span class="token function">newFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> nodeFlag <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> nodeFlag<span class="token punctuation">&#123;</span>dirty<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> gen<span class="token punctuation">:</span> t<span class="token punctuation">.</span>cachegen<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>当trie.cachegen - node.cachegen &gt; cachelimit时，就会把节点从内存中卸载（删除），用的是canUnload方法判断，每个继承node接口的类都实现了该方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>fullNode<span class="token punctuation">)</span> <span class="token function">canUnload</span><span class="token punctuation">(</span>gen<span class="token punctuation">,</span> limit <span class="token builtin">uint16</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>  <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> n<span class="token punctuation">.</span>flags<span class="token punctuation">.</span><span class="token function">canUnload</span><span class="token punctuation">(</span>gen<span class="token punctuation">,</span> limit<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>shortNode<span class="token punctuation">)</span> <span class="token function">canUnload</span><span class="token punctuation">(</span>gen<span class="token punctuation">,</span> limit <span class="token builtin">uint16</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> n<span class="token punctuation">.</span>flags<span class="token punctuation">.</span><span class="token function">canUnload</span><span class="token punctuation">(</span>gen<span class="token punctuation">,</span> limit<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n hashNode<span class="token punctuation">)</span> <span class="token function">canUnload</span><span class="token punctuation">(</span><span class="token builtin">uint16</span><span class="token punctuation">,</span> <span class="token builtin">uint16</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>      <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n valueNode<span class="token punctuation">)</span> <span class="token function">canUnload</span><span class="token punctuation">(</span><span class="token builtin">uint16</span><span class="token punctuation">,</span> <span class="token builtin">uint16</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>     <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>卸载的作用是节省内存，所以说经过几次commit后，就会有节点被从内存中删除，删除是在hash方法中，也就是那个方法的第一个if</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>hasher<span class="token punctuation">)</span> <span class="token function">hash</span><span class="token punctuation">(</span>n node<span class="token punctuation">,</span> db <span class="token operator">*</span>Database<span class="token punctuation">,</span> force <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>node<span class="token punctuation">,</span> node<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> hash<span class="token punctuation">,</span> dirty <span class="token operator">:=</span> n<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> hash <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> db <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> hash<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> n<span class="token punctuation">.</span><span class="token function">canUnload</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span>cachegen<span class="token punctuation">,</span> h<span class="token punctuation">.</span>cachelimit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			cacheUnloadCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> hash<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>dirty <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> hash<span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token operator">...</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>获取hash是首先从节点的cache中获取，若存在的话，先不急着返回，首先判断是否可卸载，若可以，则卸载，注意卸载方式很有意思，不返回节点实例，而是返回一个hash表示节点，然后需要的时候在反序列化即可。注意若节点没有缓存hash值，则一定不进行卸载。</p>
<h2 id="SecureTrie"><a href="#SecureTrie" class="headerlink" title="SecureTrie"></a>SecureTrie</h2><p>最后还有一个SecureTrie，是为了避免使用很长的key导致性能下降。SecureTrie包装了trie，所有的key都转化为keccak256计算的hash，但在数据库中存储原始key</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> SecureTrie <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	trie             Trie
	hashKeyBuf       <span class="token punctuation">[</span>common<span class="token punctuation">.</span>HashLength<span class="token punctuation">]</span><span class="token builtin">byte</span> 
	secKeyCache      <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token comment">//hash值和key值的映射</span>
	secKeyCacheOwner <span class="token operator">*</span>SecureTrie 
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="database-go"><a href="#database-go" class="headerlink" title="database.go"></a>database.go</h2><p>这也是trie包中的，是比较贴近实际使用的。源码注释中介绍它是一个介于内存中的trie数据和硬盘的中间层，作用是不将每次树的操作都写入内存，而是周期性的写入。</p>
<p>先看初始化，在其他地方源码中用的较多的是NewDatabase与NewDatabaseWithCache两个方法，均可以获得一个database对象</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewDatabase</span><span class="token punctuation">(</span>diskdb ethdb<span class="token punctuation">.</span>Database<span class="token punctuation">)</span> <span class="token operator">*</span>Database <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token function">NewDatabaseWithCache</span><span class="token punctuation">(</span>diskdb<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">NewDatabaseWithCache</span><span class="token punctuation">(</span>diskdb ethdb<span class="token punctuation">.</span>Database<span class="token punctuation">,</span> cache <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>Database <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> cleans <span class="token operator">*</span>bigcache<span class="token punctuation">.</span>BigCache
	<span class="token keyword">if</span> cache <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		cleans<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> bigcache<span class="token punctuation">.</span><span class="token function">NewBigCache</span><span class="token punctuation">(</span>bigcache<span class="token punctuation">.</span>Config<span class="token punctuation">&#123;</span>
			Shards<span class="token punctuation">:</span>             <span class="token number">1024</span><span class="token punctuation">,</span>
			LifeWindow<span class="token punctuation">:</span>         time<span class="token punctuation">.</span>Hour<span class="token punctuation">,</span>
			MaxEntriesInWindow<span class="token punctuation">:</span> cache <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>
			MaxEntrySize<span class="token punctuation">:</span>       <span class="token number">512</span><span class="token punctuation">,</span>
			HardMaxCacheSize<span class="token punctuation">:</span>   cache<span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Database<span class="token punctuation">&#123;</span>
		diskdb<span class="token punctuation">:</span>    diskdb<span class="token punctuation">,</span>
		cleans<span class="token punctuation">:</span>    cleans<span class="token punctuation">,</span>
		dirties<span class="token punctuation">:</span>   <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>cachedNode<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		preimages<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过参考BlockChain源码我们可以知道，为了获得一个statedb对象，会使用statedb.New方法，其中需要一个Database对象，一般都是通过state包中的NewDatabase或者NewDatabaseWithCache方法，但是需要一个参数，所以由调用了trie包中的NewDatabase或者NewDatabaseWithCache方法，如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">state<span class="token punctuation">,</span> err <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span><span class="token function">Root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bc<span class="token punctuation">.</span>stateCache<span class="token punctuation">)</span>

stateCache<span class="token punctuation">:</span>     state<span class="token punctuation">.</span><span class="token function">NewDatabaseWithCache</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> cacheConfig<span class="token punctuation">.</span>TrieCleanLimit<span class="token punctuation">)</span><span class="token punctuation">,</span>

<span class="token keyword">func</span> <span class="token function">NewDatabaseWithCache</span><span class="token punctuation">(</span>db ethdb<span class="token punctuation">.</span>Database<span class="token punctuation">,</span> cache <span class="token builtin">int</span><span class="token punctuation">)</span> Database <span class="token punctuation">&#123;</span>
	csc<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> lru<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>codeSizeCacheSize<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>cachingDB<span class="token punctuation">&#123;</span>
		db<span class="token punctuation">:</span>            trie<span class="token punctuation">.</span><span class="token function">NewDatabaseWithCache</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">,</span> 
		codeSizeCache<span class="token punctuation">:</span> csc<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过层层引用，只有到trie包中的database对象才持有真正的数据库对象。</p>
<h3 id="InsertBlob"><a href="#InsertBlob" class="headerlink" title="InsertBlob"></a>InsertBlob</h3><p>这个方法出现在statedb的commit中，如果一个stateObject的code字段不为空且被设置过，则将code进行插入</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">s<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">TrieDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">InsertBlob</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span><span class="token function">BytesToHash</span><span class="token punctuation">(</span>stateObject<span class="token punctuation">.</span><span class="token function">CodeHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stateObject<span class="token punctuation">.</span>code<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>Database<span class="token punctuation">)</span> <span class="token function">InsertBlob</span><span class="token punctuation">(</span>hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> blob <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	db<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> blob<span class="token punctuation">,</span> <span class="token function">rawNode</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>Database<span class="token punctuation">)</span> <span class="token function">insert</span><span class="token punctuation">(</span>hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> blob <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> node node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> db<span class="token punctuation">.</span>dirties<span class="token punctuation">[</span>hash<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	entry <span class="token operator">:=</span> <span class="token operator">&amp;</span>cachedNode<span class="token punctuation">&#123;</span>
		node<span class="token punctuation">:</span>      <span class="token function">simplifyNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">,</span>
		size<span class="token punctuation">:</span>      <span class="token function">uint16</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		flushPrev<span class="token punctuation">:</span> db<span class="token punctuation">.</span>newest<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> child <span class="token operator">:=</span> <span class="token keyword">range</span> entry<span class="token punctuation">.</span><span class="token function">childs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> c <span class="token operator">:=</span> db<span class="token punctuation">.</span>dirties<span class="token punctuation">[</span>child<span class="token punctuation">]</span><span class="token punctuation">;</span> c <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			c<span class="token punctuation">.</span>parents<span class="token operator">++</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	db<span class="token punctuation">.</span>dirties<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> entry


	<span class="token keyword">if</span> db<span class="token punctuation">.</span>oldest <span class="token operator">==</span> <span class="token punctuation">(</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		db<span class="token punctuation">.</span>oldest<span class="token punctuation">,</span> db<span class="token punctuation">.</span>newest <span class="token operator">=</span> hash<span class="token punctuation">,</span> hash
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		db<span class="token punctuation">.</span>dirties<span class="token punctuation">[</span>db<span class="token punctuation">.</span>newest<span class="token punctuation">]</span><span class="token punctuation">.</span>flushNext<span class="token punctuation">,</span> db<span class="token punctuation">.</span>newest <span class="token operator">=</span> hash<span class="token punctuation">,</span> hash
	<span class="token punctuation">&#125;</span>
	db<span class="token punctuation">.</span>dirtiesSize <span class="token operator">+=</span> common<span class="token punctuation">.</span><span class="token function">StorageSize</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span>HashLength <span class="token operator">+</span> entry<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>InsertBlob我们传入要存储的数据及其hash，之后调用insert方法，将要传入的数据又包装成一个rawNode类型。在insert方法中，首先检测要传入的数据是否被缓存过，是的话直接结束操作。</p>
<p>之后构建了一个cacheNode类型。然后调用了childs遍历其所有孩子并将其组成一个Hash类型的数组，之后遍历这个数组，看是否有引入该节点的项，有的话将其对应的parents字段加一。最后将刚才生成的cacheNode放入dirties中。</p>
<p>再往下有一个修改oldest与newest的逻辑，这里解释一下，源码这这里构建了一个刷新列表，实际为一个链表，oldest表示列表中最旧的节点，在列表头部；newest表示最新的节点，位于列表尾部。而cachedNode的flushNext表示该节点之后下一个要刷入数据库的节点，对应的还有flushPrev，在构造cachedNode时被设为newest。这里，如果oldest为空，表示列表为空，则oldest与newest都为当前该节点。否则只修改newest和该节点的flushNext字段。</p>
<p>接着修改database的dirtiesSize表示已缓存的数据量。</p>
<h3 id="Commit"><a href="#Commit" class="headerlink" title="Commit"></a>Commit</h3><p>可以看到之前的insert方法并没有将数据存入数据库，而是放入dirties中，我们这里看一下commit方法，他要求传入一个节点hash：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>Database<span class="token punctuation">)</span> <span class="token function">Commit</span><span class="token punctuation">(</span>node common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> report <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	batch <span class="token operator">:=</span> db<span class="token punctuation">.</span>diskdb<span class="token punctuation">.</span><span class="token function">NewBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> hash<span class="token punctuation">,</span> preimage <span class="token operator">:=</span> <span class="token keyword">range</span> db<span class="token punctuation">.</span>preimages <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> batch<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span><span class="token function">secureKey</span><span class="token punctuation">(</span>hash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> preimage<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Failed to commit preimage from trie database"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> batch<span class="token punctuation">.</span><span class="token function">ValueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> ethdb<span class="token punctuation">.</span>IdealBatchSize <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> batch<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">&#125;</span>
			batch<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	nodes<span class="token punctuation">,</span> storage <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>dirties<span class="token punctuation">)</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>dirtiesSize
	<span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> batch<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Failed to commit trie from trie database"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> batch<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Failed to write trie to disk"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


	db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	db<span class="token punctuation">.</span>preimages <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>
	db<span class="token punctuation">.</span>preimagesSize <span class="token operator">=</span> <span class="token number">0</span>

	db<span class="token punctuation">.</span><span class="token function">uncache</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>

	memcacheCommitTimeTimer<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span>
	memcacheCommitSizeMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span>storage <span class="token operator">-</span> db<span class="token punctuation">.</span>dirtiesSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
	memcacheCommitNodesMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span>nodes <span class="token operator">-</span> <span class="token function">len</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>dirties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	logger <span class="token operator">:=</span> log<span class="token punctuation">.</span>Info
	<span class="token keyword">if</span> <span class="token operator">!</span>report <span class="token punctuation">&#123;</span>
		logger <span class="token operator">=</span> log<span class="token punctuation">.</span>Debug
	<span class="token punctuation">&#125;</span>
	<span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">"Persisted trie from memory database"</span><span class="token punctuation">,</span> <span class="token string">"nodes"</span><span class="token punctuation">,</span> nodes<span class="token operator">-</span><span class="token function">len</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>dirties<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">int</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>flushnodes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"size"</span><span class="token punctuation">,</span> storage<span class="token operator">-</span>db<span class="token punctuation">.</span>dirtiesSize<span class="token operator">+</span>db<span class="token punctuation">.</span>flushsize<span class="token punctuation">,</span> <span class="token string">"time"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token operator">+</span>db<span class="token punctuation">.</span>flushtime<span class="token punctuation">,</span>
		<span class="token string">"gcnodes"</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>gcnodes<span class="token punctuation">,</span> <span class="token string">"gcsize"</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>gcsize<span class="token punctuation">,</span> <span class="token string">"gctime"</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>gctime<span class="token punctuation">,</span> <span class="token string">"livenodes"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>dirties<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"livesize"</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>dirtiesSize<span class="token punctuation">)</span>


	db<span class="token punctuation">.</span>gcnodes<span class="token punctuation">,</span> db<span class="token punctuation">.</span>gcsize<span class="token punctuation">,</span> db<span class="token punctuation">.</span>gctime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
	db<span class="token punctuation">.</span>flushnodes<span class="token punctuation">,</span> db<span class="token punctuation">.</span>flushsize<span class="token punctuation">,</span> db<span class="token punctuation">.</span>flushtime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里首先创建了一个数据库的batch对象，用于后面批量操作。首先放入batch中的是preimages数据，这个稍后再说。每放入一个就检查是否超过batch规定的最大容量（100KB），超过的话先执行一次写入操作再进行后续的数据放入。在往下调用了commit方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>Database<span class="token punctuation">)</span> <span class="token function">commit</span><span class="token punctuation">(</span>hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> batch ethdb<span class="token punctuation">.</span>Batch<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	node<span class="token punctuation">,</span> ok <span class="token operator">:=</span> db<span class="token punctuation">.</span>dirties<span class="token punctuation">[</span>hash<span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> child <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span><span class="token function">childs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> batch<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> batch<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>hash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">rlp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> batch<span class="token punctuation">.</span><span class="token function">ValueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> ethdb<span class="token punctuation">.</span>IdealBatchSize <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> batch<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
		batch<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法很简单就是从指定的节点开始递归遍历节点的所有孩子，将节点经过rlp编码后存入数据库。回到Commit中，调用了一次batch的write方法确保所有数据都被写入数据库。最后初始化一些变量。</p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>Database<span class="token punctuation">)</span> <span class="token function">Reference</span><span class="token punctuation">(</span>child common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> parent common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	db<span class="token punctuation">.</span><span class="token function">reference</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>Database<span class="token punctuation">)</span> <span class="token function">reference</span><span class="token punctuation">(</span>child common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> parent common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	node<span class="token punctuation">,</span> ok <span class="token operator">:=</span> db<span class="token punctuation">.</span>dirties<span class="token punctuation">[</span>child<span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> db<span class="token punctuation">.</span>dirties<span class="token punctuation">[</span>parent<span class="token punctuation">]</span><span class="token punctuation">.</span>children <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		db<span class="token punctuation">.</span>dirties<span class="token punctuation">[</span>parent<span class="token punctuation">]</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token builtin">uint16</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">=</span> db<span class="token punctuation">.</span>dirties<span class="token punctuation">[</span>parent<span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span>child<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> parent <span class="token operator">!=</span> <span class="token punctuation">(</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	node<span class="token punctuation">.</span>parents<span class="token operator">++</span>
	db<span class="token punctuation">.</span>dirties<span class="token punctuation">[</span>parent<span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span>child<span class="token punctuation">]</span><span class="token operator">++</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Reference是建立一个从父结点到子节点的引用。首先检查了是否缓存有子节点，有的话再看要建立引入的父节点的孩子是否为空，再检查是否已经建立的引用，没有的将孩子节点的父节点树加一，然后将父节点对应的孩子节点引用树加一。</p>
<h3 id="Cap"><a href="#Cap" class="headerlink" title="Cap"></a>Cap</h3><p>这个方法在BlockChain中实际写入一个区块后，如果是带缓存模式时，先检查已缓存是否超过的现在，超过的话利用此方法写入数据库</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>Database<span class="token punctuation">)</span> <span class="token function">Cap</span><span class="token punctuation">(</span>limit common<span class="token punctuation">.</span>StorageSize<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	nodes<span class="token punctuation">,</span> storage<span class="token punctuation">,</span> start <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>dirties<span class="token punctuation">)</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>dirtiesSize<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	batch <span class="token operator">:=</span> db<span class="token punctuation">.</span>diskdb<span class="token punctuation">.</span><span class="token function">NewBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	size <span class="token operator">:=</span> db<span class="token punctuation">.</span>dirtiesSize <span class="token operator">+</span> common<span class="token punctuation">.</span><span class="token function">StorageSize</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>dirties<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">*</span>common<span class="token punctuation">.</span>HashLength<span class="token punctuation">)</span>

	flushPreimages <span class="token operator">:=</span> db<span class="token punctuation">.</span>preimagesSize <span class="token operator">></span> <span class="token number">4</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span>
	<span class="token keyword">if</span> flushPreimages <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> hash<span class="token punctuation">,</span> preimage <span class="token operator">:=</span> <span class="token keyword">range</span> db<span class="token punctuation">.</span>preimages <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> batch<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span><span class="token function">secureKey</span><span class="token punctuation">(</span>hash<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> preimage<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Failed to commit preimage from trie database"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">if</span> batch<span class="token punctuation">.</span><span class="token function">ValueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> ethdb<span class="token punctuation">.</span>IdealBatchSize <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> err <span class="token operator">:=</span> batch<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token keyword">return</span> err
				<span class="token punctuation">&#125;</span>
				batch<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	oldest <span class="token operator">:=</span> db<span class="token punctuation">.</span>oldest
	<span class="token keyword">for</span> size <span class="token operator">></span> limit <span class="token operator">&amp;&amp;</span> oldest <span class="token operator">!=</span> <span class="token punctuation">(</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		node <span class="token operator">:=</span> db<span class="token punctuation">.</span>dirties<span class="token punctuation">[</span>oldest<span class="token punctuation">]</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> batch<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>oldest<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">rlp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> batch<span class="token punctuation">.</span><span class="token function">ValueSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> ethdb<span class="token punctuation">.</span>IdealBatchSize <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> batch<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Failed to write flush list to disk"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">&#125;</span>
			batch<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		size <span class="token operator">-=</span> common<span class="token punctuation">.</span><span class="token function">StorageSize</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span>common<span class="token punctuation">.</span>HashLength <span class="token operator">+</span> <span class="token function">int</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
		oldest <span class="token operator">=</span> node<span class="token punctuation">.</span>flushNext
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> batch<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Failed to write flush list to disk"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> db<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> flushPreimages <span class="token punctuation">&#123;</span>
		db<span class="token punctuation">.</span>preimages <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span>
		db<span class="token punctuation">.</span>preimagesSize <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> db<span class="token punctuation">.</span>oldest <span class="token operator">!=</span> oldest <span class="token punctuation">&#123;</span>
		node <span class="token operator">:=</span> db<span class="token punctuation">.</span>dirties<span class="token punctuation">[</span>db<span class="token punctuation">.</span>oldest<span class="token punctuation">]</span>
		<span class="token function">delete</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>dirties<span class="token punctuation">,</span> db<span class="token punctuation">.</span>oldest<span class="token punctuation">)</span>
		db<span class="token punctuation">.</span>oldest <span class="token operator">=</span> node<span class="token punctuation">.</span>flushNext

		db<span class="token punctuation">.</span>dirtiesSize <span class="token operator">-=</span> common<span class="token punctuation">.</span><span class="token function">StorageSize</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span>HashLength <span class="token operator">+</span> <span class="token function">int</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> db<span class="token punctuation">.</span>oldest <span class="token operator">!=</span> <span class="token punctuation">(</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		db<span class="token punctuation">.</span>dirties<span class="token punctuation">[</span>db<span class="token punctuation">.</span>oldest<span class="token punctuation">]</span><span class="token punctuation">.</span>flushPrev <span class="token operator">=</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	db<span class="token punctuation">.</span>flushnodes <span class="token operator">+=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>nodes <span class="token operator">-</span> <span class="token function">len</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>dirties<span class="token punctuation">)</span><span class="token punctuation">)</span>
	db<span class="token punctuation">.</span>flushsize <span class="token operator">+=</span> storage <span class="token operator">-</span> db<span class="token punctuation">.</span>dirtiesSize
	db<span class="token punctuation">.</span>flushtime <span class="token operator">+=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span>

	memcacheFlushTimeTimer<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span>
	memcacheFlushSizeMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span>storage <span class="token operator">-</span> db<span class="token punctuation">.</span>dirtiesSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
	memcacheFlushNodesMeter<span class="token punctuation">.</span><span class="token function">Mark</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span>nodes <span class="token operator">-</span> <span class="token function">len</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>dirties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Persisted nodes from memory database"</span><span class="token punctuation">,</span> <span class="token string">"nodes"</span><span class="token punctuation">,</span> nodes<span class="token operator">-</span><span class="token function">len</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>dirties<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"size"</span><span class="token punctuation">,</span> storage<span class="token operator">-</span>db<span class="token punctuation">.</span>dirtiesSize<span class="token punctuation">,</span> <span class="token string">"time"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token string">"flushnodes"</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>flushnodes<span class="token punctuation">,</span> <span class="token string">"flushsize"</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>flushsize<span class="token punctuation">,</span> <span class="token string">"flushtime"</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>flushtime<span class="token punctuation">,</span> <span class="token string">"livenodes"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>dirties<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"livesize"</span><span class="token punctuation">,</span> db<span class="token punctuation">.</span>dirtiesSize<span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同样先获取了batch，然后计算了几个数据：dirties的长度，dirties内容大小以及总的大小（包含dirties的内容大小dirties自身大小）。接着判断了preimages是否超过了4MB，超过的话将其写入数据库。</p>
<p>接着获取要刷入列表的头部，也就是oldest指向的节点。此时如果刚才计算的总大小超过了限制，则从oldest开始，沿着那个刷新链表将每个节点写入数据库，直到链表结束或总的大小不超过限制为止。接着又调用了一次Write方法确保数据被写入数据库。最后更新了几个变量。</p>
<h3 id="Preimage"><a href="#Preimage" class="headerlink" title="Preimage"></a>Preimage</h3><p>这个和SecureTrie有关，每当SecureTrie利用Update或TryUpdate向树中插入数据时，都会将要存储的键值对在secKeyCache从缓存一份，在SecureTrie的的commit方法中，在调用trie的commit之前，secKeyCache中的数据通过insertPreimage插入</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>db <span class="token operator">*</span>Database<span class="token punctuation">)</span> <span class="token function">insertPreimage</span><span class="token punctuation">(</span>hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> preimage <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> db<span class="token punctuation">.</span>preimages<span class="token punctuation">[</span>hash<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	db<span class="token punctuation">.</span>preimages<span class="token punctuation">[</span>hash<span class="token punctuation">]</span> <span class="token operator">=</span> common<span class="token punctuation">.</span><span class="token function">CopyBytes</span><span class="token punctuation">(</span>preimage<span class="token punctuation">)</span>
	db<span class="token punctuation">.</span>preimagesSize <span class="token operator">+=</span> common<span class="token punctuation">.</span><span class="token function">StorageSize</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span>HashLength <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>preimage<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>secKeyCache表示一个树的阶段性状态，在调用commit后会对secKeyCache清空。</p>
<p>在database中提交时，无论是调用commit或者cap方法，都是先提交preimages，在提交节点数据。其中preimages实际上相当于存储着树中的原始数据，而存储节点时而存储的是节点(指cachedNode)rlp编码后的数据。</p>
<blockquote>
<p>题图来自unsplash：<a target="_blank" rel="noopener" href="https://unsplash.com/photos/hnw3Al47-KE">https://unsplash.com/photos/hnw3Al47-KE</a></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag"><i class="fa fa-tag"></i> 区块链</a>
              <a href="/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" rel="tag"><i class="fa fa-tag"></i> 以太坊</a>
              <a href="/tags/go/" rel="tag"><i class="fa fa-tag"></i> go</a>
              <a href="/tags/go-ethereum/" rel="tag"><i class="fa fa-tag"></i> go-ethereum</a>
              <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag"><i class="fa fa-tag"></i> 数据结构</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/03/26/IDEA%E5%8A%A0%E5%AF%86/" rel="prev" title="IDEA加密与实现">
                  <i class="fa fa-chevron-left"></i> IDEA加密与实现
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/03/27/RC4%E5%8A%A0%E5%AF%86/" rel="next" title="RC4加密与实现">
                  RC4加密与实现 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">AmorFati</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">632k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:35</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
