<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">

<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CConsolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="article">
<meta property="og:title" content="Protobuf学习及编码深入">
<meta property="og:url" content="http://example.com/2019/03/22/Protobuf%E5%AD%A6%E4%B9%A0%E5%8F%8A%E7%BC%96%E7%A0%81%E6%B7%B1%E5%85%A5/index.html">
<meta property="og:site_name" content="AmorFati">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/pb1.png">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/5111131-43c2d0f4aa4e43bb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/pb2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/pb3.png">
<meta property="article:published_time" content="2019-03-22T04:33:54.000Z">
<meta property="article:modified_time" content="2021-11-17T13:54:30.485Z">
<meta property="article:author" content="AmorFati">
<meta property="article:tag" content="java">
<meta property="article:tag" content="编码">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/pb1.png">


<link rel="canonical" href="http://example.com/2019/03/22/Protobuf%E5%AD%A6%E4%B9%A0%E5%8F%8A%E7%BC%96%E7%A0%81%E6%B7%B1%E5%85%A5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2019/03/22/Protobuf%E5%AD%A6%E4%B9%A0%E5%8F%8A%E7%BC%96%E7%A0%81%E6%B7%B1%E5%85%A5/","path":"2019/03/22/Protobuf学习及编码深入/","title":"Protobuf学习及编码深入"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Protobuf学习及编码深入 | AmorFati</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">AmorFati</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">风吹过窗前的书，又翻过一页</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="nav-number">2.</span> <span class="nav-text">简单使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89Protobuf%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.</span> <span class="nav-text">定义Protobuf文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91"><span class="nav-number">2.2.</span> <span class="nav-text">编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E6%93%8D%E4%BD%9C"><span class="nav-number">2.3.</span> <span class="nav-text">接口操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B"><span class="nav-number">2.4.</span> <span class="nav-text">简单示例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AF%A6%E7%BB%86%E8%AF%AD%E6%B3%95"><span class="nav-number">3.</span> <span class="nav-text">详细语法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B"><span class="nav-number">3.1.</span> <span class="nav-text">基本字段类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E9%85%8D%E5%AD%97%E6%AE%B5%E7%BC%96%E5%8F%B7"><span class="nav-number">3.2.</span> <span class="nav-text">分配字段编号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E7%BA%A6%E6%9D%9F"><span class="nav-number">3.3.</span> <span class="nav-text">字段约束</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E9%87%8A"><span class="nav-number">3.4.</span> <span class="nav-text">注释</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%9D%E7%95%99%E5%AD%97"><span class="nav-number">3.5.</span> <span class="nav-text">保留字</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AF%E9%80%89%E5%AD%97%E6%AE%B5%E7%9A%84%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="nav-number">3.6.</span> <span class="nav-text">可选字段的默认值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B"><span class="nav-number">3.7.</span> <span class="nav-text">枚举类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BC%E5%8C%85"><span class="nav-number">3.8.</span> <span class="nav-text">导包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B5%8C%E5%A5%97%E5%AE%9A%E4%B9%89"><span class="nav-number">3.9.</span> <span class="nav-text">嵌套定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Extensions"><span class="nav-number">3.10.</span> <span class="nav-text">Extensions</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Oneof"><span class="nav-number">3.11.</span> <span class="nav-text">Oneof</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#maps"><span class="nav-number">3.12.</span> <span class="nav-text">maps</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Message%E6%9B%B4%E6%96%B0"><span class="nav-number">3.13.</span> <span class="nav-text">Message更新</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#packages"><span class="nav-number">3.14.</span> <span class="nav-text">packages</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%80%89%E9%A1%B9"><span class="nav-number">3.15.</span> <span class="nav-text">自定义选项</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#proto3%E8%AF%AD%E6%B3%95"><span class="nav-number">4.</span> <span class="nav-text">proto3语法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E5%8F%B7"><span class="nav-number">4.1.</span> <span class="nav-text">版本号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E9%A5%B0%E8%AF%8D"><span class="nav-number">4.2.</span> <span class="nav-text">修饰词</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="nav-number">4.3.</span> <span class="nav-text">默认值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B-1"><span class="nav-number">4.4.</span> <span class="nav-text">枚举类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AA%E7%9F%A5%E5%AD%97%E6%AE%B5"><span class="nav-number">4.5.</span> <span class="nav-text">未知字段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#any"><span class="nav-number">4.6.</span> <span class="nav-text">any</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BC%96%E7%A0%81"><span class="nav-number">5.</span> <span class="nav-text">编码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Varints%E8%A7%84%E5%88%99"><span class="nav-number">5.1.</span> <span class="nav-text">Varints规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%BC%96%E7%A0%81%E8%A7%84%E5%88%99"><span class="nav-number">5.2.</span> <span class="nav-text">基本编码规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E7%B1%BB%E5%9E%8B%E8%A7%84%E5%88%99"><span class="nav-number">5.3.</span> <span class="nav-text">其他类型规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sint32-sint64"><span class="nav-number">5.3.1.</span> <span class="nav-text">sint32, sint64</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#64-bit-%E5%92%8C-32-bit-%E7%B1%BB%E5%9E%8B"><span class="nav-number">5.3.2.</span> <span class="nav-text">64-bit 和 32-bit 类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Strings"><span class="nav-number">5.3.3.</span> <span class="nav-text">Strings</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#packed"><span class="nav-number">5.4.</span> <span class="nav-text">packed</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%BA%E5%BA%8F"><span class="nav-number">5.5.</span> <span class="nav-text">顺序</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="AmorFati"
      src="/assets/img/icon.jpg">
  <p class="site-author-name" itemprop="name">AmorFati</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/1chenyy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;1chenyy" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:henyang4346@foxmail.com" title="E-Mail → mailto:henyang4346@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/52c1bec4559c" title="简书 → https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;52c1bec4559c" rel="noopener" target="_blank"><i class="fa fa-globe fa-fw"></i>简书</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/03/22/Protobuf%E5%AD%A6%E4%B9%A0%E5%8F%8A%E7%BC%96%E7%A0%81%E6%B7%B1%E5%85%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/icon.jpg">
      <meta itemprop="name" content="AmorFati">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmorFati">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Protobuf学习及编码深入
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-03-22 12:33:54" itemprop="dateCreated datePublished" datetime="2019-03-22T12:33:54+08:00">2019-03-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-11-17 21:54:30" itemprop="dateModified" datetime="2021-11-17T21:54:30+08:00">2021-11-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">编码</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/pb1.png"></p>
<span id="more"></span>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>按照官方的介绍，Protocol buffers是一种与具体平台或者编程语言无关的可扩展的序列化语言，类似于XML或者JSON，由其对比XML而言，具有更小更快更简单的特点。接下来我们就来了解一下这个东西。</p>
<h1 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h1><p>一般而言，使用步骤有三步。首先定义Protobuf模板文件，以.proto为后缀；然后生成特定语言的接口代码；最后利用接口代码进行序列化或者反序列操作。整体步骤和我们利用一些第三方库如Gson去操作json文件类似，下面就具体看一下这几个过程：</p>
<h2 id="定义Protobuf文件"><a href="#定义Protobuf文件" class="headerlink" title="定义Protobuf文件"></a>定义Protobuf文件</h2><p>下面这个例子是官方文档给出，定义了一个地址簿的数据结构：</p>
<pre class="line-numbers language-none"><code class="language-none">syntax &#x3D; &quot;proto2&quot;;

package tutorial;

option java_package &#x3D; &quot;code.protobuf&quot;;
option java_outer_classname &#x3D; &quot;AddressBookProtos&quot;;

message Person &#123;
  required string name &#x3D; 1;
  required int32 id &#x3D; 2;
  optional string email &#x3D; 3;
&#125;

message AddressBook &#123;
  repeated Person people &#x3D; 1;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>具体语法我们稍后再介绍，首先可以看到，Protobuf文件的格式很像一些面向对象语言中类的定义，上面例子一个message就像一个类定义，类之间可以嵌套。AddressBook中有Person对象，Person中又有PhoneNumber对象。Person中也有一些基本类型如string和int。用过Gson之类的库解析json的应该感觉这和解析json时定义的类很像。</p>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>写好Protobuf文件后，就相当于写好一个模板文件，在不同平台或者不同语言间交互时都以这个文件为标准，但是还不能直接，根据具体的编程语言，我们还要有接口文件，我们可以利用官方给的<a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf/releases/tag/v3.7.0">编译工具</a>生成我们需要的接口代码，以java语言为例：</p>
<pre class="line-numbers language-none"><code class="language-none">protoc --java_out&#x3D;src\ src\code\protobuf\addressbook.proto<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>–java_out表示生成的接口文件路径，由于我们在Protobuf文件文件中定义了java_package，所以只需指定包所在目录即可，生成的文件会自动放在具体包下，最后指定Protobuf文件具体路径。生成的文件名在Protobuf文件中java_outer_classname字段定义。</p>
<h2 id="接口操作"><a href="#接口操作" class="headerlink" title="接口操作"></a>接口操作</h2><p>执行完命令后，在code.protobuf包下生成了AddressBookProtos.java文件(要使用这个代码还需要导入相关库)。代码还是很长的，我们仅仅定义了一个简单的地址簿数据结构，就生成了近2000行代码，但是对于我们所使用的接口而言，生成的这个代码其实就是一个JavaBean类，它使用了建造者模式，当我们要构造一个Person对象时，如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>Person</span> john <span class="token operator">=</span> <span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>Person</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1234</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"John"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span><span class="token string">"john@163.com"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addPhones</span><span class="token punctuation">(</span><span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>Person<span class="token punctuation">.</span>PhoneNumber</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token string">"15463"</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>Person<span class="token punctuation">.</span>PhoneType</span><span class="token punctuation">.</span>HOME<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>除了常用的get与set方法，还提供了：toString()方法用于转为有意义的字符串形式；isInitialized()方法用于检测所有必需字段是否设置；clear()方法用于清空所有字段；mergeFrom(Message other)用于合并两个对象。</p>
<p>当然作为序列化工具，生成的对象也提供了序列化和反序列化相关的方法：toByteArray()和parseFrom(byte[] data)。另外还可以直接操作流：writeTo(OutputStream output)和parseFrom(InputStream input)。</p>
<h2 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h2><p>这里演示一个简单的跨语言的传输数据的例子。使用Go语言编写服务端，java编写客户端，从客户端向服务端发送数据。protobuf文件还使用上面的例子，这里在使用编译工具编译go语言的接口文件，protobuf文件不用做任何修改：</p>
<pre class="line-numbers language-none"><code class="language-none">protoc --go_out&#x3D;.\ src\code\protobuf\addressbook.proto<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>java的客户端代码如下：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>Person</span> person <span class="token operator">=</span> <span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>Person</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"jack"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span><span class="token string">"jack@163.com"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>AddressBook</span> book <span class="token operator">=</span> <span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>AddressBook</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">addPeople</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span><span class="token number">1234</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">OutputStream</span> out <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        socket<span class="token punctuation">.</span><span class="token function">shutdownOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>go的服务端代码如下</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	listener<span class="token punctuation">,</span>err<span class="token operator">:=</span>net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span><span class="token string">":1234"</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err<span class="token operator">!=</span><span class="token boolean">nil</span><span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span><span class="token string">"Listen："</span><span class="token punctuation">,</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	con<span class="token punctuation">,</span>err<span class="token operator">:=</span>listener<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err<span class="token operator">!=</span><span class="token boolean">nil</span><span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span><span class="token string">"Accept："</span><span class="token punctuation">,</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	result<span class="token punctuation">,</span>err<span class="token operator">:=</span>ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>con<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err<span class="token operator">!=</span><span class="token boolean">nil</span><span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span><span class="token string">"ReadAll："</span><span class="token punctuation">,</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	book <span class="token operator">:=</span> <span class="token operator">&amp;</span>tutorial<span class="token punctuation">.</span>AddressBook<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> proto<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> book<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span><span class="token string">"Failed to parse address book:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>book<span class="token punctuation">.</span>People<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Email<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="详细语法"><a href="#详细语法" class="headerlink" title="详细语法"></a>详细语法</h1><p>首先在文件第一行在指定语法版本，如：syntax = “proto2”;</p>
<h2 id="基本字段类型"><a href="#基本字段类型" class="headerlink" title="基本字段类型"></a>基本字段类型</h2><p>message中每个字段都要指定数据类型。如下表：<br><img src="https://upload-images.jianshu.io/upload_images/5111131-43c2d0f4aa4e43bb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="TIM截图20190308165734.png"></p>
<h2 id="分配字段编号"><a href="#分配字段编号" class="headerlink" title="分配字段编号"></a>分配字段编号</h2><p>如例子中所示，每个字段都要分配一个独一无二编号，编号范围在1~536,870,911，主要是为了标记字段，并且不能改变，需要注意的是19000到19999是不能使用的。关于编号，官方文档建议，对于频繁使用的元素应当使用1到15的编号，因为这些序号被编码为1byte，而16到2047被编码为2byte。</p>
<h2 id="字段约束"><a href="#字段约束" class="headerlink" title="字段约束"></a>字段约束</h2><p>有以下几个修饰词:</p>
<pre class="line-numbers language-none"><code class="language-none">required：使用时必须被指定的字段
optional：可以不被指定，但是最多只能指定一个
repeated：可以出现次的，也可以不出现，相当于数组的概念。官方建议使用[packed&#x3D;true]选项提高编码效率：repeated int32 samples &#x3D; 4 [packed&#x3D;true];<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>了解完字段类型，编号，约束词以后，我们可以得到message中一个字段的完整定义:</p>
<pre class="line-numbers language-none"><code class="language-none">字段约束 类型 名称 &#x3D; 字段编号;
required string query &#x3D; 1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><p>类似于java等语言的注释风格：使用// 或/**/</p>
<h2 id="保留字"><a href="#保留字" class="headerlink" title="保留字"></a>保留字</h2><p>对于以删除的字段，若是后面再被使用，可能会导致问题，所以可以用reserved标记出来，若被使用编译器将报错。reserved使用方法如下：</p>
<pre class="line-numbers language-none"><code class="language-none">message Foo &#123;
  reserved 2, 15, 9 to 11;
  reserved &quot;foo&quot;, &quot;bar&quot;;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意字段和编号不能混合在一起用reserved标记</p>
<h2 id="可选字段的默认值"><a href="#可选字段的默认值" class="headerlink" title="可选字段的默认值"></a>可选字段的默认值</h2><p>对于optional修饰的字段，若未定义，会有一个与字段类型对应的默认值，如string为空，bool为false等，我们也可以指定默认值如下所示：</p>
<pre class="line-numbers language-none"><code class="language-none">optional int32 result_per_page &#x3D; 3 [default &#x3D; 10];<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="枚举类型"><a href="#枚举类型" class="headerlink" title="枚举类型"></a>枚举类型</h2><p>定义如下：</p>
<pre class="line-numbers language-none"><code class="language-none">enum Corpus &#123;
    UNIVERSAL &#x3D; 0;
    WEB &#x3D; 1;
    IMAGES &#x3D; 2;
    LOCAL &#x3D; 3;
    NEWS &#x3D; 4;
    PRODUCTS &#x3D; 5;
    VIDEO &#x3D; 6;
  &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在一个枚举中，可以指定一些相同值的成员，这样会被解析为别名，同时需要加上option allow_alias = true</p>
<pre class="line-numbers language-none"><code class="language-none">enum EnumAllowingAlias &#123;
  option allow_alias &#x3D; true;
  UNKNOWN &#x3D; 0;
  STARTED &#x3D; 1;
  RUNNING &#x3D; 1;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>若在一个message中使用另一个message的enum可以以MessageType.EnumType的形式调用</p>
<h2 id="导包"><a href="#导包" class="headerlink" title="导包"></a>导包</h2><p>protobuf也有导包的概念，如果要从一个proto文件中引用另一个proto文件中的一个message，需要使用import关键字进行导包。注意在编译时使用-I指定搜索包的路径，否则只会默认搜索当前目录下的文件</p>
<h2 id="嵌套定义"><a href="#嵌套定义" class="headerlink" title="嵌套定义"></a>嵌套定义</h2><pre class="line-numbers language-none"><code class="language-none">message SearchResponse &#123;
  message Result &#123;
    required string url &#x3D; 1;
    optional string title &#x3D; 2;
    repeated string snippets &#x3D; 3;
  &#125;
  repeated Result result &#x3D; 1;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面例子在一个message中定义了另一个message，使用时利用SearchResponse.Result引用内部定义的message</p>
<h2 id="Extensions"><a href="#Extensions" class="headerlink" title="Extensions"></a>Extensions</h2><p>扩展实际上是一个占位符，它代表未在原始文件中定义的字段</p>
<pre class="line-numbers language-none"><code class="language-none">message Foo &#123;
  extensions 100 to 199;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>其他用户可以使用extensions指定的字段为原来的message添加新字段</p>
<pre class="line-numbers language-none"><code class="language-none">extend Foo &#123;
  optional int32 bar &#x3D; 126;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>访问extension也有特殊的api，示例：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//序列化</span>
<span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>AddressBook</span> book <span class="token operator">=</span> <span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>AddressBook</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setExtension</span><span class="token punctuation">(</span><span class="token class-name">AddressBookProtos</span><span class="token punctuation">.</span>bar<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> out <span class="token operator">=</span> book<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//反序列化</span>
<span class="token class-name">ExtensionRegistry</span> registry <span class="token operator">=</span> <span class="token class-name">ExtensionRegistry</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
registry<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">AddressBookProtos</span><span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>AddressBook</span> ob <span class="token operator">=</span> <span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>AddressBook</span><span class="token punctuation">.</span><span class="token function">parseFrom</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ob<span class="token punctuation">.</span><span class="token function">hasExtension</span><span class="token punctuation">(</span><span class="token class-name">AddressBookProtos</span><span class="token punctuation">.</span>bar<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意在反序列化时候要注册需要解析的extension，并作为参数传入parseFrom</p>
<h2 id="Oneof"><a href="#Oneof" class="headerlink" title="Oneof"></a>Oneof</h2><p>oneof的出现是为了实现这样的需求：一个message中有多个成员，但同一时间只能有一个成员被赋值。</p>
<pre class="line-numbers language-none"><code class="language-none">oneof test&#123;
    string a &#x3D; 4;
    string b &#x3D; 5;
    string c &#x3D; 6;
  &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>Person</span> p2 <span class="token operator">=</span> <span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>Person</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"tom"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setEmail</span><span class="token punctuation">(</span><span class="token string">"tom@163.com"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setA</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setB</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>AddressBook</span> book <span class="token operator">=</span> <span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>AddressBook</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addPeople</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                
<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> out <span class="token operator">=</span> book<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>AddressBook</span> ob <span class="token operator">=</span> <span class="token class-name">AddressBookProtos<span class="token punctuation">.</span>AddressBook</span><span class="token punctuation">.</span><span class="token function">parseFrom</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ob<span class="token punctuation">.</span><span class="token function">getPeople</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ob<span class="token punctuation">.</span><span class="token function">getPeople</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可见我们虽然同时对A，B都进行了赋值，但是只有B被赋值成功，也就是同时只有一个成员可以被赋值<br>需要有以下几点注意：</p>
<ol>
<li>对一个成员赋值，会自动清除其他已赋值的成员</li>
<li>extension不支持oneof</li>
<li>oneof不能被修饰为repeated</li>
</ol>
<p>实际上对于oneof修饰的一组成员，完全可以把它们当做普通的optional成员看待，只不过这几个成员之间又互相依赖关系</p>
<p>另外，oneof：</p>
<ol>
<li>安全的移除或添加字段，但会可能会导致数据丢失</li>
<li>可以删除一个oneof，也可能会导致数据丢失</li>
<li>可以分割或合并oneof，效果类似移除或添加字段</li>
</ol>
<h2 id="maps"><a href="#maps" class="headerlink" title="maps"></a>maps</h2><p>一般意义上的映射数据类型。</p>
<pre class="line-numbers language-none"><code class="language-none">map&lt;string, Project&gt; projects &#x3D; 3;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>key可以使任何整数或string（也就是浮点和字节类型除外），枚举也不能做为key。value可以是除map外的任何类型。注意事项：</p>
<ol>
<li>extension不支持map</li>
<li>map不能有repeated, optional, 或 required修饰</li>
<li>map是无序的</li>
</ol>
<p>map等效于下面的实现：</p>
<pre class="line-numbers language-none"><code class="language-none">message MapFieldEntry &#123;
  optional key_type key &#x3D; 1;
  optional value_type value &#x3D; 2;
&#125;

repeated MapFieldEntry map_field &#x3D; N;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Message更新"><a href="#Message更新" class="headerlink" title="Message更新"></a>Message更新</h2><p>更新需要遵循以下规则</p>
<ol>
<li>不要改变已有字段的编号</li>
<li>新字段只能使用optional或repeated修饰。这样也很好理解，旧的代码序列化的数据仍然可以被新代码解析，否则会由于缺少required而报错</li>
<li>非required修饰的字段可以被移除，但是注意被删除的字段所使用的编号不能再次使用</li>
<li>只要类型或者编号不便，非required字段可以转为extension</li>
<li>int32, uint32, int64, uint64 和 bool 是可以互相兼容的，也就是可以互相转换</li>
<li>sint32和sint64彼此兼容，但不和其他整数类型兼容</li>
<li>string和bytes互相兼容，前提是使用UTF-8编码</li>
<li>fixed32和sfixed32、fixed64、sfixed64是兼容的</li>
<li>optional与repeated是兼容的，若输入的是repeated，在解析为optional时，以最后一个输入为主，或合并输入</li>
<li>可以改变默认值，但要注意不同版本的protobuf文件的默认不同时会在带来潜在的冲突</li>
<li>enum 和 int32, uint32, int64, uint64是兼容的</li>
<li>将optional改为oneof是安全的</li>
</ol>
<h2 id="packages"><a href="#packages" class="headerlink" title="packages"></a>packages</h2><p>在proto文件中指定package字段来防止名字冲突。在java中，除非指定java_package字段，否则会以package作为包名</p>
<h2 id="自定义选项"><a href="#自定义选项" class="headerlink" title="自定义选项"></a>自定义选项</h2><ol>
<li>java_package ：指定生成的java文件所在的包</li>
<li>java_outer_classname ：指定生成的java文件名</li>
<li>optimize_for ：优化选项，有SPEED, CODE_SIZE, 和 LITE_RUNTIME三种选择。SPEED是默认选项，对代码进行优化。CODE_SIZE可以减小生成代码量，但解析速度会下降，LITE_RUNTIME生成的代码最少，但会失去一些特性</li>
<li>deprecated：被标记为true的字段表示不再使用：optional int32 old_field = 6 [deprecated=true];</li>
</ol>
<h1 id="proto3语法"><a href="#proto3语法" class="headerlink" title="proto3语法"></a>proto3语法</h1><p>proto3的语法和2有很多相似之处，所以这里只介绍一些不同点</p>
<h2 id="版本号"><a href="#版本号" class="headerlink" title="版本号"></a>版本号</h2><p>当然版本号要更改为proto3</p>
<pre class="line-numbers language-none"><code class="language-none">syntax &#x3D; &quot;proto3&quot;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="修饰词"><a href="#修饰词" class="headerlink" title="修饰词"></a>修饰词</h2><p>移除了required修饰词；<br>所有字段默认都是singular，也就是原来的optional，但是不能显式的指定为singular<br>repeated被保留了</p>
<p>正常情况下一个message书写如下：</p>
<pre class="line-numbers language-none"><code class="language-none">syntax &#x3D; &quot;proto3&quot;;

message SearchRequest &#123;
  string query &#x3D; 1;
  int32 page_number &#x3D; 2;
  int32 result_per_page &#x3D; 3;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="默认值"><a href="#默认值" class="headerlink" title="默认值"></a>默认值</h2><p>取消了default选项，也就是说默认值只能有系统默认指定，如字符串为空串，bool型为false，数字为0等。还有对于枚举类，默认是编号为0的成员。</p>
<h2 id="枚举类型-1"><a href="#枚举类型-1" class="headerlink" title="枚举类型"></a>枚举类型</h2><p>必须有一个编号为0的成员来作为其第一个成员。</p>
<h2 id="未知字段"><a href="#未知字段" class="headerlink" title="未知字段"></a>未知字段</h2><p>在3.5版本之前，不能被解析的字段会被直接抛弃，但是在3.5版本之后，这种特性又回归到proto2上，即不能被解析的字段仍然会保留到下次序列化的输出中</p>
<h2 id="any"><a href="#any" class="headerlink" title="any"></a>any</h2><p>用于替代extensions，不过尚在开发中</p>
<h1 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h1><h2 id="Varints规则"><a href="#Varints规则" class="headerlink" title="Varints规则"></a>Varints规则</h2><p>protobuf的编码基础是Varints，它是将整数序列化为一个或多个byte的方法。 Varints规则是用每byte的第7位存储值，第8位为标志位，若标志位为1，表示后面还有数据，若为0，表示该byte为最后一个。最后Varints采用小端存储。下面举一个例子：</p>
<pre class="line-numbers language-none"><code class="language-none">以整数300为例，300的二进制表示如下：
    100101100
按小端存储并每7位一组：
    0101100 0000010
再加上标志位，最终表示如下：
    10101100 00000010<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Varints的优点是，由于标志位存在，省去了编码长度的表示，其次越小的数编码越短，但是由于标志位的存在，也牺牲了容量，如4byte实际可用表示数值的只有28位</p>
<h2 id="基本编码规则"><a href="#基本编码规则" class="headerlink" title="基本编码规则"></a>基本编码规则</h2><p>我们首先看一下message中每个成员变量的定义</p>
<pre class="line-numbers language-none"><code class="language-none">int32 a &#x3D; 1;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>有三部分组成，变量类型，变量名和变量序号。其中变量名只是为了帮助我们做识别，在编码时不会写入，仅仅用变量序号作为标识，所以也就有了在更新message时序号不能复用的规则，以及可以安全地添加新成员（没有被识别的会直接跳过）。</p>
<p>在编码中，成员变量是以键值对形式出现的，键有两部分组成：成员序号加上成员类型代码，具体代码如下</p>
<p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/pb2.png"></p>
<p>总共有6种代码，其中group使用的两个代码已被弃用，但是依旧保留。这6个代码需要3位二进制表示，所以键的组成是：字段编号+类型代码（加好表示拼接，并不是运算），示例如下：</p>
<pre class="line-numbers language-none"><code class="language-none">当我们有一个inst32类型的成员a，编号为1，被赋值为150时
由于是int32类型，根据上图采用varint规则，首先对150进行Varints规则编码（过程略）：
    10010110 00000001
由于是int32类型，类型代码为0，编号为1，类型代码采用三位二进制表示为000，二者拼接之后如下：
    0001000
所以a的最终编码为
    0001000 10010110 00000001
改用16进制表示如下
    08 96 01<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="其他类型规则"><a href="#其他类型规则" class="headerlink" title="其他类型规则"></a>其他类型规则</h2><h3 id="sint32-sint64"><a href="#sint32-sint64" class="headerlink" title="sint32, sint64"></a>sint32, sint64</h3><p>对于Varints规则不适用与存储负数，负数最高位为1，造成编码极大的浪费，为了节省空间，引入了ZigZag编码格式，基本思想就是将有符号整数转为无符号整数。转换规则如下：</p>
<pre class="line-numbers language-none"><code class="language-none">(n &lt;&lt; 1) ^ (n &gt;&gt; 31)  #sint32
(n &lt;&lt; 1) ^ (n &gt;&gt; 63)  #sint64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>示例如下：</p>
<p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/pb3.png"></p>
<p>转为无符号的整数后，再用varints编码即可。</p>
<h3 id="64-bit-和-32-bit-类型"><a href="#64-bit-和-32-bit-类型" class="headerlink" title="64-bit 和 32-bit 类型"></a>64-bit 和 32-bit 类型</h3><p>这两种分有不同的类型代码，而且编码时不进行其他转换，直接以64位或32位原始存储（注意也是小端存储），读取时根据类型代码直接读取64位或32位</p>
<h3 id="Strings"><a href="#Strings" class="headerlink" title="Strings"></a>Strings</h3><p>类型代码2表示一类Length-delimited数据。这种编码类型还附带有长度信息，就是在键值之间附加一个用varints编码的长度编码，例子如下：</p>
<pre class="line-numbers language-none"><code class="language-none">我们有一个string类型的变量b，编号为2，赋值为testing
首先testing的utf-8编码如下：
    74 65 73 74 69 6e 67
长度为7，varints格式编码如下：
    00000111
编号加类型代码拼接后如下：
    00010010
最后组合在一起用十六进制表示如下：
    12 07 74 65 73 74 69 6e 67<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>除了表示字符串这种简单信息，还可以表示其他message，如下：</p>
<pre class="line-numbers language-none"><code class="language-none">message Test3 &#123;
  optional Test1 c &#x3D; 3;
&#125;
其中Test1：
message Test1 &#123;
  optional int32 a &#x3D; 1;
&#125;
我们对Test1中a赋值为150，上面已经计算过，最后编码为
    08 96 01
对于Test1类型的变量c表示如下：
首先原始数据就是08 96 01，长度为3，编号为3，类型代码为2，组合起来就是
    1a 03 08 96 01<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="packed"><a href="#packed" class="headerlink" title="packed"></a>packed</h2><p>在proto3中packed为默认的，在proto2中需要手动指定。使用proto3 模式将会使编码更加紧凑（主要针对repeated 类型）。设想，对于一个repeated类型的成员，他们有多个值时，虽然值不同，前键都是相同的，我们可以减少键的数量，如下例：</p>
<pre class="line-numbers language-none"><code class="language-none">假设有一个int32类型的变量d，序号为4，是一个repeated类型，我们赋了4个值，分别是3,270,86942.
使用packed模式后，如下
22 06 03 8E 02 9E A7 05
注意22是编号加类型代码（为2，指packed repeated fields），06表示数据长度
后面实际数据，都是varints编码，但是互有区分<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="顺序"><a href="#顺序" class="headerlink" title="顺序"></a>顺序</h2><p>编解码顺序和字段顺序无关，由键值对保证即可。未知字段会写在已知字段后。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/java/" rel="tag"><i class="fa fa-tag"></i> java</a>
              <a href="/tags/%E7%BC%96%E7%A0%81/" rel="tag"><i class="fa fa-tag"></i> 编码</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/03/20/Playfair%E5%AF%86%E7%A0%81/" rel="prev" title="Playfair密码与实现">
                  <i class="fa fa-chevron-left"></i> Playfair密码与实现
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/03/24/%E5%88%86%E7%BB%84%E5%AF%86%E7%A0%81%E4%B8%AD%E7%9A%84%E7%AE%97%E6%B3%95%E6%A8%A1%E5%BC%8F/" rel="next" title="分组密码中的算法模式">
                  分组密码中的算法模式 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">AmorFati</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">632k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:35</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
