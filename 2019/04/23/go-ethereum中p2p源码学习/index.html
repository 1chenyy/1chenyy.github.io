<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">

<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CConsolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="article">
<meta property="og:title" content="go-ethereum中p2p源码学习">
<meta property="og:url" content="http://example.com/2019/04/23/go-ethereum%E4%B8%ADp2p%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="AmorFati">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/p1.jpg">
<meta property="article:published_time" content="2019-04-23T07:18:56.000Z">
<meta property="article:modified_time" content="2021-11-17T13:54:30.496Z">
<meta property="article:author" content="AmorFati">
<meta property="article:tag" content="区块链">
<meta property="article:tag" content="以太坊">
<meta property="article:tag" content="go">
<meta property="article:tag" content="go-ethereum">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/p1.jpg">


<link rel="canonical" href="http://example.com/2019/04/23/go-ethereum%E4%B8%ADp2p%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2019/04/23/go-ethereum%E4%B8%ADp2p%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/","path":"2019/04/23/go-ethereum中p2p源码学习/","title":"go-ethereum中p2p源码学习"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>go-ethereum中p2p源码学习 | AmorFati</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">AmorFati</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">风吹过窗前的书，又翻过一页</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#server-go"><span class="nav-number">1.</span> <span class="nav-text">server.go</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Start"><span class="nav-number">1.1.</span> <span class="nav-text">Start</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#setupLocalNode"><span class="nav-number">1.2.</span> <span class="nav-text">setupLocalNode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#setupListening"><span class="nav-number">1.3.</span> <span class="nav-text">setupListening</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#setupDiscovery"><span class="nav-number">1.4.</span> <span class="nav-text">setupDiscovery</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#run"><span class="nav-number">1.5.</span> <span class="nav-text">run</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#run-running"><span class="nav-number">1.6.</span> <span class="nav-text">run:running</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#rlpx-go"><span class="nav-number">2.</span> <span class="nav-text">rlpx.go</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#dial-go"><span class="nav-number">3.</span> <span class="nav-text">dial.go</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#newTasks"><span class="nav-number">3.1.</span> <span class="nav-text">newTasks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Do"><span class="nav-number">3.2.</span> <span class="nav-text">Do</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dialTask"><span class="nav-number">3.2.1.</span> <span class="nav-text">dialTask</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#discoverTask"><span class="nav-number">3.2.2.</span> <span class="nav-text">discoverTask</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#waitExpireTask"><span class="nav-number">3.2.3.</span> <span class="nav-text">waitExpireTask</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#addStatic-removeStatic"><span class="nav-number">3.3.</span> <span class="nav-text">addStatic removeStatic</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dial%E6%80%BB%E7%BB%93"><span class="nav-number">3.4.</span> <span class="nav-text">dial总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#peer-go"><span class="nav-number">4.</span> <span class="nav-text">peer.go</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#newPeer"><span class="nav-number">4.1.</span> <span class="nav-text">newPeer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#run-1"><span class="nav-number">4.2.</span> <span class="nav-text">run</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#readLoop"><span class="nav-number">4.3.</span> <span class="nav-text">readLoop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pingLoop"><span class="nav-number">4.4.</span> <span class="nav-text">pingLoop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#startProtocols"><span class="nav-number">4.5.</span> <span class="nav-text">startProtocols</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#run-loop"><span class="nav-number">4.6.</span> <span class="nav-text">run:loop</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="AmorFati"
      src="/assets/img/icon.jpg">
  <p class="site-author-name" itemprop="name">AmorFati</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/1chenyy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;1chenyy" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:henyang4346@foxmail.com" title="E-Mail → mailto:henyang4346@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/52c1bec4559c" title="简书 → https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;52c1bec4559c" rel="noopener" target="_blank"><i class="fa fa-globe fa-fw"></i>简书</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/04/23/go-ethereum%E4%B8%ADp2p%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/icon.jpg">
      <meta itemprop="name" content="AmorFati">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmorFati">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          go-ethereum中p2p源码学习
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-23 15:18:56" itemprop="dateCreated datePublished" datetime="2019-04-23T15:18:56+08:00">2019-04-23</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-11-17 21:54:30" itemprop="dateModified" datetime="2021-11-17T21:54:30+08:00">2021-11-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go-ethereum%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">go-ethereum源码学习</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>26k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>24 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/p1.jpg"></p>
<span id="more"></span>
<p>前一篇<a target="_blank" rel="noopener" href="https://blog.grapefruit.tk/2019/04/15/go-ethereum%E4%B8%ADp2p-discover%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">笔记</a>学习了以太坊p2p网络的发现和维护机制，这篇笔记就来了解一下p2p服务</p>
<h1 id="server-go"><a href="#server-go" class="headerlink" title="server.go"></a>server.go</h1><p>这是P2P服务的主逻辑代码所在处</p>
<h2 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h2><p>服务的启动代码如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	srv<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> srv<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>running <span class="token punctuation">&#123;</span> <span class="token comment">//判断是否启动，避免重复启动</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"server already running"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	srv<span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">true</span> 
	srv<span class="token punctuation">.</span>log <span class="token operator">=</span> srv<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Logger
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>log <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		srv<span class="token punctuation">.</span>log <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>NoDial <span class="token operator">&amp;&amp;</span> srv<span class="token punctuation">.</span>ListenAddr <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span> <span class="token comment">//判断节点是否主动连接其他节点或者监听提起节点</span>
		srv<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"P2P server will be useless, neither dialing nor listening"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// static fields</span>
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>PrivateKey <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"Server.PrivateKey must be set to a non-nil key"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>newTransport <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		srv<span class="token punctuation">.</span>newTransport <span class="token operator">=</span> newRLPX
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>Dialer <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		srv<span class="token punctuation">.</span>Dialer <span class="token operator">=</span> TCPDialer<span class="token punctuation">&#123;</span><span class="token operator">&amp;</span>net<span class="token punctuation">.</span>Dialer<span class="token punctuation">&#123;</span>Timeout<span class="token punctuation">:</span> defaultDialTimeout<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	srv<span class="token punctuation">.</span>quit <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>addpeer <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>conn<span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>delpeer <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> peerDrop<span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>posthandshake <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>conn<span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>addstatic <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>enode<span class="token punctuation">.</span>Node<span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>removestatic <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>enode<span class="token punctuation">.</span>Node<span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>addtrusted <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>enode<span class="token punctuation">.</span>Node<span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>removetrusted <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>enode<span class="token punctuation">.</span>Node<span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>peerOp <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> peerOpFunc<span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>peerOpDone <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">setupLocalNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>ListenAddr <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">setupListening</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">setupDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>

	dynPeers <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">maxDialedConns</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	dialer <span class="token operator">:=</span> <span class="token function">newDialState</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>localnode<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> srv<span class="token punctuation">.</span>StaticNodes<span class="token punctuation">,</span> srv<span class="token punctuation">.</span>BootstrapNodes<span class="token punctuation">,</span> srv<span class="token punctuation">.</span>ntab<span class="token punctuation">,</span> dynPeers<span class="token punctuation">,</span> srv<span class="token punctuation">.</span>NetRestrict<span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>loopWG<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> srv<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>dialer<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先判断是否启动，避免多起启动实例，然后将服务已运行的标志位置true。然后初始化log实例，检查是否要主动连接其他节点，检查私钥是否为空。之后配置rlpx与dial类，稍后再介绍这两个东西。再往下初始化了一系列的channel留作同步用。接着调用了setupLocalNode实现如下</p>
<h2 id="setupLocalNode"><a href="#setupLocalNode" class="headerlink" title="setupLocalNode"></a>setupLocalNode</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">setupLocalNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	pubkey <span class="token operator">:=</span> crypto<span class="token punctuation">.</span><span class="token function">FromECDSAPub</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>srv<span class="token punctuation">.</span>PrivateKey<span class="token punctuation">.</span>PublicKey<span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>ourHandshake <span class="token operator">=</span> <span class="token operator">&amp;</span>protoHandshake<span class="token punctuation">&#123;</span>Version<span class="token punctuation">:</span> baseProtocolVersion<span class="token punctuation">,</span> Name<span class="token punctuation">:</span> srv<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> ID<span class="token punctuation">:</span> pubkey<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> srv<span class="token punctuation">.</span>Protocols <span class="token punctuation">&#123;</span>
		srv<span class="token punctuation">.</span>ourHandshake<span class="token punctuation">.</span>Caps <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>ourHandshake<span class="token punctuation">.</span>Caps<span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token function">cap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	sort<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span><span class="token function">capsByNameAndVersion</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>ourHandshake<span class="token punctuation">.</span>Caps<span class="token punctuation">)</span><span class="token punctuation">)</span>

	db<span class="token punctuation">,</span> err <span class="token operator">:=</span> enode<span class="token punctuation">.</span><span class="token function">OpenDB</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>NodeDatabase<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	srv<span class="token punctuation">.</span>nodedb <span class="token operator">=</span> db
	srv<span class="token punctuation">.</span>localnode <span class="token operator">=</span> enode<span class="token punctuation">.</span><span class="token function">NewLocalNode</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span> srv<span class="token punctuation">.</span>PrivateKey<span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>localnode<span class="token punctuation">.</span><span class="token function">SetFallbackIP</span><span class="token punctuation">(</span>net<span class="token punctuation">.</span>IP<span class="token punctuation">&#123;</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>localnode<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token function">capsByNameAndVersion</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>ourHandshake<span class="token punctuation">.</span>Caps<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> srv<span class="token punctuation">.</span>Protocols <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> e <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>Attributes <span class="token punctuation">&#123;</span>
			srv<span class="token punctuation">.</span>localnode<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">switch</span> srv<span class="token punctuation">.</span>NAT<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
	<span class="token keyword">case</span> nat<span class="token punctuation">.</span>ExtIP<span class="token punctuation">:</span>
		ip<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> srv<span class="token punctuation">.</span>NAT<span class="token punctuation">.</span><span class="token function">ExternalIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		srv<span class="token punctuation">.</span>localnode<span class="token punctuation">.</span><span class="token function">SetStaticIP</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		srv<span class="token punctuation">.</span>loopWG<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">defer</span> srv<span class="token punctuation">.</span>loopWG<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> ip<span class="token punctuation">,</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span>NAT<span class="token punctuation">.</span><span class="token function">ExternalIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				srv<span class="token punctuation">.</span>localnode<span class="token punctuation">.</span><span class="token function">SetStaticIP</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先FromECDSAPub是将公钥以字节数组的形式表示（根据椭圆加密算法，我们知道公钥实际上是一对点坐标，这里我们将这对点用字节数组表示出来），之后构造了握手协议的实例，主要记录了版本号（5）；服务名以及ID（就是公钥）。之后遍历了服务的所有协议，将每个协议的cap添加到握手协议的caps中（cap实际上记录了该协议的版本号及名字）。下面先创建了数据库，并配置给服务。接着调用NewLocalNode创建本地节点，实际上就是实例化了一个LocalNode对象，存储了公钥私钥数据库对象等信息。接下来设置了fallbackIP，Set方法实际上是将对象存储在localnode的entries中，capsByNameAndVersion实现了Entry接口。然后遍历服务中所有协议的所有Attributes（实际上也是一个个Entry数组）存储起来。</p>
<h2 id="setupListening"><a href="#setupListening" class="headerlink" title="setupListening"></a>setupListening</h2><p>配置完localnode后接着调用了setupListening</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">setupListening</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	listener<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> srv<span class="token punctuation">.</span>ListenAddr<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	laddr <span class="token operator">:=</span> listener<span class="token punctuation">.</span><span class="token function">Addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>net<span class="token punctuation">.</span>TCPAddr<span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>ListenAddr <span class="token operator">=</span> laddr<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>listener <span class="token operator">=</span> listener
	srv<span class="token punctuation">.</span>localnode<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>enr<span class="token punctuation">.</span><span class="token function">TCP</span><span class="token punctuation">(</span>laddr<span class="token punctuation">.</span>Port<span class="token punctuation">)</span><span class="token punctuation">)</span>

	srv<span class="token punctuation">.</span>loopWG<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> srv<span class="token punctuation">.</span><span class="token function">listenLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>laddr<span class="token punctuation">.</span>IP<span class="token punctuation">.</span><span class="token function">IsLoopback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> srv<span class="token punctuation">.</span>NAT <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		srv<span class="token punctuation">.</span>loopWG<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			nat<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>NAT<span class="token punctuation">,</span> srv<span class="token punctuation">.</span>quit<span class="token punctuation">,</span> <span class="token string">"tcp"</span><span class="token punctuation">,</span> laddr<span class="token punctuation">.</span>Port<span class="token punctuation">,</span> laddr<span class="token punctuation">.</span>Port<span class="token punctuation">,</span> <span class="token string">"ethereum p2p"</span><span class="token punctuation">)</span>
			srv<span class="token punctuation">.</span>loopWG<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里主要是监听某个tcp端口地址，启动了listenLoop</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">listenLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">defer</span> srv<span class="token punctuation">.</span>loopWG<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"TCP listener up"</span><span class="token punctuation">,</span> <span class="token string">"addr"</span><span class="token punctuation">,</span> srv<span class="token punctuation">.</span>listener<span class="token punctuation">.</span><span class="token function">Addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	tokens <span class="token operator">:=</span> defaultMaxPendingPeers
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>MaxPendingPeers <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		tokens <span class="token operator">=</span> srv<span class="token punctuation">.</span>MaxPendingPeers
	<span class="token punctuation">&#125;</span>
	slots <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> tokens<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tokens<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		slots <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token operator">&lt;-</span>slots

		<span class="token keyword">var</span> <span class="token punctuation">(</span>
			fd  net<span class="token punctuation">.</span>Conn
			err <span class="token builtin">error</span>
		<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
			fd<span class="token punctuation">,</span> err <span class="token operator">=</span> srv<span class="token punctuation">.</span>listener<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> netutil<span class="token punctuation">.</span><span class="token function">IsTemporaryError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				srv<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Temporary read error"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				srv<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Read error"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> srv<span class="token punctuation">.</span>NetRestrict <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> tcp<span class="token punctuation">,</span> ok <span class="token operator">:=</span> fd<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>net<span class="token punctuation">.</span>TCPAddr<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>srv<span class="token punctuation">.</span>NetRestrict<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>tcp<span class="token punctuation">.</span>IP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				srv<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Rejected conn (not whitelisted in NetRestrict)"</span><span class="token punctuation">,</span> <span class="token string">"addr"</span><span class="token punctuation">,</span> fd<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				fd<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				slots <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">var</span> ip net<span class="token punctuation">.</span>IP
		<span class="token keyword">if</span> tcp<span class="token punctuation">,</span> ok <span class="token operator">:=</span> fd<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>net<span class="token punctuation">.</span>TCPAddr<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
			ip <span class="token operator">=</span> tcp<span class="token punctuation">.</span>IP
		<span class="token punctuation">&#125;</span>
		fd <span class="token operator">=</span> <span class="token function">newMeteredConn</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> ip<span class="token punctuation">)</span>
		srv<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Accepted connection"</span><span class="token punctuation">,</span> <span class="token string">"addr"</span><span class="token punctuation">,</span> fd<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			srv<span class="token punctuation">.</span><span class="token function">SetupConn</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> inboundConn<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			slots <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先规定了最大的等待连接数量tokens，然后创建了一个容量与之一样大的channel，在于一个无限循环中中，利用channel机制，启动了tokens个无限循环。每个循环会接收一个连接请求，实际上虽然是无限循环，在获得一个请求后循环便结束了（之所以要用无限循环是要跳过其中的临时性错误）。然后检查白名单，不在名单内的IP都拒绝服务。对于可以服务的连接，单独启动一个goroutine去处理，然后主循环继续，如果连接数未达到最大，则继续等待连接到来。处理连接的方法是SetupConn：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">SetupConn</span><span class="token punctuation">(</span>fd net<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> flags connFlag<span class="token punctuation">,</span> dialDest <span class="token operator">*</span>enode<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	c <span class="token operator">:=</span> <span class="token operator">&amp;</span>conn<span class="token punctuation">&#123;</span>fd<span class="token punctuation">:</span> fd<span class="token punctuation">,</span> transport<span class="token punctuation">:</span> srv<span class="token punctuation">.</span><span class="token function">newTransport</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token punctuation">:</span> flags<span class="token punctuation">,</span> cont<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
	err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">setupConn</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> dialDest<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		c<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		srv<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Setting up connection failed"</span><span class="token punctuation">,</span> <span class="token string">"addr"</span><span class="token punctuation">,</span> fd<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>SetupConn是执行一个握手协议，并尝试把连接创建成一个peer对象。可以看到只是先创建了conn对象，然后调用了setupConn：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">setupConn</span><span class="token punctuation">(</span>c <span class="token operator">*</span>conn<span class="token punctuation">,</span> flags connFlag<span class="token punctuation">,</span> dialDest <span class="token operator">*</span>enode<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	srv<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	running <span class="token operator">:=</span> srv<span class="token punctuation">.</span>running
	srv<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>running <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errServerStopped
	<span class="token punctuation">&#125;</span>
	
	<span class="token keyword">var</span> dialPubkey <span class="token operator">*</span>ecdsa<span class="token punctuation">.</span>PublicKey
	<span class="token keyword">if</span> dialDest <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		dialPubkey <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>ecdsa<span class="token punctuation">.</span>PublicKey<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> dialDest<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>enode<span class="token punctuation">.</span>Secp256k1<span class="token punctuation">)</span><span class="token punctuation">(</span>dialPubkey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"dial destination doesn't have a secp256k1 public key"</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	
	remotePubkey<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">doEncHandshake</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>PrivateKey<span class="token punctuation">,</span> dialPubkey<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		srv<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Failed RLPx handshake"</span><span class="token punctuation">,</span> <span class="token string">"addr"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>fd<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"conn"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>flags<span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> dialDest <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// For dialed connections, check that the remote public key matches.</span>
		<span class="token keyword">if</span> dialPubkey<span class="token punctuation">.</span>X<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>remotePubkey<span class="token punctuation">.</span>X<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> dialPubkey<span class="token punctuation">.</span>Y<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>remotePubkey<span class="token punctuation">.</span>Y<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> DiscUnexpectedIdentity
		<span class="token punctuation">&#125;</span>
		c<span class="token punctuation">.</span>node <span class="token operator">=</span> dialDest
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		c<span class="token punctuation">.</span>node <span class="token operator">=</span> <span class="token function">nodeFromConn</span><span class="token punctuation">(</span>remotePubkey<span class="token punctuation">,</span> c<span class="token punctuation">.</span>fd<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> conn<span class="token punctuation">,</span> ok <span class="token operator">:=</span> c<span class="token punctuation">.</span>fd<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>meteredConn<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
		conn<span class="token punctuation">.</span><span class="token function">handshakeDone</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	clog <span class="token operator">:=</span> srv<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"addr"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>fd<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"conn"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>flags<span class="token punctuation">)</span>
	err <span class="token operator">=</span> srv<span class="token punctuation">.</span><span class="token function">checkpoint</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> srv<span class="token punctuation">.</span>posthandshake<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		clog<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Rejected peer before protocol handshake"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	
	phs<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">doProtoHandshake</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>ourHandshake<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		clog<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Failed proto handshake"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> id <span class="token operator">:=</span> c<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>bytes<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>crypto<span class="token punctuation">.</span><span class="token function">Keccak256</span><span class="token punctuation">(</span>phs<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">,</span> id<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		clog<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Wrong devp2p handshake identity"</span><span class="token punctuation">,</span> <span class="token string">"phsid"</span><span class="token punctuation">,</span> hex<span class="token punctuation">.</span><span class="token function">EncodeToString</span><span class="token punctuation">(</span>phs<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> DiscUnexpectedIdentity
	<span class="token punctuation">&#125;</span>
	c<span class="token punctuation">.</span>caps<span class="token punctuation">,</span> c<span class="token punctuation">.</span>name <span class="token operator">=</span> phs<span class="token punctuation">.</span>Caps<span class="token punctuation">,</span> phs<span class="token punctuation">.</span>Name
	err <span class="token operator">=</span> srv<span class="token punctuation">.</span><span class="token function">checkpoint</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> srv<span class="token punctuation">.</span>addpeer<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		clog<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Rejected peer"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	
	clog<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"connection set up"</span><span class="token punctuation">,</span> <span class="token string">"inbound"</span><span class="token punctuation">,</span> dialDest <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先确保服务正在运行，然后判断远端节点是否为nil（为nil其实是被动连接，不为nil其实是在dial中主动连接），来计算其公钥。当收到一个连接时，这里为nil不执行。然后调用doEncHandshake开始加密握手，这里实际上是调用的rlpx中的方法，稍后再讲。这里最后得到远端的公钥。对于收到一个连接，远端node开始为空，这里调用nodeFromConn创建一个，主要是记录公钥、ip地址及端口号。接着执行checkpoint方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">checkpoint</span><span class="token punctuation">(</span>c <span class="token operator">*</span>conn<span class="token punctuation">,</span> stage <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token operator">*</span>conn<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> stage <span class="token operator">&lt;-</span> c<span class="token punctuation">:</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>srv<span class="token punctuation">.</span>quit<span class="token punctuation">:</span>
		<span class="token keyword">return</span> errServerStopped
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> err <span class="token operator">:=</span> <span class="token operator">&lt;-</span>c<span class="token punctuation">.</span>cont<span class="token punctuation">:</span>
		<span class="token keyword">return</span> err
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>srv<span class="token punctuation">.</span>quit<span class="token punctuation">:</span>
		<span class="token keyword">return</span> errServerStopped
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上就是给posthandshake赋值，然后触发后续逻辑，我们稍后再讲。紧接着又执行了协议握手，调用了doProtoHandshake方法，也是rlpx中方法，传入的参数是ourHandshake，也就是在配置localnode是初始化的，记录了版本号、服务名和自己公钥以及服务中所有协议的摘要。这个方法返回远端的协议信息，之后在conn对象中记录下来远端的服务名和服务中所有协议摘要。同样也通过checkpoint传递给addpeer用来触发后续逻辑。完成后就和远端建立的连接。</p>
<h2 id="setupDiscovery"><a href="#setupDiscovery" class="headerlink" title="setupDiscovery"></a>setupDiscovery</h2><p>刚才我们在分析配置网络监听的代码时顺便看了收到连接时的逻辑。再回到Start中，下面又调用了setupDiscovery;</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">setupDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>NoDiscovery <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>srv<span class="token punctuation">.</span>DiscoveryV5 <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	addr<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">ResolveUDPAddr</span><span class="token punctuation">(</span><span class="token string">"udp"</span><span class="token punctuation">,</span> srv<span class="token punctuation">.</span>ListenAddr<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">ListenUDP</span><span class="token punctuation">(</span><span class="token string">"udp"</span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	realaddr <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">LocalAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>net<span class="token punctuation">.</span>UDPAddr<span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"UDP listener up"</span><span class="token punctuation">,</span> <span class="token string">"addr"</span><span class="token punctuation">,</span> realaddr<span class="token punctuation">)</span>
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>NAT <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>realaddr<span class="token punctuation">.</span>IP<span class="token punctuation">.</span><span class="token function">IsLoopback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">go</span> nat<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>NAT<span class="token punctuation">,</span> srv<span class="token punctuation">.</span>quit<span class="token punctuation">,</span> <span class="token string">"udp"</span><span class="token punctuation">,</span> realaddr<span class="token punctuation">.</span>Port<span class="token punctuation">,</span> realaddr<span class="token punctuation">.</span>Port<span class="token punctuation">,</span> <span class="token string">"ethereum discovery"</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	srv<span class="token punctuation">.</span>localnode<span class="token punctuation">.</span><span class="token function">SetFallbackUDP</span><span class="token punctuation">(</span>realaddr<span class="token punctuation">.</span>Port<span class="token punctuation">)</span>

	
	<span class="token keyword">var</span> unhandled <span class="token keyword">chan</span> discover<span class="token punctuation">.</span>ReadPacket
	<span class="token keyword">var</span> sconn <span class="token operator">*</span>sharedUDPConn
	<span class="token keyword">if</span> <span class="token operator">!</span>srv<span class="token punctuation">.</span>NoDiscovery <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> srv<span class="token punctuation">.</span>DiscoveryV5 <span class="token punctuation">&#123;</span>
			unhandled <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> discover<span class="token punctuation">.</span>ReadPacket<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
			sconn <span class="token operator">=</span> <span class="token operator">&amp;</span>sharedUDPConn<span class="token punctuation">&#123;</span>conn<span class="token punctuation">,</span> unhandled<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		cfg <span class="token operator">:=</span> discover<span class="token punctuation">.</span>Config<span class="token punctuation">&#123;</span>
			PrivateKey<span class="token punctuation">:</span>  srv<span class="token punctuation">.</span>PrivateKey<span class="token punctuation">,</span>
			NetRestrict<span class="token punctuation">:</span> srv<span class="token punctuation">.</span>NetRestrict<span class="token punctuation">,</span>
			Bootnodes<span class="token punctuation">:</span>   srv<span class="token punctuation">.</span>BootstrapNodes<span class="token punctuation">,</span>
			Unhandled<span class="token punctuation">:</span>   unhandled<span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span>
		ntab<span class="token punctuation">,</span> err <span class="token operator">:=</span> discover<span class="token punctuation">.</span><span class="token function">ListenUDP</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> srv<span class="token punctuation">.</span>localnode<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
		srv<span class="token punctuation">.</span>ntab <span class="token operator">=</span> ntab
	<span class="token punctuation">&#125;</span>
	
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>DiscoveryV5 <span class="token punctuation">&#123;</span>
		<span class="token keyword">var</span> ntab <span class="token operator">*</span>discv5<span class="token punctuation">.</span>Network
		<span class="token keyword">var</span> err <span class="token builtin">error</span>
		<span class="token keyword">if</span> sconn <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			ntab<span class="token punctuation">,</span> err <span class="token operator">=</span> discv5<span class="token punctuation">.</span><span class="token function">ListenUDP</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>PrivateKey<span class="token punctuation">,</span> sconn<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> srv<span class="token punctuation">.</span>NetRestrict<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			ntab<span class="token punctuation">,</span> err <span class="token operator">=</span> discv5<span class="token punctuation">.</span><span class="token function">ListenUDP</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>PrivateKey<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> srv<span class="token punctuation">.</span>NetRestrict<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> ntab<span class="token punctuation">.</span><span class="token function">SetFallbackNodes</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>BootstrapNodesV5<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
		srv<span class="token punctuation">.</span>DiscV5 <span class="token operator">=</span> ntab
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里主要就是监听udp连接，配置私钥、白名单、bootstrap节点等，然后调用discover的ListenUDP开始节点发现，后续逻辑详见<a target="_blank" rel="noopener" href="https://blog.grapefruit.tk/2019/04/15/go-ethereum%E4%B8%ADp2p-discover%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">这里</a>。</p>
<h2 id="run"><a href="#run" class="headerlink" title="run"></a>run</h2><p>稍微总结一下，start的逻辑主要是配置：配置localnode，处理tcp连接用于节点通信，处理udp连接用于节点发现。配置完毕后，调用newDialState创建了一个dialstate对象，然后运行run方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">run</span><span class="token punctuation">(</span>dialstate dialer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	srv<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Started P2P networking"</span><span class="token punctuation">,</span> <span class="token string">"self"</span><span class="token punctuation">,</span> srv<span class="token punctuation">.</span>localnode<span class="token punctuation">.</span><span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> srv<span class="token punctuation">.</span>loopWG<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> srv<span class="token punctuation">.</span>nodedb<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		peers        <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>enode<span class="token punctuation">.</span>ID<span class="token punctuation">]</span><span class="token operator">*</span>Peer<span class="token punctuation">)</span>
		inboundCount <span class="token operator">=</span> <span class="token number">0</span>
		trusted      <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>enode<span class="token punctuation">.</span>ID<span class="token punctuation">]</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>TrustedNodes<span class="token punctuation">)</span><span class="token punctuation">)</span>
		taskdone     <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> task<span class="token punctuation">,</span> maxActiveDialTasks<span class="token punctuation">)</span>
		runningTasks <span class="token punctuation">[</span><span class="token punctuation">]</span>task
		queuedTasks  <span class="token punctuation">[</span><span class="token punctuation">]</span>task <span class="token comment">// tasks that can't run yet</span>
	<span class="token punctuation">)</span>
	
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> srv<span class="token punctuation">.</span>TrustedNodes <span class="token punctuation">&#123;</span>
		trusted<span class="token punctuation">[</span>n<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token punctuation">&#125;</span>

	
	delTask <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t task<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> runningTasks <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> runningTasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> t <span class="token punctuation">&#123;</span>
				runningTasks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>runningTasks<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> runningTasks<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	
	startTasks <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ts <span class="token punctuation">[</span><span class="token punctuation">]</span>task<span class="token punctuation">)</span> <span class="token punctuation">(</span>rest <span class="token punctuation">[</span><span class="token punctuation">]</span>task<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		i <span class="token operator">:=</span> <span class="token number">0</span>
		<span class="token keyword">for</span> <span class="token punctuation">;</span> <span class="token function">len</span><span class="token punctuation">(</span>runningTasks<span class="token punctuation">)</span> <span class="token operator">&lt;</span> maxActiveDialTasks <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
			t <span class="token operator">:=</span> ts<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
			srv<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"New dial task"</span><span class="token punctuation">,</span> <span class="token string">"task"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>
			<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> t<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>srv<span class="token punctuation">)</span><span class="token punctuation">;</span> taskdone <span class="token operator">&lt;-</span> t <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			runningTasks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>runningTasks<span class="token punctuation">,</span> t<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> ts<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token punctuation">&#125;</span>
	scheduleTasks <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		queuedTasks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>queuedTasks<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">startTasks</span><span class="token punctuation">(</span>queuedTasks<span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>runningTasks<span class="token punctuation">)</span> <span class="token operator">&lt;</span> maxActiveDialTasks <span class="token punctuation">&#123;</span>
			nt <span class="token operator">:=</span> dialstate<span class="token punctuation">.</span><span class="token function">newTasks</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>runningTasks<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">len</span><span class="token punctuation">(</span>queuedTasks<span class="token punctuation">)</span><span class="token punctuation">,</span> peers<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			queuedTasks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>queuedTasks<span class="token punctuation">,</span> <span class="token function">startTasks</span><span class="token punctuation">(</span>nt<span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

running<span class="token punctuation">:</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token function">scheduleTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">select</span><span class="token punctuation">&#123;</span>
		    <span class="token operator">...</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>run方法主要是处理一些连接的逻辑，首先定义了两个队列runningTasks与queuedTasks，保存正在运行和等待运行的任务。然后定义了三个处理任务的方法。delTask就是删除任务。startTasks就是将任务添加到runningTasks并执行do方法，对于暂时无法运行的任务则返回。scheduleTasks是用来启动任务，他会先尝试启动等待中的任务，然后用newTasks新建一个任务，添加到queuedTasks中。</p>
<p>在接下来的一个无限循环开始，首先启动scheduleTasks，触发一些连接的建立和任务的启动，之后进入select开始阻塞，等待特定的逻辑被触发。</p>
<h2 id="run-running"><a href="#run-running" class="headerlink" title="run:running"></a>run:running</h2><p>回顾刚才的代码流程，在执行完加密握手后，调用了checkpoint，将一个conn对象传给了srv.posthandshake，出发了run中如下逻辑：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> c <span class="token operator">:=</span> <span class="token operator">&lt;-</span>srv<span class="token punctuation">.</span>posthandshake<span class="token punctuation">:</span>
			<span class="token keyword">if</span> trusted<span class="token punctuation">[</span>c<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>
				c<span class="token punctuation">.</span>flags <span class="token operator">|=</span> trustedConn
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">case</span> c<span class="token punctuation">.</span>cont <span class="token operator">&lt;-</span> srv<span class="token punctuation">.</span><span class="token function">encHandshakeChecks</span><span class="token punctuation">(</span>peers<span class="token punctuation">,</span> inboundCount<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>srv<span class="token punctuation">.</span>quit<span class="token punctuation">:</span>
				<span class="token keyword">break</span> running
			<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先检测是否是可信节点，是的话修改flags的值。然后执行encHandshakeChecks方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">encHandshakeChecks</span><span class="token punctuation">(</span>peers <span class="token keyword">map</span><span class="token punctuation">[</span>enode<span class="token punctuation">.</span>ID<span class="token punctuation">]</span><span class="token operator">*</span>Peer<span class="token punctuation">,</span> inboundCount <span class="token builtin">int</span><span class="token punctuation">,</span> c <span class="token operator">*</span>conn<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">switch</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> <span class="token operator">!</span>c<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>trustedConn<span class="token operator">|</span>staticDialedConn<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>peers<span class="token punctuation">)</span> <span class="token operator">>=</span> srv<span class="token punctuation">.</span>MaxPeers<span class="token punctuation">:</span>
		<span class="token keyword">return</span> DiscTooManyPeers
	<span class="token keyword">case</span> <span class="token operator">!</span>c<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>trustedConn<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>inboundConn<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> inboundCount <span class="token operator">>=</span> srv<span class="token punctuation">.</span><span class="token function">maxInboundConns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> DiscTooManyPeers
	<span class="token keyword">case</span> peers<span class="token punctuation">[</span>c<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> DiscAlreadyConnected
	<span class="token keyword">case</span> c<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> srv<span class="token punctuation">.</span>localnode<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> DiscSelf
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>前两个case主要是通过检查conn的flags判断是节点的性质以及连接数，后两个检查是否是自己或者已连接。检查结果赋值给c.cont，这时回到checkpoint中，如果刚才检查无误setupConn流程继续，否则则抛出异常拒绝服务。</p>
<p>再往下，在setupConn中执行完协议握手后，同样调用了checkpoint方法，这次是给srv.addpeer赋值来触发逻辑：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> c <span class="token operator">:=</span> <span class="token operator">&lt;-</span>srv<span class="token punctuation">.</span>addpeer<span class="token punctuation">:</span>
	err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">protoHandshakeChecks</span><span class="token punctuation">(</span>peers<span class="token punctuation">,</span> inboundCount<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		p <span class="token operator">:=</span> <span class="token function">newPeer</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> srv<span class="token punctuation">.</span>Protocols<span class="token punctuation">)</span>
		<span class="token keyword">if</span> srv<span class="token punctuation">.</span>EnableMsgEvents <span class="token punctuation">&#123;</span>
			p<span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token operator">&amp;</span>srv<span class="token punctuation">.</span>peerFeed
		<span class="token punctuation">&#125;</span>
		name <span class="token operator">:=</span> <span class="token function">truncateName</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
		srv<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Adding p2p peer"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token string">"addr"</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>fd<span class="token punctuation">.</span><span class="token function">RemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"peers"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>peers<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> srv<span class="token punctuation">.</span><span class="token function">runPeer</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
		peers<span class="token punctuation">[</span>c<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> p
		<span class="token keyword">if</span> p<span class="token punctuation">.</span><span class="token function">Inbound</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			inboundCount<span class="token operator">++</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> c<span class="token punctuation">.</span>cont <span class="token operator">&lt;-</span> err<span class="token punctuation">:</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>srv<span class="token punctuation">.</span>quit<span class="token punctuation">:</span>
		<span class="token keyword">break</span> running
	<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同样先检查节点，这次调用的是protoHandshakeChecks：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">protoHandshakeChecks</span><span class="token punctuation">(</span>peers <span class="token keyword">map</span><span class="token punctuation">[</span>enode<span class="token punctuation">.</span>ID<span class="token punctuation">]</span><span class="token operator">*</span>Peer<span class="token punctuation">,</span> inboundCount <span class="token builtin">int</span><span class="token punctuation">,</span> c <span class="token operator">*</span>conn<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>Protocols<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">countMatchingProtocols</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>Protocols<span class="token punctuation">,</span> c<span class="token punctuation">.</span>caps<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> DiscUselessPeer
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> srv<span class="token punctuation">.</span><span class="token function">encHandshakeChecks</span><span class="token punctuation">(</span>peers<span class="token punctuation">,</span> inboundCount<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于握手后，我们知道了对方能提供的协议详情，这里进行了匹配检查，如果双方没有能匹配到的协议，则返回DiscUselessPeer，之后和刚才加密握手一样调用encHandshakeChecks进行节点检查。最后如果都没有问题，调用newPeer创建一个新的Peer。这里表示握手通过，连接正式建立。之后进行了后续操作，如将刚才生成的peer记录下来，另外如果是一个接入的连接，则inboundCount自增。同时调用了runPeer方法</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">runPeer</span><span class="token punctuation">(</span>p <span class="token operator">*</span>Peer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>newPeerHook <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		srv<span class="token punctuation">.</span><span class="token function">newPeerHook</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	srv<span class="token punctuation">.</span>peerFeed<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>PeerEvent<span class="token punctuation">&#123;</span>
		Type<span class="token punctuation">:</span> PeerEventTypeAdd<span class="token punctuation">,</span>
		Peer<span class="token punctuation">:</span> p<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	remoteRequested<span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	srv<span class="token punctuation">.</span>peerFeed<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>PeerEvent<span class="token punctuation">&#123;</span>
		Type<span class="token punctuation">:</span>  PeerEventTypeDrop<span class="token punctuation">,</span>
		Peer<span class="token punctuation">:</span>  p<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		Error<span class="token punctuation">:</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	srv<span class="token punctuation">.</span>delpeer <span class="token operator">&lt;-</span> peerDrop<span class="token punctuation">&#123;</span>p<span class="token punctuation">,</span> err<span class="token punctuation">,</span> remoteRequested<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里主要是先广播了peer的建立，然后调用peer的run方法，这里稍后再讲，知道peer连接断开，然后给delpeer赋值触发相应逻辑。由于runPeer是运行在一个单独goroutine中，所以不会阻塞server的run运行，我们回到run中，srv.addpeer对应的逻辑最后有个阻塞，会给c.cont赋值，这时回到setupConn，如果赋值为空表示没有错误，连接正常，则继续setupConn的逻辑。这样一次握手完成。再看peer断开时，srv.delpeer被赋值，触发如下逻辑：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> pd <span class="token operator">:=</span> <span class="token operator">&lt;-</span>srv<span class="token punctuation">.</span>delpeer<span class="token punctuation">:</span>
	d <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">PrettyDuration</span><span class="token punctuation">(</span>mclock<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> pd<span class="token punctuation">.</span>created<span class="token punctuation">)</span>
	pd<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Removing p2p peer"</span><span class="token punctuation">,</span> <span class="token string">"duration"</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token string">"peers"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>peers<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"req"</span><span class="token punctuation">,</span> pd<span class="token punctuation">.</span>requested<span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> pd<span class="token punctuation">.</span>err<span class="token punctuation">)</span>
	<span class="token function">delete</span><span class="token punctuation">(</span>peers<span class="token punctuation">,</span> pd<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> pd<span class="token punctuation">.</span><span class="token function">Inbound</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		inboundCount<span class="token operator">--</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主要的逻辑就是从peers删除对应的peer，然后如果是接入型peer，inboundCount再自减1。</p>
<p>到这里server的主逻辑分析完毕，除了这些，服务还提供了一些方法供外部使用，首先看AddPeer：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">AddPeer</span><span class="token punctuation">(</span>node <span class="token operator">*</span>enode<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> srv<span class="token punctuation">.</span>addstatic <span class="token operator">&lt;-</span> node<span class="token punctuation">:</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>srv<span class="token punctuation">.</span>quit<span class="token punctuation">:</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>也是利用channel模式触发run中的逻辑</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> n <span class="token operator">:=</span> <span class="token operator">&lt;-</span>srv<span class="token punctuation">.</span>addstatic<span class="token punctuation">:</span>
	srv<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Adding static node"</span><span class="token punctuation">,</span> <span class="token string">"node"</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
	dialstate<span class="token punctuation">.</span><span class="token function">addStatic</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>很简单就是将要添加的节点dialstate的static这个map中，key就是节点的ID，值就是一个dialTask。</p>
<p>除此之外还有RemovePeer、AddTrustedPeer、RemoveTrustedPeer等方法，都是利用向一个channel中赋值，来触发run中的逻辑这里不再详细叙述。</p>
<h1 id="rlpx-go"><a href="#rlpx-go" class="headerlink" title="rlpx.go"></a>rlpx.go</h1><p>这是一个较独立的模块，所以拿出来分析了，详见此文：<a target="_blank" rel="noopener" href="https://blog.grapefruit.tk/2019/04/21/go-ethereum%E4%B8%ADp2p-rlpx%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">go-ethereum中p2p-rlpx源码学习</a></p>
<h1 id="dial-go"><a href="#dial-go" class="headerlink" title="dial.go"></a>dial.go</h1><p>dial在p2p中也负责链接的建立，在p2pserver中第一次出现是在start方法内构造了一个TCPDialer对象赋值给Dialer：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>Dialer <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		srv<span class="token punctuation">.</span>Dialer <span class="token operator">=</span> TCPDialer<span class="token punctuation">&#123;</span><span class="token operator">&amp;</span>net<span class="token punctuation">.</span>Dialer<span class="token punctuation">&#123;</span>Timeout<span class="token punctuation">:</span> defaultDialTimeout<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	
<span class="token keyword">type</span> TCPDialer <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	<span class="token operator">*</span>net<span class="token punctuation">.</span>Dialer
<span class="token punctuation">&#125;</span>	

<span class="token keyword">func</span> <span class="token punctuation">(</span>t TCPDialer<span class="token punctuation">)</span> <span class="token function">Dial</span><span class="token punctuation">(</span>dest <span class="token operator">*</span>enode<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token punctuation">(</span>net<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	addr <span class="token operator">:=</span> <span class="token operator">&amp;</span>net<span class="token punctuation">.</span>TCPAddr<span class="token punctuation">&#123;</span>IP<span class="token punctuation">:</span> dest<span class="token punctuation">.</span><span class="token function">IP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Port<span class="token punctuation">:</span> dest<span class="token punctuation">.</span><span class="token function">TCP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> t<span class="token punctuation">.</span>Dialer<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">"tcp"</span><span class="token punctuation">,</span> addr<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>TCPDialer实际上对Dialer进行了封装，然后提供了Dial用于和指定Node建立tcp链接。除此之外还有一个重要的结构体dialstate，它在p2pserver中的start方法最后进行了实例化，并作为参数传递给了run方法，初始化方法如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">newDialState</span><span class="token punctuation">(</span>self enode<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> static <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>enode<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> bootnodes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>enode<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> ntab discoverTable<span class="token punctuation">,</span> maxdyn <span class="token builtin">int</span><span class="token punctuation">,</span> netrestrict <span class="token operator">*</span>netutil<span class="token punctuation">.</span>Netlist<span class="token punctuation">)</span> <span class="token operator">*</span>dialstate <span class="token punctuation">&#123;</span>
	s <span class="token operator">:=</span> <span class="token operator">&amp;</span>dialstate<span class="token punctuation">&#123;</span>
		maxDynDials<span class="token punctuation">:</span> maxdyn<span class="token punctuation">,</span>
		ntab<span class="token punctuation">:</span>        ntab<span class="token punctuation">,</span>
		self<span class="token punctuation">:</span>        self<span class="token punctuation">,</span>
		netrestrict<span class="token punctuation">:</span> netrestrict<span class="token punctuation">,</span>
		static<span class="token punctuation">:</span>      <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>enode<span class="token punctuation">.</span>ID<span class="token punctuation">]</span><span class="token operator">*</span>dialTask<span class="token punctuation">)</span><span class="token punctuation">,</span>
		dialing<span class="token punctuation">:</span>     <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>enode<span class="token punctuation">.</span>ID<span class="token punctuation">]</span>connFlag<span class="token punctuation">)</span><span class="token punctuation">,</span>
		bootnodes<span class="token punctuation">:</span>   <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>enode<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>bootnodes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		randomNodes<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>enode<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> maxdyn<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		hist<span class="token punctuation">:</span>        <span class="token function">new</span><span class="token punctuation">(</span>dialHistory<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>bootnodes<span class="token punctuation">,</span> bootnodes<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> static <span class="token punctuation">&#123;</span>
		s<span class="token punctuation">.</span><span class="token function">addStatic</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> s
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>maxDynDials就是server的maxDialedConns，计算如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">maxDialedConns</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>NoDiscovery <span class="token operator">||</span> srv<span class="token punctuation">.</span>NoDial <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token number">0</span>
	<span class="token punctuation">&#125;</span>
	r <span class="token operator">:=</span> srv<span class="token punctuation">.</span>DialRatio
	<span class="token keyword">if</span> r <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		r <span class="token operator">=</span> defaultDialRatio
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> srv<span class="token punctuation">.</span>MaxPeers <span class="token operator">/</span> r
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>他在节点从不进行发现或进行连接时等于0，否则根据MaxPeers和DialRatio计算。ntab就是discover的table，代表节点发现协议。其他的赋值了信赖节点和boot节点。实例化之后，在run方法中调用了它的下面几个方法：</p>
<h2 id="newTasks"><a href="#newTasks" class="headerlink" title="newTasks"></a>newTasks</h2><p>这是在定义scheduleTasks时调用的</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>dialstate<span class="token punctuation">)</span> <span class="token function">newTasks</span><span class="token punctuation">(</span>nRunning <span class="token builtin">int</span><span class="token punctuation">,</span> peers <span class="token keyword">map</span><span class="token punctuation">[</span>enode<span class="token punctuation">.</span>ID<span class="token punctuation">]</span><span class="token operator">*</span>Peer<span class="token punctuation">,</span> now time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>task <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> s<span class="token punctuation">.</span>start<span class="token punctuation">.</span><span class="token function">IsZero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		s<span class="token punctuation">.</span>start <span class="token operator">=</span> now
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">var</span> newtasks <span class="token punctuation">[</span><span class="token punctuation">]</span>task
	addDial <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>flag connFlag<span class="token punctuation">,</span> n <span class="token operator">*</span>enode<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">checkDial</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> peers<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Skipping dial candidate"</span><span class="token punctuation">,</span> <span class="token string">"id"</span><span class="token punctuation">,</span> n<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"addr"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>net<span class="token punctuation">.</span>TCPAddr<span class="token punctuation">&#123;</span>IP<span class="token punctuation">:</span> n<span class="token punctuation">.</span><span class="token function">IP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Port<span class="token punctuation">:</span> n<span class="token punctuation">.</span><span class="token function">TCP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span>
		<span class="token punctuation">&#125;</span>
		s<span class="token punctuation">.</span>dialing<span class="token punctuation">[</span>n<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> flag
		newtasks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>newtasks<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dialTask<span class="token punctuation">&#123;</span>flags<span class="token punctuation">:</span> flag<span class="token punctuation">,</span> dest<span class="token punctuation">:</span> n<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token punctuation">&#125;</span>

	needDynDials <span class="token operator">:=</span> s<span class="token punctuation">.</span>maxDynDials
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> peers <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> p<span class="token punctuation">.</span>rw<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>dynDialedConn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			needDynDials<span class="token operator">--</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> flag <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>dialing <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> flag<span class="token operator">&amp;</span>dynDialedConn <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			needDynDials<span class="token operator">--</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	s<span class="token punctuation">.</span>hist<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span>

	<span class="token keyword">for</span> id<span class="token punctuation">,</span> t <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>static <span class="token punctuation">&#123;</span>
		err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">checkDial</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>dest<span class="token punctuation">,</span> peers<span class="token punctuation">)</span>
		<span class="token keyword">switch</span> err <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> errNotWhitelisted<span class="token punctuation">,</span> errSelf<span class="token punctuation">:</span>
			log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Removing static dial candidate"</span><span class="token punctuation">,</span> <span class="token string">"id"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>dest<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token string">"addr"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>net<span class="token punctuation">.</span>TCPAddr<span class="token punctuation">&#123;</span>IP<span class="token punctuation">:</span> t<span class="token punctuation">.</span>dest<span class="token punctuation">.</span><span class="token function">IP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Port<span class="token punctuation">:</span> t<span class="token punctuation">.</span>dest<span class="token punctuation">.</span><span class="token function">TCP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>static<span class="token punctuation">,</span> t<span class="token punctuation">.</span>dest<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
			s<span class="token punctuation">.</span>dialing<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">.</span>flags
			newtasks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>newtasks<span class="token punctuation">,</span> t<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>peers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>bootnodes<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> needDynDials <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> now<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>start<span class="token punctuation">)</span> <span class="token operator">></span> fallbackInterval <span class="token punctuation">&#123;</span>
		bootnode <span class="token operator">:=</span> s<span class="token punctuation">.</span>bootnodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
		s<span class="token punctuation">.</span>bootnodes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>bootnodes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>bootnodes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
		s<span class="token punctuation">.</span>bootnodes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>bootnodes<span class="token punctuation">,</span> bootnode<span class="token punctuation">)</span>

		<span class="token keyword">if</span> <span class="token function">addDial</span><span class="token punctuation">(</span>dynDialedConn<span class="token punctuation">,</span> bootnode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			needDynDials<span class="token operator">--</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	randomCandidates <span class="token operator">:=</span> needDynDials <span class="token operator">/</span> <span class="token number">2</span>
	<span class="token keyword">if</span> randomCandidates <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		n <span class="token operator">:=</span> s<span class="token punctuation">.</span>ntab<span class="token punctuation">.</span><span class="token function">ReadRandomNodes</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>randomNodes<span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> randomCandidates <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> <span class="token function">addDial</span><span class="token punctuation">(</span>dynDialedConn<span class="token punctuation">,</span> s<span class="token punctuation">.</span>randomNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				needDynDials<span class="token operator">--</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	i <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>lookupBuf<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> needDynDials <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token function">addDial</span><span class="token punctuation">(</span>dynDialedConn<span class="token punctuation">,</span> s<span class="token punctuation">.</span>lookupBuf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			needDynDials<span class="token operator">--</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	s<span class="token punctuation">.</span>lookupBuf <span class="token operator">=</span> s<span class="token punctuation">.</span>lookupBuf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">copy</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>lookupBuf<span class="token punctuation">,</span> s<span class="token punctuation">.</span>lookupBuf<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>lookupBuf<span class="token punctuation">)</span> <span class="token operator">&lt;</span> needDynDials <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>s<span class="token punctuation">.</span>lookupRunning <span class="token punctuation">&#123;</span>
		s<span class="token punctuation">.</span>lookupRunning <span class="token operator">=</span> <span class="token boolean">true</span>
		newtasks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>newtasks<span class="token punctuation">,</span> <span class="token operator">&amp;</span>discoverTask<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> nRunning <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>newtasks<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span>hist<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		t <span class="token operator">:=</span> <span class="token operator">&amp;</span>waitExpireTask<span class="token punctuation">&#123;</span>s<span class="token punctuation">.</span>hist<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exp<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
		newtasks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>newtasks<span class="token punctuation">,</span> t<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> newtasks
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>他所返回的是一组task对象，task有一个Do方法。开头第一个检查时间的是为了初始化开始时间。然后定义了addDial方法，主要将节点包装成dialTask添加到newtasks中。不过首先对节点进行了检查，主要是检查是否已连接或者正在连接或者非信任节点等。之后计算了需要建立动态连接的数量。</p>
<p>然后遍历所有静态节点，检查每个节点，没有问题的将其暂存到newtasks中。接下来如果已连接数为0，并且已经过了fallbackInterval时间，则寻找一个bootnode进行连接。接下来在randomNodes中添加需要建立动态连接的数量的一半的节点。后面如果还未达到需要建立动态连接的数量要求，则从lookupBuf中挑选。如果数量还不够创建discoverTask添加进去，用于节点发现。最后当什么都不做创建waitExpireTask返回。</p>
<p>这个方法就是添加一系列要执行的任务。</p>
<h2 id="Do"><a href="#Do" class="headerlink" title="Do"></a>Do</h2><p>之后回到p2pserver的run方法中，在startTasks方法内，会启动这一系列任务，通过Do方法，不同的任务有同的Do方法：</p>
<h3 id="dialTask"><a href="#dialTask" class="headerlink" title="dialTask"></a>dialTask</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>dialTask<span class="token punctuation">)</span> <span class="token function">Do</span><span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> t<span class="token punctuation">.</span>dest<span class="token punctuation">.</span><span class="token function">Incomplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>srv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	err <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">dial</span><span class="token punctuation">(</span>srv<span class="token punctuation">,</span> t<span class="token punctuation">.</span>dest<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Dial error"</span><span class="token punctuation">,</span> <span class="token string">"task"</span><span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token comment">// Try resolving the ID of static nodes if dialing failed.</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>dialError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> t<span class="token punctuation">.</span>flags<span class="token operator">&amp;</span>staticDialedConn <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>srv<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				t<span class="token punctuation">.</span><span class="token function">dial</span><span class="token punctuation">(</span>srv<span class="token punctuation">,</span> t<span class="token punctuation">.</span>dest<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Incomplete方法是检查节点是否有IP地址，如果没有则调用resolve方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>dialTask<span class="token punctuation">)</span> <span class="token function">resolve</span><span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>ntab <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Can't resolve node"</span><span class="token punctuation">,</span> <span class="token string">"id"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>dest<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> <span class="token string">"discovery is disabled"</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> t<span class="token punctuation">.</span>resolveDelay <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		t<span class="token punctuation">.</span>resolveDelay <span class="token operator">=</span> initialResolveDelay
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>lastResolved<span class="token punctuation">)</span> <span class="token operator">&lt;</span> t<span class="token punctuation">.</span>resolveDelay <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">&#125;</span>
	resolved <span class="token operator">:=</span> srv<span class="token punctuation">.</span>ntab<span class="token punctuation">.</span><span class="token function">Resolve</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>dest<span class="token punctuation">)</span>
	t<span class="token punctuation">.</span>lastResolved <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> resolved <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		t<span class="token punctuation">.</span>resolveDelay <span class="token operator">*=</span> <span class="token number">2</span>
		<span class="token keyword">if</span> t<span class="token punctuation">.</span>resolveDelay <span class="token operator">></span> maxResolveDelay <span class="token punctuation">&#123;</span>
			t<span class="token punctuation">.</span>resolveDelay <span class="token operator">=</span> maxResolveDelay
		<span class="token punctuation">&#125;</span>
		log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Resolving node failed"</span><span class="token punctuation">,</span> <span class="token string">"id"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>dest<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token string">"newdelay"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>resolveDelay<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">&#125;</span>

	t<span class="token punctuation">.</span>resolveDelay <span class="token operator">=</span> initialResolveDelay
	t<span class="token punctuation">.</span>dest <span class="token operator">=</span> resolved
	log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Resolved node"</span><span class="token punctuation">,</span> <span class="token string">"id"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>dest<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token string">"addr"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>net<span class="token punctuation">.</span>TCPAddr<span class="token punctuation">&#123;</span>IP<span class="token punctuation">:</span> t<span class="token punctuation">.</span>dest<span class="token punctuation">.</span><span class="token function">IP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Port<span class="token punctuation">:</span> t<span class="token punctuation">.</span>dest<span class="token punctuation">.</span><span class="token function">TCP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法是进程查询的，规定最小查询间隔是60秒。调用的是table中的Resolve，具体代码就不贴了，实际上就是先查找k桶，找到目标节点返回或摘到离他较近的节点调用lookup进行查找，所以就是节点查找的过程。如果查不到节点，则将最小查询间隔翻倍。如果查到的话，则更新节点。回到Do中，如果IP地址被补全，则调用dial进行连接，</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>dialTask<span class="token punctuation">)</span> <span class="token function">dial</span><span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">,</span> dest <span class="token operator">*</span>enode<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	fd<span class="token punctuation">,</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span>Dialer<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>dialError<span class="token punctuation">&#123;</span>err<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	mfd <span class="token operator">:=</span> <span class="token function">newMeteredConn</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> dest<span class="token punctuation">.</span><span class="token function">IP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> srv<span class="token punctuation">.</span><span class="token function">SetupConn</span><span class="token punctuation">(</span>mfd<span class="token punctuation">,</span> t<span class="token punctuation">.</span>flags<span class="token punctuation">,</span> dest<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Dialer实际上就是前文的TCPDialer，建立tcp连接后，调用了SetupConn，之后的逻辑前文以及分析过了。</p>
<h3 id="discoverTask"><a href="#discoverTask" class="headerlink" title="discoverTask"></a>discoverTask</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>discoverTask<span class="token punctuation">)</span> <span class="token function">Do</span><span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	next <span class="token operator">:=</span> srv<span class="token punctuation">.</span>lastLookup<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>lookupInterval<span class="token punctuation">)</span>
	<span class="token keyword">if</span> now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> now<span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>next<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	srv<span class="token punctuation">.</span>lastLookup <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span>results <span class="token operator">=</span> srv<span class="token punctuation">.</span>ntab<span class="token punctuation">.</span><span class="token function">LookupRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先也是判断是否在最小间隔内，若是则等待，否则执行disocer的LookupRandom方法进行随机查找</p>
<h3 id="waitExpireTask"><a href="#waitExpireTask" class="headerlink" title="waitExpireTask"></a>waitExpireTask</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t waitExpireTask<span class="token punctuation">)</span> <span class="token function">Do</span><span class="token punctuation">(</span><span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>就是一个定时方法</p>
<h2 id="addStatic-removeStatic"><a href="#addStatic-removeStatic" class="headerlink" title="addStatic removeStatic"></a>addStatic removeStatic</h2><p>这两个方法是提供给p2pserver的run方法中使用的，就是添加或移除节点。</p>
<h2 id="dial总结"><a href="#dial总结" class="headerlink" title="dial总结"></a>dial总结</h2><p>结合p2pserver分析，可知首先封装了一个TCP连接对象给server。然后初始化dialstate进行连接的建立。首先在run的大循环中第一次调用scheduleTasks，此时queuedTasks和queuedTasks都为空，此时添加的任务就是那些静态节点或桶中节点包装的dialTask，以及还有可能的discoverTask和最后的waitExpireTask。然后启动这些任务。对于dialTask，主动和相关节点建立联系；对于discoverTask，执行节点发现逻辑；对于waitExpireTask进行定时方法。</p>
<h1 id="peer-go"><a href="#peer-go" class="headerlink" title="peer.go"></a>peer.go</h1><h2 id="newPeer"><a href="#newPeer" class="headerlink" title="newPeer"></a>newPeer</h2><p>前面介绍了链路建立的准备工作，到这里peer代表一个已经建立好的连接。在p2p服务中，最早出现peer的地方是在节点主动发出或收到一个连接请求，并进行协议握手后，双方检查协议匹配性，检查通过后利用newPeer方法建立了一个peer对象，表示一条稳定的连接：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">newPeer</span><span class="token punctuation">(</span>conn <span class="token operator">*</span>conn<span class="token punctuation">,</span> protocols <span class="token punctuation">[</span><span class="token punctuation">]</span>Protocol<span class="token punctuation">)</span> <span class="token operator">*</span>Peer <span class="token punctuation">&#123;</span>
	protomap <span class="token operator">:=</span> <span class="token function">matchProtocols</span><span class="token punctuation">(</span>protocols<span class="token punctuation">,</span> conn<span class="token punctuation">.</span>caps<span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
	p <span class="token operator">:=</span> <span class="token operator">&amp;</span>Peer<span class="token punctuation">&#123;</span>
		rw<span class="token punctuation">:</span>       conn<span class="token punctuation">,</span>
		running<span class="token punctuation">:</span>  protomap<span class="token punctuation">,</span>
		created<span class="token punctuation">:</span>  mclock<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		disc<span class="token punctuation">:</span>     <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> DiscReason<span class="token punctuation">)</span><span class="token punctuation">,</span>
		protoErr<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>protomap<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// protocols + pingLoop</span>
		closed<span class="token punctuation">:</span>   <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		log<span class="token punctuation">:</span>      log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> conn<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"conn"</span><span class="token punctuation">,</span> conn<span class="token punctuation">.</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> p
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>matchProtocols表示双方都能提供的协议，参数中protocols表示自己能提供的协议，conn.caps表示对方能提供的协议，来看具体实现：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">matchProtocols</span><span class="token punctuation">(</span>protocols <span class="token punctuation">[</span><span class="token punctuation">]</span>Protocol<span class="token punctuation">,</span> caps <span class="token punctuation">[</span><span class="token punctuation">]</span>Cap<span class="token punctuation">,</span> rw MsgReadWriter<span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>protoRW <span class="token punctuation">&#123;</span>
	sort<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span><span class="token function">capsByNameAndVersion</span><span class="token punctuation">(</span>caps<span class="token punctuation">)</span><span class="token punctuation">)</span>
	offset <span class="token operator">:=</span> baseProtocolLength
	result <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>protoRW<span class="token punctuation">)</span>

outer<span class="token punctuation">:</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token builtin">cap</span> <span class="token operator">:=</span> <span class="token keyword">range</span> caps <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> proto <span class="token operator">:=</span> <span class="token keyword">range</span> protocols <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> proto<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token builtin">cap</span><span class="token punctuation">.</span>Name <span class="token operator">&amp;&amp;</span> proto<span class="token punctuation">.</span>Version <span class="token operator">==</span> <span class="token builtin">cap</span><span class="token punctuation">.</span>Version <span class="token punctuation">&#123;</span>
				<span class="token comment">// If an old protocol version matched, revert it</span>
				<span class="token keyword">if</span> old <span class="token operator">:=</span> result<span class="token punctuation">[</span><span class="token builtin">cap</span><span class="token punctuation">.</span>Name<span class="token punctuation">]</span><span class="token punctuation">;</span> old <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					offset <span class="token operator">-=</span> old<span class="token punctuation">.</span>Length
				<span class="token punctuation">&#125;</span>
				<span class="token comment">// Assign the new match</span>
				result<span class="token punctuation">[</span><span class="token builtin">cap</span><span class="token punctuation">.</span>Name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>protoRW<span class="token punctuation">&#123;</span>Protocol<span class="token punctuation">:</span> proto<span class="token punctuation">,</span> offset<span class="token punctuation">:</span> offset<span class="token punctuation">,</span> in<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> Msg<span class="token punctuation">)</span><span class="token punctuation">,</span> w<span class="token punctuation">:</span> rw<span class="token punctuation">&#125;</span>
				offset <span class="token operator">+=</span> proto<span class="token punctuation">.</span>Length

				<span class="token keyword">continue</span> outer
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> result
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>基本就是遍历自己和对方的协议集合，将所有名字和版本号一样的协议封装成protoRW对象并按名字存入result中，最后返回二者都能提供的协议集合。</p>
<h2 id="run-1"><a href="#run-1" class="headerlink" title="run"></a>run</h2><p>回到newPeer中，构建了一个Peer对象并返回。紧接着启动了一个goroutine去调用runPeer，在runPeer中执行了peer的run方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Peer<span class="token punctuation">)</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>remoteRequested <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		writeStart <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		writeErr   <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		readErr    <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		reason     DiscReason <span class="token comment">// sent to the peer</span>
	<span class="token punctuation">)</span>
	p<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> p<span class="token punctuation">.</span><span class="token function">readLoop</span><span class="token punctuation">(</span>readErr<span class="token punctuation">)</span>
	<span class="token keyword">go</span> p<span class="token punctuation">.</span><span class="token function">pingLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	writeStart <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	p<span class="token punctuation">.</span><span class="token function">startProtocols</span><span class="token punctuation">(</span>writeStart<span class="token punctuation">,</span> writeErr<span class="token punctuation">)</span>

loop<span class="token punctuation">:</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> err <span class="token operator">=</span> <span class="token operator">&lt;-</span>writeErr<span class="token punctuation">:</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				reason <span class="token operator">=</span> DiscNetworkError
				<span class="token keyword">break</span> loop
			<span class="token punctuation">&#125;</span>
			writeStart <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
		<span class="token keyword">case</span> err <span class="token operator">=</span> <span class="token operator">&lt;-</span>readErr<span class="token punctuation">:</span>
			<span class="token keyword">if</span> r<span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span>DiscReason<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
				remoteRequested <span class="token operator">=</span> <span class="token boolean">true</span>
				reason <span class="token operator">=</span> r
			<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
				reason <span class="token operator">=</span> DiscNetworkError
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">break</span> loop
		<span class="token keyword">case</span> err <span class="token operator">=</span> <span class="token operator">&lt;-</span>p<span class="token punctuation">.</span>protoErr<span class="token punctuation">:</span>
			reason <span class="token operator">=</span> <span class="token function">discReasonForError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
			<span class="token keyword">break</span> loop
		<span class="token keyword">case</span> err <span class="token operator">=</span> <span class="token operator">&lt;-</span>p<span class="token punctuation">.</span>disc<span class="token punctuation">:</span>
			reason <span class="token operator">=</span> <span class="token function">discReasonForError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
			<span class="token keyword">break</span> loop
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">close</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>closed<span class="token punctuation">)</span>
	p<span class="token punctuation">.</span>rw<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
	p<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> remoteRequested<span class="token punctuation">,</span> err
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="readLoop"><a href="#readLoop" class="headerlink" title="readLoop"></a>readLoop</h2><p>在run方法中，首先在一个独立goroutine中启动了readLoop方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Peer<span class="token punctuation">)</span> <span class="token function">readLoop</span><span class="token punctuation">(</span>errc <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">defer</span> p<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		msg<span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span>rw<span class="token punctuation">.</span><span class="token function">ReadMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			errc <span class="token operator">&lt;-</span> err
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
		msg<span class="token punctuation">.</span>ReceivedAt <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			errc <span class="token operator">&lt;-</span> err
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这就是一个阻塞型的从流中读取信息的方法。rw是conn类型，conn是在开启一个tcp连接后，在SetupConn中将net.Conn包装后的对象。它的ReadMsg实际上就是rlpx的ReadMsg方法，前文已经分析过，返回的是一个Msg对象。之后在readLoop中给mag打上接受的时间戳，然后调用handle处理这个msg</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Peer<span class="token punctuation">)</span> <span class="token function">handle</span><span class="token punctuation">(</span>msg Msg<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">switch</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> msg<span class="token punctuation">.</span>Code <span class="token operator">==</span> pingMsg<span class="token punctuation">:</span>
		msg<span class="token punctuation">.</span><span class="token function">Discard</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token function">SendItems</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>rw<span class="token punctuation">,</span> pongMsg<span class="token punctuation">)</span>
	<span class="token keyword">case</span> msg<span class="token punctuation">.</span>Code <span class="token operator">==</span> discMsg<span class="token punctuation">:</span>
		<span class="token keyword">var</span> reason <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>DiscReason
		rlp<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>Payload<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reason<span class="token punctuation">)</span>
		<span class="token keyword">return</span> reason<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token keyword">case</span> msg<span class="token punctuation">.</span>Code <span class="token operator">&lt;</span> baseProtocolLength<span class="token punctuation">:</span>
		<span class="token keyword">return</span> msg<span class="token punctuation">.</span><span class="token function">Discard</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		proto<span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">getProto</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>Code<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"msg code out of range: %v"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>Code<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> proto<span class="token punctuation">.</span>in <span class="token operator">&lt;-</span> msg<span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>p<span class="token punctuation">.</span>closed<span class="token punctuation">:</span>
			<span class="token keyword">return</span> io<span class="token punctuation">.</span>EOF
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里主要是根据msg.Code决定执行的逻辑。主要是判断是否是ping消息或的断开连接的消息。都不是的话判断code是否满足规范，满足的话根据code取具体的协议getProto：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Peer<span class="token punctuation">)</span> <span class="token function">getProto</span><span class="token punctuation">(</span>code <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>protoRW<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> proto <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>running <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> code <span class="token operator">>=</span> proto<span class="token punctuation">.</span>offset <span class="token operator">&amp;&amp;</span> code <span class="token operator">&lt;</span> proto<span class="token punctuation">.</span>offset<span class="token operator">+</span>proto<span class="token punctuation">.</span>Length <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> proto<span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token function">newPeerError</span><span class="token punctuation">(</span>errInvalidMsgCode<span class="token punctuation">,</span> <span class="token string">"%d"</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里根据code查找具体协议，匹配的方式是根据协议的offset和length，看是否在[offset,offset+length)区间内，然后返回具体协议。找到后将msg赋值给proto.in触发相应逻辑。到这里handle执行完毕，readLoop的一个循环结束，开始下一个循环等待数据到来，这样一次完整的数据读取完成。还有一点需要注意的是handle多次出现了Discard方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>msg Msg<span class="token punctuation">)</span> <span class="token function">Discard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>ioutil<span class="token punctuation">.</span>Discard<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>Payload<span class="token punctuation">)</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">&#125;</span>

<span class="token keyword">var</span> Discard io<span class="token punctuation">.</span>Writer <span class="token operator">=</span> <span class="token function">devNull</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于msg的payload携带的是一个Reader对象，当消息抛弃是也要把read的内容读完，所以这里使用Discard这个虚拟的写对象，这个不执行什么实际操作，但是不会报错，可以安全的丢弃数据。</p>
<h2 id="pingLoop"><a href="#pingLoop" class="headerlink" title="pingLoop"></a>pingLoop</h2><p>再回到run方法中，和readLoop同时启动的还有pingLoop</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Peer<span class="token punctuation">)</span> <span class="token function">pingLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	ping <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTimer</span><span class="token punctuation">(</span>pingInterval<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> p<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> ping<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ping<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">SendItems</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>rw<span class="token punctuation">,</span> pingMsg<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				p<span class="token punctuation">.</span>protoErr <span class="token operator">&lt;-</span> err
				<span class="token keyword">return</span>
			<span class="token punctuation">&#125;</span>
			ping<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>pingInterval<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>p<span class="token punctuation">.</span>closed<span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这相当于是一个心跳包，即使双方没有数据传输，也要每隔一段时间内发送一个ping包看对方是否在线，这里时间间隔是15秒。15秒后执行SendItems方法</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">SendItems</span><span class="token punctuation">(</span>w MsgWriter<span class="token punctuation">,</span> msgcode <span class="token builtin">uint64</span><span class="token punctuation">,</span> elems <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token function">Send</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> msgcode<span class="token punctuation">,</span> elems<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">Send</span><span class="token punctuation">(</span>w MsgWriter<span class="token punctuation">,</span> msgcode <span class="token builtin">uint64</span><span class="token punctuation">,</span> data <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	size<span class="token punctuation">,</span> r<span class="token punctuation">,</span> err <span class="token operator">:=</span> rlp<span class="token punctuation">.</span><span class="token function">EncodeToReader</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> w<span class="token punctuation">.</span><span class="token function">WriteMsg</span><span class="token punctuation">(</span>Msg<span class="token punctuation">&#123;</span>Code<span class="token punctuation">:</span> msgcode<span class="token punctuation">,</span> Size<span class="token punctuation">:</span> <span class="token function">uint32</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">,</span> Payload<span class="token punctuation">:</span> r<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的ping包是一个空包，只有一个pingMsg，最后还用rlpx的WriteMsg发送一个封装好的msg对象。发送后对方接受的逻辑就在上文分析的handle方法，</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> msg<span class="token punctuation">.</span>Code <span class="token operator">==</span> pingMsg<span class="token punctuation">:</span>
	msg<span class="token punctuation">.</span><span class="token function">Discard</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">SendItems</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>rw<span class="token punctuation">,</span> pongMsg<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>可见显示抛弃消息，然后为了避免阻塞发送了pong包，和发送ping包一样。当我们接受到pong包时，由于pongMsg小于baseProtocolLength，所以直接被抛弃。</p>
<h2 id="startProtocols"><a href="#startProtocols" class="headerlink" title="startProtocols"></a>startProtocols</h2><p>再回到run中，由于readLoop和pingLoop都是异步进行了，我们看主线程的逻辑，首先调用了startProtocols</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Peer<span class="token punctuation">)</span> <span class="token function">startProtocols</span><span class="token punctuation">(</span>writeStart <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> writeErr <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	p<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>running<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> proto <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>running <span class="token punctuation">&#123;</span>
		proto <span class="token operator">:=</span> proto
		proto<span class="token punctuation">.</span>closed <span class="token operator">=</span> p<span class="token punctuation">.</span>closed
		proto<span class="token punctuation">.</span>wstart <span class="token operator">=</span> writeStart
		proto<span class="token punctuation">.</span>werr <span class="token operator">=</span> writeErr
		<span class="token keyword">var</span> rw MsgReadWriter <span class="token operator">=</span> proto
		<span class="token keyword">if</span> p<span class="token punctuation">.</span>events <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			rw <span class="token operator">=</span> <span class="token function">newMsgEventer</span><span class="token punctuation">(</span>rw<span class="token punctuation">,</span> p<span class="token punctuation">.</span>events<span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proto<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Starting protocol %s/%d"</span><span class="token punctuation">,</span> proto<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> proto<span class="token punctuation">.</span>Version<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			err <span class="token operator">:=</span> proto<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> rw<span class="token punctuation">)</span>
			<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Protocol %s/%d returned"</span><span class="token punctuation">,</span> proto<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> proto<span class="token punctuation">.</span>Version<span class="token punctuation">)</span><span class="token punctuation">)</span>
				err <span class="token operator">=</span> errProtocolReturned
			<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> err <span class="token operator">!=</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">&#123;</span>
				p<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Protocol %s/%d failed"</span><span class="token punctuation">,</span> proto<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> proto<span class="token punctuation">.</span>Version<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			p<span class="token punctuation">.</span>protoErr <span class="token operator">&lt;-</span> err
			p<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>running就是在newPeer中挑选的匹配上的协议，这里遍历这些协议进行启动操作。由于这里遍历的是Protocol的封装类protoRW，所以先对其几个channel赋值，然后启动一个匿名方法，执行协议的Run方法。</p>
<h2 id="run-loop"><a href="#run-loop" class="headerlink" title="run:loop"></a>run:loop</h2><p>在启动完所有协议后，开启了一个loop，也是一个无限循环，这个主要是处理各种错误的，如读写错误等，对于所有读写错误处理都是直接结束循环，后续触发peer的结束。</p>
<blockquote>
<p>题图来自unsplash：<a target="_blank" rel="noopener" href="https://unsplash.com/photos/gooBgyq17i0">https://unsplash.com/photos/gooBgyq17i0</a></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag"><i class="fa fa-tag"></i> 区块链</a>
              <a href="/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" rel="tag"><i class="fa fa-tag"></i> 以太坊</a>
              <a href="/tags/go/" rel="tag"><i class="fa fa-tag"></i> go</a>
              <a href="/tags/go-ethereum/" rel="tag"><i class="fa fa-tag"></i> go-ethereum</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/04/21/go-ethereum%E4%B8%ADp2p-rlpx%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" rel="prev" title="go-ethereum中p2p-rlpx源码学习">
                  <i class="fa fa-chevron-left"></i> go-ethereum中p2p-rlpx源码学习
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/04/29/go-ethereum%E4%B8%ADeth-ProtocolManager%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" rel="next" title="go-ethereum中eth-ProtocolManager源码学习">
                  go-ethereum中eth-ProtocolManager源码学习 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">AmorFati</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">632k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:35</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
