<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">

<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CConsolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="article">
<meta property="og:title" content="go-ethereum中eth-ProtocolManager源码学习">
<meta property="og:url" content="http://example.com/2019/04/29/go-ethereum%E4%B8%ADeth-ProtocolManager%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="AmorFati">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/pm1.jpg">
<meta property="article:published_time" content="2019-04-29T07:14:58.000Z">
<meta property="article:modified_time" content="2021-11-17T13:54:30.490Z">
<meta property="article:author" content="AmorFati">
<meta property="article:tag" content="区块链">
<meta property="article:tag" content="以太坊">
<meta property="article:tag" content="go">
<meta property="article:tag" content="go-ethereum">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/pm1.jpg">


<link rel="canonical" href="http://example.com/2019/04/29/go-ethereum%E4%B8%ADeth-ProtocolManager%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2019/04/29/go-ethereum%E4%B8%ADeth-ProtocolManager%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/","path":"2019/04/29/go-ethereum中eth-ProtocolManager源码学习/","title":"go-ethereum中eth-ProtocolManager源码学习"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>go-ethereum中eth-ProtocolManager源码学习 | AmorFati</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">AmorFati</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">风吹过窗前的书，又翻过一页</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#NewProtocolManager"><span class="nav-number">1.</span> <span class="nav-text">NewProtocolManager</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#handle"><span class="nav-number">2.</span> <span class="nav-text">handle</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Handshake"><span class="nav-number">2.1.</span> <span class="nav-text">Handshake</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Register-amp-broadcast"><span class="nav-number">2.2.</span> <span class="nav-text">Register &amp; broadcast</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#handleMsg"><span class="nav-number">3.</span> <span class="nav-text">handleMsg</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#GetBlockHeadersMsg"><span class="nav-number">3.1.</span> <span class="nav-text">GetBlockHeadersMsg</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BlockHeadersMsg"><span class="nav-number">3.2.</span> <span class="nav-text">BlockHeadersMsg</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Start"><span class="nav-number">4.</span> <span class="nav-text">Start</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#txBroadcastLoop"><span class="nav-number">4.1.</span> <span class="nav-text">txBroadcastLoop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#minedBroadcastLoop"><span class="nav-number">4.2.</span> <span class="nav-text">minedBroadcastLoop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#syncer"><span class="nav-number">4.3.</span> <span class="nav-text">syncer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#txsyncLoop"><span class="nav-number">4.4.</span> <span class="nav-text">txsyncLoop</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="AmorFati"
      src="/assets/img/icon.jpg">
  <p class="site-author-name" itemprop="name">AmorFati</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/1chenyy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;1chenyy" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:henyang4346@foxmail.com" title="E-Mail → mailto:henyang4346@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/52c1bec4559c" title="简书 → https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;52c1bec4559c" rel="noopener" target="_blank"><i class="fa fa-globe fa-fw"></i>简书</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/04/29/go-ethereum%E4%B8%ADeth-ProtocolManager%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/icon.jpg">
      <meta itemprop="name" content="AmorFati">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmorFati">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          go-ethereum中eth-ProtocolManager源码学习
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-29 15:14:58" itemprop="dateCreated datePublished" datetime="2019-04-29T15:14:58+08:00">2019-04-29</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-11-17 21:54:30" itemprop="dateModified" datetime="2021-11-17T21:54:30+08:00">2021-11-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go-ethereum%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">go-ethereum源码学习</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>24k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>22 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/1/pm1.jpg"></p>
<span id="more"></span>
<h1 id="NewProtocolManager"><a href="#NewProtocolManager" class="headerlink" title="NewProtocolManager"></a>NewProtocolManager</h1><p>在eth的创建过程中初始化了一个protocolManager成员，从名称上看是协议管理者，实际上它是用来管理Ethereum的子协议的，也是上层消息的处理分发的类。由于和上一篇P2P有很大的联系，所以单独拿出来分析一下。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// go-ethereum\eth\handler.go</span>
<span class="token keyword">func</span> <span class="token function">NewProtocolManager</span><span class="token punctuation">(</span>config <span class="token operator">*</span>params<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">,</span> mode downloader<span class="token punctuation">.</span>SyncMode<span class="token punctuation">,</span> networkID <span class="token builtin">uint64</span><span class="token punctuation">,</span> mux <span class="token operator">*</span>event<span class="token punctuation">.</span>TypeMux<span class="token punctuation">,</span> txpool txPool<span class="token punctuation">,</span> engine consensus<span class="token punctuation">.</span>Engine<span class="token punctuation">,</span> blockchain <span class="token operator">*</span>core<span class="token punctuation">.</span>BlockChain<span class="token punctuation">,</span> chaindb ethdb<span class="token punctuation">.</span>Database<span class="token punctuation">,</span> whitelist <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint64</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>ProtocolManager<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	manager <span class="token operator">:=</span> <span class="token operator">&amp;</span>ProtocolManager<span class="token punctuation">&#123;</span>
		networkID<span class="token punctuation">:</span>   networkID<span class="token punctuation">,</span>
		eventMux<span class="token punctuation">:</span>    mux<span class="token punctuation">,</span>
		txpool<span class="token punctuation">:</span>      txpool<span class="token punctuation">,</span>
		blockchain<span class="token punctuation">:</span>  blockchain<span class="token punctuation">,</span>
		chainconfig<span class="token punctuation">:</span> config<span class="token punctuation">,</span>
		peers<span class="token punctuation">:</span>       <span class="token function">newPeerSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		whitelist<span class="token punctuation">:</span>   whitelist<span class="token punctuation">,</span>
		newPeerCh<span class="token punctuation">:</span>   <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>peer<span class="token punctuation">)</span><span class="token punctuation">,</span>
		noMorePeers<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		txsyncCh<span class="token punctuation">:</span>    <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>txsync<span class="token punctuation">)</span><span class="token punctuation">,</span>
		quitSync<span class="token punctuation">:</span>    <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> mode <span class="token operator">==</span> downloader<span class="token punctuation">.</span>FastSync <span class="token operator">&amp;&amp;</span> blockchain<span class="token punctuation">.</span><span class="token function">CurrentBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Blockchain not empty, fast sync disabled"</span><span class="token punctuation">)</span>
		mode <span class="token operator">=</span> downloader<span class="token punctuation">.</span>FullSync
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> mode <span class="token operator">==</span> downloader<span class="token punctuation">.</span>FastSync <span class="token punctuation">&#123;</span>
		manager<span class="token punctuation">.</span>fastSync <span class="token operator">=</span> <span class="token function">uint32</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	manager<span class="token punctuation">.</span>SubProtocols <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>p2p<span class="token punctuation">.</span>Protocol<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>ProtocolVersions<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> version <span class="token operator">:=</span> <span class="token keyword">range</span> ProtocolVersions <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> mode <span class="token operator">==</span> downloader<span class="token punctuation">.</span>FastSync <span class="token operator">&amp;&amp;</span> version <span class="token operator">&lt;</span> eth63 <span class="token punctuation">&#123;</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">&#125;</span>
		version <span class="token operator">:=</span> version 
		manager<span class="token punctuation">.</span>SubProtocols <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>manager<span class="token punctuation">.</span>SubProtocols<span class="token punctuation">,</span> p2p<span class="token punctuation">.</span>Protocol<span class="token punctuation">&#123;</span>
			Name<span class="token punctuation">:</span>    ProtocolName<span class="token punctuation">,</span>
			Version<span class="token punctuation">:</span> version<span class="token punctuation">,</span>
			Length<span class="token punctuation">:</span>  ProtocolLengths<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
			Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>p <span class="token operator">*</span>p2p<span class="token punctuation">.</span>Peer<span class="token punctuation">,</span> rw p2p<span class="token punctuation">.</span>MsgReadWriter<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
				peer <span class="token operator">:=</span> manager<span class="token punctuation">.</span><span class="token function">newPeer</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> rw<span class="token punctuation">)</span>
				<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">case</span> manager<span class="token punctuation">.</span>newPeerCh <span class="token operator">&lt;-</span> peer<span class="token punctuation">:</span>
					manager<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
					<span class="token keyword">defer</span> manager<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token keyword">return</span> manager<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span>
				<span class="token keyword">case</span> <span class="token operator">&lt;-</span>manager<span class="token punctuation">.</span>quitSync<span class="token punctuation">:</span>
					<span class="token keyword">return</span> p2p<span class="token punctuation">.</span>DiscQuitting
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
			NodeInfo<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> manager<span class="token punctuation">.</span><span class="token function">NodeInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
			PeerInfo<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>id enode<span class="token punctuation">.</span>ID<span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> p <span class="token operator">:=</span> manager<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">Peer</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%x"</span><span class="token punctuation">,</span> id<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span>
			<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>manager<span class="token punctuation">.</span>SubProtocols<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errIncompatibleConfig
	<span class="token punctuation">&#125;</span>

	manager<span class="token punctuation">.</span>downloader <span class="token operator">=</span> downloader<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>mode<span class="token punctuation">,</span> chaindb<span class="token punctuation">,</span> manager<span class="token punctuation">.</span>eventMux<span class="token punctuation">,</span> blockchain<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> manager<span class="token punctuation">.</span>removePeer<span class="token punctuation">)</span>

	validator <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>header <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> engine<span class="token punctuation">.</span><span class="token function">VerifyHeader</span><span class="token punctuation">(</span>blockchain<span class="token punctuation">,</span> header<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	heighter <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">uint64</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> blockchain<span class="token punctuation">.</span><span class="token function">CurrentBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	inserter <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>blocks types<span class="token punctuation">.</span>Blocks<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>manager<span class="token punctuation">.</span>fastSync<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Discarded bad propagated block"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> blocks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> blocks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
		atomic<span class="token punctuation">.</span><span class="token function">StoreUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>manager<span class="token punctuation">.</span>acceptTxs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// Mark initial sync done on any fetcher import</span>
		<span class="token keyword">return</span> manager<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">InsertChain</span><span class="token punctuation">(</span>blocks<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	manager<span class="token punctuation">.</span>fetcher <span class="token operator">=</span> fetcher<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>blockchain<span class="token punctuation">.</span>GetBlockByHash<span class="token punctuation">,</span> validator<span class="token punctuation">,</span> manager<span class="token punctuation">.</span>BroadcastBlock<span class="token punctuation">,</span> heighter<span class="token punctuation">,</span> inserter<span class="token punctuation">,</span> manager<span class="token punctuation">.</span>removePeer<span class="token punctuation">)</span>

	<span class="token keyword">return</span> manager<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在初始化对象后，先判断了节点同步方法，如果是FastSync而当前节点又不是0，就改为FullSync，这也就是FastSync模式只在第一次有效的原因。然后配置了manager的同步方式。接下来我们可以看到他所管理的子协议实际上就是p2p协议，这里在pm初始化的同时就创建了一个p2p的Protocol数组SubProtocols。然后遍历ProtocolVersions，这个代表协议版本号。在我当前的版本中支持{eth63, eth62}，关于eth63、eth62及以太坊网络协议的更多说明见<a target="_blank" rel="noopener" href="https://github.com/ethereum/devp2p/blob/master/caps/eth.md">这里</a>。</p>
<p>对于每个版本都向SubProtocols中添加一个Protocol对象，其名字就是eth，ProtocolLengths长度对于eth63而言是17，对于eth62是8；接下来定义一个Run方法，前文在分析p2p-peer时，对于每个peer都会启动所有协议，启动时会在一个独立的goroutine中运行run方法。在run方法中先用newPeer创建了一个peer（p2p-peer的封装）：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pm <span class="token operator">*</span>ProtocolManager<span class="token punctuation">)</span> <span class="token function">newPeer</span><span class="token punctuation">(</span>pv <span class="token builtin">int</span><span class="token punctuation">,</span> p <span class="token operator">*</span>p2p<span class="token punctuation">.</span>Peer<span class="token punctuation">,</span> rw p2p<span class="token punctuation">.</span>MsgReadWriter<span class="token punctuation">)</span> <span class="token operator">*</span>peer <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token function">newPeer</span><span class="token punctuation">(</span>pv<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token function">newMeteredMsgWriter</span><span class="token punctuation">(</span>rw<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// go-ethereum\eth\peer.go</span>
<span class="token keyword">func</span> <span class="token function">newPeer</span><span class="token punctuation">(</span>version <span class="token builtin">int</span><span class="token punctuation">,</span> p <span class="token operator">*</span>p2p<span class="token punctuation">.</span>Peer<span class="token punctuation">,</span> rw p2p<span class="token punctuation">.</span>MsgReadWriter<span class="token punctuation">)</span> <span class="token operator">*</span>peer <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>peer<span class="token punctuation">&#123;</span>
		Peer<span class="token punctuation">:</span>        p<span class="token punctuation">,</span>
		rw<span class="token punctuation">:</span>          rw<span class="token punctuation">,</span>
		version<span class="token punctuation">:</span>     version<span class="token punctuation">,</span>
		id<span class="token punctuation">:</span>          fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%x"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		knownTxs<span class="token punctuation">:</span>    mapset<span class="token punctuation">.</span><span class="token function">NewSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		knownBlocks<span class="token punctuation">:</span> mapset<span class="token punctuation">.</span><span class="token function">NewSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		queuedTxs<span class="token punctuation">:</span>   <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> maxQueuedTxs<span class="token punctuation">)</span><span class="token punctuation">,</span>
		queuedProps<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>propEvent<span class="token punctuation">,</span> maxQueuedProps<span class="token punctuation">)</span><span class="token punctuation">,</span>
		queuedAnns<span class="token punctuation">:</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">,</span> maxQueuedAnns<span class="token punctuation">)</span><span class="token punctuation">,</span>
		term<span class="token punctuation">:</span>        <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="handle"><a href="#handle" class="headerlink" title="handle"></a>handle</h1><p>接着给manager的newPeerCh赋值，执行handle方法,用来处理连接</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pm <span class="token operator">*</span>ProtocolManager<span class="token punctuation">)</span> <span class="token function">handle</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> pm<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> pm<span class="token punctuation">.</span>maxPeers <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>p<span class="token punctuation">.</span>Peer<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Network<span class="token punctuation">.</span>Trusted <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> p2p<span class="token punctuation">.</span>DiscTooManyPeers
	<span class="token punctuation">&#125;</span>
	p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Ethereum peer connected"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		genesis <span class="token operator">=</span> pm<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">Genesis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		head    <span class="token operator">=</span> pm<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">CurrentHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		hash    <span class="token operator">=</span> head<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		number  <span class="token operator">=</span> head<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		td      <span class="token operator">=</span> pm<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">GetTd</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> number<span class="token punctuation">)</span>
	<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">Handshake</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span>networkID<span class="token punctuation">,</span> td<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> genesis<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Ethereum handshake failed"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> rw<span class="token punctuation">,</span> ok <span class="token operator">:=</span> p<span class="token punctuation">.</span>rw<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>meteredMsgReadWriter<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
		rw<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>version<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> pm<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Ethereum peer registration failed"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">defer</span> pm<span class="token punctuation">.</span><span class="token function">removePeer</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> pm<span class="token punctuation">.</span>downloader<span class="token punctuation">.</span><span class="token function">RegisterPeer</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>version<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>

	pm<span class="token punctuation">.</span><span class="token function">syncTransactions</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>

	<span class="token keyword">if</span> daoBlock <span class="token operator">:=</span> pm<span class="token punctuation">.</span>chainconfig<span class="token punctuation">.</span>DAOForkBlock<span class="token punctuation">;</span> daoBlock <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">RequestHeadersByNumber</span><span class="token punctuation">(</span>daoBlock<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>

		p<span class="token punctuation">.</span>forkDrop <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">AfterFunc</span><span class="token punctuation">(</span>daoChallengeTimeout<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Timed out DAO fork-check, dropping"</span><span class="token punctuation">)</span>
			pm<span class="token punctuation">.</span><span class="token function">removePeer</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

		<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> p<span class="token punctuation">.</span>forkDrop <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				p<span class="token punctuation">.</span>forkDrop<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				p<span class="token punctuation">.</span>forkDrop <span class="token operator">=</span> <span class="token boolean">nil</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> number <span class="token operator">:=</span> <span class="token keyword">range</span> pm<span class="token punctuation">.</span>whitelist <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">RequestHeadersByNumber</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> pm<span class="token punctuation">.</span><span class="token function">handleMsg</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Ethereum message handling failed"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Handshake"><a href="#Handshake" class="headerlink" title="Handshake"></a>Handshake</h2><p>首先检测是否超过最大peer数量或者不是信任节点，检测通过的话进行Ethereum握手。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// go-ethereum\eth\peer.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>peer<span class="token punctuation">)</span> <span class="token function">Handshake</span><span class="token punctuation">(</span>network <span class="token builtin">uint64</span><span class="token punctuation">,</span> td <span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> head common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> genesis common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	errc <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> status statusData 

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		errc <span class="token operator">&lt;-</span> p2p<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>rw<span class="token punctuation">,</span> StatusMsg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>statusData<span class="token punctuation">&#123;</span>
			ProtocolVersion<span class="token punctuation">:</span> <span class="token function">uint32</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>version<span class="token punctuation">)</span><span class="token punctuation">,</span>
			NetworkId<span class="token punctuation">:</span>       network<span class="token punctuation">,</span>
			TD<span class="token punctuation">:</span>              td<span class="token punctuation">,</span>
			CurrentBlock<span class="token punctuation">:</span>    head<span class="token punctuation">,</span>
			GenesisBlock<span class="token punctuation">:</span>    genesis<span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		errc <span class="token operator">&lt;-</span> p<span class="token punctuation">.</span><span class="token function">readStatus</span><span class="token punctuation">(</span>network<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> genesis<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	timeout <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTimer</span><span class="token punctuation">(</span>handshakeTimeout<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> timeout<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> err <span class="token operator">:=</span> <span class="token operator">&lt;-</span>errc<span class="token punctuation">:</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">&#125;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>timeout<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
			<span class="token keyword">return</span> p2p<span class="token punctuation">.</span>DiscReadTimeout
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	p<span class="token punctuation">.</span>td<span class="token punctuation">,</span> p<span class="token punctuation">.</span>head <span class="token operator">=</span> status<span class="token punctuation">.</span>TD<span class="token punctuation">,</span> status<span class="token punctuation">.</span>CurrentBlock
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先启动一个goroutine利用Send发送一条初始消息，这里的Send是p2p包中message.go的方法，但是send方法中又调用了参数中的MsgWriter，这里的MsgWriter是在p2p包内peer.go在启动协议时传入的，实际上是protoRW的WriteMsg，但最终实际执行者是rlpx。这里还有一点需要注意的是，在发送时将原来的code加了一个offset，因为eth的协议code是从0开始，如果不加offset，会在读取时被当做基本协议过滤掉（详见p2p的peer源码分析），这个offset最后会在读取时减去恢复出原始的code。</p>
<p>发送的msg的code是StatusMsg，即0。发送的消息有协议版本，网络ID，总难度当前区块和创世区块。之后又启动一个goroutine去读取消息：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>peer<span class="token punctuation">)</span> <span class="token function">readStatus</span><span class="token punctuation">(</span>network <span class="token builtin">uint64</span><span class="token punctuation">,</span> status <span class="token operator">*</span>statusData<span class="token punctuation">,</span> genesis common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	msg<span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span>rw<span class="token punctuation">.</span><span class="token function">ReadMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> msg<span class="token punctuation">.</span>Code <span class="token operator">!=</span> StatusMsg <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">errResp</span><span class="token punctuation">(</span>ErrNoStatusMsg<span class="token punctuation">,</span> <span class="token string">"first msg has code %x (!= %x)"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>Code<span class="token punctuation">,</span> StatusMsg<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> msg<span class="token punctuation">.</span>Size <span class="token operator">></span> ProtocolMaxMsgSize <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">errResp</span><span class="token punctuation">(</span>ErrMsgTooLarge<span class="token punctuation">,</span> <span class="token string">"%v > %v"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>Size<span class="token punctuation">,</span> ProtocolMaxMsgSize<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// Decode the handshake and make sure everything matches</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">errResp</span><span class="token punctuation">(</span>ErrDecode<span class="token punctuation">,</span> <span class="token string">"msg %v: %v"</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> status<span class="token punctuation">.</span>GenesisBlock <span class="token operator">!=</span> genesis <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">errResp</span><span class="token punctuation">(</span>ErrGenesisBlockMismatch<span class="token punctuation">,</span> <span class="token string">"%x (!= %x)"</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span>GenesisBlock<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> genesis<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> status<span class="token punctuation">.</span>NetworkId <span class="token operator">!=</span> network <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">errResp</span><span class="token punctuation">(</span>ErrNetworkIdMismatch<span class="token punctuation">,</span> <span class="token string">"%d (!= %d)"</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span>NetworkId<span class="token punctuation">,</span> network<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token function">int</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>ProtocolVersion<span class="token punctuation">)</span> <span class="token operator">!=</span> p<span class="token punctuation">.</span>version <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">errResp</span><span class="token punctuation">(</span>ErrProtocolVersionMismatch<span class="token punctuation">,</span> <span class="token string">"%d (!= %d)"</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span>ProtocolVersion<span class="token punctuation">,</span> p<span class="token punctuation">.</span>version<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先调用ReadMsg，这个ReadMsg是p2p包内peer.go中protoRW的方法，回顾peer源码分析，对于一个peer当收到一条消息时，如果消息不是基本消息，会给protoRW的in字段赋值，而在ReadMsg会阻塞的从in字段读取msg并返回。回到readStatus中，首先判断code是否是StatusMsg，在判断size大小是否合格。之后调用msg的Decode方法解码，就是rlp解码，最后将数据写入statusData，之后对双方的创世区块、网络ID一届协议版本进行对比，判断是否匹配，不匹配的话返回具体错误。</p>
<p>回到Handshake中，在启动收发数据的goroutine的同时，启动了一个定时器，时间是5s，来判断是否握手超时，在判断超时时也判断了收发是否报错。握手成功后记录对方的总难度和当前区块。有一点需要注意的是，Handshake的这两个收发goroutine是没有先后关系的，因为我们p2p的peer是在主动发送或收到一个请求后经过握手建立的，建立成功后双方各自实例化一个peer对象，然后启动协议，并执行协议的Run方法，这些步骤在双方是独立进行的。</p>
<h2 id="Register-amp-broadcast"><a href="#Register-amp-broadcast" class="headerlink" title="Register &amp; broadcast"></a>Register &amp; broadcast</h2><p>再回到handle中，经过刚才的握手后，如果双方的区块链信息也匹配，则将这个peer注册到ProtocolManager的peers中，这个注册会在结束时被移除。注册方法如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>ps <span class="token operator">*</span>peerSet<span class="token punctuation">)</span> <span class="token function">Register</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	ps<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> ps<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> ps<span class="token punctuation">.</span>closed <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errClosed
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> ps<span class="token punctuation">.</span>peers<span class="token punctuation">[</span>p<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errAlreadyRegistered
	<span class="token punctuation">&#125;</span>
	ps<span class="token punctuation">.</span>peers<span class="token punctuation">[</span>p<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> p
	<span class="token keyword">go</span> p<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主要实现就是将peer添加到pm的peers字段中用来集中管理，并启动了一个goroutine去调用broadcast：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>peer<span class="token punctuation">)</span> <span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> txs <span class="token operator">:=</span> <span class="token operator">&lt;-</span>p<span class="token punctuation">.</span>queuedTxs<span class="token punctuation">:</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">SendTransactions</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">&#125;</span>
			p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Broadcast transactions"</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token keyword">case</span> prop <span class="token operator">:=</span> <span class="token operator">&lt;-</span>p<span class="token punctuation">.</span>queuedProps<span class="token punctuation">:</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">SendNewBlock</span><span class="token punctuation">(</span>prop<span class="token punctuation">.</span>block<span class="token punctuation">,</span> prop<span class="token punctuation">.</span>td<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">&#125;</span>
			p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Propagated block"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> prop<span class="token punctuation">.</span>block<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> prop<span class="token punctuation">.</span>block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"td"</span><span class="token punctuation">,</span> prop<span class="token punctuation">.</span>td<span class="token punctuation">)</span>

		<span class="token keyword">case</span> block <span class="token operator">:=</span> <span class="token operator">&lt;-</span>p<span class="token punctuation">.</span>queuedAnns<span class="token punctuation">:</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">SendNewBlockHashes</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">&#123;</span>block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint64</span><span class="token punctuation">&#123;</span>block<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">&#125;</span>
			p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Announced block"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>p<span class="token punctuation">.</span>term<span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这也是一个无限循环，用于事件处理，具体逻辑稍后介绍。</p>
<p>之后开始同步交易，将自己交易池中等待的交易发送给对方。然后又验证了DAO硬分叉，另外如果有白名单则也去请求，和前面验证DAO一样，都是通过编号去请求头。</p>
<h1 id="handleMsg"><a href="#handleMsg" class="headerlink" title="handleMsg"></a>handleMsg</h1><p>最后来到主循环，调用handleMsg去处理消息：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pm <span class="token operator">*</span>ProtocolManager<span class="token punctuation">)</span> <span class="token function">handleMsg</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// Read the next message from the remote peer, and ensure it's fully consumed</span>
	msg<span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span>rw<span class="token punctuation">.</span><span class="token function">ReadMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> msg<span class="token punctuation">.</span>Size <span class="token operator">></span> ProtocolMaxMsgSize <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">errResp</span><span class="token punctuation">(</span>ErrMsgTooLarge<span class="token punctuation">,</span> <span class="token string">"%v > %v"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>Size<span class="token punctuation">,</span> ProtocolMaxMsgSize<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">defer</span> msg<span class="token punctuation">.</span><span class="token function">Discard</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Handle the message depending on its contents</span>
	<span class="token keyword">switch</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> msg<span class="token punctuation">.</span>Code <span class="token operator">==</span> StatusMsg<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">errResp</span><span class="token punctuation">(</span>ErrExtraStatusMsg<span class="token punctuation">,</span> <span class="token string">"uncontrolled status message"</span><span class="token punctuation">)</span> 
	<span class="token operator">...</span>        
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="GetBlockHeadersMsg"><a href="#GetBlockHeadersMsg" class="headerlink" title="GetBlockHeadersMsg"></a>GetBlockHeadersMsg</h2><p>这一部分代码非常多，由于是p2p通信的上层部分，所以要考虑的情况十分多。我们简单看几个，以刚才验证DAO分叉和请求白名单所用的RequestHeadersByNumber方法为例（其余的会在介绍后续流程时涉及到），首先发送如下请求：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>peer<span class="token punctuation">)</span> <span class="token function">RequestHeadersByNumber</span><span class="token punctuation">(</span>origin <span class="token builtin">uint64</span><span class="token punctuation">,</span> amount <span class="token builtin">int</span><span class="token punctuation">,</span> skip <span class="token builtin">int</span><span class="token punctuation">,</span> reverse <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Fetching batch of headers"</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> amount<span class="token punctuation">,</span> <span class="token string">"fromnum"</span><span class="token punctuation">,</span> origin<span class="token punctuation">,</span> <span class="token string">"skip"</span><span class="token punctuation">,</span> skip<span class="token punctuation">,</span> <span class="token string">"reverse"</span><span class="token punctuation">,</span> reverse<span class="token punctuation">)</span>
	<span class="token keyword">return</span> p2p<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>rw<span class="token punctuation">,</span> GetBlockHeadersMsg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>getBlockHeadersData<span class="token punctuation">&#123;</span>Origin<span class="token punctuation">:</span> hashOrNumber<span class="token punctuation">&#123;</span>Number<span class="token punctuation">:</span> origin<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> Amount<span class="token punctuation">:</span> <span class="token function">uint64</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">,</span> Skip<span class="token punctuation">:</span> <span class="token function">uint64</span><span class="token punctuation">(</span>skip<span class="token punctuation">)</span><span class="token punctuation">,</span> Reverse<span class="token punctuation">:</span> reverse<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>同样是发送一个msg，其code是GetBlockHeadersMsg，在handleMsg中对于逻辑如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> msg<span class="token punctuation">.</span>Code <span class="token operator">==</span> GetBlockHeadersMsg<span class="token punctuation">:</span>
	<span class="token keyword">var</span> query getBlockHeadersData
	<span class="token keyword">if</span> err <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">errResp</span><span class="token punctuation">(</span>ErrDecode<span class="token punctuation">,</span> <span class="token string">"%v: %v"</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	hashMode <span class="token operator">:=</span> query<span class="token punctuation">.</span>Origin<span class="token punctuation">.</span>Hash <span class="token operator">!=</span> <span class="token punctuation">(</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	first <span class="token operator">:=</span> <span class="token boolean">true</span>
	maxNonCanonical <span class="token operator">:=</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		bytes   common<span class="token punctuation">.</span>StorageSize
		headers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header
		unknown <span class="token builtin">bool</span>
	<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token operator">!</span>unknown <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">int</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>Amount<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bytes <span class="token operator">&lt;</span> softResponseLimit <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token operator">&lt;</span> downloader<span class="token punctuation">.</span>MaxHeaderFetch <span class="token punctuation">&#123;</span>
		<span class="token keyword">var</span> origin <span class="token operator">*</span>types<span class="token punctuation">.</span>Header
		<span class="token keyword">if</span> hashMode <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> first <span class="token punctuation">&#123;</span>
				first <span class="token operator">=</span> <span class="token boolean">false</span>
				origin <span class="token operator">=</span> pm<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">GetHeaderByHash</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>Origin<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span>
				<span class="token keyword">if</span> origin <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					query<span class="token punctuation">.</span>Origin<span class="token punctuation">.</span>Number <span class="token operator">=</span> origin<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
				origin <span class="token operator">=</span> pm<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">GetHeader</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>Origin<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> query<span class="token punctuation">.</span>Origin<span class="token punctuation">.</span>Number<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			origin <span class="token operator">=</span> pm<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">GetHeaderByNumber</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>Origin<span class="token punctuation">.</span>Number<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> origin <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
		headers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>headers<span class="token punctuation">,</span> origin<span class="token punctuation">)</span>
		bytes <span class="token operator">+=</span> estHeaderRlpSize

		<span class="token keyword">switch</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> hashMode <span class="token operator">&amp;&amp;</span> query<span class="token punctuation">.</span>Reverse<span class="token punctuation">:</span>
			ancestor <span class="token operator">:=</span> query<span class="token punctuation">.</span>Skip <span class="token operator">+</span> <span class="token number">1</span>
			<span class="token keyword">if</span> ancestor <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				unknown <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
				query<span class="token punctuation">.</span>Origin<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> query<span class="token punctuation">.</span>Origin<span class="token punctuation">.</span>Number <span class="token operator">=</span> pm<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">GetAncestor</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>Origin<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> query<span class="token punctuation">.</span>Origin<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> ancestor<span class="token punctuation">,</span> <span class="token operator">&amp;</span>maxNonCanonical<span class="token punctuation">)</span>
				unknown <span class="token operator">=</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>Origin<span class="token punctuation">.</span>Hash <span class="token operator">==</span> common<span class="token punctuation">.</span>Hash<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token keyword">case</span> hashMode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>query<span class="token punctuation">.</span>Reverse<span class="token punctuation">:</span>
			<span class="token keyword">var</span> <span class="token punctuation">(</span>
				current <span class="token operator">=</span> origin<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				next    <span class="token operator">=</span> current <span class="token operator">+</span> query<span class="token punctuation">.</span>Skip <span class="token operator">+</span> <span class="token number">1</span>
			<span class="token punctuation">)</span>
			<span class="token keyword">if</span> next <span class="token operator">&lt;=</span> current <span class="token punctuation">&#123;</span>
				infos<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">MarshalIndent</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>Peer<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"  "</span><span class="token punctuation">)</span>
				p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"GetBlockHeaders skip overflow attack"</span><span class="token punctuation">,</span> <span class="token string">"current"</span><span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token string">"skip"</span><span class="token punctuation">,</span> query<span class="token punctuation">.</span>Skip<span class="token punctuation">,</span> <span class="token string">"next"</span><span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token string">"attacker"</span><span class="token punctuation">,</span> infos<span class="token punctuation">)</span>
				unknown <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">if</span> header <span class="token operator">:=</span> pm<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">GetHeaderByNumber</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span> header <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					nextHash <span class="token operator">:=</span> header<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					expOldHash<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> pm<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">GetAncestor</span><span class="token punctuation">(</span>nextHash<span class="token punctuation">,</span> next<span class="token punctuation">,</span> query<span class="token punctuation">.</span>Skip<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>maxNonCanonical<span class="token punctuation">)</span>
					<span class="token keyword">if</span> expOldHash <span class="token operator">==</span> query<span class="token punctuation">.</span>Origin<span class="token punctuation">.</span>Hash <span class="token punctuation">&#123;</span>
						query<span class="token punctuation">.</span>Origin<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> query<span class="token punctuation">.</span>Origin<span class="token punctuation">.</span>Number <span class="token operator">=</span> nextHash<span class="token punctuation">,</span> next
					<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
						unknown <span class="token operator">=</span> <span class="token boolean">true</span>
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
					unknown <span class="token operator">=</span> <span class="token boolean">true</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token keyword">case</span> query<span class="token punctuation">.</span>Reverse<span class="token punctuation">:</span>
			<span class="token keyword">if</span> query<span class="token punctuation">.</span>Origin<span class="token punctuation">.</span>Number <span class="token operator">>=</span> query<span class="token punctuation">.</span>Skip<span class="token operator">+</span><span class="token number">1</span> <span class="token punctuation">&#123;</span>
				query<span class="token punctuation">.</span>Origin<span class="token punctuation">.</span>Number <span class="token operator">-=</span> query<span class="token punctuation">.</span>Skip <span class="token operator">+</span> <span class="token number">1</span>
			<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
				unknown <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token punctuation">&#125;</span>

		<span class="token keyword">case</span> <span class="token operator">!</span>query<span class="token punctuation">.</span>Reverse<span class="token punctuation">:</span>
			query<span class="token punctuation">.</span>Origin<span class="token punctuation">.</span>Number <span class="token operator">+=</span> query<span class="token punctuation">.</span>Skip <span class="token operator">+</span> <span class="token number">1</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">SendBlockHeaders</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一步就是解码，得到请求消息getBlockHeadersData，其中包含要查询的某一个区块的编号或hash，查询数量，跳过的数量，是否反向查询等。然后判断查询用的是编号还是hash，之后再一个循环内，根据请求获取头数据，然后放到heads中，最后通过SendBlockHeaders发送数据：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>peer<span class="token punctuation">)</span> <span class="token function">SendBlockHeaders</span><span class="token punctuation">(</span>headers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> p2p<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>rw<span class="token punctuation">,</span> BlockHeadersMsg<span class="token punctuation">,</span> headers<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="BlockHeadersMsg"><a href="#BlockHeadersMsg" class="headerlink" title="BlockHeadersMsg"></a>BlockHeadersMsg</h2><p>可见code是BlockHeadersMsg，回到请求方，对应的逻辑如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> msg<span class="token punctuation">.</span>Code <span class="token operator">==</span> BlockHeadersMsg<span class="token punctuation">:</span>
	<span class="token keyword">var</span> headers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Header
	<span class="token keyword">if</span> err <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">errResp</span><span class="token punctuation">(</span>ErrDecode<span class="token punctuation">,</span> <span class="token string">"msg %v: %v"</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>forkDrop <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// Possibly an empty reply to the fork header checks, sanity check TDs</span>
		verifyDAO <span class="token operator">:=</span> <span class="token boolean">true</span>

		<span class="token keyword">if</span> daoHeader <span class="token operator">:=</span> pm<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">GetHeaderByNumber</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span>chainconfig<span class="token punctuation">.</span>DAOForkBlock<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> daoHeader <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> td <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">Head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> td<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">GetTd</span><span class="token punctuation">(</span>daoHeader<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> daoHeader<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				verifyDAO <span class="token operator">=</span> <span class="token boolean">false</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> verifyDAO <span class="token punctuation">&#123;</span>
			p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Seems to be on the same side of the DAO fork"</span><span class="token punctuation">)</span>
			p<span class="token punctuation">.</span>forkDrop<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			p<span class="token punctuation">.</span>forkDrop <span class="token operator">=</span> <span class="token boolean">nil</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	filter <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>
	<span class="token keyword">if</span> filter <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> p<span class="token punctuation">.</span>forkDrop <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> pm<span class="token punctuation">.</span>chainconfig<span class="token punctuation">.</span>DAOForkBlock<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>headers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Number<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			p<span class="token punctuation">.</span>forkDrop<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			p<span class="token punctuation">.</span>forkDrop <span class="token operator">=</span> <span class="token boolean">nil</span>

			<span class="token keyword">if</span> err <span class="token operator">:=</span> misc<span class="token punctuation">.</span><span class="token function">VerifyDAOHeaderExtraData</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span>chainconfig<span class="token punctuation">,</span> headers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Verified to be on the other side of the DAO fork, dropping"</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">&#125;</span>
			p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Verified to be on the same side of the DAO fork"</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> want<span class="token punctuation">,</span> ok <span class="token operator">:=</span> pm<span class="token punctuation">.</span>whitelist<span class="token punctuation">[</span>headers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> hash <span class="token operator">:=</span> headers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> want <span class="token operator">!=</span> hash <span class="token punctuation">&#123;</span>
				p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Whitelist mismatch, dropping peer"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> headers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">"want"</span><span class="token punctuation">,</span> want<span class="token punctuation">)</span>
				<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"whitelist block mismatch"</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Whitelist block verified"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> headers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> want<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		headers <span class="token operator">=</span> pm<span class="token punctuation">.</span>fetcher<span class="token punctuation">.</span><span class="token function">FilterHeaders</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span>filter <span class="token punctuation">&#123;</span>
		err <span class="token operator">:=</span> pm<span class="token punctuation">.</span>downloader<span class="token punctuation">.</span><span class="token function">DeliverHeaders</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> headers<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Failed to deliver headers"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>到这里也是首先解析返回的数据，首先对于DAO分叉验证，如果收到的heads内容为空，则验证通过，最后如果验证通过则取消刚才请求时的定时器，否则那个定时器到期后会中断连接。接着当heads长度为1是，还是先验证DAO分叉，如果不必验证则是刚才请求的白名单区块，进行验证，主要是进行hash匹配。最后如果heads长度大于1则执行downloader的DeliverHeaders方法。</p>
<p>到这里handle基本分析完了，回到NewProtocolManager中，刚才主要看了定义协议时的Run方法，除了定义Run还定义了NodeInfo和PeerInfo，这两个方法也是共p2p调用的。在添加完要管理的协议后，检查总共协议的数量，如果为0则退出。否则调用downloader.New创建一个Downloader。接着配置了validator方法用来验证头部；heighter方法用来获取区块链高度；inserter 方法用于插入区块，但是如果开启fastSync，则不会使用，最后生成一个fetcher，这是用来汇集各个peer的区块通知。</p>
<h1 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h1><p>这样一个ProtocolManager就创建并初始化完毕，随后随着Ethereum的启动，也会调用ProtocolManager的start方法</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pm <span class="token operator">*</span>ProtocolManager<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>maxPeers <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	pm<span class="token punctuation">.</span>maxPeers <span class="token operator">=</span> maxPeers

	pm<span class="token punctuation">.</span>txsCh <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> core<span class="token punctuation">.</span>NewTxsEvent<span class="token punctuation">,</span> txChanSize<span class="token punctuation">)</span>
	pm<span class="token punctuation">.</span>txsSub <span class="token operator">=</span> pm<span class="token punctuation">.</span>txpool<span class="token punctuation">.</span><span class="token function">SubscribeNewTxsEvent</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span>txsCh<span class="token punctuation">)</span>
	<span class="token keyword">go</span> pm<span class="token punctuation">.</span><span class="token function">txBroadcastLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	pm<span class="token punctuation">.</span>minedBlockSub <span class="token operator">=</span> pm<span class="token punctuation">.</span>eventMux<span class="token punctuation">.</span><span class="token function">Subscribe</span><span class="token punctuation">(</span>core<span class="token punctuation">.</span>NewMinedBlockEvent<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> pm<span class="token punctuation">.</span><span class="token function">minedBroadcastLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> pm<span class="token punctuation">.</span><span class="token function">syncer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> pm<span class="token punctuation">.</span><span class="token function">txsyncLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="txBroadcastLoop"><a href="#txBroadcastLoop" class="headerlink" title="txBroadcastLoop"></a>txBroadcastLoop</h2><p>主要是启动了几个goroutine，分别进行交易的广播，挖矿广播，网络同步和交易同步等。对于交易广播：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pm <span class="token operator">*</span>ProtocolManager<span class="token punctuation">)</span> <span class="token function">txBroadcastLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> event <span class="token operator">:=</span> <span class="token operator">&lt;-</span>pm<span class="token punctuation">.</span>txsCh<span class="token punctuation">:</span>
			pm<span class="token punctuation">.</span><span class="token function">BroadcastTxs</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>Txs<span class="token punctuation">)</span>

		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>pm<span class="token punctuation">.</span>txsSub<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>pm <span class="token operator">*</span>ProtocolManager<span class="token punctuation">)</span> <span class="token function">BroadcastTxs</span><span class="token punctuation">(</span>txs types<span class="token punctuation">.</span>Transactions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> txset <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token operator">*</span>peer<span class="token punctuation">]</span>types<span class="token punctuation">.</span>Transactions<span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> txs <span class="token punctuation">&#123;</span>
		peers <span class="token operator">:=</span> pm<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">PeersWithoutTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> peer <span class="token operator">:=</span> <span class="token keyword">range</span> peers <span class="token punctuation">&#123;</span>
			txset<span class="token punctuation">[</span>peer<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>txset<span class="token punctuation">[</span>peer<span class="token punctuation">]</span><span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Broadcast transaction"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"recipients"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>peers<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> peer<span class="token punctuation">,</span> txs <span class="token operator">:=</span> <span class="token keyword">range</span> txset <span class="token punctuation">&#123;</span>
		peer<span class="token punctuation">.</span><span class="token function">AsyncSendTransactions</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ps <span class="token operator">*</span>peerSet<span class="token punctuation">)</span> <span class="token function">PeersWithoutTx</span><span class="token punctuation">(</span>hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>peer <span class="token punctuation">&#123;</span>
	ps<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> ps<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	list <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>peer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> ps<span class="token punctuation">.</span>peers <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>p<span class="token punctuation">.</span>knownTxs<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			list <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> list
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当收到合法的交易时，变调用BroadcastTxs方法，在BroadcastTxs中，先查询每个peer是否有这个交易（通过判断knownTxs字段，knownTxs的内容实在pm中收到TxMsg消息时添加的，所以存储着对于peer所有的tx信息），找出没有的peer放入txset中，然后调用AsyncSendTransactions发送</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>peer<span class="token punctuation">)</span> <span class="token function">AsyncSendTransactions</span><span class="token punctuation">(</span>txs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> p<span class="token punctuation">.</span>queuedTxs <span class="token operator">&lt;-</span> txs<span class="token punctuation">:</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> txs <span class="token punctuation">&#123;</span>
			p<span class="token punctuation">.</span>knownTxs<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Dropping transaction propagation"</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是一个异步发送方法，首先标记这个peer已有这些tx信息，由于是传值给queuedTxs，所以触发broadcast方法中对于的逻辑，</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> txs <span class="token operator">:=</span> <span class="token operator">&lt;-</span>p<span class="token punctuation">.</span>queuedTxs<span class="token punctuation">:</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">SendTransactions</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
    	<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Broadcast transactions"</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>peer<span class="token punctuation">)</span> <span class="token function">SendTransactions</span><span class="token punctuation">(</span>txs types<span class="token punctuation">.</span>Transactions<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> txs <span class="token punctuation">&#123;</span>
		p<span class="token punctuation">.</span>knownTxs<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> p2p<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>rw<span class="token punctuation">,</span> TxMsg<span class="token punctuation">,</span> txs<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后利用SendTransactions中的Send方法发送，发送的包是TxMsg，顺便看一下接受到该包时的逻辑，还是在handleMsg中：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> msg<span class="token punctuation">.</span>Code <span class="token operator">==</span> TxMsg<span class="token punctuation">:</span>
	<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pm<span class="token punctuation">.</span>acceptTxs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">break</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">var</span> txs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction
	<span class="token keyword">if</span> err <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>txs<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">errResp</span><span class="token punctuation">(</span>ErrDecode<span class="token punctuation">,</span> <span class="token string">"msg %v: %v"</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> txs <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> tx <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token function">errResp</span><span class="token punctuation">(</span>ErrDecode<span class="token punctuation">,</span> <span class="token string">"transaction %d is nil"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		p<span class="token punctuation">.</span><span class="token function">MarkTransaction</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	pm<span class="token punctuation">.</span>txpool<span class="token punctuation">.</span><span class="token function">AddRemotes</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于是pm主要是事件分发，所以主要就是先进行解码，然后标记对应的peer有相关tx，最后交给txpool处理。</p>
<h2 id="minedBroadcastLoop"><a href="#minedBroadcastLoop" class="headerlink" title="minedBroadcastLoop"></a>minedBroadcastLoop</h2><p>start中调用的另外一个方法是minedBroadcastLoop</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pm <span class="token operator">*</span>ProtocolManager<span class="token punctuation">)</span> <span class="token function">minedBroadcastLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> obj <span class="token operator">:=</span> <span class="token keyword">range</span> pm<span class="token punctuation">.</span>minedBlockSub<span class="token punctuation">.</span><span class="token function">Chan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> ev<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span>Data<span class="token punctuation">.</span><span class="token punctuation">(</span>core<span class="token punctuation">.</span>NewMinedBlockEvent<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>
			pm<span class="token punctuation">.</span><span class="token function">BroadcastBlock</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>Block<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>  <span class="token comment">// First propagate block to peers</span>
			pm<span class="token punctuation">.</span><span class="token function">BroadcastBlock</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>Block<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// Only then announce to the rest</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里当收到订阅事件时，调用BroadcastBlock用来广播区块：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pm <span class="token operator">*</span>ProtocolManager<span class="token punctuation">)</span> <span class="token function">BroadcastBlock</span><span class="token punctuation">(</span>block <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">,</span> propagate <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	hash <span class="token operator">:=</span> block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	peers <span class="token operator">:=</span> pm<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">PeersWithoutBlock</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>

	<span class="token keyword">if</span> propagate <span class="token punctuation">&#123;</span>
		<span class="token keyword">var</span> td <span class="token operator">*</span>big<span class="token punctuation">.</span>Int
		<span class="token keyword">if</span> parent <span class="token operator">:=</span> pm<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">GetBlock</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">ParentHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> parent <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			td <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">Difficulty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pm<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">GetTd</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">ParentHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Propagating dangling block"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>

		transferLen <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span><span class="token function">Sqrt</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>peers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> transferLen <span class="token operator">&lt;</span> minBroadcastPeers <span class="token punctuation">&#123;</span>
			transferLen <span class="token operator">=</span> minBroadcastPeers
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> transferLen <span class="token operator">></span> <span class="token function">len</span><span class="token punctuation">(</span>peers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			transferLen <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>peers<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		transfer <span class="token operator">:=</span> peers<span class="token punctuation">[</span><span class="token punctuation">:</span>transferLen<span class="token punctuation">]</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> peer <span class="token operator">:=</span> <span class="token keyword">range</span> transfer <span class="token punctuation">&#123;</span>
			peer<span class="token punctuation">.</span><span class="token function">AsyncSendNewBlock</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> td<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Propagated block"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">"recipients"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>transfer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"duration"</span><span class="token punctuation">,</span> common<span class="token punctuation">.</span><span class="token function">PrettyDuration</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>ReceivedAt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> pm<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">HasBlock</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> peer <span class="token operator">:=</span> <span class="token keyword">range</span> peers <span class="token punctuation">&#123;</span>
			peer<span class="token punctuation">.</span><span class="token function">AsyncSendNewBlockHash</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Announced block"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">"recipients"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>peers<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"duration"</span><span class="token punctuation">,</span> common<span class="token punctuation">.</span><span class="token function">PrettyDuration</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>ReceivedAt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法根据其第二个参数的不同，有两种不同的执行逻辑。首先寻找没有改区块的peer，然后当propagate为true时，先计算含该区块的总难度，然后对部分peer发送区块信息及总难度，如果是false则，在自己拥有该区块的前提下给peers发送区块的hash，二者分别调用了AsyncSendNewBlock和peer.AsyncSendNewBlockHash(block)</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>peer<span class="token punctuation">)</span> <span class="token function">AsyncSendNewBlock</span><span class="token punctuation">(</span>block <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">,</span> td <span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> p<span class="token punctuation">.</span>queuedProps <span class="token operator">&lt;-</span> <span class="token operator">&amp;</span>propEvent<span class="token punctuation">&#123;</span>block<span class="token punctuation">:</span> block<span class="token punctuation">,</span> td<span class="token punctuation">:</span> td<span class="token punctuation">&#125;</span><span class="token punctuation">:</span>
		p<span class="token punctuation">.</span>knownBlocks<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Dropping block propagation"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>peer<span class="token punctuation">)</span> <span class="token function">AsyncSendNewBlockHash</span><span class="token punctuation">(</span>block <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> p<span class="token punctuation">.</span>queuedAnns <span class="token operator">&lt;-</span> block<span class="token punctuation">:</span>
		p<span class="token punctuation">.</span>knownBlocks<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Dropping block announcement"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>AsyncSendNewBlock方法中给queuedProps赋值，然后标记该peer拥有该区块。赋值后触发broadcast中的逻辑：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> prop <span class="token operator">:=</span> <span class="token operator">&lt;-</span>p<span class="token punctuation">.</span>queuedProps<span class="token punctuation">:</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">SendNewBlock</span><span class="token punctuation">(</span>prop<span class="token punctuation">.</span>block<span class="token punctuation">,</span> prop<span class="token punctuation">.</span>td<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Propagated block"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> prop<span class="token punctuation">.</span>block<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> prop<span class="token punctuation">.</span>block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"td"</span><span class="token punctuation">,</span> prop<span class="token punctuation">.</span>td<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>peer<span class="token punctuation">)</span> <span class="token function">SendNewBlock</span><span class="token punctuation">(</span>block <span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">,</span> td <span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	p<span class="token punctuation">.</span>knownBlocks<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> p2p<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>rw<span class="token punctuation">,</span> NewBlockMsg<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span>block<span class="token punctuation">,</span> td<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后调用SendNewBlock利用p2p发送区块信息和总难度，所发的msg是NewBlockMsg。</p>
<p>对于AsyncSendNewBlockHash方法，先给queuedAnns赋值，然后标记该peer知道该区块，之后触发broadcast中的逻辑：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> block <span class="token operator">:=</span> <span class="token operator">&lt;-</span>p<span class="token punctuation">.</span>queuedAnns<span class="token punctuation">:</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">SendNewBlockHashes</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">&#123;</span>block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint64</span><span class="token punctuation">&#123;</span>block<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Announced block"</span><span class="token punctuation">,</span> <span class="token string">"number"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>peer<span class="token punctuation">)</span> <span class="token function">SendNewBlockHashes</span><span class="token punctuation">(</span>hashes <span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> numbers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> hash <span class="token operator">:=</span> <span class="token keyword">range</span> hashes <span class="token punctuation">&#123;</span>
		p<span class="token punctuation">.</span>knownBlocks<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	request <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>newBlockHashesData<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>hashes<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>hashes<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		request<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Hash <span class="token operator">=</span> hashes<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
		request<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Number <span class="token operator">=</span> numbers<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> p2p<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>rw<span class="token punctuation">,</span> NewBlockHashesMsg<span class="token punctuation">,</span> request<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里调用SendNewBlockHashes发送区块hash和编号，发送的msg是NewBlockHashesMsg。</p>
<p>顺便也看一下接受的逻辑，对于NewBlockMsg，还HandleMsg中</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> msg<span class="token punctuation">.</span>Code <span class="token operator">==</span> NewBlockMsg<span class="token punctuation">:</span>
	<span class="token keyword">var</span> request newBlockData
	<span class="token keyword">if</span> err <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">errResp</span><span class="token punctuation">(</span>ErrDecode<span class="token punctuation">,</span> <span class="token string">"%v: %v"</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	request<span class="token punctuation">.</span>Block<span class="token punctuation">.</span>ReceivedAt <span class="token operator">=</span> msg<span class="token punctuation">.</span>ReceivedAt
	request<span class="token punctuation">.</span>Block<span class="token punctuation">.</span>ReceivedFrom <span class="token operator">=</span> p

	p<span class="token punctuation">.</span><span class="token function">MarkBlock</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>Block<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	pm<span class="token punctuation">.</span>fetcher<span class="token punctuation">.</span><span class="token function">Enqueue</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> request<span class="token punctuation">.</span>Block<span class="token punctuation">)</span>

	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		trueHead <span class="token operator">=</span> request<span class="token punctuation">.</span>Block<span class="token punctuation">.</span><span class="token function">ParentHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		trueTD   <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>TD<span class="token punctuation">,</span> request<span class="token punctuation">.</span>Block<span class="token punctuation">.</span><span class="token function">Difficulty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> td <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">Head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> trueTD<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>td<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		p<span class="token punctuation">.</span><span class="token function">SetHead</span><span class="token punctuation">(</span>trueHead<span class="token punctuation">,</span> trueTD<span class="token punctuation">)</span>

		currentBlock <span class="token operator">:=</span> pm<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">CurrentBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> trueTD<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">GetTd</span><span class="token punctuation">(</span>currentBlock<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> currentBlock<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">go</span> pm<span class="token punctuation">.</span><span class="token function">synchronise</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先进行解码，然后取出收到的时间和发送对象，之后标记对应的peer拥有该区块，然后交给fetcher处理。接着计算出对方的总难度减去区块的难度是否大于0，然后更新对应peer的区块链头和总难度，接着计算双方总难度之差，如果对方大于自己，则去同步。</p>
<p>对于另外一个消息NewBlockHashesMsg，逻辑如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">case</span> msg<span class="token punctuation">.</span>Code <span class="token operator">==</span> NewBlockHashesMsg<span class="token punctuation">:</span>
	<span class="token keyword">var</span> announces newBlockHashesData
	<span class="token keyword">if</span> err <span class="token operator">:=</span> msg<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>announces<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token function">errResp</span><span class="token punctuation">(</span>ErrDecode<span class="token punctuation">,</span> <span class="token string">"%v: %v"</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> block <span class="token operator">:=</span> <span class="token keyword">range</span> announces <span class="token punctuation">&#123;</span>
		p<span class="token punctuation">.</span><span class="token function">MarkBlock</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	unknown <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>newBlockHashesData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>announces<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> block <span class="token operator">:=</span> <span class="token keyword">range</span> announces <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>pm<span class="token punctuation">.</span>blockchain<span class="token punctuation">.</span><span class="token function">HasBlock</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> block<span class="token punctuation">.</span>Number<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			unknown <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>unknown<span class="token punctuation">,</span> block<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> block <span class="token operator">:=</span> <span class="token keyword">range</span> unknown <span class="token punctuation">&#123;</span>
		pm<span class="token punctuation">.</span>fetcher<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>id<span class="token punctuation">,</span> block<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> block<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>RequestOneHeader<span class="token punctuation">,</span> p<span class="token punctuation">.</span>RequestBodies<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里也是先解码，然后标记对应的peer有响应的区块，然后统计自由不知道的区块最后交给fetcher处理。</p>
<h2 id="syncer"><a href="#syncer" class="headerlink" title="syncer"></a>syncer</h2><p>start还启动了syncer方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pm <span class="token operator">*</span>ProtocolManager<span class="token punctuation">)</span> <span class="token function">syncer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	pm<span class="token punctuation">.</span>fetcher<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> pm<span class="token punctuation">.</span>fetcher<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> pm<span class="token punctuation">.</span>downloader<span class="token punctuation">.</span><span class="token function">Terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	forceSync <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span>forceSyncCycle<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> forceSync<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>pm<span class="token punctuation">.</span>newPeerCh<span class="token punctuation">:</span>
			<span class="token keyword">if</span> pm<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> minDesiredPeerCount <span class="token punctuation">&#123;</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">go</span> pm<span class="token punctuation">.</span><span class="token function">synchronise</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">BestPeer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>forceSync<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
			<span class="token keyword">go</span> pm<span class="token punctuation">.</span><span class="token function">synchronise</span><span class="token punctuation">(</span>pm<span class="token punctuation">.</span>peers<span class="token punctuation">.</span><span class="token function">BestPeer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>pm<span class="token punctuation">.</span>noMorePeers<span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里首先启动了fetcher，关于fetcher稍后介绍，然后启动了一个定时器每5秒执行一次逻辑。下面是一个阻塞型的事件触发逻辑，其中关于定时器的就是调用synchronise去同步。</p>
<h2 id="txsyncLoop"><a href="#txsyncLoop" class="headerlink" title="txsyncLoop"></a>txsyncLoop</h2><p>start中最后还有一个txsyncLoop：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pm <span class="token operator">*</span>ProtocolManager<span class="token punctuation">)</span> <span class="token function">txsyncLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token operator">...</span><span class="token punctuation">.</span>

	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> s <span class="token operator">:=</span> <span class="token operator">&lt;-</span>pm<span class="token punctuation">.</span>txsyncCh<span class="token punctuation">:</span>
			pending<span class="token punctuation">[</span>s<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> s
			<span class="token keyword">if</span> <span class="token operator">!</span>sending <span class="token punctuation">&#123;</span>
				<span class="token function">send</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token keyword">case</span> err <span class="token operator">:=</span> <span class="token operator">&lt;-</span>done<span class="token punctuation">:</span>
			sending <span class="token operator">=</span> <span class="token boolean">false</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				pack<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Transaction send failed"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token function">delete</span><span class="token punctuation">(</span>pending<span class="token punctuation">,</span> pack<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">if</span> s <span class="token operator">:=</span> <span class="token function">pick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> s <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				<span class="token function">send</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>pm<span class="token punctuation">.</span>quitSync<span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里主要是先定义了两个方法，然后启动了一个循环取处理事件，第一个事件在syncTransactions中发出，它在ProtocolManager的handle中调用，handle在会在每个peer建立后得到调用，所以也就是对新来的连接会执行syncTransactions方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pm <span class="token operator">*</span>ProtocolManager<span class="token punctuation">)</span> <span class="token function">syncTransactions</span><span class="token punctuation">(</span>p <span class="token operator">*</span>peer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> txs types<span class="token punctuation">.</span>Transactions
	pending<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> pm<span class="token punctuation">.</span>txpool<span class="token punctuation">.</span><span class="token function">Pending</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> batch <span class="token operator">:=</span> <span class="token keyword">range</span> pending <span class="token punctuation">&#123;</span>
		txs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>txs<span class="token punctuation">,</span> batch<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> pm<span class="token punctuation">.</span>txsyncCh <span class="token operator">&lt;-</span> <span class="token operator">&amp;</span>txsync<span class="token punctuation">&#123;</span>p<span class="token punctuation">,</span> txs<span class="token punctuation">&#125;</span><span class="token punctuation">:</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>pm<span class="token punctuation">.</span>quitSync<span class="token punctuation">:</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在syncTransactions中，首先获取所有等待中的交易，然后打包传给txsyncCh触发txsyncLoop中的逻辑。主要是调用send方法，就是开始定义的：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">send <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>s <span class="token operator">*</span>txsync<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	size <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">StorageSize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	pack<span class="token punctuation">.</span>p <span class="token operator">=</span> s<span class="token punctuation">.</span>p
	pack<span class="token punctuation">.</span>txs <span class="token operator">=</span> pack<span class="token punctuation">.</span>txs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>txs<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> size <span class="token operator">&lt;</span> txsyncPackSize<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		pack<span class="token punctuation">.</span>txs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>pack<span class="token punctuation">.</span>txs<span class="token punctuation">,</span> s<span class="token punctuation">.</span>txs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
		size <span class="token operator">+=</span> s<span class="token punctuation">.</span>txs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	s<span class="token punctuation">.</span>txs <span class="token operator">=</span> s<span class="token punctuation">.</span>txs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">copy</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>txs<span class="token punctuation">,</span> s<span class="token punctuation">.</span>txs<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>pack<span class="token punctuation">.</span>txs<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>txs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token function">delete</span><span class="token punctuation">(</span>pending<span class="token punctuation">,</span> s<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	s<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Sending batch of transactions"</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>pack<span class="token punctuation">.</span>txs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"bytes"</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span>
	sending <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> done <span class="token operator">&lt;-</span> pack<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">SendTransactions</span><span class="token punctuation">(</span>pack<span class="token punctuation">.</span>txs<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里一次只发送一部分交易信息，要求发送的消息总大小不超过txsyncPackSize。之后如果全都发送的话，把该peer从pending中移除，表示没有消息要发送，然后更新剩余信息。之后启动一个goroutine发送信息，使用的是SendTransactions方法，前文介绍过，并将发送结果传给done，触发txsyncLoop中select另外一个逻辑，这里如果发送无错则先调用pick方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">pick <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>txsync <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>pending<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	n <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>pending<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> s <span class="token operator">:=</span> <span class="token keyword">range</span> pending <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> n<span class="token operator">--</span><span class="token punctuation">;</span> n <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> s
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是从pending中随机选一个等待发送的peer（表示为一个txsync对象，里面含有一个peer和对应的tx），然后调用send方法。直到所有等待的都发送完了（先前一次没有发完的txsync也会在后续被随机选到再次发送），send–pick逻辑结束。</p>
<blockquote>
<p>题图来自unsplash：<a target="_blank" rel="noopener" href="https://unsplash.com/photos/fR9U2S31Exs">https://unsplash.com/photos/fR9U2S31Exs</a></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag"><i class="fa fa-tag"></i> 区块链</a>
              <a href="/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" rel="tag"><i class="fa fa-tag"></i> 以太坊</a>
              <a href="/tags/go/" rel="tag"><i class="fa fa-tag"></i> go</a>
              <a href="/tags/go-ethereum/" rel="tag"><i class="fa fa-tag"></i> go-ethereum</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/04/23/go-ethereum%E4%B8%ADp2p%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" rel="prev" title="go-ethereum中p2p源码学习">
                  <i class="fa fa-chevron-left"></i> go-ethereum中p2p源码学习
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/05/10/go-ethereum%E4%B8%ADeth-Fetcher%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" rel="next" title="go-ethereum中eth-Fetcher源码学习">
                  go-ethereum中eth-Fetcher源码学习 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">AmorFati</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">632k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:35</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
