<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">

<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CConsolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="article">
<meta property="og:title" content="go-ethereum中txpool源码学习">
<meta property="og:url" content="http://example.com/2019/06/08/go-ethereum%E4%B8%ADtxpool%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="AmorFati">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/201906/stefan-kunze-26932-unsplash.jpg">
<meta property="article:published_time" content="2019-06-08T08:00:58.000Z">
<meta property="article:modified_time" content="2021-11-17T13:54:30.497Z">
<meta property="article:author" content="AmorFati">
<meta property="article:tag" content="区块链">
<meta property="article:tag" content="以太坊">
<meta property="article:tag" content="go">
<meta property="article:tag" content="go-ethereum">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/201906/stefan-kunze-26932-unsplash.jpg">


<link rel="canonical" href="http://example.com/2019/06/08/go-ethereum%E4%B8%ADtxpool%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2019/06/08/go-ethereum%E4%B8%ADtxpool%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/","path":"2019/06/08/go-ethereum中txpool源码学习/","title":"go-ethereum中txpool源码学习"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>go-ethereum中txpool源码学习 | AmorFati</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">AmorFati</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">风吹过窗前的书，又翻过一页</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#nonceHeap"><span class="nav-number">1.</span> <span class="nav-text">nonceHeap</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Push"><span class="nav-number">1.1.</span> <span class="nav-text">Push</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pop"><span class="nav-number">1.2.</span> <span class="nav-text">Pop</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#txSortedMap"><span class="nav-number">2.</span> <span class="nav-text">txSortedMap</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Get-amp-Put"><span class="nav-number">2.1.</span> <span class="nav-text">Get &amp; Put</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Forward"><span class="nav-number">2.2.</span> <span class="nav-text">Forward</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Filter"><span class="nav-number">2.3.</span> <span class="nav-text">Filter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cap"><span class="nav-number">2.4.</span> <span class="nav-text">Cap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Remove"><span class="nav-number">2.5.</span> <span class="nav-text">Remove</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ready"><span class="nav-number">2.6.</span> <span class="nav-text">Ready</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Flatten"><span class="nav-number">2.7.</span> <span class="nav-text">Flatten</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#txList"><span class="nav-number">3.</span> <span class="nav-text">txList</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Overlaps"><span class="nav-number">3.1.</span> <span class="nav-text">Overlaps</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Add"><span class="nav-number">3.2.</span> <span class="nav-text">Add</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Forward-1"><span class="nav-number">3.3.</span> <span class="nav-text">Forward</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Filter-1"><span class="nav-number">3.4.</span> <span class="nav-text">Filter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Remove-1"><span class="nav-number">3.5.</span> <span class="nav-text">Remove</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#txLookup"><span class="nav-number">4.</span> <span class="nav-text">txLookup</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Range"><span class="nav-number">4.1.</span> <span class="nav-text">Range</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Get-amp-Add"><span class="nav-number">4.2.</span> <span class="nav-text">Get &amp; Add</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#accountSet"><span class="nav-number">5.</span> <span class="nav-text">accountSet</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#contains"><span class="nav-number">5.1.</span> <span class="nav-text">contains</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#containsTx"><span class="nav-number">5.2.</span> <span class="nav-text">containsTx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#add"><span class="nav-number">5.3.</span> <span class="nav-text">add</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#flatten"><span class="nav-number">5.4.</span> <span class="nav-text">flatten</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#priceHeap"><span class="nav-number">6.</span> <span class="nav-text">priceHeap</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#txPricedList"><span class="nav-number">7.</span> <span class="nav-text">txPricedList</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Put"><span class="nav-number">7.1.</span> <span class="nav-text">Put</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cap-1"><span class="nav-number">7.2.</span> <span class="nav-text">Cap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Underpriced"><span class="nav-number">7.3.</span> <span class="nav-text">Underpriced</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Discard"><span class="nav-number">7.4.</span> <span class="nav-text">Discard</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Removed"><span class="nav-number">7.5.</span> <span class="nav-text">Removed</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#txJournal"><span class="nav-number">8.</span> <span class="nav-text">txJournal</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#load"><span class="nav-number">8.1.</span> <span class="nav-text">load</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#insert"><span class="nav-number">8.2.</span> <span class="nav-text">insert</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rotate"><span class="nav-number">8.3.</span> <span class="nav-text">rotate</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#txSenderCacher"><span class="nav-number">9.</span> <span class="nav-text">txSenderCacher</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#cache"><span class="nav-number">9.1.</span> <span class="nav-text">cache</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#recover"><span class="nav-number">9.2.</span> <span class="nav-text">recover</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#recoverFromBlocks"><span class="nav-number">9.3.</span> <span class="nav-text">recoverFromBlocks</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TxPool"><span class="nav-number">10.</span> <span class="nav-text">TxPool</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E9%80%A0"><span class="nav-number">10.1.</span> <span class="nav-text">构造</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#reset"><span class="nav-number">10.2.</span> <span class="nav-text">reset</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#loop"><span class="nav-number">10.3.</span> <span class="nav-text">loop</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#addTxsLocked"><span class="nav-number">10.4.</span> <span class="nav-text">addTxsLocked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#demoteUnexecutables"><span class="nav-number">10.5.</span> <span class="nav-text">demoteUnexecutables</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#promoteExecutables"><span class="nav-number">10.6.</span> <span class="nav-text">promoteExecutables</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#add-1"><span class="nav-number">10.7.</span> <span class="nav-text">add</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#validateTx"><span class="nav-number">10.8.</span> <span class="nav-text">validateTx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#removeTx"><span class="nav-number">10.9.</span> <span class="nav-text">removeTx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#enqueueTx"><span class="nav-number">10.10.</span> <span class="nav-text">enqueueTx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#journalTx"><span class="nav-number">10.11.</span> <span class="nav-text">journalTx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#promoteTx"><span class="nav-number">10.12.</span> <span class="nav-text">promoteTx</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="AmorFati"
      src="/assets/img/icon.jpg">
  <p class="site-author-name" itemprop="name">AmorFati</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/1chenyy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;1chenyy" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:henyang4346@foxmail.com" title="E-Mail → mailto:henyang4346@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/52c1bec4559c" title="简书 → https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;52c1bec4559c" rel="noopener" target="_blank"><i class="fa fa-globe fa-fw"></i>简书</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/06/08/go-ethereum%E4%B8%ADtxpool%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/img/icon.jpg">
      <meta itemprop="name" content="AmorFati">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmorFati">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          go-ethereum中txpool源码学习
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-08 16:00:58" itemprop="dateCreated datePublished" datetime="2019-06-08T16:00:58+08:00">2019-06-08</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-11-17 21:54:30" itemprop="dateModified" datetime="2021-11-17T21:54:30+08:00">2021-11-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/go-ethereum%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">go-ethereum源码学习</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>36k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>32 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p><img src="https://raw.githubusercontent.com/chenyaoyang/blog-pic/master/201906/stefan-kunze-26932-unsplash.jpg"></p>
<span id="more"></span>
<p>TxPool有许多辅助的数据类型，不先介绍一下将会很难理解txpool的实现，这里先介绍与之先关的数据类型</p>
<h1 id="nonceHeap"><a href="#nonceHeap" class="headerlink" title="nonceHeap"></a>nonceHeap</h1><p>这是一个uint64数组类型，他实现的是heap接口(container/heap)，heap又实现了sort接口，这是一个最小堆。</p>
<h2 id="Push"><a href="#Push" class="headerlink" title="Push"></a>Push</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>nonceHeap<span class="token punctuation">)</span> <span class="token function">Push</span><span class="token punctuation">(</span>x <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token operator">*</span>h <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token operator">*</span>h<span class="token punctuation">,</span> x<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">uint64</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>就是简单的把一个uint64类型数据放入数组末尾</p>
<h2 id="Pop"><a href="#Pop" class="headerlink" title="Pop"></a>Pop</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>nonceHeap<span class="token punctuation">)</span> <span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>
	old <span class="token operator">:=</span> <span class="token operator">*</span>h
	n <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span>
	x <span class="token operator">:=</span> old<span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token operator">*</span>h <span class="token operator">=</span> old<span class="token punctuation">[</span><span class="token number">0</span> <span class="token punctuation">:</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token keyword">return</span> x
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从末尾弹出一个数据</p>
<h1 id="txSortedMap"><a href="#txSortedMap" class="headerlink" title="txSortedMap"></a>txSortedMap</h1><p>这是一个nonce到交易的映射</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> txSortedMap <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	items <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint64</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction 
	index <span class="token operator">*</span>nonceHeap                    
	cache types<span class="token punctuation">.</span>Transactions           
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>他有一个map类型成员，键是uint64位数据。即nonce，值就是一个个交易。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">newTxSortedMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>txSortedMap <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>txSortedMap<span class="token punctuation">&#123;</span>
		items<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">uint64</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span><span class="token punctuation">,</span>
		index<span class="token punctuation">:</span> <span class="token function">new</span><span class="token punctuation">(</span>nonceHeap<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>构造方法就是初始化两个成员变量</p>
<h2 id="Get-amp-Put"><a href="#Get-amp-Put" class="headerlink" title="Get &amp; Put"></a>Get &amp; Put</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>txSortedMap<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>nonce <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> m<span class="token punctuation">.</span>items<span class="token punctuation">[</span>nonce<span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>txSortedMap<span class="token punctuation">)</span> <span class="token function">Put</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	nonce <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> m<span class="token punctuation">.</span>items<span class="token punctuation">[</span>nonce<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		heap<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>index<span class="token punctuation">,</span> nonce<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	m<span class="token punctuation">.</span>items<span class="token punctuation">[</span>nonce<span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>cache <span class="token operator">=</span> tx<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>get方法就是按照nonce取值，put方法就是将交易按期nonce值存储。</p>
<h2 id="Forward"><a href="#Forward" class="headerlink" title="Forward"></a>Forward</h2><p>这个方法用来删除存储的所有nonce小于threshold的交易</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>txSortedMap<span class="token punctuation">)</span> <span class="token function">Forward</span><span class="token punctuation">(</span>threshold <span class="token builtin">uint64</span><span class="token punctuation">)</span> types<span class="token punctuation">.</span>Transactions <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> removed types<span class="token punctuation">.</span>Transactions

	<span class="token keyword">for</span> m<span class="token punctuation">.</span>index<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> threshold <span class="token punctuation">&#123;</span>
		nonce <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">uint64</span><span class="token punctuation">)</span>
		removed <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>removed<span class="token punctuation">,</span> m<span class="token punctuation">.</span>items<span class="token punctuation">[</span>nonce<span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token function">delete</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>items<span class="token punctuation">,</span> nonce<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> m<span class="token punctuation">.</span>cache <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		m<span class="token punctuation">.</span>cache <span class="token operator">=</span> m<span class="token punctuation">.</span>cache<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>removed<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> removed
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，由于index是一个nonceHeap类型数据，他从小到大排序，所有每次取第一个也就是最小值，进行判断并删除。</p>
<h2 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h2><p>过滤并删除功能</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>txSortedMap<span class="token punctuation">)</span> <span class="token function">Filter</span><span class="token punctuation">(</span>filter <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> types<span class="token punctuation">.</span>Transactions <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> removed types<span class="token punctuation">.</span>Transactions

	<span class="token keyword">for</span> nonce<span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> m<span class="token punctuation">.</span>items <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token function">filter</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			removed <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>removed<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>items<span class="token punctuation">,</span> nonce<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>removed<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token operator">*</span>m<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint64</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> nonce <span class="token operator">:=</span> <span class="token keyword">range</span> m<span class="token punctuation">.</span>items <span class="token punctuation">&#123;</span>
			<span class="token operator">*</span>m<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">.</span>index<span class="token punctuation">,</span> nonce<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		heap<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>index<span class="token punctuation">)</span>

		m<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> removed
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先遍历所有的item，然后删除所有满足filter函数的交易。注意删除完要重构堆。</p>
<h2 id="Cap"><a href="#Cap" class="headerlink" title="Cap"></a>Cap</h2><p>这个方法限制存储的交易数量</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>txSortedMap<span class="token punctuation">)</span> <span class="token function">Cap</span><span class="token punctuation">(</span>threshold <span class="token builtin">int</span><span class="token punctuation">)</span> types<span class="token punctuation">.</span>Transactions <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> threshold <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">var</span> drops types<span class="token punctuation">.</span>Transactions

	sort<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
	<span class="token keyword">for</span> size <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span> size <span class="token operator">></span> threshold<span class="token punctuation">;</span> size<span class="token operator">--</span> <span class="token punctuation">&#123;</span>
		drops <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>drops<span class="token punctuation">,</span> m<span class="token punctuation">.</span>items<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">[</span>size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token function">delete</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>items<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">[</span>size<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token operator">*</span>m<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span>threshold<span class="token punctuation">]</span>
	heap<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>index<span class="token punctuation">)</span>

	<span class="token keyword">if</span> m<span class="token punctuation">.</span>cache <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		m<span class="token punctuation">.</span>cache <span class="token operator">=</span> m<span class="token punctuation">.</span>cache<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>cache<span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">len</span><span class="token punctuation">(</span>drops<span class="token punctuation">)</span><span class="token punctuation">]</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> drops
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果已有的交易数量大于指定值，则先对index排序，然后将index从后向前删除，知道满足条件，最后还要重构堆。</p>
<h2 id="Remove"><a href="#Remove" class="headerlink" title="Remove"></a>Remove</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>txSortedMap<span class="token punctuation">)</span> <span class="token function">Remove</span><span class="token punctuation">(</span>nonce <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>items<span class="token punctuation">[</span>nonce<span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> m<span class="token punctuation">.</span>index<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> nonce <span class="token punctuation">&#123;</span>
			heap<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>index<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">delete</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>items<span class="token punctuation">,</span> nonce<span class="token punctuation">)</span>
	m<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token boolean">nil</span>

	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>删除方法，先从items中找到对应的交易，然后先从堆中删除给定的nonce，之后再从itmes中删除</p>
<h2 id="Ready"><a href="#Ready" class="headerlink" title="Ready"></a>Ready</h2><p>返回一组连续交易，并将其从中删除，这一组交易中第一个交易的nonce要小于给定的值。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>txSortedMap<span class="token punctuation">)</span> <span class="token function">Ready</span><span class="token punctuation">(</span>start <span class="token builtin">uint64</span><span class="token punctuation">)</span> types<span class="token punctuation">.</span>Transactions <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> m<span class="token punctuation">.</span>index<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">></span> start <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">var</span> ready types<span class="token punctuation">.</span>Transactions
	<span class="token keyword">for</span> next <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> m<span class="token punctuation">.</span>index<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>m<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> next<span class="token punctuation">;</span> next<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		ready <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ready<span class="token punctuation">,</span> m<span class="token punctuation">.</span>items<span class="token punctuation">[</span>next<span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token function">delete</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>items<span class="token punctuation">,</span> next<span class="token punctuation">)</span>
		heap<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	m<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token boolean">nil</span>

	<span class="token keyword">return</span> ready
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于index是一个最小堆，所以根节点也就是数组的第一个值时堆的最小值，如果这个最小值比我们给定的值要大则直接返回。接下来开始一个循环，从堆得最小值开始，寻找连续的交易，每找到一个就将其从items中删除，直到下一个值不连续为止。</p>
<h2 id="Flatten"><a href="#Flatten" class="headerlink" title="Flatten"></a>Flatten</h2><p>这个方法是返回一个基于nonce排序的交易集合</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>txSortedMap<span class="token punctuation">)</span> <span class="token function">Flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span> types<span class="token punctuation">.</span>Transactions <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> m<span class="token punctuation">.</span>cache <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		m<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>Transactions<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> m<span class="token punctuation">.</span>items <span class="token punctuation">&#123;</span>
			m<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>cache<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		sort<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">TxByNonce</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>cache<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	txs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>Transactions<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>cache<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>txs<span class="token punctuation">,</span> m<span class="token punctuation">.</span>cache<span class="token punctuation">)</span>
	<span class="token keyword">return</span> txs
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先从cache中查找，没有的话将所有交易放入cache中，并按Nonce排序，最后返回一个Transactions类型数据。TxByNonce是一个可排序的Transactions类型。</p>
<h1 id="txList"><a href="#txList" class="headerlink" title="txList"></a>txList</h1><p>txList 是属于同一个账号的交易列表，按照nonce排序。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> txList <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	strict <span class="token builtin">bool</span>        
	txs    <span class="token operator">*</span>txSortedMap 

	costcap <span class="token operator">*</span>big<span class="token punctuation">.</span>Int 
	gascap  <span class="token builtin">uint64</span>  
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可见其中封装了txSortedMap，实际存储还是在txSortedMap中。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">newTxList</span><span class="token punctuation">(</span>strict <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>txList <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>txList<span class="token punctuation">&#123;</span>
		strict<span class="token punctuation">:</span>  strict<span class="token punctuation">,</span>
		txs<span class="token punctuation">:</span>     <span class="token function">newTxSortedMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		costcap<span class="token punctuation">:</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>strict是规定nonce是由要求连续的。</p>
<h2 id="Overlaps"><a href="#Overlaps" class="headerlink" title="Overlaps"></a>Overlaps</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>txList<span class="token punctuation">)</span> <span class="token function">Overlaps</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> l<span class="token punctuation">.</span>txs<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>检查给定的交易是否在txList中，实际上是借助txSortedMap的get方法按nonce查询。</p>
<h2 id="Add"><a href="#Add" class="headerlink" title="Add"></a>Add</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>txList<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> priceBump <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	old <span class="token operator">:=</span> l<span class="token punctuation">.</span>txs<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> old <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		threshold <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Div</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Mul</span><span class="token punctuation">(</span>old<span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">+</span><span class="token function">int64</span><span class="token punctuation">(</span>priceBump<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> old<span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">||</span> threshold<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	l<span class="token punctuation">.</span>txs<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> cost <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Cost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> l<span class="token punctuation">.</span>costcap<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>cost<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		l<span class="token punctuation">.</span>costcap <span class="token operator">=</span> cost
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> gas <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> l<span class="token punctuation">.</span>gascap <span class="token operator">&lt;</span> gas <span class="token punctuation">&#123;</span>
		l<span class="token punctuation">.</span>gascap <span class="token operator">=</span> gas
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> old
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是添加或替换方法。首先根据交易的nonce从已存储的集合中尝试获取，如果有的话表示有旧的交易。此时安装下面公式计算：(old_price * (100+priceBump))/100.只有如果旧的交易的GasPrice大于新的交易，或者刚才那个值大于新的交易的GasPrice则不进行任何处理。否则将新的交易放入txlist中。接着按情况更新costcap，他代表所有交易中的最高花费，以及gascap，表示所有交易中的最高gas用量。</p>
<h2 id="Forward-1"><a href="#Forward-1" class="headerlink" title="Forward"></a>Forward</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>txList<span class="token punctuation">)</span> <span class="token function">Forward</span><span class="token punctuation">(</span>threshold <span class="token builtin">uint64</span><span class="token punctuation">)</span> types<span class="token punctuation">.</span>Transactions <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> l<span class="token punctuation">.</span>txs<span class="token punctuation">.</span><span class="token function">Forward</span><span class="token punctuation">(</span>threshold<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>直接调用txSortedMap方法，删除并返回比指定值小的交易</p>
<h2 id="Filter-1"><a href="#Filter-1" class="headerlink" title="Filter"></a>Filter</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>txList<span class="token punctuation">)</span> <span class="token function">Filter</span><span class="token punctuation">(</span>costLimit <span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> gasLimit <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>types<span class="token punctuation">.</span>Transactions<span class="token punctuation">,</span> types<span class="token punctuation">.</span>Transactions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> l<span class="token punctuation">.</span>costcap<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>costLimit<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> l<span class="token punctuation">.</span>gascap <span class="token operator">&lt;=</span> gasLimit <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	l<span class="token punctuation">.</span>costcap <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>costLimit<span class="token punctuation">)</span> 
	l<span class="token punctuation">.</span>gascap <span class="token operator">=</span> gasLimit

	removed <span class="token operator">:=</span> l<span class="token punctuation">.</span>txs<span class="token punctuation">.</span><span class="token function">Filter</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> tx<span class="token punctuation">.</span><span class="token function">Cost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>costLimit<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> tx<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> gasLimit <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	<span class="token keyword">var</span> invalids types<span class="token punctuation">.</span>Transactions

	<span class="token keyword">if</span> l<span class="token punctuation">.</span>strict <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>removed<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		lowest <span class="token operator">:=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>MaxUint64<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> removed <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> nonce <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> lowest <span class="token operator">></span> nonce <span class="token punctuation">&#123;</span>
				lowest <span class="token operator">=</span> nonce
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		invalids <span class="token operator">=</span> l<span class="token punctuation">.</span>txs<span class="token punctuation">.</span><span class="token function">Filter</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> tx<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> lowest <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> removed<span class="token punctuation">,</span> invalids
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>给定两个参数一个是花费限制，一个是gas限制，所有大于这两个值其中之一的交易都会被删除并返回。</p>
<p>第一步先判断我们已有的交易中是否有符合条件的交易。有的话先更新costcap和gascap。之后利用txSortedMap的filter进行过滤。如果实在严格模式下，先获取刚才过滤出的交易集合中改的最小nonce，返回在获取大于次nonce的所有交易。主要是为了保持连续性</p>
<h2 id="Remove-1"><a href="#Remove-1" class="headerlink" title="Remove"></a>Remove</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>txList<span class="token punctuation">)</span> <span class="token function">Remove</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> types<span class="token punctuation">.</span>Transactions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	nonce <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> removed <span class="token operator">:=</span> l<span class="token punctuation">.</span>txs<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>nonce<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>removed <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> l<span class="token punctuation">.</span>strict <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>txs<span class="token punctuation">.</span><span class="token function">Filter</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> tx<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> nonce <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>删除一个交易，但是在严格模式下，还要过滤出所有nonce大于给定交易的nonce的所有交易。主要是为了保持连续性</p>
<h1 id="txLookup"><a href="#txLookup" class="headerlink" title="txLookup"></a>txLookup</h1><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> txLookup <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	all  <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction
	lock sync<span class="token punctuation">.</span>RWMutex
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">newTxLookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>txLookup <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>txLookup<span class="token punctuation">&#123;</span>
		all<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Hash<span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>只是封装了一个map，键是交易的hash，值就是交易本身。另外还有一个读写锁</p>
<h2 id="Range"><a href="#Range" class="headerlink" title="Range"></a>Range</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>txLookup<span class="token punctuation">)</span> <span class="token function">Range</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span>hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	t<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> t<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> t<span class="token punctuation">.</span>all <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">f</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要指定一个方法，会用这个方法处理txLookup例那个map中的所有键值对，当返回false时终止。</p>
<h2 id="Get-amp-Add"><a href="#Get-amp-Add" class="headerlink" title="Get &amp; Add"></a>Get &amp; Add</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>txLookup<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span> <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction <span class="token punctuation">&#123;</span>
	t<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> t<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> t<span class="token punctuation">.</span>all<span class="token punctuation">[</span>hash<span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>txLookup<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	t<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> t<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	t<span class="token punctuation">.</span>all<span class="token punctuation">[</span>tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> tx
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>txLookup<span class="token punctuation">)</span> <span class="token function">Remove</span><span class="token punctuation">(</span>hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	t<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> t<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token function">delete</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>all<span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>txLookup<span class="token punctuation">)</span> <span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>
	t<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> t<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>all<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>都是直接调用map实现的增删查方法。</p>
<h1 id="accountSet"><a href="#accountSet" class="headerlink" title="accountSet"></a>accountSet</h1><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> accountSet <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	accounts <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	signer   types<span class="token punctuation">.</span>Signer
	cache    <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Address
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">newAccountSet</span><span class="token punctuation">(</span>signer types<span class="token punctuation">.</span>Signer<span class="token punctuation">)</span> <span class="token operator">*</span>accountSet <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>accountSet<span class="token punctuation">&#123;</span>
		accounts<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		signer<span class="token punctuation">:</span>   signer<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>简单来说就是一个账号的集合，由于封装了Singer对象，所以还可以用来处理签名，Signer是一个接口，提供了从交易中获取发送人地址，获取交易hash以及交易原始签名值的功能</p>
<h2 id="contains"><a href="#contains" class="headerlink" title="contains"></a>contains</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>as <span class="token operator">*</span>accountSet<span class="token punctuation">)</span> <span class="token function">contains</span><span class="token punctuation">(</span>addr common<span class="token punctuation">.</span>Address<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> exist <span class="token operator">:=</span> as<span class="token punctuation">.</span>accounts<span class="token punctuation">[</span>addr<span class="token punctuation">]</span>
	<span class="token keyword">return</span> exist
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>判断给定的地址是否在集合内</p>
<h2 id="containsTx"><a href="#containsTx" class="headerlink" title="containsTx"></a>containsTx</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>as <span class="token operator">*</span>accountSet<span class="token punctuation">)</span> <span class="token function">containsTx</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> addr<span class="token punctuation">,</span> err <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">Sender</span><span class="token punctuation">(</span>as<span class="token punctuation">.</span>signer<span class="token punctuation">,</span> tx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> as<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>给定一个交易，先用Sender方法获取到发送人地址，在判断该地址是否在集合内</p>
<h2 id="add"><a href="#add" class="headerlink" title="add"></a>add</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>as <span class="token operator">*</span>accountSet<span class="token punctuation">)</span> <span class="token function">add</span><span class="token punctuation">(</span>addr common<span class="token punctuation">.</span>Address<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	as<span class="token punctuation">.</span>accounts<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	as<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>给定一个地址放入集合内</p>
<h2 id="flatten"><a href="#flatten" class="headerlink" title="flatten"></a>flatten</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>as <span class="token operator">*</span>accountSet<span class="token punctuation">)</span> <span class="token function">flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Address <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> as<span class="token punctuation">.</span>cache <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		accounts <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>as<span class="token punctuation">.</span>accounts<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> account <span class="token operator">:=</span> <span class="token keyword">range</span> as<span class="token punctuation">.</span>accounts <span class="token punctuation">&#123;</span>
			accounts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>accounts<span class="token punctuation">,</span> account<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		as<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token operator">&amp;</span>accounts
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token operator">*</span>as<span class="token punctuation">.</span>cache
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以数组的形式返回存储的所有地址，先从cache中取，没有值的话在遍历accounts。</p>
<h1 id="priceHeap"><a href="#priceHeap" class="headerlink" title="priceHeap"></a>priceHeap</h1><p>首先实际上他是一个Transaction类型的数组，但是实现了堆接口，也是一个最小堆，按照gas价格排序，若gas价格一样则按nonce排序</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> priceHeap <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction

<span class="token keyword">func</span> <span class="token punctuation">(</span>h priceHeap<span class="token punctuation">)</span> <span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>      <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h priceHeap<span class="token punctuation">)</span> <span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> h<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> h<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> h<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> h<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h priceHeap<span class="token punctuation">)</span> <span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">switch</span> h<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>h<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> h<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> h<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>priceHeap<span class="token punctuation">)</span> <span class="token function">Push</span><span class="token punctuation">(</span>x <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token operator">*</span>h <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token operator">*</span>h<span class="token punctuation">,</span> x<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>priceHeap<span class="token punctuation">)</span> <span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>
	old <span class="token operator">:=</span> <span class="token operator">*</span>h
	n <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span>
	x <span class="token operator">:=</span> old<span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token operator">*</span>h <span class="token operator">=</span> old<span class="token punctuation">[</span><span class="token number">0</span> <span class="token punctuation">:</span> n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token keyword">return</span> x
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="txPricedList"><a href="#txPricedList" class="headerlink" title="txPricedList"></a>txPricedList</h1><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> txPricedList <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	all    <span class="token operator">*</span>txLookup  
	items  <span class="token operator">*</span>priceHeap 
	stales <span class="token builtin">int</span>       
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">newTxPricedList</span><span class="token punctuation">(</span>all <span class="token operator">*</span>txLookup<span class="token punctuation">)</span> <span class="token operator">*</span>txPricedList <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>txPricedList<span class="token punctuation">&#123;</span>
		all<span class="token punctuation">:</span>   all<span class="token punctuation">,</span>
		items<span class="token punctuation">:</span> <span class="token function">new</span><span class="token punctuation">(</span>priceHeap<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>类似于txList的功能，构造时会传入txloopup对象，其中包含一系列的交易</p>
<h2 id="Put"><a href="#Put" class="headerlink" title="Put"></a>Put</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>txPricedList<span class="token punctuation">)</span> <span class="token function">Put</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	heap<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>items<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>注意这里是将交易放在那个最小堆中</p>
<h2 id="Cap-1"><a href="#Cap-1" class="headerlink" title="Cap"></a>Cap</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>txPricedList<span class="token punctuation">)</span> <span class="token function">Cap</span><span class="token punctuation">(</span>threshold <span class="token operator">*</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> local <span class="token operator">*</span>accountSet<span class="token punctuation">)</span> types<span class="token punctuation">.</span>Transactions <span class="token punctuation">&#123;</span>
	drop <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>Transactions<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span> 
	save <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>Transactions<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>  

	<span class="token keyword">for</span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token operator">*</span>l<span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		tx <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span>
		<span class="token keyword">if</span> l<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			l<span class="token punctuation">.</span>stales<span class="token operator">--</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> tx<span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>threshold<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			save <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>save<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> local<span class="token punctuation">.</span><span class="token function">containsTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			save <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>save<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			drop <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>drop<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> save <span class="token punctuation">&#123;</span>
		heap<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>items<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> drop
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>给定两个参数，第一个参数是一个阈值，第二个是一个accountSet集合local。这里会遍历所有item中存储的交易，对于gasprice小于阈值的交易如果不属于local，则放入drop中返回，否则还放回items中。</p>
<h2 id="Underpriced"><a href="#Underpriced" class="headerlink" title="Underpriced"></a>Underpriced</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>txPricedList<span class="token punctuation">)</span> <span class="token function">Underpriced</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> local <span class="token operator">*</span>accountSet<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> local<span class="token punctuation">.</span><span class="token function">containsTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token operator">*</span>l<span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		head <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span><span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token operator">*</span>l<span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
		<span class="token keyword">if</span> l<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			l<span class="token punctuation">.</span>stales<span class="token operator">--</span>
			heap<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>items<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">break</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token operator">*</span>l<span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Pricing query for empty pool"</span><span class="token punctuation">)</span> 
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">&#125;</span>
	cheapest <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span><span class="token function">Transaction</span><span class="token punctuation">(</span><span class="token operator">*</span>l<span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token keyword">return</span> cheapest<span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法是给定一个交易，然后检查这个交易的GasPrice是否比集合中存储的GasPrice的最小值还要小，由于是按GasPrice排序，所以items中第一个元素就是GasPrice最小值。</p>
<h2 id="Discard"><a href="#Discard" class="headerlink" title="Discard"></a>Discard</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>txPricedList<span class="token punctuation">)</span> <span class="token function">Discard</span><span class="token punctuation">(</span>count <span class="token builtin">int</span><span class="token punctuation">,</span> local <span class="token operator">*</span>accountSet<span class="token punctuation">)</span> types<span class="token punctuation">.</span>Transactions <span class="token punctuation">&#123;</span>
	drop <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>Transactions<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span> 
	save <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>Transactions<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>    

	<span class="token keyword">for</span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token operator">*</span>l<span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> count <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// Discard stale transactions if found during cleanup</span>
		tx <span class="token operator">:=</span> heap<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span>
		<span class="token keyword">if</span> l<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			l<span class="token punctuation">.</span>stales<span class="token operator">--</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">&#125;</span>
		<span class="token comment">// Non stale transaction found, discard unless local</span>
		<span class="token keyword">if</span> local<span class="token punctuation">.</span><span class="token function">containsTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			save <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>save<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			drop <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>drop<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
			count<span class="token operator">--</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> save <span class="token punctuation">&#123;</span>
		heap<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>items<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> drop
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个是取集合中GasPrice最小的count个交易从中删除并返回，前提是不在local中，若在则需要再放回</p>
<h2 id="Removed"><a href="#Removed" class="headerlink" title="Removed"></a>Removed</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>txPricedList<span class="token punctuation">)</span> <span class="token function">Removed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	l<span class="token punctuation">.</span>stales<span class="token operator">++</span>
	<span class="token keyword">if</span> l<span class="token punctuation">.</span>stales <span class="token operator">&lt;=</span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token operator">*</span>l<span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	reheap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>priceHeap<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	l<span class="token punctuation">.</span>stales<span class="token punctuation">,</span> l<span class="token punctuation">.</span>items <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>reheap
	l<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
		<span class="token operator">*</span>l<span class="token punctuation">.</span>items <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token operator">*</span>l<span class="token punctuation">.</span>items<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	heap<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>items<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>用来通知有旧的交易被删除，该方法每调用一次，stales加一，当达到items个数的四分之一时，从新调整堆，集体方法是新建一个堆，让后将原来items中改的元素依次放入然后初始化该堆即可。</p>
<h1 id="txJournal"><a href="#txJournal" class="headerlink" title="txJournal"></a>txJournal</h1><p>这是一个交易的循环日志对象，目的是存储本地创建的交易，使未执行的交易能在节点启动时得到执行</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> txJournal <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	path   <span class="token builtin">string</span>         
	writer io<span class="token punctuation">.</span>WriteCloser 
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">newTxJournal</span><span class="token punctuation">(</span>path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>txJournal <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>txJournal<span class="token punctuation">&#123;</span>
		path<span class="token punctuation">:</span> path<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>path就是存储交易的目录</p>
<h2 id="load"><a href="#load" class="headerlink" title="load"></a>load</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>journal <span class="token operator">*</span>txJournal<span class="token punctuation">)</span> <span class="token function">load</span><span class="token punctuation">(</span>add <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>journal<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	input<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>journal<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">defer</span> input<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	journal<span class="token punctuation">.</span>writer <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>devNull<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> journal<span class="token punctuation">.</span>writer <span class="token operator">=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	stream <span class="token operator">:=</span> rlp<span class="token punctuation">.</span><span class="token function">NewStream</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	total<span class="token punctuation">,</span> dropped <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>

	loadBatch <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>txs types<span class="token punctuation">.</span>Transactions<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">add</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Failed to add journaled transaction"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				dropped<span class="token operator">++</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">var</span> <span class="token punctuation">(</span>
		failure <span class="token builtin">error</span>
		batch   types<span class="token punctuation">.</span>Transactions
	<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		tx <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">&#123;</span>
				failure <span class="token operator">=</span> err
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">if</span> batch<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				<span class="token function">loadBatch</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">&#125;</span>
		total<span class="token operator">++</span>

		<span class="token keyword">if</span> batch <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>batch<span class="token punctuation">,</span> tx<span class="token punctuation">)</span><span class="token punctuation">;</span> batch<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1024</span> <span class="token punctuation">&#123;</span>
			<span class="token function">loadBatch</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span>
			batch <span class="token operator">=</span> batch<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Loaded local transaction journal"</span><span class="token punctuation">,</span> <span class="token string">"transactions"</span><span class="token punctuation">,</span> total<span class="token punctuation">,</span> <span class="token string">"dropped"</span><span class="token punctuation">,</span> dropped<span class="token punctuation">)</span>

	<span class="token keyword">return</span> failure
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>加载并解析磁盘存储的交易。首先判断路径所指的文件是否存在，然后打开该文件。devNull是一个虚拟写的对象，它的write不产生任何写动作，直接返回要写数据的长度，它的close永远返回nil。</p>
<p>打开文件后，根据input获取一个rlp的流，之后进入一个循环，每次解码出一个交易，如果没错的话，计数器total加一，然后将刚才解码出的交易放入batch中，这是一个交易集合。若batch中交易数量大于1024或者刚才解码出错都调用loadBatch方法。</p>
<p>loadBatch方法线用add方法处理刚才得到了交易集合，add方法是我们调用load方法是指定的，之后遍历add返回的error数组，对于有错的交易打印log并使计数器dropped加一。</p>
<h2 id="insert"><a href="#insert" class="headerlink" title="insert"></a>insert</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>journal <span class="token operator">*</span>txJournal<span class="token punctuation">)</span> <span class="token function">insert</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> journal<span class="token punctuation">.</span>writer <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errNoActiveJournal
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> rlp<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>journal<span class="token punctuation">.</span>writer<span class="token punctuation">,</span> tx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里是将一个交易放入日志中，直接使用rlp编码，接入写入writer中。</p>
<h2 id="rotate"><a href="#rotate" class="headerlink" title="rotate"></a>rotate</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>journal <span class="token operator">*</span>txJournal<span class="token punctuation">)</span> <span class="token function">rotate</span><span class="token punctuation">(</span>all <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">]</span>types<span class="token punctuation">.</span>Transactions<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> journal<span class="token punctuation">.</span>writer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> journal<span class="token punctuation">.</span>writer<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">&#125;</span>
		journal<span class="token punctuation">.</span>writer <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>

	replacement<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>journal<span class="token punctuation">.</span>path<span class="token operator">+</span><span class="token string">".new"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_WRONLY<span class="token operator">|</span>os<span class="token punctuation">.</span>O_CREATE<span class="token operator">|</span>os<span class="token punctuation">.</span>O_TRUNC<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	journaled <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> txs <span class="token operator">:=</span> <span class="token keyword">range</span> all <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> txs <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> err <span class="token operator">=</span> rlp<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>replacement<span class="token punctuation">,</span> tx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				replacement<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		journaled <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	replacement<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> err <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Rename</span><span class="token punctuation">(</span>journal<span class="token punctuation">.</span>path<span class="token operator">+</span><span class="token string">".new"</span><span class="token punctuation">,</span> journal<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	sink<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>journal<span class="token punctuation">.</span>path<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_WRONLY<span class="token operator">|</span>os<span class="token punctuation">.</span>O_APPEND<span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	journal<span class="token punctuation">.</span>writer <span class="token operator">=</span> sink
	log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Regenerated local transaction journal"</span><span class="token punctuation">,</span> <span class="token string">"transactions"</span><span class="token punctuation">,</span> journaled<span class="token punctuation">,</span> <span class="token string">"accounts"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>all<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个是用来重新生成交易日志的。第一步先把原来的writer关闭，之后新建一个日志文件，在原来path基础上加.new后缀，然后遍历所有给定的交易，参数中给的是一个map，指的是对应地址的所有交易。对于每个交易先经过rlp编码后写入文件中。最后将新建的文件重命名为原来给定的名字。最后重新打开新的文件，然后设置writer为新文件对象。</p>
<h1 id="txSenderCacher"><a href="#txSenderCacher" class="headerlink" title="txSenderCacher"></a>txSenderCacher</h1><p>这是一个帮助了，为的是并发的从一组交易中恢复出每个交易的发送人地址</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> senderCacher <span class="token operator">=</span> <span class="token function">newTxSenderCacher</span><span class="token punctuation">(</span>runtime<span class="token punctuation">.</span><span class="token function">NumCPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> txSenderCacher <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	threads <span class="token builtin">int</span>
	tasks   <span class="token keyword">chan</span> <span class="token operator">*</span>txSenderCacherRequest
<span class="token punctuation">&#125;</span>

<span class="token keyword">type</span> txSenderCacherRequest <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	signer types<span class="token punctuation">.</span>Signer
	txs    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction
	inc    <span class="token builtin">int</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">newTxSenderCacher</span><span class="token punctuation">(</span>threads <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>txSenderCacher <span class="token punctuation">&#123;</span>
	cacher <span class="token operator">:=</span> <span class="token operator">&amp;</span>txSenderCacher<span class="token punctuation">&#123;</span>
		tasks<span class="token punctuation">:</span>   <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>txSenderCacherRequest<span class="token punctuation">,</span> threads<span class="token punctuation">)</span><span class="token punctuation">,</span>
		threads<span class="token punctuation">:</span> threads<span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threads<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">go</span> cacher<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> cacher
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>构造参数需要指定并发数，一般都是cpu核数。然后启动若干个goroutine去执行cache方法</p>
<h2 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>cacher <span class="token operator">*</span>txSenderCacher<span class="token punctuation">)</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> task <span class="token operator">:=</span> <span class="token keyword">range</span> cacher<span class="token punctuation">.</span>tasks <span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>txs<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> task<span class="token punctuation">.</span>inc <span class="token punctuation">&#123;</span>
			types<span class="token punctuation">.</span><span class="token function">Sender</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>signer<span class="token punctuation">,</span> task<span class="token punctuation">.</span>txs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>tasks是一个channel，其中数据时txSenderCacherRequest，在cache中会在for循环中阻塞，知道通道中有数据来临，然后调用Sender方法去恢复地址，并将地址写入对应交易的from字段</p>
<h2 id="recover"><a href="#recover" class="headerlink" title="recover"></a>recover</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>cacher <span class="token operator">*</span>txSenderCacher<span class="token punctuation">)</span> <span class="token function">recover</span><span class="token punctuation">(</span>signer types<span class="token punctuation">.</span>Signer<span class="token punctuation">,</span> txs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>

	tasks <span class="token operator">:=</span> cacher<span class="token punctuation">.</span>threads
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span> <span class="token operator">&lt;</span> tasks<span class="token operator">*</span><span class="token number">4</span> <span class="token punctuation">&#123;</span>
		tasks <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">4</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tasks<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		cacher<span class="token punctuation">.</span>tasks <span class="token operator">&lt;-</span> <span class="token operator">&amp;</span>txSenderCacherRequest<span class="token punctuation">&#123;</span>
			signer<span class="token punctuation">:</span> signer<span class="token punctuation">,</span>
			txs<span class="token punctuation">:</span>    txs<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
			inc<span class="token punctuation">:</span>    tasks<span class="token punctuation">,</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们说刚才cache方法在没有数据时会被阻塞，这个方法就是用来发送数据的，现将给定的交易集合分为若干份，每一份都封装为一个txSenderCacherRequest对象，然后发送到通道中，这样激活了cache去解析地址。</p>
<h2 id="recoverFromBlocks"><a href="#recoverFromBlocks" class="headerlink" title="recoverFromBlocks"></a>recoverFromBlocks</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>cacher <span class="token operator">*</span>txSenderCacher<span class="token punctuation">)</span> <span class="token function">recoverFromBlocks</span><span class="token punctuation">(</span>signer types<span class="token punctuation">.</span>Signer<span class="token punctuation">,</span> blocks <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Block<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	count <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> block <span class="token operator">:=</span> <span class="token keyword">range</span> blocks <span class="token punctuation">&#123;</span>
		count <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span><span class="token function">Transactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	txs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> block <span class="token operator">:=</span> <span class="token keyword">range</span> blocks <span class="token punctuation">&#123;</span>
		txs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>txs<span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">Transactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	cacher<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>signer<span class="token punctuation">,</span> txs<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们知道一个区块中也保存了大量交易，所以这里也封装了一个方法去直接处理一个区块中的所有交易，主要是将区块中的交易封装为一个Transactions然后用recover方法处理。</p>
<h1 id="TxPool"><a href="#TxPool" class="headerlink" title="TxPool"></a>TxPool</h1><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> TxPool <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	config       TxPoolConfig
	chainconfig  <span class="token operator">*</span>params<span class="token punctuation">.</span>ChainConfig
	chain        blockChain
	gasPrice     <span class="token operator">*</span>big<span class="token punctuation">.</span>Int
	txFeed       event<span class="token punctuation">.</span>Feed
	scope        event<span class="token punctuation">.</span>SubscriptionScope
	chainHeadCh  <span class="token keyword">chan</span> ChainHeadEvent
	chainHeadSub event<span class="token punctuation">.</span>Subscription
	signer       types<span class="token punctuation">.</span>Signer
	mu           sync<span class="token punctuation">.</span>RWMutex

	currentState  <span class="token operator">*</span>state<span class="token punctuation">.</span>StateDB     
	pendingState  <span class="token operator">*</span>state<span class="token punctuation">.</span>ManagedState 
	currentMaxGas <span class="token builtin">uint64</span>              

	locals  <span class="token operator">*</span>accountSet 
	journal <span class="token operator">*</span>txJournal  

	pending <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">]</span><span class="token operator">*</span>txList   
	queue   <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">]</span><span class="token operator">*</span>txList   
	beats   <span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">]</span>time<span class="token punctuation">.</span>Time 
	all     <span class="token operator">*</span>txLookup                   
	priced  <span class="token operator">*</span>txPricedList                

	wg sync<span class="token punctuation">.</span>WaitGroup 

	homestead <span class="token builtin">bool</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面有几个重要的成员，后面的方法大多都是围绕这几个成员操作的。pending指所有当前可以处理的交易，按照发送人地址归类。queue指当前还不能处理的交易，也是按发送人地址归类。beats指每一个相关账户最后一次心跳时间。all指所有可以查找到的交易。priced是将交易按GasPrice排序的集合。gasPrice指最小gas价格。currentMaxGas指当前最大gas使用量。默认的txpool配置如下</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> DefaultTxPoolConfig <span class="token operator">=</span> TxPoolConfig<span class="token punctuation">&#123;</span>
	Journal<span class="token punctuation">:</span>   <span class="token string">"transactions.rlp"</span><span class="token punctuation">,</span>
	Rejournal<span class="token punctuation">:</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">,</span>

	PriceLimit<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
	PriceBump<span class="token punctuation">:</span>  <span class="token number">10</span><span class="token punctuation">,</span>

	AccountSlots<span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
	GlobalSlots<span class="token punctuation">:</span>  <span class="token number">4096</span><span class="token punctuation">,</span>
	AccountQueue<span class="token punctuation">:</span> <span class="token number">64</span><span class="token punctuation">,</span>
	GlobalQueue<span class="token punctuation">:</span>  <span class="token number">1024</span><span class="token punctuation">,</span>

	Lifetime<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="构造"><a href="#构造" class="headerlink" title="构造"></a>构造</h2><p>txpool包含所有当前已知交易。当从网络收到交易或本地提交交易后，交易会被放入txpool中，当交易已经被包含在区块链中时，会被删除。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewTxPool</span><span class="token punctuation">(</span>config TxPoolConfig<span class="token punctuation">,</span> chainconfig <span class="token operator">*</span>params<span class="token punctuation">.</span>ChainConfig<span class="token punctuation">,</span> chain blockChain<span class="token punctuation">)</span> <span class="token operator">*</span>TxPool <span class="token punctuation">&#123;</span>
	config <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sanitize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	pool <span class="token operator">:=</span> <span class="token operator">&amp;</span>TxPool<span class="token punctuation">&#123;</span>
		config<span class="token punctuation">:</span>      config<span class="token punctuation">,</span>
		chainconfig<span class="token punctuation">:</span> chainconfig<span class="token punctuation">,</span>
		chain<span class="token punctuation">:</span>       chain<span class="token punctuation">,</span>
		signer<span class="token punctuation">:</span>      types<span class="token punctuation">.</span><span class="token function">NewEIP155Signer</span><span class="token punctuation">(</span>chainconfig<span class="token punctuation">.</span>ChainID<span class="token punctuation">)</span><span class="token punctuation">,</span>
		pending<span class="token punctuation">:</span>     <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">]</span><span class="token operator">*</span>txList<span class="token punctuation">)</span><span class="token punctuation">,</span>
		queue<span class="token punctuation">:</span>       <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">]</span><span class="token operator">*</span>txList<span class="token punctuation">)</span><span class="token punctuation">,</span>
		beats<span class="token punctuation">:</span>       <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">]</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span><span class="token punctuation">,</span>
		all<span class="token punctuation">:</span>         <span class="token function">newTxLookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		chainHeadCh<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> ChainHeadEvent<span class="token punctuation">,</span> chainHeadChanSize<span class="token punctuation">)</span><span class="token punctuation">,</span>
		gasPrice<span class="token punctuation">:</span>    <span class="token function">new</span><span class="token punctuation">(</span>big<span class="token punctuation">.</span>Int<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetUint64</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>PriceLimit<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">&#125;</span>
	pool<span class="token punctuation">.</span>locals <span class="token operator">=</span> <span class="token function">newAccountSet</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>signer<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> addr <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>Locals <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Setting new local account"</span><span class="token punctuation">,</span> <span class="token string">"address"</span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
		pool<span class="token punctuation">.</span>locals<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	pool<span class="token punctuation">.</span>priced <span class="token operator">=</span> <span class="token function">newTxPricedList</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>all<span class="token punctuation">)</span>
	pool<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> chain<span class="token punctuation">.</span><span class="token function">CurrentBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>config<span class="token punctuation">.</span>NoLocals <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>Journal <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>
		pool<span class="token punctuation">.</span>journal <span class="token operator">=</span> <span class="token function">newTxJournal</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Journal<span class="token punctuation">)</span>

		<span class="token keyword">if</span> err <span class="token operator">:=</span> pool<span class="token punctuation">.</span>journal<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>AddLocals<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Failed to load transaction journal"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> pool<span class="token punctuation">.</span>journal<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Failed to rotate transaction journal"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	pool<span class="token punctuation">.</span>chainHeadSub <span class="token operator">=</span> pool<span class="token punctuation">.</span>chain<span class="token punctuation">.</span><span class="token function">SubscribeChainHeadEvent</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>chainHeadCh<span class="token punctuation">)</span>

	pool<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> pool<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> pool
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一步调用的TxPoolConfig的sanitize方法主要是检查配置是否合法。剩余的都是在给txpool的成员赋值，新建了许多我们刚才介绍过的数据类型，其中注册了ChainHead事件。还有就是初始化了Locals，他从config中加载一些账户，这些账户的交易被标记为本地交易，以免在后面的操作中被移除。在构造方法中还调用了rest方法，最后还在一个单独的goroutine中执行了loop方法</p>
<h2 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h2><p>reset方法检索区块链的当前状态并且确保交易池的内容关于当前的区块链状态是有效的。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">reset</span><span class="token punctuation">(</span>oldHead<span class="token punctuation">,</span> newHead <span class="token operator">*</span>types<span class="token punctuation">.</span>Header<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> reinject types<span class="token punctuation">.</span>Transactions

	<span class="token keyword">if</span> oldHead <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> oldHead<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> newHead<span class="token punctuation">.</span>ParentHash <span class="token punctuation">&#123;</span>
		oldNum <span class="token operator">:=</span> oldHead<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		newNum <span class="token operator">:=</span> newHead<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token keyword">if</span> depth <span class="token operator">:=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span><span class="token function">Abs</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>oldNum<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">float64</span><span class="token punctuation">(</span>newNum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> depth <span class="token operator">></span> <span class="token number">64</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Skipping deep transaction reorg"</span><span class="token punctuation">,</span> <span class="token string">"depth"</span><span class="token punctuation">,</span> depth<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">var</span> discarded<span class="token punctuation">,</span> included types<span class="token punctuation">.</span>Transactions

			<span class="token keyword">var</span> <span class="token punctuation">(</span>
				rem <span class="token operator">=</span> pool<span class="token punctuation">.</span>chain<span class="token punctuation">.</span><span class="token function">GetBlock</span><span class="token punctuation">(</span>oldHead<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oldHead<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				add <span class="token operator">=</span> pool<span class="token punctuation">.</span>chain<span class="token punctuation">.</span><span class="token function">GetBlock</span><span class="token punctuation">(</span>newHead<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newHead<span class="token punctuation">.</span>Number<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">)</span>
			<span class="token keyword">for</span> rem<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> add<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				discarded <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>discarded<span class="token punctuation">,</span> rem<span class="token punctuation">.</span><span class="token function">Transactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> rem <span class="token operator">=</span> pool<span class="token punctuation">.</span>chain<span class="token punctuation">.</span><span class="token function">GetBlock</span><span class="token punctuation">(</span>rem<span class="token punctuation">.</span><span class="token function">ParentHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rem<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rem <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Unrooted old chain seen by tx pool"</span><span class="token punctuation">,</span> <span class="token string">"block"</span><span class="token punctuation">,</span> oldHead<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> oldHead<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token keyword">return</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">for</span> add<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> rem<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				included <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>included<span class="token punctuation">,</span> add<span class="token punctuation">.</span><span class="token function">Transactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> add <span class="token operator">=</span> pool<span class="token punctuation">.</span>chain<span class="token punctuation">.</span><span class="token function">GetBlock</span><span class="token punctuation">(</span>add<span class="token punctuation">.</span><span class="token function">ParentHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> add<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> add <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Unrooted new chain seen by tx pool"</span><span class="token punctuation">,</span> <span class="token string">"block"</span><span class="token punctuation">,</span> newHead<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> newHead<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token keyword">return</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">for</span> rem<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> add<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				discarded <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>discarded<span class="token punctuation">,</span> rem<span class="token punctuation">.</span><span class="token function">Transactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> rem <span class="token operator">=</span> pool<span class="token punctuation">.</span>chain<span class="token punctuation">.</span><span class="token function">GetBlock</span><span class="token punctuation">(</span>rem<span class="token punctuation">.</span><span class="token function">ParentHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rem<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> rem <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Unrooted old chain seen by tx pool"</span><span class="token punctuation">,</span> <span class="token string">"block"</span><span class="token punctuation">,</span> oldHead<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> oldHead<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token keyword">return</span>
				<span class="token punctuation">&#125;</span>
				included <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>included<span class="token punctuation">,</span> add<span class="token punctuation">.</span><span class="token function">Transactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> add <span class="token operator">=</span> pool<span class="token punctuation">.</span>chain<span class="token punctuation">.</span><span class="token function">GetBlock</span><span class="token punctuation">(</span>add<span class="token punctuation">.</span><span class="token function">ParentHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> add<span class="token punctuation">.</span><span class="token function">NumberU64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> add <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Unrooted new chain seen by tx pool"</span><span class="token punctuation">,</span> <span class="token string">"block"</span><span class="token punctuation">,</span> newHead<span class="token punctuation">.</span>Number<span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> newHead<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token keyword">return</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
			reinject <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">TxDifference</span><span class="token punctuation">(</span>discarded<span class="token punctuation">,</span> included<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> newHead <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		newHead <span class="token operator">=</span> pool<span class="token punctuation">.</span>chain<span class="token punctuation">.</span><span class="token function">CurrentBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
	<span class="token punctuation">&#125;</span>
	statedb<span class="token punctuation">,</span> err <span class="token operator">:=</span> pool<span class="token punctuation">.</span>chain<span class="token punctuation">.</span><span class="token function">StateAt</span><span class="token punctuation">(</span>newHead<span class="token punctuation">.</span>Root<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Failed to reset txpool state"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	pool<span class="token punctuation">.</span>currentState <span class="token operator">=</span> statedb
	pool<span class="token punctuation">.</span>pendingState <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">ManageState</span><span class="token punctuation">(</span>statedb<span class="token punctuation">)</span>
	pool<span class="token punctuation">.</span>currentMaxGas <span class="token operator">=</span> newHead<span class="token punctuation">.</span>GasLimit

	log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Reinjecting stale transactions"</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>reinject<span class="token punctuation">)</span><span class="token punctuation">)</span>
	senderCacher<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>signer<span class="token punctuation">,</span> reinject<span class="token punctuation">)</span>
	pool<span class="token punctuation">.</span><span class="token function">addTxsLocked</span><span class="token punctuation">(</span>reinject<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>

	pool<span class="token punctuation">.</span><span class="token function">demoteUnexecutables</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> addr<span class="token punctuation">,</span> list <span class="token operator">:=</span> <span class="token keyword">range</span> pool<span class="token punctuation">.</span>pending <span class="token punctuation">&#123;</span>
		txs <span class="token operator">:=</span> list<span class="token punctuation">.</span><span class="token function">Flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
		pool<span class="token punctuation">.</span>pendingState<span class="token punctuation">.</span><span class="token function">SetNonce</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> txs<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	pool<span class="token punctuation">.</span><span class="token function">promoteExecutables</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>参数中传入两个区块头，表示一新一旧两个区块。首先如果旧区块不是新区快的父区块的话，需要重构。但是如果二者高度相差太多则不执行重构，这里的界线是64。如果需要重构，首先要找到二者的公共祖先节点，逻辑和BlockChain插入区块时主要需要调整的逻辑类似。两个区块在回溯时，经过的区块中包含交易都分别保存在discarded和included中，discarded表示要删除的交易，included表示要添加的交易。最后用TxDifference方法寻找二者区别，也就是discarded有的而included没有的。</p>
<p>接着获取新区快的状态树，并设置pool的currentState、pendingState和currentMaxGas。接下来调用recover方法将要添加的交易恢复出发送人地址。</p>
<p>再往下调用了addTxsLocked方法，这里有效交易放到相应队列中。后面的demoteUnexecutables方法将pending中一些不能执行的交易放入queue中。之后有一个循环更新交易账号的nonce，最后调用promoteExecutables方法见将一些可以执行的交易放到pending中。</p>
<p>之所以调用demoteUnexecutables方法是因为currentMaxGas等信息的改变，有一些交易将变得无法执行。调用promoteExecutables是因为账户的nonce发送改变，有一些交易变得可以执行</p>
<h2 id="loop"><a href="#loop" class="headerlink" title="loop"></a>loop</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">defer</span> pool<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">var</span> prevPending<span class="token punctuation">,</span> prevQueued<span class="token punctuation">,</span> prevStales <span class="token builtin">int</span>

	report <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span>statsReportInterval<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> report<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	evict <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span>evictionInterval<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> evict<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	journal <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Rejournal<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> journal<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	head <span class="token operator">:=</span> pool<span class="token punctuation">.</span>chain<span class="token punctuation">.</span><span class="token function">CurrentBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">select</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">case</span> ev <span class="token operator">:=</span> <span class="token operator">&lt;-</span>pool<span class="token punctuation">.</span>chainHeadCh<span class="token punctuation">:</span>
			<span class="token keyword">if</span> ev<span class="token punctuation">.</span>Block <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				pool<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> pool<span class="token punctuation">.</span>chainconfig<span class="token punctuation">.</span><span class="token function">IsHomestead</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>Block<span class="token punctuation">.</span><span class="token function">Number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					pool<span class="token punctuation">.</span>homestead <span class="token operator">=</span> <span class="token boolean">true</span>
				<span class="token punctuation">&#125;</span>
				pool<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ev<span class="token punctuation">.</span>Block<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				head <span class="token operator">=</span> ev<span class="token punctuation">.</span>Block

				pool<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>

		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>pool<span class="token punctuation">.</span>chainHeadSub<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span>

		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>report<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
			pool<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			pending<span class="token punctuation">,</span> queued <span class="token operator">:=</span> pool<span class="token punctuation">.</span><span class="token function">stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			stales <span class="token operator">:=</span> pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span>stales
			pool<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

			<span class="token keyword">if</span> pending <span class="token operator">!=</span> prevPending <span class="token operator">||</span> queued <span class="token operator">!=</span> prevQueued <span class="token operator">||</span> stales <span class="token operator">!=</span> prevStales <span class="token punctuation">&#123;</span>
				log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Transaction pool status report"</span><span class="token punctuation">,</span> <span class="token string">"executable"</span><span class="token punctuation">,</span> pending<span class="token punctuation">,</span> <span class="token string">"queued"</span><span class="token punctuation">,</span> queued<span class="token punctuation">,</span> <span class="token string">"stales"</span><span class="token punctuation">,</span> stales<span class="token punctuation">)</span>
				prevPending<span class="token punctuation">,</span> prevQueued<span class="token punctuation">,</span> prevStales <span class="token operator">=</span> pending<span class="token punctuation">,</span> queued<span class="token punctuation">,</span> stales
			<span class="token punctuation">&#125;</span>


		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>evict<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
			pool<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">for</span> addr <span class="token operator">:=</span> <span class="token keyword">range</span> pool<span class="token punctuation">.</span>queue <span class="token punctuation">&#123;</span>
				<span class="token comment">// Skip local transactions from the eviction mechanism</span>
				<span class="token keyword">if</span> pool<span class="token punctuation">.</span>locals<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">continue</span>
				<span class="token punctuation">&#125;</span>
				<span class="token comment">// Any non-locals old enough should be removed</span>
				<span class="token keyword">if</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>beats<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Lifetime <span class="token punctuation">&#123;</span>
					<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> pool<span class="token punctuation">.</span>queue<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
						pool<span class="token punctuation">.</span><span class="token function">removeTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
			pool<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>journal<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
			<span class="token keyword">if</span> pool<span class="token punctuation">.</span>journal <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
				pool<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">:=</span> pool<span class="token punctuation">.</span>journal<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
					log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Failed to rotate local tx journal"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
				pool<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这就是txloop的事件循环。开始设置了三个定时器，report每8秒触发一次，evict每分钟触发一次，journal可以自己设置，最低每秒触发一次，默认是1小时。</p>
<p>journal每次触发时会调用local方法获取pending和queue中的所有键值对，然后生成新的日志文件。</p>
<p>report触发时就是打印日志。</p>
<p>evict触发时会遍历queue中的超时交易并将其删除，默认超时时间是3小时。</p>
<p>chainHeadCh触发时表示收到新区快，此时调用reset方法。</p>
<h2 id="addTxsLocked"><a href="#addTxsLocked" class="headerlink" title="addTxsLocked"></a>addTxsLocked</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">addTxsLocked</span><span class="token punctuation">(</span>txs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> local <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	dirty <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	errs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> i<span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> txs <span class="token punctuation">&#123;</span>
		<span class="token keyword">var</span> replace <span class="token builtin">bool</span>
		<span class="token keyword">if</span> replace<span class="token punctuation">,</span> errs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> local<span class="token punctuation">)</span><span class="token punctuation">;</span> errs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>replace <span class="token punctuation">&#123;</span>
			from<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">Sender</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>signer<span class="token punctuation">,</span> tx<span class="token punctuation">)</span> 
			dirty<span class="token punctuation">[</span>from<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>dirty<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		addrs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>dirty<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> addr <span class="token operator">:=</span> <span class="token keyword">range</span> dirty <span class="token punctuation">&#123;</span>
			addrs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>addrs<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		pool<span class="token punctuation">.</span><span class="token function">promoteExecutables</span><span class="token punctuation">(</span>addrs<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> errs
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法尝试将交易放到相应队列中。</p>
<p>这里给定一组交易，首先遍历这些交易，对于每个交易执行add方法将其添加到对应队列。replace表示是否替换了旧的交易，没有的话还原出交易的发送者，然后在dirty中添加值。处理完所有交易后如果dirty长度不为零，则读出其中存储的所有交易发送人地址，并执行promoteExecutables方法。</p>
<h2 id="demoteUnexecutables"><a href="#demoteUnexecutables" class="headerlink" title="demoteUnexecutables"></a>demoteUnexecutables</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">demoteUnexecutables</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> addr<span class="token punctuation">,</span> list <span class="token operator">:=</span> <span class="token keyword">range</span> pool<span class="token punctuation">.</span>pending <span class="token punctuation">&#123;</span>
		nonce <span class="token operator">:=</span> pool<span class="token punctuation">.</span>currentState<span class="token punctuation">.</span><span class="token function">GetNonce</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span>

		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> list<span class="token punctuation">.</span><span class="token function">Forward</span><span class="token punctuation">(</span>nonce<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			hash <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Removed old pending transaction"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
			pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
			pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Removed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>

		drops<span class="token punctuation">,</span> invalids <span class="token operator">:=</span> list<span class="token punctuation">.</span><span class="token function">Filter</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>currentState<span class="token punctuation">.</span><span class="token function">GetBalance</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">,</span> pool<span class="token punctuation">.</span>currentMaxGas<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> drops <span class="token punctuation">&#123;</span>
			hash <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Removed unpayable pending transaction"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
			pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
			pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Removed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			pendingNofundsCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> invalids <span class="token punctuation">&#123;</span>
			hash <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Demoting pending transaction"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
			pool<span class="token punctuation">.</span><span class="token function">enqueueTx</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> list<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> list<span class="token punctuation">.</span>txs<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>nonce<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> list<span class="token punctuation">.</span><span class="token function">Cap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				hash <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Demoting invalidated transaction"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
				pool<span class="token punctuation">.</span><span class="token function">enqueueTx</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> list<span class="token punctuation">.</span><span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>pending<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>beats<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法是从pending中删除无效交易</p>
<p>这里首先遍历pending这个map，取出每个地址当前的nonce，然后从对应的list中移除所有nonce小于当前值的交易，并将这些交易移除all和priced。之后在滤除所有花费大于当前地址余额或者、gaslimite大于currentMaxGas的交易。Filter返回两部分，drops是符合条件被滤除的，接下来这些交易需要被删除。invalids是由于要保持连续性被滤除的这些交易需要通过enqueueTx方法进入queue中。</p>
<p>再往下，经过刚才操作后，如果pending中账户对应的list中还有值，但是取不到对应nonce的交易，表示剩下的交易都是nonce大于账户当前nonce的交易，这些交易也需要被拿出来放入queue中。此时如果对应的list为空这删除该地址的相关信息。</p>
<h2 id="promoteExecutables"><a href="#promoteExecutables" class="headerlink" title="promoteExecutables"></a>promoteExecutables</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">promoteExecutables</span><span class="token punctuation">(</span>accounts <span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">var</span> promoted <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction

	<span class="token keyword">if</span> accounts <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		accounts <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> addr <span class="token operator">:=</span> <span class="token keyword">range</span> pool<span class="token punctuation">.</span>queue <span class="token punctuation">&#123;</span>
			accounts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>accounts<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> addr <span class="token operator">:=</span> <span class="token keyword">range</span> accounts <span class="token punctuation">&#123;</span>
		list <span class="token operator">:=</span> pool<span class="token punctuation">.</span>queue<span class="token punctuation">[</span>addr<span class="token punctuation">]</span>
		<span class="token keyword">if</span> list <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">continue</span> 
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> list<span class="token punctuation">.</span><span class="token function">Forward</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>currentState<span class="token punctuation">.</span><span class="token function">GetNonce</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			hash <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Removed old queued transaction"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
			pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
			pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Removed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>

		drops<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> list<span class="token punctuation">.</span><span class="token function">Filter</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>currentState<span class="token punctuation">.</span><span class="token function">GetBalance</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">,</span> pool<span class="token punctuation">.</span>currentMaxGas<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> drops <span class="token punctuation">&#123;</span>
			hash <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Removed unpayable queued transaction"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
			pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
			pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Removed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			queuedNofundsCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> list<span class="token punctuation">.</span><span class="token function">Ready</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>pendingState<span class="token punctuation">.</span><span class="token function">GetNonce</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			hash <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> pool<span class="token punctuation">.</span><span class="token function">promoteTx</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> tx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Promoting queued transaction"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
				promoted <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>promoted<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> <span class="token operator">!</span>pool<span class="token punctuation">.</span>locals<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> list<span class="token punctuation">.</span><span class="token function">Cap</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>AccountQueue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				hash <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
				pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Removed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				queuedRateLimitCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
				log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Removed cap-exceeding queued transaction"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> list<span class="token punctuation">.</span><span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>promoted<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">go</span> pool<span class="token punctuation">.</span>txFeed<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>NewTxsEvent<span class="token punctuation">&#123;</span>promoted<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	pending <span class="token operator">:=</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> list <span class="token operator">:=</span> <span class="token keyword">range</span> pool<span class="token punctuation">.</span>pending <span class="token punctuation">&#123;</span>
		pending <span class="token operator">+=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> pending <span class="token operator">></span> pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>GlobalSlots <span class="token punctuation">&#123;</span>
		pendingBeforeCap <span class="token operator">:=</span> pending
		spammers <span class="token operator">:=</span> prque<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> addr<span class="token punctuation">,</span> list <span class="token operator">:=</span> <span class="token keyword">range</span> pool<span class="token punctuation">.</span>pending <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>pool<span class="token punctuation">.</span>locals<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">uint64</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>AccountSlots <span class="token punctuation">&#123;</span>
				spammers<span class="token punctuation">.</span><span class="token function">Push</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token function">int64</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		offenders <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
		<span class="token keyword">for</span> pending <span class="token operator">></span> pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>GlobalSlots <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>spammers<span class="token punctuation">.</span><span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			offender<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> spammers<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			offenders <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>offenders<span class="token punctuation">,</span> offender<span class="token punctuation">.</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token punctuation">)</span>

			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>offenders<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token punctuation">&#123;</span>
				threshold <span class="token operator">:=</span> pool<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>offender<span class="token punctuation">.</span><span class="token punctuation">(</span>common<span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

				<span class="token keyword">for</span> pending <span class="token operator">></span> pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>GlobalSlots <span class="token operator">&amp;&amp;</span> pool<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>offenders<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>offenders<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> threshold <span class="token punctuation">&#123;</span>
					<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>offenders<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
						list <span class="token operator">:=</span> pool<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>offenders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
						<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> list<span class="token punctuation">.</span><span class="token function">Cap</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
							hash <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
							pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
							pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Removed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


							<span class="token keyword">if</span> nonce <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> pool<span class="token punctuation">.</span>pendingState<span class="token punctuation">.</span><span class="token function">GetNonce</span><span class="token punctuation">(</span>offenders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> nonce <span class="token punctuation">&#123;</span>
								pool<span class="token punctuation">.</span>pendingState<span class="token punctuation">.</span><span class="token function">SetNonce</span><span class="token punctuation">(</span>offenders<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> nonce<span class="token punctuation">)</span>
							<span class="token punctuation">&#125;</span>
							log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Removed fairness-exceeding pending transaction"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
						<span class="token punctuation">&#125;</span>
						pending<span class="token operator">--</span>
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> pending <span class="token operator">></span> pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>GlobalSlots <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>offenders<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">for</span> pending <span class="token operator">></span> pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>GlobalSlots <span class="token operator">&amp;&amp;</span> <span class="token function">uint64</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>offenders<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>offenders<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>AccountSlots <span class="token punctuation">&#123;</span>
				<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> addr <span class="token operator">:=</span> <span class="token keyword">range</span> offenders <span class="token punctuation">&#123;</span>
					list <span class="token operator">:=</span> pool<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>addr<span class="token punctuation">]</span>
					<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> list<span class="token punctuation">.</span><span class="token function">Cap</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
						hash <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
						pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
						pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Removed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

						<span class="token keyword">if</span> nonce <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> pool<span class="token punctuation">.</span>pendingState<span class="token punctuation">.</span><span class="token function">GetNonce</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token operator">></span> nonce <span class="token punctuation">&#123;</span>
							pool<span class="token punctuation">.</span>pendingState<span class="token punctuation">.</span><span class="token function">SetNonce</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> nonce<span class="token punctuation">)</span>
						<span class="token punctuation">&#125;</span>
						log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Removed fairness-exceeding pending transaction"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
					<span class="token punctuation">&#125;</span>
					pending<span class="token operator">--</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		pendingRateLimitCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span>pendingBeforeCap <span class="token operator">-</span> pending<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	queued <span class="token operator">:=</span> <span class="token function">uint64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> list <span class="token operator">:=</span> <span class="token keyword">range</span> pool<span class="token punctuation">.</span>queue <span class="token punctuation">&#123;</span>
		queued <span class="token operator">+=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> queued <span class="token operator">></span> pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>GlobalQueue <span class="token punctuation">&#123;</span>
		addresses <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>addressesByHeartbeat<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> addr <span class="token operator">:=</span> <span class="token keyword">range</span> pool<span class="token punctuation">.</span>queue <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>pool<span class="token punctuation">.</span>locals<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
				addresses <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>addresses<span class="token punctuation">,</span> addressByHeartbeat<span class="token punctuation">&#123;</span>addr<span class="token punctuation">,</span> pool<span class="token punctuation">.</span>beats<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		sort<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span>addresses<span class="token punctuation">)</span>

		<span class="token keyword">for</span> drop <span class="token operator">:=</span> queued <span class="token operator">-</span> pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>GlobalQueue<span class="token punctuation">;</span> drop <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>addresses<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">&#123;</span>
			addr <span class="token operator">:=</span> addresses<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>addresses<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
			list <span class="token operator">:=</span> pool<span class="token punctuation">.</span>queue<span class="token punctuation">[</span>addr<span class="token punctuation">.</span>address<span class="token punctuation">]</span>

			addresses <span class="token operator">=</span> addresses<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>addresses<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

			<span class="token keyword">if</span> size <span class="token operator">:=</span> <span class="token function">uint64</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> size <span class="token operator">&lt;=</span> drop <span class="token punctuation">&#123;</span>
				<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> list<span class="token punctuation">.</span><span class="token function">Flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					pool<span class="token punctuation">.</span><span class="token function">removeTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
				<span class="token punctuation">&#125;</span>
				drop <span class="token operator">-=</span> size
				queuedRateLimitCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">&#125;</span>
			txs <span class="token operator">:=</span> list<span class="token punctuation">.</span><span class="token function">Flatten</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>txs<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> drop <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">&#123;</span>
				pool<span class="token punctuation">.</span><span class="token function">removeTx</span><span class="token punctuation">(</span>txs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
				drop<span class="token operator">--</span>
				queuedRateLimitCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里是将queue中可执行的交易放到pending中。</p>
<p>参数中给定一组地址，表示其所对应的交易需要修改状态。如果参数为空，则默认为queue中所有地址。</p>
<p>之后遍历所有账户，取其在queue中对应的list，首先移除list中交易的nonce低于账户当前nonce的，将其从all和priced中移除。之后再滤除所有交易花费大于账户余额的或者gas用量大于当前gas限制的所有交易，也将其从all和priced中移除。之后利用ready方法得到可执行的交易，ready方法需要指定一个nonce，如果存储的最小值小于这个nonce，这从起开始取一系列连续的交易。由于之前已经删除了nonce小于当前账户值的交易，所以这里是从nonce等于账户当前值的交易开始取，取出的一些列交易nonce是递增的。对于这些交易使用promoteTx方法将其放入pending中，若放入成功，则在promoted中存一份。</p>
<p>之后如果该放手地址不在locals中，限制list数量为最大64（默认值）。经过上面处理后如果queue中对应地址的list为空，则将其从queue中删除。</p>
<p>循环完所有给定的地址后，如果有交易需要放到pending中时，发送消息。</p>
<p>下面是处理pending溢出的问题。首先添加pending中给所有交易处理。如果大于给定值（默认4096）则需要进一步处理。首先新建一个优先级队列spammers。然后遍历pending中所有键值对，如果不属于locals而且其对应list长度大于给定值（默认16），则将其地址放入spammers，优先级就是list长度。</p>
<p>接着开启一个循环，直到pending中交易数量满足要求或者spammers为空为止。每次循环都从spammers获取优先级最高的地址，放入offenders，直到offenders数量大于1时，循环删除数组中每个地址的list的最后一个交易，前提是保证各个地址的优先级顺序。如果还超过指定数量，则继续循环删除，要保证list长度不小于16（默认值）.</p>
<p>接着处理queue溢出问题，也是先统计数量，默认的最大值是1024。将queue中所有不属于locals的地址放入addresses中，这是一个addressesByHeartbeat数组，可以按心跳时间排序。接着按心跳时间从就到新依次删除，直到总数满足要求。</p>
<h2 id="add-1"><a href="#add-1" class="headerlink" title="add"></a>add</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">add</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> local <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	hash <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Discarding already known transaction"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"known transaction: %x"</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> pool<span class="token punctuation">.</span><span class="token function">validateTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> local<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Discarding invalid transaction"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		invalidTxCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token function">uint64</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>GlobalSlots<span class="token operator">+</span>pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>GlobalQueue <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>local <span class="token operator">&amp;&amp;</span> pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Underpriced</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> pool<span class="token punctuation">.</span>locals<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Discarding underpriced transaction"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			underpricedTxCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> ErrUnderpriced
		<span class="token punctuation">&#125;</span>

		drop <span class="token operator">:=</span> pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Discard</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">int</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>GlobalSlots<span class="token operator">+</span>pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>GlobalQueue<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pool<span class="token punctuation">.</span>locals<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> drop <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Discarding freshly underpriced transaction"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			underpricedTxCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			pool<span class="token punctuation">.</span><span class="token function">removeTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	from<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">Sender</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>signer<span class="token punctuation">,</span> tx<span class="token punctuation">)</span> 
	<span class="token keyword">if</span> list <span class="token operator">:=</span> pool<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>from<span class="token punctuation">]</span><span class="token punctuation">;</span> list <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> list<span class="token punctuation">.</span><span class="token function">Overlaps</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		inserted<span class="token punctuation">,</span> old <span class="token operator">:=</span> list<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PriceBump<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>inserted <span class="token punctuation">&#123;</span>
			pendingDiscardCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> ErrReplaceUnderpriced
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span> old <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
			pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>old<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Removed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			pendingReplaceCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span>
		pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span>
		pool<span class="token punctuation">.</span><span class="token function">journalTx</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>

		log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Pooled new executable transaction"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">"from"</span><span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token string">"to"</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token keyword">go</span> pool<span class="token punctuation">.</span>txFeed<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>NewTxsEvent<span class="token punctuation">&#123;</span>types<span class="token punctuation">.</span>Transactions<span class="token punctuation">&#123;</span>tx<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

		<span class="token keyword">return</span> old <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	replace<span class="token punctuation">,</span> err <span class="token operator">:=</span> pool<span class="token punctuation">.</span><span class="token function">enqueueTx</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> local <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>pool<span class="token punctuation">.</span>locals<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Setting new local account"</span><span class="token punctuation">,</span> <span class="token string">"address"</span><span class="token punctuation">,</span> from<span class="token punctuation">)</span>
			pool<span class="token punctuation">.</span>locals<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	pool<span class="token punctuation">.</span><span class="token function">journalTx</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>

	log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Pooled new future transaction"</span><span class="token punctuation">,</span> <span class="token string">"hash"</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token string">"from"</span><span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token string">"to"</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> replace<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里主要是验证交易并根据情况插入到相应队列。</p>
<p>首先给定一个交易，首先判断是否在all中，是的话表示已经知道该交易直接返回。之后调用validateTx验证交易是否有效。有效的话，看all中的交易数量是否满了，满的话，检查要插入的交易是否比priced中所有交易的GasPrice都要小，是的话抛弃新交易，否则，抛弃priced中一定数量的交易，对于要抛弃的交易调用removeTx方法将其从一些集合中删除。</p>
<p>如果all没有满，或已满但处理过之后，从交易中还原出发送人地址。接着从pending中取出对应地址的交易集合，如果集合不为空且有相同nonce的交易，则尝试替换，如果不需要替换则直接返回，若需要替换，则将旧的交易从all和priced中删除。并将新的交易放入all和priced中。</p>
<p>若该交易的发送人在pending中没有交易列表或列表内没旧的交易，则将调用enqueueTx将其放入queue中。若是本地模式则检查locals是否包含该地址，若没有则加入进去。之后将交易放入日志中，最后返回。</p>
<h2 id="validateTx"><a href="#validateTx" class="headerlink" title="validateTx"></a>validateTx</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">validateTx</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">,</span> local <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> tx<span class="token punctuation">.</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">32</span><span class="token operator">*</span><span class="token number">1024</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> ErrOversizedData
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> tx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> ErrNegativeValue
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> pool<span class="token punctuation">.</span>currentMaxGas <span class="token operator">&lt;</span> tx<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> ErrGasLimit
	<span class="token punctuation">&#125;</span>

	from<span class="token punctuation">,</span> err <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">Sender</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>signer<span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> ErrInvalidSender
	<span class="token punctuation">&#125;</span>

	local <span class="token operator">=</span> local <span class="token operator">||</span> pool<span class="token punctuation">.</span>locals<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token comment">// account may be local even if the transaction arrived from the network</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>local <span class="token operator">&amp;&amp;</span> pool<span class="token punctuation">.</span>gasPrice<span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">GasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> ErrUnderpriced
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> pool<span class="token punctuation">.</span>currentState<span class="token punctuation">.</span><span class="token function">GetNonce</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token operator">></span> tx<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> ErrNonceTooLow
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> pool<span class="token punctuation">.</span>currentState<span class="token punctuation">.</span><span class="token function">GetBalance</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Cmp</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Cost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> ErrInsufficientFunds
	<span class="token punctuation">&#125;</span>
	intrGas<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">IntrinsicGas</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">To</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> pool<span class="token punctuation">.</span>homestead<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> tx<span class="token punctuation">.</span><span class="token function">Gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> intrGas <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> ErrIntrinsicGas
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先判断交易的大小，所谓交易的大小是指交易数据（如发送人、接收人、GasPrice、value等数据）经rlp编码后的大小，最大不得超过32KB。</p>
<p>之后传输的金额不得小于0，并且交易的GasLimit不得超过当前txpool设置的值（在reset中根据区块设置），也就是区块的限制。接着恢复出交易的发送人地址，这里不能有错。然后对于非本地交易，其gasprice不得小于txpool设定的和。另外还要验证发送者的nonce和交易中标记的nonce是否符合要求，并且发送者还要有足够的余额。最后计算出消耗的固定gas，不能超过gaslimit。</p>
<h2 id="removeTx"><a href="#removeTx" class="headerlink" title="removeTx"></a>removeTx</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">removeTx</span><span class="token punctuation">(</span>hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> outofbound <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	tx <span class="token operator">:=</span> pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
	<span class="token keyword">if</span> tx <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	addr<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">Sender</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>signer<span class="token punctuation">,</span> tx<span class="token punctuation">)</span> 

	pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
	<span class="token keyword">if</span> outofbound <span class="token punctuation">&#123;</span>
		pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Removed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> pending <span class="token operator">:=</span> pool<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">;</span> pending <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> removed<span class="token punctuation">,</span> invalids <span class="token operator">:=</span> pending<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">;</span> removed <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> pending<span class="token punctuation">.</span><span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token function">delete</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>pending<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
				<span class="token function">delete</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>beats<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tx <span class="token operator">:=</span> <span class="token keyword">range</span> invalids <span class="token punctuation">&#123;</span>
				pool<span class="token punctuation">.</span><span class="token function">enqueueTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tx<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">if</span> nonce <span class="token operator">:=</span> tx<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> pool<span class="token punctuation">.</span>pendingState<span class="token punctuation">.</span><span class="token function">GetNonce</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token operator">></span> nonce <span class="token punctuation">&#123;</span>
				pool<span class="token punctuation">.</span>pendingState<span class="token punctuation">.</span><span class="token function">SetNonce</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> nonce<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> future <span class="token operator">:=</span> pool<span class="token punctuation">.</span>queue<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">;</span> future <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		future<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span>
		<span class="token keyword">if</span> future<span class="token punctuation">.</span><span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是删除一个交易的操作。首先从all中获取对应交易，没有的话直接返回。有的话从交易中恢复出地址，然后从all中删除交易，如果第二个参数为true的话，priced中的也要对应删除。之后获取pending中对应地址的txlist，将交易从中删除，若删除之后对应txlist为空则还要删除对应的txlist。txlist的remove的第二个方法是在严格模式下删除的那些不连续的交易，对于这些交易要通过enqueueTx放入未执行队列中。最后如果发送地址的nonce大于交易的nonce，要修改发送地址的nonce。</p>
<p>最后删除queue中对应地址下的txlist中的相应交易。</p>
<h2 id="enqueueTx"><a href="#enqueueTx" class="headerlink" title="enqueueTx"></a>enqueueTx</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">enqueueTx</span><span class="token punctuation">(</span>hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	from<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> types<span class="token punctuation">.</span><span class="token function">Sender</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span>signer<span class="token punctuation">,</span> tx<span class="token punctuation">)</span> 
	<span class="token keyword">if</span> pool<span class="token punctuation">.</span>queue<span class="token punctuation">[</span>from<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		pool<span class="token punctuation">.</span>queue<span class="token punctuation">[</span>from<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newTxList</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	inserted<span class="token punctuation">,</span> old <span class="token operator">:=</span> pool<span class="token punctuation">.</span>queue<span class="token punctuation">[</span>from<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PriceBump<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>inserted <span class="token punctuation">&#123;</span>
		queuedDiscardCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> ErrReplaceUnderpriced
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> old <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>old<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Removed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		queuedReplaceCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span>
		pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> old <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是将一个交易插入queue中，首先获取交易的发送人地址，之后如果queue中对应地址的值为空，则新建一个txlist（非严格模式）。之后调用add方法插入，add方法会返回有相同nonce的旧交易，若有旧交易则需要将其从all删除。对于新交易如果all中没有则添加进去，同样也要在priced中添加一份。</p>
<h2 id="journalTx"><a href="#journalTx" class="headerlink" title="journalTx"></a>journalTx</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">journalTx</span><span class="token punctuation">(</span>from common<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> pool<span class="token punctuation">.</span>journal <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token operator">!</span>pool<span class="token punctuation">.</span>locals<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> pool<span class="token punctuation">.</span>journal<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Failed to journal local transaction"</span><span class="token punctuation">,</span> <span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个操作主要是讲交易放入日志中，但事先会检查地址是否在locals中</p>
<h2 id="promoteTx"><a href="#promoteTx" class="headerlink" title="promoteTx"></a>promoteTx</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>pool <span class="token operator">*</span>TxPool<span class="token punctuation">)</span> <span class="token function">promoteTx</span><span class="token punctuation">(</span>addr common<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> hash common<span class="token punctuation">.</span>Hash<span class="token punctuation">,</span> tx <span class="token operator">*</span>types<span class="token punctuation">.</span>Transaction<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> pool<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		pool<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newTxList</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	list <span class="token operator">:=</span> pool<span class="token punctuation">.</span>pending<span class="token punctuation">[</span>addr<span class="token punctuation">]</span>

	inserted<span class="token punctuation">,</span> old <span class="token operator">:=</span> list<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> pool<span class="token punctuation">.</span>config<span class="token punctuation">.</span>PriceBump<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>inserted <span class="token punctuation">&#123;</span>
		pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
		pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Removed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		pendingDiscardCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> old <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>old<span class="token punctuation">.</span><span class="token function">Hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Removed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

		pendingReplaceCounter<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		pool<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span>
		pool<span class="token punctuation">.</span>priced<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	pool<span class="token punctuation">.</span>beats<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	pool<span class="token punctuation">.</span>pendingState<span class="token punctuation">.</span><span class="token function">SetNonce</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> tx<span class="token punctuation">.</span><span class="token function">Nonce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是将某个交易放入pending中</p>
<p>首先将交易放入pending中对应的list中，如果没有出现替换，则将新的交易从all中移除，若出现替换则将旧的交易从all中移除。最后还要讲新的交易放入all和priced中，并记录改地址心跳时间，并更新地址的nonce。</p>
<blockquote>
<p>题图来自unsplash：<a target="_blank" rel="noopener" href="https://unsplash.com/photos/eWFdaPRFjwE">https://unsplash.com/photos/eWFdaPRFjwE</a></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag"><i class="fa fa-tag"></i> 区块链</a>
              <a href="/tags/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" rel="tag"><i class="fa fa-tag"></i> 以太坊</a>
              <a href="/tags/go/" rel="tag"><i class="fa fa-tag"></i> go</a>
              <a href="/tags/go-ethereum/" rel="tag"><i class="fa fa-tag"></i> go-ethereum</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/06/08/go-ethereum%E4%B8%ADProcessor%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/" rel="prev" title="go-ethereum中Processor源码学习">
                  <i class="fa fa-chevron-left"></i> go-ethereum中Processor源码学习
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/06/08/go-ethereum%E4%B8%ADgeth%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/" rel="next" title="go-ethereum中geth启动流程分析">
                  go-ethereum中geth启动流程分析 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">AmorFati</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">632k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:35</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
